<!DOCTYPE html>
<html style="filter:grayscale(0%);">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>octopus 快速上手</title>
    <meta name="description" content="octopus-8.4快速上手记录短期内应该不会用octopus了，记录免忘记不得不说octopus官方的教程写的真是太好了">

    <link rel="shortcut icon" href="/favicon.jpg?" type="image/x-icon">
    <link rel="icon" href="/favicon.jpg?" type="image/x-icon">
    <!---2020-01-17 change font-awesome-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <!--- 
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
    -->
    <link rel="stylesheet" href="/css/cndaqiang.css"> 
	<!---图标cdn icon，每次在iconfont中添加一个图标，这个链接就要更新--->
   <link rel="stylesheet" href="https://at.alicdn.com/t/font_461356_ofctiykkk5.css">
	 <link rel="stylesheet" href="/css/main.css ">
   <link rel="canonical" href="http://0.0.0.0:4000/2019/04/11/octopus/">
   <link rel="alternate" type="application/rss+xml" title="cndaqiang" href="http://0.0.0.0:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8ba332e6517ae0ba8a13339285d97bb3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>



<!-- 谷歌统计 --><!-- 跨网域跟踪 -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?UA-109057291-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109057291-1');
</script>



<script defer src="https://cloud.umami.is/script.js" data-website-id="27e72116-bcc0-4a4d-82a5-485b4105820e"></script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: { inlineMath: [["$","$"],["\\(","\\)"]] },
    "HTML-CSS": {
      linebreaks: { automatic: true, width: "container" }
    }
});
</script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!---   谷歌cse站内搜索-->
<!--- <script async src="https://cse.google.com/cse.js?cx=011772597085732398296:uzswyrqhpft"></script>
--->





</head>


  <body>

    <!-- 备案不显示镜像-->


<header id="top">
    <div class="wrapper">
      
        <a href="/" class="brand">cndaqiang</a>
        <small>Web Linux DFT</small> 
        
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>专栏
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>工具
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>标签
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <!---文章页面--->

<div class="page clearfix" post>
    <div class="left">
        <h1>octopus 快速上手</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2019-04-11
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>cndaqiang
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#DFT" title="Category: DFT" rel="category">DFT</a>&nbsp;
    
        <a href="/category/#TDDFT" title="Category: TDDFT" rel="category">TDDFT</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#octopus" title="Tag: octopus" rel="tag">octopus</a-->
        <a href="/tag/#octopus" title="Tag: octopus" rel="tag">octopus</a>
    
  

</span>


            </div>
            <!--- 2020-01-17 RSS-->
            <div class="label-card">
                <a href="/feed.xml" title="RSS"><i class="fa fa-rss-square" aria-hidden="true"></i>RSS</a>
            </div>

            <div class="label-card">
                <a href="https://github.com/cndaqiang/cndaqiang.github.io" title="RSS"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i>Star</a>
            </div>
            
            <!--- github start , copy from https://github.com/mdo/github-buttons--->
            <!---
            <div>
                <iframe src="/html_script/github-btn.html?user=cndaqiang&repo=cndaqiang.github.io&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
            </div>
            --->

        </div>
        
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
  <li><a href="#简单运行" id="markdown-toc-简单运行">简单运行</a></li>
  <li><a href="#inp文件" id="markdown-toc-inp文件">inp文件</a>    <ul>
      <li><a href="#文件格式" id="markdown-toc-文件格式">文件格式</a></li>
      <li><a href="#计算参数" id="markdown-toc-计算参数">计算参数</a>        <ul>
          <li><a href="#赝势" id="markdown-toc-赝势">赝势</a></li>
          <li><a href="#泛函" id="markdown-toc-泛函">泛函</a></li>
          <li><a href="#原子质量" id="markdown-toc-原子质量">原子质量</a></li>
          <li><a href="#vdw修正" id="markdown-toc-vdw修正">vdw修正</a></li>
        </ul>
      </li>
      <li><a href="#控制参数" id="markdown-toc-控制参数">控制参数</a>        <ul>
          <li><a href="#boxshape-计算网格形状" id="markdown-toc-boxshape-计算网格形状"><code class="language-plaintext highlighter-rouge">BoxShape</code> 计算网格形状</a></li>
          <li><a href="#tdtimestep时间步长" id="markdown-toc-tdtimestep时间步长"><code class="language-plaintext highlighter-rouge">TDTimeStep</code>时间步长</a></li>
          <li><a href="#kpointsusetimereversal时间反演对称性" id="markdown-toc-kpointsusetimereversal时间反演对称性"><code class="language-plaintext highlighter-rouge">KPointsUseTimeReversal</code>时间反演对称性</a></li>
          <li><a href="#动力学参数" id="markdown-toc-动力学参数">动力学参数</a></li>
        </ul>
      </li>
      <li><a href="#续算" id="markdown-toc-续算">续算</a></li>
      <li><a href="#终止程序" id="markdown-toc-终止程序">终止程序</a></li>
    </ul>
  </li>
  <li><a href="#结构优化" id="markdown-toc-结构优化">结构优化</a>    <ul>
      <li><a href="#关于续算的一些测试" id="markdown-toc-关于续算的一些测试">关于续算的一些测试</a></li>
      <li><a href="#尝试解决报错循环报错" id="markdown-toc-尝试解决报错循环报错">尝试解决报错循环报错</a>        <ul>
          <li><a href="#报错iteration-is-not-making-progress-towards-solution" id="markdown-toc-报错iteration-is-not-making-progress-towards-solution">报错<code class="language-plaintext highlighter-rouge">iteration is not making progress towards solution</code></a></li>
          <li><a href="#续算和交替优化" id="markdown-toc-续算和交替优化">续算和交替优化</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#性质计算" id="markdown-toc-性质计算">性质计算</a>    <ul>
      <li><a href="#输入" id="markdown-toc-输入">输入</a></li>
      <li><a href="#output参数" id="markdown-toc-output参数">Output参数</a>        <ul>
          <li><a href="#密度" id="markdown-toc-密度">密度</a></li>
          <li><a href="#dos--pdos" id="markdown-toc-dos--pdos">dos &amp; pdos</a></li>
          <li><a href="#波函数" id="markdown-toc-波函数">波函数</a></li>
        </ul>
      </li>
      <li><a href="#输出文件" id="markdown-toc-输出文件">输出文件</a>        <ul>
          <li><a href="#static" id="markdown-toc-static">static</a></li>
        </ul>
      </li>
      <li><a href="#tdoutput" id="markdown-toc-tdoutput">TDOutput</a></li>
    </ul>
  </li>
  <li><a href="#搭建说明网页" id="markdown-toc-搭建说明网页">搭建说明网页</a></li>
  <li><a href="#示例" id="markdown-toc-示例">示例</a>    <ul>
      <li><a href="#周期性示例" id="markdown-toc-周期性示例">周期性示例</a></li>
      <li><a href="#td-计算示例" id="markdown-toc-td-计算示例">td 计算示例</a></li>
    </ul>
  </li>
  <li><a href="#报错" id="markdown-toc-报错">报错</a>    <ul>
      <li><a href="#使用中文的tab键" id="markdown-toc-使用中文的tab键">使用中文的tab键</a></li>
      <li><a href="#核数不合适" id="markdown-toc-核数不合适">核数不合适</a></li>
      <li><a href="#radius太小" id="markdown-toc-radius太小">radius太小</a></li>
      <li><a href="#缺少赝势" id="markdown-toc-缺少赝势">缺少赝势</a></li>
    </ul>
  </li>
</ul>

<p>octopus-8.4快速上手记录<br />
短期内应该不会用octopus了，记录免忘记<br />
不得不说octopus官方的教程写的真是太好了</p>

<h2 id="参考">参考</h2>
<p><a href="https://octopus-code.org/wiki/Tutorial:Getting_started">octopus-Tutorial</a></p>

<p><a href="/2018/12/21/gcc-octopus8/"> Gcc OPENMPI 编译octopus-8 遇到的问题和解决方案</a></p>

<p><a href="/2018/09/15/gun-openmpi-octopus-7.1/"> centos6.5 Gcc Openmpi 编译octopus-7.1 </a></p>

<h2 id="简单运行">简单运行</h2>
<p>octopus有原子坐标既可以运行<br />
如，新建<code class="language-plaintext highlighter-rouge">inp</code>填入</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%Coordinates
'H'  |0 | 0 | 0
%
</code></pre></div></div>
<p>然后</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mpirun -np 核数 octopus
</code></pre></div></div>
<p>就可以了，octopsu会提供赝势等等参数<br /></p>

<p>运算之后，生成<code class="language-plaintext highlighter-rouge">exec   restart   static</code><br />
<code class="language-plaintext highlighter-rouge">static</code>里面包含计算结果和输出文件</p>

<h2 id="inp文件">inp文件</h2>
<h3 id="文件格式">文件格式</h3>
<ul>
  <li>可以在inp中自定义变量，<strong>变量名区分大小写</strong>，并进行相关数学计算<a href="https://octopus-code.org/wiki/Manual:Input_file#Mathematical_expressions">Mathematical expressions</a></li>
  <li><strong>计算参数名不区分大小写</strong>，不区分顺序</li>
  <li><strong>系统变量也不区分大小写</strong>,如<code class="language-plaintext highlighter-rouge">Output = dos</code> 等价于<code class="language-plaintext highlighter-rouge">Output = DOS</code></li>
  <li>注释<code class="language-plaintext highlighter-rouge">#</code>开头</li>
  <li>可以用 <code class="language-plaintext highlighter-rouge">include 文件名</code> 把其他文件放到inp文件中</li>
  <li><strong>输入文件只能是inp,不能改变名字</strong></li>
  <li>说明书中的参数解释:</li>
  <li>
    <ul>
      <li>DOSComputePDOS  ;参数名</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>Section: Output ;分类,<strong>没用</strong></li>
    </ul>
  </li>
  <li>
    <ul>
      <li>Type: logical   ;类型:float,logical,integer,string,block等, <strong>logical类型赋值为0/1</strong></li>
    </ul>
  </li>
  <li>
    <ul>
      <li>Default: false  ; 默认参数</li>
    </ul>
  </li>
  <li>不同版本的参数会出现不同,本文主要基于Octopus-8/10.4</li>
  <li><strong>逻辑变量赋值为yes/no(或1/0),不是true/T之类的</strong></li>
</ul>

<h3 id="计算参数">计算参数</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">MaximumIter=10</code> 最大自洽步数,用于快速debug代码</li>
</ul>

<h4 id="赝势">赝势</h4>
<p><strong>自己下载的赝势</strong>,<code class="language-plaintext highlighter-rouge">UPF</code>的赝势虽然可以用,但是计算量特别大</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%Species
'Ag' | species_pseudo | file |  './Ag_ONCV_PBE_fr.upf'
'C' | species_pseudo | file |  './C_ONCV_PBE_fr.upf'
'H' | species_pseudo | file |  './H_ONCV_PBE_fr.upf'
%
#XML (QSO, UPF, and PSML, PSP8) pseudopotential support is an experimental feature.
#需要设置ExperimentalFeatures=yes
ExperimentalFeatures=yes
</code></pre></div></div>

<p><strong>octopus目录的赝势</strong></p>
<ul>
  <li>如<code class="language-plaintext highlighter-rouge">sg15</code>则读取<code class="language-plaintext highlighter-rouge">octopus-10.4/share/octopus/pseudopotentials/quantum-simulation.org/sg15/</code>目录的赝势,<br />
由于是upf格式,还要加上<code class="language-plaintext highlighter-rouge">ExperimentalFeatures=yes</code></li>
  <li><code class="language-plaintext highlighter-rouge">standard</code>的赝势只有有限的几个H, Li, C, N, O, Na, Si, S, Ti, Se, Cd.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%Species
'Ag' | species_pseudo | set | sg15
#set后面支持的参数,说明书中的PseudopotentialSet由可用列表
%
ExperimentalFeatures=yes
#如果有很多元素则可以这样设置所有都默认是sg15
PseudopotentialSet=sg15
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="泛函">泛函</h4>
<p>有的赝势,octopus无法识别泛函的类型,这时会用默认的LDA进行计算,这时需要指定泛函</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**   Unknown XC functional for species 'Ag'
</code></pre></div></div>
<p>如</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#exchange:x   correlation:c
XCFunctional=gga_x_pbe+gga_c_pbe
</code></pre></div></div>

<h4 id="原子质量">原子质量</h4>
<p>默认根据元素名识别相对原子质量,不用指定也可以. 如果元素名随意设置,会报错<code class="language-plaintext highlighter-rouge">Cannot determine the element for species CC</code></p>

<h4 id="vdw修正">vdw修正</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VDWCorrection=vdw_d3
ExperimentalFeatures=yes
</code></pre></div></div>

<h3 id="控制参数">控制参数</h3>

<h4 id="boxshape-计算网格形状"><code class="language-plaintext highlighter-rouge">BoxShape</code> 计算网格形状</h4>
<p><a href="https://octopus-code.org/doc/10.4/html/vars.php?section=Mesh&amp;name=BoxShape">BoxShape</a></p>

<p>默认是<code class="language-plaintext highlighter-rouge">minimum</code>,原子越远离原点,网格点越多</p>

<p>使用sphere时,如果原子/电子超出设置的球形边界,不会被计算,会出现误差</p>

<p>This variable decides the shape of the simulation box. The default is minimum for finite systems and parallelepiped for periodic systems. Note that some incompatibilities apply:</p>

<p><strong>Spherical or minimum mesh is not allowed for periodic systems.</strong>
Cylindrical mesh is not allowed for systems that are periodic in more than one dimension.
box_image is only allowed in 2D.</p>

<p>Options:</p>
<ul>
  <li>sphere: The simulation box will be a sphere of radius Radius. (In 2D, this is a circle.), 半径<code class="language-plaintext highlighter-rouge">radius = 15.0*angstrom</code></li>
  <li>cylinder: The simulation box will be a cylinder with radius Radius and height (in the x-direction) of 2 Xlength.</li>
  <li>minimum: The simulation box will be constructed by adding spheres created around each atom (or user-defined potential), of radius Radius.</li>
  <li>parallelepiped: The simulation box will be a parallelepiped whose dimensions are taken from the variable Lsize.</li>
  <li>box_image: The simulation box will be defined through an image, specified with BoxShapeImage. White (RGB = 255,255,255) means that the point is contained in the simulation box, while any other color means that the point is out. The image will be scaled to fit Lsize, while its resolution will define the default Spacing. The actual box may be slightly larger than Lsize to ensure one grid point = one pixel for default Spacing.</li>
  <li>hypercube: (experimental) The simulation box will be a hypercube or hyperparallelepiped. This is equivalent to the parallelepiped box but it can work with an arbitrary number of dimensions.</li>
  <li>user_defined: The shape of the simulation box will be read from the variable BoxShapeUsDef.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BoxShape = sphere
spacing = 0.19*angstrom
radius = 15.0*angstrom
</code></pre></div></div>

<h4 id="tdtimestep时间步长"><code class="language-plaintext highlighter-rouge">TDTimeStep</code>时间步长</h4>
<p>TDTimeStep默认单位是$3.674932539796e-02 \hbar/eV$, $1 \hbar/eV = 0.658211951 fs$</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TDTimeStep = 0.002 # 4.83776903362502e-05 fs, *826827 ~ 40fs
</code></pre></div></div>

<h4 id="kpointsusetimereversal时间反演对称性"><code class="language-plaintext highlighter-rouge">KPointsUseTimeReversal</code>时间反演对称性</h4>

<h4 id="动力学参数">动力学参数</h4>
<p>是否移动原子,<strong>只有打开MoveIons,原子位置后面的yes和no才会生效</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MoveIons = yes
%Coordinates
'C' | angstrom*   -0.0142124300 | angstrom*   -1.1141926050 | angstrom*    4.7610890850  | no
'H' | angstrom*   -0.0135859800 | angstrom*   -1.1175805350 | angstrom*    3.6428618450  | yes
'H' | angstrom*   -0.9162065400 | angstrom*   -1.6344720150 | angstrom*    5.1074087650  | yes
'H' | angstrom*    0.8873471600 | angstrom*   -1.6333341650 | angstrom*    5.1089549050  | yes
'H' | angstrom*   -0.0152745800 | angstrom*   -0.0720769150 | angstrom*    5.1038265250  | yes
%
</code></pre></div></div>

<h3 id="续算">续算</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RestartWriteInterval=50 #每隔多少步保存一次文件,用于续算
FromScratch=no #no读入保存文件,进行续算. yes从头算
</code></pre></div></div>

<h3 id="终止程序">终止程序</h3>
<p>在运行目录,建一个<code class="language-plaintext highlighter-rouge">stop</code>文件</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>** Warning:
**   Clean STOP

  27658      55.316000 -20002.140099         1         3.865
Info: Writing output to output_iter/td.0027658
</code></pre></div></div>

<h2 id="结构优化">结构优化</h2>
<ul>
  <li><strong>先用其他程序(VASP)优化可以减少很多时间</strong></li>
  <li><strong><code class="language-plaintext highlighter-rouge">cg_</code>,<code class="language-plaintext highlighter-rouge">steep</code>等算法,优化到极小值点时程序会崩溃掉,这时只能换其他算法如<code class="language-plaintext highlighter-rouge">fire</code></strong><br />
 <code class="language-plaintext highlighter-rouge">steep</code>,<code class="language-plaintext highlighter-rouge">cg_</code>到极小值后换<code class="language-plaintext highlighter-rouge">cg_</code>,<code class="language-plaintext highlighter-rouge">steep</code>还是极小值,只能换<code class="language-plaintext highlighter-rouge">fire</code>
 <strong>交替优化时<code class="language-plaintext highlighter-rouge">GOMaxIter=50</code>就可以, 提高精度继续重新开始</strong><br />
 <strong>先使用运动速度快的,如<code class="language-plaintext highlighter-rouge">GOMethod=fire</code>配<code class="language-plaintext highlighter-rouge">GOFireMass=0.01</code>.GOFireMass越小越大,<code class="language-plaintext highlighter-rouge">0.01</code>比默认的<code class="language-plaintext highlighter-rouge">1</code>快很多倍</strong></li>
  <li><strong><code class="language-plaintext highlighter-rouge">fire</code>算法是通过跑MD的方式,也可以设置一个大的<code class="language-plaintext highlighter-rouge">GOMaxIter=500</code>,<code class="language-plaintext highlighter-rouge">GOFireMass=0.01</code>,苛刻的优化参数<code class="language-plaintext highlighter-rouge">GOTolerance = 0.01*eV/angstrom</code>,让程序跑一段时间</strong><br />
 <code class="language-plaintext highlighter-rouge">fire</code>不存在到达极小值无法优化奔溃掉</li>
  <li><code class="language-plaintext highlighter-rouge">GOObjective</code>的取值,影响不大</li>
</ul>

<h3 id="关于续算的一些测试">关于续算的一些测试</h3>
<ul>
  <li>使用<code class="language-plaintext highlighter-rouge">steep</code>算法,续算后力的变化也比较有限</li>
  <li><code class="language-plaintext highlighter-rouge">steep</code>续算到无法续算后的结构,steep,bfgs算法输入次结构,也是直接无法计算<br />
使用<code class="language-plaintext highlighter-rouge">fire</code>继续算这个结构,倒是可以又深层次优化一下</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CalculationMode = go
GOMethod = cg_bfgs #先快速steep,最后用cg_bfgs,然后逐渐提高各项精度
GOTolerance = 0.01*eV/angstrom #Default: 0.001 H/b (0.051 eV/A)
#yes移动原子,no固定原子
%Coordinates
'Ag' | angstrom*   -0.0013139800 | angstrom*   -2.7930235850 | angstrom*   -2.7300387650 | no
'Ag' | angstrom*   -0.0013139800 | angstrom*   -2.7930235850 | angstrom*   1.7300387650 | yes
%
</code></pre></div></div>
<p>更多固定方式</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#0动,1固定
%GOConstrains
  'C' | 1 | 0 | 0
  'O' |  1 | 0 | 0
%
</code></pre></div></div>
<p>输出</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">work-geom.xyz</code> 每一步的结构</li>
  <li><code class="language-plaintext highlighter-rouge">last.xyz</code> 最后一步结构.<strong>当设置续算<code class="language-plaintext highlighter-rouge">FromScratch = no</code>时,会读入<code class="language-plaintext highlighter-rouge">last.xyz</code>进行续算</strong></li>
  <li><code class="language-plaintext highlighter-rouge">geom/</code> 日志,力,位移. 每进行一次最小化循环<code class="language-plaintext highlighter-rouge">MINIMIZATION ITER</code>,就输出一个<code class="language-plaintext highlighter-rouge">geom/go.nnnn.xyz</code>文件</li>
  <li><code class="language-plaintext highlighter-rouge">min.xyz</code> 优化结束时的输出</li>
</ul>

<p><strong>跑完了,不一定是收敛了,可能是内存溢出程序终止了</strong>,结束输出</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iter   18 : etot -2.19005958E+02 : abs_dens 3.71E-08 : force  4.73E-07 : etime     0.0s
ETA: .......1......2.......3......4......5.......6......7.......8......9......0

iter   19 : etot -2.19005957E+02 : abs_dens 2.30E-08 : force  4.92E-07 : etime     0.0s
#这里的force 是前后两步force的差别,用来判断scf是否收敛的.同static/convergence
             Info: Writing states. 2022/09/14 at 15:16:35


        Info: Finished writing states. 2022/09/14 at 15:16:35

Info: SCF converged in   19 iterations



++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++ MINIMIZATION ITER #:    1 ++++++++++++++++++++++
  Energy    = -219.0059565865 eV
  Max force =    0.0486830383 eV/A
  Max dr    =    0.0013009175 A
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



Writing final coordinates to min.xyz
Info: Finished writing information to 'restart/gs'.

             Calculation ended on 2022/09/14 at 15:16:35

                          Walltime:  09.651s

Octopus emitted 5 warnings.
</code></pre></div></div>

<h3 id="尝试解决报错循环报错">尝试解决报错循环报错</h3>
<h4 id="报错iteration-is-not-making-progress-towards-solution">报错<code class="language-plaintext highlighter-rouge">iteration is not making progress towards solution</code></h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++ MINIMIZATION ITER #:    7 ++++++++++++++++++++++
  Energy    = -219.0067014605 eV
  Max force =    0.0153721653 eV/A
  Max dr    =    0.0000000000 A
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++




**************************** FATAL ERROR *****************************
*** Fatal Error (description follows)
*--------------------------------------------------------------------
* From node =    0
*--------------------------------------------------------------------
* Error occurred during the GSL minimization procedure:
* iteration is not making progress towards solution
**********************************************************************

Abort(999) on node 0 (rank 0 in comm 0): application called MPI_Abort(MPI_COMM_WORLD, 999) - process 0
</code></pre></div></div>
<p>多核运行时根本看不到报错信息啊….,不同服务器都报错<code class="language-plaintext highlighter-rouge">tag=1620299</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+++++++++++++++++++++ MINIMIZATION ITER #:    7 ++++++++++++++++++++++
  Energy    = -219.0066996657 eV
  Max force =    0.0153715180 eV/A
  Max dr    =    0.0000000000 A
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



Abort(336193796) on node 7 (rank 7 in comm 0): Fatal error in PMPI_Send_init: Invalid tag, error stack:
PMPI_Send_init(152): MPI_Send_init(buf=0x1c55854, count=1, MPI_INTEGER, dest=0, tag=1620299, MPI_COMM_WORLD, request=0x7fffb210d1f8) failed
PMPI_Send_init(103): Invalid tag, value is 1620299
</code></pre></div></div>

<p><strong>看起来就是,两个构型之间的force一样,原子相对位移为0,<code class="language-plaintext highlighter-rouge">Max dr    =    0.0000000000 A</code>优化不动了</strong>,官方给的解决方案就是用<code class="language-plaintext highlighter-rouge">go.xxxx.xyz</code>重算</p>
<blockquote>
  <p>This means that, although the minimization algorithm managed to get very close (~ 0.014 eV/Å), it was unable to improve the solutions up to the desired accuracy. Unfortunately there are not many things that can be done in this case. The most simple one is just to restart the calculation starting from the last geometry (use the last go.XXXX.xyz file) and see if the code is able to improve further the geometry.</p>
</blockquote>

<h4 id="续算和交替优化">续算和交替优化</h4>
<p>有时候系统的续算,一重算就错,自己写的续算更稳</p>
<ul>
  <li>除了构型的输入参数<code class="language-plaintext highlighter-rouge">input.inp</code></li>
  <li>初始构型<code class="language-plaintext highlighter-rouge">structure.xyz</code></li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function </span>xyz2oct<span class="o">()</span>
<span class="o">{</span>
<span class="nv">OUTPUTFILE</span><span class="o">=</span>inp

<span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> geom <span class="o">]</span> <span class="c">#存在目录,说明算过了,开始续算</span>
<span class="k">then</span>
  <span class="c">#geom会被octopus清空</span>
  <span class="c">#检查是否存在正常的xyz文件,否则退出</span>
  <span class="nv">INPUTFILE</span><span class="o">=</span>geom/go.0001.xyz
  <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$INPUTFILE</span>  <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="s2">"Error: No xyz in geom"</span><span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi
  if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi
  if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> <span class="k">$((</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-1</span> <span class="nv">$INPUTFILE</span><span class="si">)</span><span class="o">+</span><span class="m">2</span><span class="k">))</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi</span>
  <span class="c">#</span>
  <span class="c">#选择最新正常的xyz文件</span>
  <span class="nv">INPUTFILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls </span>geom/go<span class="k">*</span>.xyz | <span class="nb">sort</span> | <span class="nb">tail</span> <span class="nt">-1</span><span class="si">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nv">INPUTFILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls </span>geom/go<span class="k">*</span>.xyz | <span class="nb">sort</span> | <span class="nb">tail</span> <span class="nt">-2</span> | <span class="nb">head</span> <span class="nt">-1</span><span class="si">)</span><span class="p">;</span><span class="k">fi
  if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nv">INPUTFILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls </span>geom/go<span class="k">*</span>.xyz | <span class="nb">sort</span> | <span class="nb">tail</span> <span class="nt">-2</span> | <span class="nb">head</span> <span class="nt">-1</span><span class="si">)</span><span class="p">;</span><span class="k">fi
else</span> <span class="c">#第一次开始计算,使用structure作为结构</span>
  <span class="nv">INPUTFILE</span><span class="o">=</span>structure.xyz
<span class="k">fi</span>
<span class="c">#最后确定xyz文件是否正常</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span>  <span class="nv">$INPUTFILE</span> <span class="o">]</span>
<span class="k">then
</span><span class="nb">echo</span> <span class="s2">"-------------------------------"</span>
<span class="nb">ls</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span>
<span class="nb">echo</span> <span class="s2">"build input from "</span><span class="nv">$INPUTFILE</span>
<span class="nb">cat</span> <span class="nv">$INPUTFILE</span>
<span class="nb">echo</span> <span class="s2">"-------------------------------"</span>
<span class="c">#检查结构,失败直接退出</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> <span class="k">$((</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-1</span> <span class="nv">$INPUTFILE</span><span class="si">)</span><span class="o">+</span><span class="m">2</span><span class="k">))</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi</span>
<span class="c">#生成输入文件</span>
<span class="nb">cp </span>input.inp <span class="nv">$OUTPUTFILE</span>
<span class="nv">startline</span><span class="o">=</span>3
<span class="nv">x</span><span class="o">=</span>0<span class="p">;</span><span class="nv">y</span><span class="o">=</span>0<span class="p">;</span><span class="nv">z</span><span class="o">=</span>0
<span class="c">#x=$(tail -n +$startline $INPUTFILE | awk 'BEGIN {max = -9999; min=9999} {if ($2+0 &gt; max) max=$2; if ($2+0 &lt; min) min=$2 } END {printf "%.10f" , 0.5*(max+min) }')</span>
<span class="c">#y=$(tail -n +$startline $INPUTFILE | awk 'BEGIN {max = -9999; min=9999} {if ($3+0 &gt; max) max=$3; if ($3+0 &lt; min) min=$3 } END {printf "%.10f" , 0.5*(max+min) }')</span>
<span class="c">#z=$(tail -n +$startline $INPUTFILE | awk 'BEGIN {max = -9999; min=9999} {if ($4+0 &gt; max) max=$4; if ($4+0 &lt; min) min=$4 } END {printf "%.10f" , 0.5*(max+min) }')</span>
<span class="nb">echo</span> <span class="s2">"%Coordinates"</span> <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUTFILE</span>
<span class="nb">tail</span> <span class="nt">-n</span> +<span class="nv">$startline</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{printf "'</span><span class="se">\'</span><span class="s1">'%s'</span><span class="se">\'</span><span class="s1">' | angstrom* %15.10f | angstrom* %15.10f | angstrom* %15.10f \n",$1,$2-'</span><span class="nv">$x</span><span class="s1">',$3-'</span><span class="nv">$y</span><span class="s1">',$4-'</span><span class="nv">$z</span><span class="s1">'}'</span>  <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUTFILE</span>
<span class="c">#tail -n +$startline $INPUTFILE | awk '{printf "'\''%s'\'' |  %15.10f |  %15.10f |  %15.10f \n",$1,$2-'$x',$3-'$y',$4-'$z'}'  &gt;&gt; $OUTPUTFILE</span>
<span class="nb">echo</span> <span class="s2">"%"</span> <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUTFILE</span>
<span class="k">else
</span><span class="nb">echo</span> <span class="s2">"Can't find "</span><span class="nv">$INPUTFILE</span> <span class="s2">"breakdown"</span>
<span class="nb">exit
</span><span class="k">fi</span>
<span class="o">}</span>

<span class="nb">rm</span> <span class="nt">-rf</span> stop1
xyz2oct
mpirun octopus | <span class="nb">tee </span>result

<span class="nb">cp </span>work-geom.xyz work-geom.bak.xyz
<span class="nb">cp </span>result result.bak
<span class="nb">echo </span>geom.log <span class="o">&gt;</span> geom.log 
<span class="c">#cg算法找不到极小值会报错不输出min.xyz</span>
<span class="c">#fire虽然会输出min.xyz但是可能达到了最大步数,这时换成cg算法看可不可以</span>
<span class="k">while</span>  <span class="o">((</span><span class="si">$(</span><span class="nb">grep</span> <span class="s1">'min.xyz'</span> result | <span class="nb">wc</span> <span class="nt">-l</span> <span class="si">)</span> &lt; 1<span class="o">))</span> <span class="o">||</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> fire <span class="o">]</span> <span class="p">;</span>
<span class="k">do
</span><span class="nb">echo </span>CNQ <span class="si">$(</span><span class="nb">date</span><span class="si">)</span> <span class="o">&gt;&gt;</span> result
<span class="nb">echo</span> <span class="s2">"---------------"</span> <span class="o">&gt;&gt;</span> geom.log
<span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">ls </span>geom<span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$i</span> <span class="o">&gt;&gt;</span> geom.log<span class="p">;</span> <span class="nb">cat </span>geom/<span class="nv">$i</span> <span class="o">&gt;&gt;</span> geom.log <span class="p">;</span> <span class="k">done</span>

<span class="c">#收集上一次计算用的算法</span>
<span class="nv">GOMethod</span><span class="o">=</span>fire
<span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> fire <span class="o">]</span><span class="p">;</span>     <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>cg_bfgs <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> steep <span class="o">]</span><span class="p">;</span>    <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>fire <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_bfgs <span class="o">]</span><span class="p">;</span>  <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>fire <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_bfgs2 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>fire <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_pr <span class="o">]</span><span class="p">;</span>    <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>fire <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_fr <span class="o">]</span><span class="p">;</span>    <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>fire <span class="p">;</span> <span class="k">fi

</span>xyz2oct
<span class="c">#&gt;[可选]准备更换演化算法</span>
<span class="nb">echo</span> <span class="s2">"Change GOMethod = </span><span class="nv">$GOMethod</span><span class="s2">"</span><span class="p">;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/GOMethod/GOMethod = </span><span class="nv">$GOMethod</span><span class="s2"> #/g"</span> inp
mpirun  octopus <span class="o">&gt;</span> result <span class="c">#报错和其他日志信息在slurm的输出</span>
<span class="c">#可以通过修改参数,然后touch stop换算法、参数续算</span>
<span class="nb">cat </span>work-geom.xyz <span class="o">&gt;&gt;</span> work-geom.bak.xyz
<span class="nb">cat </span>result <span class="o">&gt;&gt;</span> result.bak

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> stop1 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">exit</span><span class="p">;</span><span class="k">fi
done

</span><span class="nb">echo</span> <span class="s2">"Relax done"</span>
</code></pre></div></div>

<p>如果最后还没有优化出来,则把<code class="language-plaintext highlighter-rouge">geom.log</code>中最后一步的结构保存到<code class="language-plaintext highlighter-rouge">geom/go.0001.xyz</code>再输入继续跑,<code class="language-plaintext highlighter-rouge">spacing</code>等其他计算参数也决定了能收敛的最高精度
利用这种方式,优化的CH4键长和vasp误差0.001ang,还可以</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#算之前清空result,文件存在与否决定是否是完成了第一次计算</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> result <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">mv </span>result result.bak<span class="p">;</span><span class="k">fi
</span><span class="nb">rm</span> <span class="nt">-rf</span> stop1 stop

<span class="k">function </span>xyz2oct<span class="o">()</span>
<span class="o">{</span>
<span class="nv">OUTPUTFILE</span><span class="o">=</span>inp

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> result <span class="o">]</span> <span class="c">#存在result文件,说明算过了,开始续算</span>
<span class="k">then</span>
  <span class="c">#有时候cg算法失败了,找不到最优解,也输出不了xyz,此时换其他cg然后不改变输入文件中的结构参数</span>
  <span class="c">#下面都采用return.终止则替换为exit</span>
  <span class="c">#</span>
  <span class="nv">INPUTFILE</span><span class="o">=</span>geom/go.0001.xyz
  <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$INPUTFILE</span>  <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="s2">"Error: No xyz in geom"</span><span class="p">;</span><span class="k">return</span><span class="p">;</span><span class="k">fi
  if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="k">return</span><span class="p">;</span><span class="k">fi
  if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> <span class="k">$((</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-1</span> <span class="nv">$INPUTFILE</span><span class="si">)</span><span class="o">+</span><span class="m">2</span><span class="k">))</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="k">return</span><span class="p">;</span><span class="k">fi</span>
  <span class="c">#</span>
  <span class="c">#选择最新正常的xyz文件</span>
  <span class="nv">INPUTFILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls </span>geom/go<span class="k">*</span>.xyz | <span class="nb">sort</span> | <span class="nb">tail</span> <span class="nt">-1</span><span class="si">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nv">INPUTFILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls </span>geom/go<span class="k">*</span>.xyz | <span class="nb">sort</span> | <span class="nb">tail</span> <span class="nt">-2</span> | <span class="nb">head</span> <span class="nt">-1</span><span class="si">)</span><span class="p">;</span><span class="k">fi
  if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nv">INPUTFILE</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls </span>geom/go<span class="k">*</span>.xyz | <span class="nb">sort</span> | <span class="nb">tail</span> <span class="nt">-2</span> | <span class="nb">head</span> <span class="nt">-1</span><span class="si">)</span><span class="p">;</span><span class="k">fi
else</span> <span class="c">#第一次开始计算,使用structure作为结构</span>
  <span class="nv">INPUTFILE</span><span class="o">=</span>structure.xyz
<span class="k">fi</span>
<span class="c">#最后确定xyz文件是否正常</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span>  <span class="nv">$INPUTFILE</span> <span class="o">]</span>
<span class="k">then
</span><span class="nb">echo</span> <span class="s2">"-------------------------------"</span>
<span class="nb">ls</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span>
<span class="nb">echo</span> <span class="s2">"build input from "</span><span class="nv">$INPUTFILE</span>
<span class="nb">cat</span> <span class="nv">$INPUTFILE</span>
<span class="nb">echo</span> <span class="s2">"-------------------------------"</span>
<span class="c">#检查结构,失败直接退出</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{ print $1 }'</span><span class="si">)</span> <span class="nt">-lt</span> <span class="k">$((</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-1</span> <span class="nv">$INPUTFILE</span><span class="si">)</span><span class="o">+</span><span class="m">2</span><span class="k">))</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then </span><span class="nb">echo</span> <span class="nv">$INPUTFILE</span> error<span class="p">;</span><span class="nb">exit</span><span class="p">;</span><span class="k">fi</span>
<span class="c">#生成输入文件</span>
<span class="nb">cp </span>input.inp <span class="nv">$OUTPUTFILE</span>
<span class="nv">startline</span><span class="o">=</span>3
<span class="nv">x</span><span class="o">=</span>0<span class="p">;</span><span class="nv">y</span><span class="o">=</span>0<span class="p">;</span><span class="nv">z</span><span class="o">=</span>0
<span class="c">#x=$(tail -n +$startline $INPUTFILE | awk 'BEGIN {max = -9999; min=9999} {if ($2+0 &gt; max) max=$2; if ($2+0 &lt; min) min=$2 } END {printf "%.10f" , 0.5*(max+min) }')</span>
<span class="c">#y=$(tail -n +$startline $INPUTFILE | awk 'BEGIN {max = -9999; min=9999} {if ($3+0 &gt; max) max=$3; if ($3+0 &lt; min) min=$3 } END {printf "%.10f" , 0.5*(max+min) }')</span>
<span class="c">#z=$(tail -n +$startline $INPUTFILE | awk 'BEGIN {max = -9999; min=9999} {if ($4+0 &gt; max) max=$4; if ($4+0 &lt; min) min=$4 } END {printf "%.10f" , 0.5*(max+min) }')</span>
<span class="nb">echo</span> <span class="s2">"%Coordinates"</span> <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUTFILE</span>
<span class="nb">tail</span> <span class="nt">-n</span> +<span class="nv">$startline</span> <span class="nv">$INPUTFILE</span> | <span class="nb">awk</span> <span class="s1">'{printf "'</span><span class="se">\'</span><span class="s1">'%s'</span><span class="se">\'</span><span class="s1">' | angstrom* %15.10f | angstrom* %15.10f | angstrom* %15.10f \n",$1,$2-'</span><span class="nv">$x</span><span class="s1">',$3-'</span><span class="nv">$y</span><span class="s1">',$4-'</span><span class="nv">$z</span><span class="s1">'}'</span>  <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUTFILE</span>
<span class="c">#tail -n +$startline $INPUTFILE | awk '{printf "'\''%s'\'' |  %15.10f |  %15.10f |  %15.10f \n",$1,$2-'$x',$3-'$y',$4-'$z'}'  &gt;&gt; $OUTPUTFILE</span>
<span class="nb">echo</span> <span class="s2">"%"</span> <span class="o">&gt;&gt;</span> <span class="nv">$OUTPUTFILE</span>
<span class="k">else
</span><span class="nb">echo</span> <span class="s2">"Can't find "</span><span class="nv">$INPUTFILE</span> <span class="s2">"breakdown"</span>
<span class="nb">exit
</span><span class="k">fi</span>
<span class="o">}</span>

xyz2oct
mpirun octopus | <span class="nb">tee </span>result

<span class="nb">cp </span>work-geom.xyz work-geom.bak.xyz
<span class="nb">cp </span>result result.bak
<span class="nb">echo </span>geom.log <span class="o">&gt;</span> geom.log 
<span class="c">#cg算法找不到极小值会报错不输出min.xyz</span>
<span class="c">#fire虽然会输出min.xyz但是可能达到了最大步数,这时换成cg算法看可不可以</span>
<span class="k">while</span>  <span class="o">((</span><span class="si">$(</span><span class="nb">grep</span> <span class="s1">'min.xyz'</span> result | <span class="nb">wc</span> <span class="nt">-l</span> <span class="si">)</span> &lt; 1<span class="o">))</span> <span class="o">||</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> fire <span class="o">]</span> <span class="p">;</span>
<span class="k">do
</span><span class="nb">echo </span>CNQ <span class="si">$(</span><span class="nb">date</span><span class="si">)</span> <span class="o">&gt;&gt;</span> result
<span class="nb">echo</span> <span class="s2">"---------------"</span> <span class="o">&gt;&gt;</span> geom.log
<span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">ls </span>geom<span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$i</span> <span class="o">&gt;&gt;</span> geom.log<span class="p">;</span> <span class="nb">cat </span>geom/<span class="nv">$i</span> <span class="o">&gt;&gt;</span> geom.log <span class="p">;</span> <span class="k">done</span>

<span class="c">#收集上一次计算用的算法</span>
<span class="nv">GOMethod</span><span class="o">=</span>steep
<span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> fire <span class="o">]</span><span class="p">;</span>     <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>steep <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> steep <span class="o">]</span><span class="p">;</span>    <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>cg_fr <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_fr <span class="o">]</span><span class="p">;</span>  <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>cg_bfgs <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_bfgs <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>cg_bfgs2 <span class="p">;</span> <span class="k">fi
if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_bfgs2 <span class="o">]</span><span class="p">;</span>    <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>cg_pr <span class="p">;</span> <span class="k">fi</span>
<span class="c">#注释此行则全用类cg算法</span>
<span class="c">#if [ $(grep 'GOMethod' inp | awk '{ print $3 }') == cg_fr ];    then GOMethod=fire ; fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">$(</span><span class="nb">grep</span> <span class="s1">'GOMethod'</span> inp | <span class="nb">awk</span> <span class="s1">'{ print $3 }'</span><span class="si">)</span> <span class="o">==</span> cg_fr <span class="o">]</span><span class="p">;</span>    <span class="k">then </span><span class="nv">GOMethod</span><span class="o">=</span>steep <span class="p">;</span> <span class="k">fi

</span>xyz2oct
<span class="c">#&gt;[可选]准备更换演化算法</span>
<span class="nb">echo</span> <span class="s2">"Change GOMethod = </span><span class="nv">$GOMethod</span><span class="s2">"</span><span class="p">;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/GOMethod/GOMethod = </span><span class="nv">$GOMethod</span><span class="s2"> #/g"</span> inp
mpirun  octopus <span class="o">&gt;</span> result <span class="c">#报错和其他日志信息在slurm的输出</span>
<span class="c">#可以通过修改参数,然后touch stop换算法、参数续算</span>
<span class="nb">cat </span>work-geom.xyz <span class="o">&gt;&gt;</span> work-geom.bak.xyz
<span class="nb">cat </span>result <span class="o">&gt;&gt;</span> result.bak
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> stop1 <span class="o">]</span><span class="p">;</span> <span class="k">then </span><span class="nb">exit</span><span class="p">;</span><span class="k">fi
done

</span><span class="nb">echo</span> <span class="s2">"Relax done"</span>
</code></pre></div></div>

<h2 id="性质计算">性质计算</h2>
<h3 id="输入">输入</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#基态计算
CalculationMode = gs
#单位
UnitsOutput = ev_angstrom
#以原点的球
BoxShape = sphere
#dr
spacing = 0.19*angstrom
#球的半径,注意直径是2倍
radius = 10*angstrom
#计算的空态,在需要td投影时可以增加空态
ExtraStates=20
#输出信息
Output =dos+ density
#输出格式
OutputFormat = xcrysden
%Coordinates
'H' | angstrom*    0.0000000000 | angstrom*    0.0000000000 | angstrom*    0.0000000000
%
</code></pre></div></div>

<h3 id="output参数">Output参数</h3>
<p>可以不断向<code class="language-plaintext highlighter-rouge">Output</code>上增加值控制输出</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#输出信息
Output =  density
Output = Output + dos
</code></pre></div></div>

<h4 id="密度">密度</h4>
<p>输出<code class="language-plaintext highlighter-rouge">density.xsf</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Output = density
OutputFormat = xcrysden
</code></pre></div></div>

<h4 id="dos--pdos">dos &amp; pdos</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Output = Output + dos
DOSComputePDOS=yes
</code></pre></div></div>
<p>会输出dos,每一个能级的dos,pdos,多k点时,输出的是每条能带的dos(共nst个)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/octopus/H$ ls static/
convergence   dos-0003.dat  dos-0007.dat  dos-0011.dat  dos-0015.dat  dos-0019.dat  info
density.xsf   dos-0004.dat  dos-0008.dat  dos-0012.dat  dos-0016.dat  dos-0020.dat  pdos-at001-H1s.dat
dos-0001.dat  dos-0005.dat  dos-0009.dat  dos-0013.dat  dos-0017.dat  dos-0021.dat  total-dos.dat
dos-0002.dat  dos-0006.dat  dos-0010.dat  dos-0014.dat  dos-0018.dat  forces        total-dos-efermi.dat
</code></pre></div></div>

<p>画dos
<img src="/uploads/2021/10/octopus.dos.png" alt="" /></p>

<h4 id="波函数">波函数</h4>

<ul>
  <li>wfs_fourier: (Experimental) Outputs wavefunctions in Fourier space. This is only implemented for the ETSF file format output. The file will be called wfs-pw-etsf.nc.</li>
  <li>wfs: Outputs wavefunctions. Which wavefunctions are to be printed is specified by the variable OutputWfsNumber – see below. The output file is called wf-, or lr_wf- in linear response.</li>
  <li>wfs_sqmod: Outputs modulus squared of the wavefunctions. The output file is called sqm-wf-. For linear response, the filename is sqm_lr_wf-.</li>
</ul>

<p>示例</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Output = Output + wfs #带符号
Output = Output + wfs_sqmod
OutputWfsNumber="1-5" #默认全部
OutputFormat = xcrysden
OutputInterval=5 #输出间隔，含时不要都输出，非常占内存
</code></pre></div></div>
<p>输出</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/octopus/H2O$ ls static/
convergence      sqm-wf-k001-st0001.xsf  sqm-wf-k002-st0001.xsf  wf-k001-st0001.xsf  wf-k002-st0001.xsf
density-sp1.xsf  sqm-wf-k001-st0002.xsf  sqm-wf-k002-st0002.xsf  wf-k001-st0002.xsf  wf-k002-st0002.xsf
density-sp2.xsf  sqm-wf-k001-st0003.xsf  sqm-wf-k002-st0003.xsf  wf-k001-st0003.xsf  wf-k002-st0003.xsf
forces           sqm-wf-k001-st0004.xsf  sqm-wf-k002-st0004.xsf  wf-k001-st0004.xsf  wf-k002-st0004.xsf
info             sqm-wf-k001-st0005.xsf  sqm-wf-k002-st0005.xsf  wf-k001-st0005.xsf  wf-k002-st0005.xsf
</code></pre></div></div>
<p>如果是没有自旋分辨的单k点</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/octopus/H2O$ !ls
ls static/
convergence  info               sqm-wf-st0003.xsf  wf-st0001.xsf  wf-st0004.xsf
density.xsf  sqm-wf-st0001.xsf  sqm-wf-st0004.xsf  wf-st0002.xsf  wf-st0005.xsf
forces       sqm-wf-st0002.xsf  sqm-wf-st0005.xsf  wf-st0003.xsf
</code></pre></div></div>
<p>在含时的情况，会输出各个波函数随时间的变化</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/octopus/H2O$ ls output_iter/td.0000025
density.xsf         wf-st0002.real.xsf  wf-st0004.real.xsf  wf-st0006.real.xsf  wf-st0008.real.xsf
wf-st0001.imag.xsf  wf-st0003.imag.xsf  wf-st0005.imag.xsf  wf-st0007.imag.xsf  wf-st0009.imag.xsf
wf-st0001.real.xsf  wf-st0003.real.xsf  wf-st0005.real.xsf  wf-st0007.real.xsf  wf-st0009.real.xsf
wf-st0002.imag.xsf  wf-st0004.imag.xsf  wf-st0006.imag.xsf  wf-st0008.imag.xsf
</code></pre></div></div>

<p><img src="/uploads/2021/11/h2owfc.png" alt="" /></p>

<h3 id="输出文件">输出文件</h3>
<p><code class="language-plaintext highlighter-rouge">restart/gs/states</code>总轨道数<code class="language-plaintext highlighter-rouge">nst</code>,k点数<code class="language-plaintext highlighter-rouge">nik</code>(spin=2时k点加倍),波函数分量<code class="language-plaintext highlighter-rouge">dim</code>(spin=4时,二分量波函数<code class="language-plaintext highlighter-rouge">dim=2</code>)
对于3个电子的体系,空轨道是20,则</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SpinComponents=spin_polarized</code>:每个自旋<code class="language-plaintext highlighter-rouge">nst=占据(1.5)+未占据(20)=22</code>,两种自选态在两套k点上计算,<code class="language-plaintext highlighter-rouge">nik=2</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/octopus/H$ cat restart/gs/states
nst=                        22
dim=                         1
nik=                         2
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">SpinComponents=spinors</code>:每种自旋态只占据一个电子,<code class="language-plaintext highlighter-rouge">nst=占据(3)+未占据(20)=23</code>,一套k点上计算,<code class="language-plaintext highlighter-rouge">nik=1</code>,波函数二分量<code class="language-plaintext highlighter-rouge">dim=2</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/octopus/H$ cat restart/gs/states
nst=                        23
dim=                         2
nik=                         1
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="static">static</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">static/convergence</code> scf的收敛信息</li>
  <li><code class="language-plaintext highlighter-rouge">static/info</code> 网格,本征值,能量,Dipole,收敛性,受力等诸多信息</li>
</ul>

<h3 id="tdoutput">TDOutput</h3>
<p><strong>TDOutput默认情况是输出<code class="language-plaintext highlighter-rouge">coordinates  energy  laser  multipoles temperature</code>文件在<code class="language-plaintext highlighter-rouge">td.general</code>目录的,如果设置了具体输出<code class="language-plaintext highlighter-rouge">TDOutput =td_occup</code>内容,那么其他文件不会输出了,我们要手动添加输出</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TDOutput=multipoles+laser+energy #+td_occup
</code></pre></div></div>

<blockquote>
  <ul>
    <li>multipoles: Outputs the (electric) multipole moments of the density to the file td.general/multipoles. This is required to, e.g., calculate optical absorption spectra of finite systems. The maximum value of l can be set with the variable TDMultipoleLmax.</li>
    <li>angular: Outputs the orbital angular momentum of the system to td.general/angular, which can be used to calculate circular dichroism.</li>
    <li>gauge_field: If set, outputs the vector gauge field corresponding to a spatially uniform (but time-dependent) external electrical potential. This is only useful in a time-dependent periodic run. On by default if GaugeVectorField is set.</li>
    <li>temperature: If set, the ionic temperature at each step is printed. On by default if MoveIons = yes.</li>
    <li>ftchd: Write Fourier transform of the electron density to the file ftchd.X, where X depends on the kick (e.g. with sin-shaped perturbation X=sin). This is needed for calculating the dynamic structure factor. In the case that the kick mode is qbessel, the written quantity is integral over density, multiplied by spherical Bessel function times real spherical harmonic. On by default if TDMomentumTransfer is set.</li>
    <li>dipole_velocity: When set, outputs the dipole velocity, calculated from the Ehrenfest theorem, in the file td.general/velocity. This file can then be processed by the utility oct-harmonic-spectrum in order to obtain the harmonic spectrum.</li>
    <li>eigenvalues: Write the KS eigenvalues.</li>
    <li>ionization_channels: Write the multiple-ionization channels using the KS orbital densities as proposed in C. Ullrich, Journal of Molecular Structure: THEOCHEM 501, 315 (2000).</li>
    <li>total_current: Output the total current (average of the current density over the cell).</li>
    <li>partial_charges: Bader and Hirshfeld partial charges. The output file is called ‘td.general/partial_charges’.</li>
    <li>td_kpoint_occup: Project propagated Kohn-Sham states to the states at t=0 given in the directory restart_proj (see %RestartOptions). This is an alternative to the option td_occup, with a formating more suitable for k-points and works only in k- and/or state parallelization</li>
    <li>td_floquet: Compute non-interacting Floquet bandstructure according to further options: TDFloquetFrequency, TDFloquetSample, TDFloquetDimension. This is done only once per td-run at t=0. works only in k- and/or state parallelization</li>
    <li>spin: (Experimental) Outputs the expectation value of the spin, which can be used to calculate magnetic circular dichroism.</li>
    <li>n_excited_el: Output the number of excited electrons, based on the projections of the time evolved wave-functions on the ground-state wave-functions. The output interval of this quantity is controled by the variable TDOutputComputeInterval</li>
    <li>coordinates_sep: Writes geometries in a separate file.</li>
    <li>velocities_sep: Writes velocities in a separate file.</li>
    <li>forces_sep: Writes forces in a separate file.</li>
    <li>total_heat_current: Output the total heat current (average of the heat current density over the cell).</li>
    <li>total_magnetization: Writes the total magnetization, where the total magnetization is calculated at the momentum defined by TDMomentumTransfer. This is used to extract the magnon frequency in case of a magnon kick.</li>
    <li>populations: (?好像是多体波函数激发态的投影)(Experimental) Outputs the projection of the time-dependent Kohn-Sham Slater determinant onto the ground state (or approximations to the excited states) to the file td.general/populations. Note that the calculation of populations is expensive in memory and computer time, so it should only be used if it is really needed. See TDExcitedStatesToProject.</li>
    <li>geometry: If set (and if the atoms are allowed to move), outputs the coordinates, velocities, and forces of the atoms to the the file td.general/coordinates. On by default if MoveIons = yes.</li>
    <li>dipole_acceleration: When set, outputs the acceleration of the electronic dipole, calculated from the Ehrenfest theorem, in the file td.general/acceleration. This file can then be processed by the utility oct-harmonic-spectrum in order to obtain the harmonic spectrum.</li>
    <li>laser: If set, outputs the laser field to the file td.general/laser. On by default if TDExternalFields is set.</li>
    <li>energy: If set, octopus outputs the different components of the energy to the file td.general/energy. Will be zero except for every TDEnergyUpdateIter iterations.</li>
    <li>td_occup: (向0时刻的ks投影)(Experimental) If set, outputs the projections of the time-dependent Kohn-Sham wavefunctions onto the static (zero-time) wavefunctions to the file td.general/projections.XXX. Only use this option if you really need it, as it might be computationally expensive. See TDProjStateStart. The output interval of this quantity is controled by the variable TDOutputComputeInterval In case of states parallelization, all the ground-state states are stored by each task.<strong>还需要设置<code class="language-plaintext highlighter-rouge">ExperimentalFeatures=yes</code>,间隔由<code class="language-plaintext highlighter-rouge">TDOutputComputeInterval=50</code>决定</strong></li>
    <li>local_mag_moments: If set, outputs the local magnetic moments, integrated in sphere centered around each atom. The radius of the sphere can be set with LocalMagneticMomentsSphereRadius.</li>
  </ul>
</blockquote>

<h2 id="搭建说明网页">搭建说明网页</h2>
<p>安装apache&amp;php,复制doc目录到网站目录后,主机hosts为<code class="language-plaintext highlighter-rouge">cndaqiang</code>时浏览器打开<a href="http://cndaqiang/octopus/doc/html/vars.php?page">http://cndaqiang/octopus/doc/html/vars.php?page</a><br />
<strong>注意chrome和edge必须有<code class="language-plaintext highlighter-rouge">?page</code>,不然打开的是空白网页,safari不加也可以打开,原因暂时不明</strong></p>

<p>或者直接打开相应的html文件,就是丑了点
<img src="/uploads/2021/10/octopusdoc.png" alt="" /></p>

<h2 id="示例">示例</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CalculationMode = gs #计算方式 gs:基态(默认) td:时间依赖 unocc:非自洽计算  
UnitsOutput =  eV_Angstrom  #默认atomic原子单位制(能量是Hartree)

Nitrogen_mass=14.0 #可以在inp文件中定义变量，支持+-*/sqrt()等多种数学运算
	#更多数学运算https://octopus-code.org/wiki/Manual:Input_file#Mathematical_expressions


%Species  #元素描述block
 'N' | species_pseudo | set | standard | lmax | 1 | lloc | 0 | mass | Nitrogen_mass
#原素名 | 性质1 | 值 | 性质2 | 值
#赝势 species_pseudo | set默认就是用系统的 | standard
#     species_pseudo | file | `赝势文件名，支持 .psf(SIESTA),.upf,.fhi,.cpi,.xml,.hgh`  
# 更多参考https://octopus-code.org/doc/8.4/html/vars.php?section=System&amp;name=Species
#lmax: The maximum angular-momentum channel that will be used for the pseudopotential.
#lloc: The angular-momentum channel of the pseudopotential to be considered local.
%


XYZCoordinates = 'N.xyz'
ExtraStates = 1

%Occupations
 2|1|1|1
%

BoxShape = sphere

Radius = 5.0*angstrom
#Spacing = 0.18*angstrom  #时空间网格大小

#参数也可以通过环境变量设置
#设置linux变量
#```
#export OCT_PARSE_ENV=1 #开启从环境读入功能
#export OCT_Spacing=0.18*angstrom  #以OCT_开头设置参数
#```

Output = wfs + density + elf + potential
#默认只产生info，显示能量，特征值，等，其他信息，设置输出
#wfs wavefunction ; elf : the electron localization function  ;potential : the Kohn-Sham potential
#dos : 态密度

OutputFormat = cube + xcrysden + dx + axis_x + plane_z
#输出文件格式，用于给不同的软件(vislt,gunplot , xcrysden,UCSF(density.dx))打开
#https://octopus-code.org/wiki/Tutorial:Visualization

#octopus目录中有很多小程序可以用

#支持 include 文件
</code></pre></div></div>

<h3 id="周期性示例">周期性示例</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CalculationMode = gs

PeriodicDimensions = 3
Spacing = 0.5 

%LatticeVectors
0.0 | 0.5 | 0.5
0.5 | 0.0 | 0.5
0.5 | 0.5 | 0.0
%

a=10.18
%LatticeParameters
 a | a | a
%

%ReducedCoordinates
 "Si" | 0.0 | 0.0 | 0.0 
 "Si" | 1/4 | 1/4 | 1/4 
%

nk=2

%KPointsGrid
  nk |  nk |  nk  #第一行：倒空间每个方向k点数量，na | nb | nc 总数na*nb*nc Monk-Pack网格
 0.5 | 0.5 | 0.5  #之后的为K点的移位
 0.5 | 0.0 | 0.0
 0.0 | 0.5 | 0.0
 0.0 | 0.0 | 0.5
%

KPointsUseSymmetries = yes

ExtraStates = 1
Output = dos
</code></pre></div></div>

<h3 id="td-计算示例">td 计算示例</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CalculationMode = td #gs
UnitsOutput = eV_Angstrom

Radius = 3.5*angstrom
Spacing = 0.18*angstrom

CH = 1.097*angstrom
%Coordinates
  "C" |           0 |          0 |           0
  "H" |  CH/sqrt(3) | CH/sqrt(3) |  CH/sqrt(3)
  "H" | -CH/sqrt(3) |-CH/sqrt(3) |  CH/sqrt(3)
  "H" |  CH/sqrt(3) |-CH/sqrt(3) | -CH/sqrt(3)
  "H" | -CH/sqrt(3) | CH/sqrt(3) | -CH/sqrt(3)
%

Tf = 1/eV
dt = 0.002/eV

TDPropagator = aetrs
TDMaxSteps = Tf/dt  #总步数
TDTimeStep = dt     #步长

FromScratch = yes
 
amplitude = 1*eV/angstrom
omega = 18.0*eV
tau0 = 0.5/eV
t0 = tau0

%TDExternalFields
  electric_field | 1 | 0 | 0 | omega | "envelope_cos"
#  电场/磁场/矢量势/标量势/ f(x,y,z) | nx | ny | nz 场的极化方向(nx,ny,nz) | omega | g(t) 字符型，定义在%TDFunctions中 |[ 相位phase(t) ]
# 外场 = f(x,y,z)*cos(w*t+phase(t))*g(t)
# f(x,y,z) : electric field, magnetic field, vector_potential
# g(t)与phase(t) 都是字符串，字符串内容随意，定义式在%TDFunctions中
#phase(t) 不设置时默认为0
%
 
%TDFunctions
  "envelope_cos" | tdf_cosinoidal | amplitude | tau0 | t0
# %TDExternalFields中g(t),phase(t) | 函数名:tdf_cw,tdf_gaussian,tdf_cosinoidal,...来自文件，自定义 | 相关参数
# https://octopus-code.org/doc/8.4/html/vars.php?section=Time-Dependent&amp;name=TDFunctions

%

TDOutput = laser + multipoles
#TD输出
#laser: If set, outputs the laser field to the file td.general/laser. On by default if TDExternalFields is set.
#multipoles: Outputs the (electric) multipole moments of the density to the file td.general/multipoles. This is required to, e.g., calculate optical absorption spectra of finite systems. The maximum value of l can be set with the variable TDMultipoleLmax.
</code></pre></div></div>
<p>td计算输文件<code class="language-plaintext highlighter-rouge">td.general</code>里面包含<code class="language-plaintext highlighter-rouge">TDOutput</code>设定的文件</p>

<h2 id="报错">报错</h2>
<h3 id="使用中文的tab键">使用中文的tab键</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input: [PseudopotentialSet = standard]
Reading Coordinates from Coordinates block

**************************** FATAL ERROR *****************************
*** Fatal Error (description follows)
*--------------------------------------------------------------------
* From node =    0
*--------------------------------------------------------------------
* Error in block Coordinates line # 1
**********************************************************************


</code></pre></div></div>

<h3 id="核数不合适">核数不合适</h3>
<ul>
  <li>并行原因: 改成2，4，5，10个核都没有问题，6个核就报错</li>
  <li><strong>核数不能超过总轨道数(occ+ExtraStates)</strong></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      Block       3 contains       1 states:       4 -       4
Info: Ground-state restart information will be read from 'restart/gs'.

           Info: Reading states: gs. 2021/03/23 at 22:18:22

ETA: .
Program received signal SIGFPE: Floating-point exception - erroneous arithmetic operation.

Backtrace for this error:

Program received signal SIGFPE: Floating-point exception - erroneous arithmetic operation.

Backtrace for this error:

Program received signal SIGFPE: Floating-point exception - erroneous arithmetic operation.
</code></pre></div></div>
<p>前面的并行信息也许可以参考</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>************************** Parallelization ***************************
Info: Octopus will run in *parallel*

      Number of processes           :      10
      Number of threads per process :       1

Info: Number of nodes in ParStates   group:     2 (       4)
Info: Number of nodes in ParDomains  group:     5 (  131995)
Info: Octopus will waste at least  0.00% of computer time.
**********************************************************************

************************** Parallelization ***************************
Info: Octopus will run in *parallel*

      Number of processes           :       4
      Number of threads per process :       1

Info: Number of nodes in ParStates   group:     4 (       4)
Info: Octopus will waste at least  0.00% of computer time.
**********************************************************************

************************** Parallelization ***************************
Info: Octopus will run in *parallel*

      Number of processes           :       5
      Number of threads per process :       1

Info: Number of nodes in ParDomains  group:     5 (  131995)
Info: Octopus will waste at least  0.00% of computer time.
**********************************************************************

************************** Parallelization ***************************
Info: Octopus will run in *parallel*

      Number of processes           :       6
      Number of threads per process :       1

Info: Number of nodes in ParStates   group:     3 (       4)
Info: Number of nodes in ParDomains  group:     2 (  131995)

** Warning:
**   Info: Octopus will waste at least 33.33% of computer time.
**   Usually a number of processors which is a multiple of small primes is best.

</code></pre></div></div>

<h3 id="radius太小">radius太小</h3>
<p>算PDOS时出现,需要比自洽更大的<code class="language-plaintext highlighter-rouge">radius</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**************************** FATAL ERROR *****************************
*** Fatal Error (description follows)
*--------------------------------------------------------------------
* From node =    0
*--------------------------------------------------------------------
* The radius of an orbital set is bigger than the radius of the simulatio box.
* Increase the value of Radius or decrease the value of OrbitalsThreshold_LDAU.
* The value of the radius is  5.90000 Bohr.
**********************************************************************
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*--------------------------------------------------------------------
* An orbital set has points outside of the simulatio box.
* Increase the value of Radius or decrease the value of OrbitalsThreshold_LDAU.
* The value of the radius is 11.00000 Bohr.
</code></pre></div></div>

<p>这里的<code class="language-plaintext highlighter-rouge">The value of the radius is  5.90000 Bohr.</code>的<code class="language-plaintext highlighter-rouge">radius</code>是轨道的半径,不是模拟体系的半径,
增加模拟尺寸,如模拟半径<code class="language-plaintext highlighter-rouge">radius = 3.2*angstrom</code>即可,下面可以证明设置<code class="language-plaintext highlighter-rouge">AO</code>开头的<code class="language-plaintext highlighter-rouge">Atomic Orbitals</code>参数无效.</p>

<p>报错程序<code class="language-plaintext highlighter-rouge">src/basis_set/atomic_orbital_inc.F90</code></p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">! ---------------------------------------------------------</span><span class="w">
</span><span class="c1">!&gt; This routine returns the atomic orbital basis -- provided</span><span class="w">
</span><span class="c1">!! by the pseudopotential structure in geo.</span><span class="w">
</span><span class="c1">! ---------------------------------------------------------</span><span class="w">
</span><span class="k">subroutine</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="n">get_atomic_orbital</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">geo</span><span class="p">,</span><span class="w"> </span><span class="n">mesh</span><span class="p">,</span><span class="w"> </span><span class="n">sm</span><span class="p">,</span><span class="w"> </span><span class="n">iatom</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">ll</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="n">orbind</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">d_dim</span><span class="p">)</span><span class="w">
</span><span class="c1">!...</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">sm</span><span class="o">%</span><span class="n">np</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">

    </span><span class="k">if</span><span class="p">(</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">box_shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MINIMUM</span><span class="w"> </span><span class="ow">.and.</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">rsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="n">message</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"The radius of an orbital set is bigger than the radius of the simulatio box."</span><span class="w">
      </span><span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Increase the value of Radius or decrease the value of OrbitalsThreshold_LDAU."</span><span class="w">
      </span><span class="k">write</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="s1">'(a,f8.5,a,i5,a)'</span><span class="p">)</span><span class="w"> </span><span class="s1">'The value of the radius is '</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="s1">' Bohr.'</span><span class="w">
      </span><span class="k">call</span><span class="w"> </span><span class="n">messages_fatal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">

    </span><span class="k">if</span><span class="p">(</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">box_shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SPHERE</span><span class="w"> </span><span class="ow">.or.</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">box_shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CYLINDER</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="p">(</span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">rsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"The radius of an orbital set is bigger than the radius of the simulatio box."</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Increase the value of Radius or decrease the value of OrbitalsThreshold_LDAU."</span><span class="w">
       </span><span class="k">write</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="s1">'(a,f8.5,a,i5,a)'</span><span class="p">)</span><span class="w"> </span><span class="s1">'The value of the radius is '</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="s1">' Bohr.'</span><span class="w">
       </span><span class="k">call</span><span class="w"> </span><span class="n">messages_fatal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
      </span><span class="k">if</span><span class="p">(</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">box_shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CYLINDER</span><span class="w"> </span><span class="ow">.and.</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">xsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"The radius of an orbital set is bigger than the length of the cylinder box."</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Increase the value of XLength or decrease the value of OrbitalsThreshold_LDAU."</span><span class="w">
       </span><span class="k">write</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="s1">'(a,f8.5,a,i5,a)'</span><span class="p">)</span><span class="w"> </span><span class="s1">'The value of the radius is '</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="s1">' Bohr.'</span><span class="w">
       </span><span class="k">call</span><span class="w"> </span><span class="n">messages_fatal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">

    </span><span class="k">if</span><span class="p">(</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">box_shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SPHERE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">geo</span><span class="o">%</span><span class="n">atom</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span><span class="o">%</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="nb">dim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">rsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"An orbital set has points outside of the simulatio box."</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Increase the value of Radius or decrease the value of OrbitalsThreshold_LDAU."</span><span class="w">
       </span><span class="k">write</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="s1">'(a,f8.5,a,i5,a)'</span><span class="p">)</span><span class="w"> </span><span class="s1">'The value of the radius is '</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="s1">' Bohr.'</span><span class="w">
       </span><span class="k">call</span><span class="w"> </span><span class="n">messages_fatal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">

    </span><span class="k">if</span><span class="p">(</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">box_shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CYLINDER</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
      </span><span class="k">if</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">geo</span><span class="o">%</span><span class="n">atom</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span><span class="o">%</span><span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="nb">dim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">rsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"An orbital set has points outside of the simulatio box."</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Increase the value of Radius or decrease the value of OrbitalsThreshold_LDAU."</span><span class="w">
       </span><span class="k">write</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="s1">'(a,f8.5,a,i5,a)'</span><span class="p">)</span><span class="w"> </span><span class="s1">'The value of the radius is '</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="s1">' Bohr.'</span><span class="w">
       </span><span class="k">call</span><span class="w"> </span><span class="n">messages_fatal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
      </span><span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">geo</span><span class="o">%</span><span class="n">atom</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span><span class="o">%</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">mesh</span><span class="o">%</span><span class="n">sb</span><span class="o">%</span><span class="n">xsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"An orbital set has points outside of the simulatio box."</span><span class="w">
       </span><span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Increase the value of Xlength or decrease the value of OrbitalsThreshold_LDAU."</span><span class="w">
       </span><span class="k">write</span><span class="p">(</span><span class="n">message</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="s1">'(a,f8.5,a,i5,a)'</span><span class="p">)</span><span class="w"> </span><span class="s1">'The value of the radius is '</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="s1">' Bohr.'</span><span class="w">
       </span><span class="k">call</span><span class="w"> </span><span class="n">messages_fatal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">
      </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
    </span><span class="k">end</span><span class="w"> </span><span class="k">if</span><span class="w">
</span></code></pre></div></div>
<p>溯源<code class="language-plaintext highlighter-rouge">./basis_set/orbitalset_utils_inc.F90</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  subroutine X(orbitalset_utils_getorbitals)(os, geo, mesh)
      ! We obtain the orbital
      call X(get_atomic_orbital)(geo, mesh, os%sphere, os%iatom, os%ii, os%ll, os%jj, &amp;
                                              os, iorb, os%radius, os%ndim)
</code></pre></div></div>
<p>溯源<code class="language-plaintext highlighter-rouge">./system/dos.F90</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              os%radius = atomic_orbital_get_radius(geo, mesh, ia, iorb, 1, &amp;
                                OPTION__AOTRUNCATION__AO_FULL, CNST(0.01))
</code></pre></div></div>
<p>最终决定半径的是<code class="language-plaintext highlighter-rouge">./basis_set/atomic_orbital.F90</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ! ---------------------------------------------------------
  FLOAT function atomic_orbital_get_radius(geo, mesh, ia, iorb, ispin, truncation, threshold) result(radius)
    type(geometry_t), target, intent(in)   :: geo
    type(mesh_t),             intent(in)   :: mesh
    integer,                  intent(in)   :: ia, iorb, ispin
    integer(8),               intent(in)   :: truncation
    FLOAT,                    intent(in)   :: threshold

    type(species_t), pointer :: spec
    integer :: ii, ll, mm

    PUSH_SUB(atomic_orbital_get_radius)

    spec =&gt; geo%atom(ia)%species
    call species_iwf_ilm(spec, iorb, ispin, ii, ll, mm)

    if(truncation == OPTION__AOTRUNCATION__AO_FULL) then
      radius = species_get_iwf_radius(spec, ii, ispin, threshold)
    else
      radius = species_get_iwf_radius(spec, ii, ispin)

      if(truncation == OPTION__AOTRUNCATION__AO_BOX) then
        ! if the orbital is larger than the size of the box, we restrict it to this size,
        ! otherwise the orbital will overlap more than one time with the simulation box.
        ! This would induces phase problem if the complete mesh is used instead of the sphere
        radius = min(radius, minval(mesh%sb%lsize(1:mesh%sb%dim)-mesh%spacing(1:mesh%sb%dim)*CNST(1.01)))
      else
        !If asked, we truncate the orbital to the radius on the projector spheres
        !of the NL part of the pseudopotential.
        !This is a way to garanty no overlap between orbitals of different atoms.
        if(species_is_ps(spec)) &amp;
          radius = min(radius,species_get_ps_radius(spec))
        end if

      end if
      ! make sure that if the spacing is too large, the orbitals fit in a few points at least
      radius = max(radius, CNST(2.0)*maxval(mesh%spacing(1:mesh%sb%dim)))

    POP_SUB(atomic_orbital_get_radius)
  end function atomic_orbital_get_radius
</code></pre></div></div>
<p>可以发现<code class="language-plaintext highlighter-rouge">./system/dos.F90</code>强行限制了<code class="language-plaintext highlighter-rouge">AOTruncation</code>为<code class="language-plaintext highlighter-rouge">ao_full</code>,按照手册</p>
<blockquote>
  <p>ao_full: The full size of the orbitals used. The radius is controled by variable AOThreshold.</p>
</blockquote>

<p><strong>然而我们发现<code class="language-plaintext highlighter-rouge">dos.F90</code>也设置了<code class="language-plaintext highlighter-rouge">threshold=CNST(0.01)</code>,所以无法通过参数调整,唯一的途径就只有调模拟尺寸的大小</strong></p>

<h3 id="缺少赝势">缺少赝势</h3>
<p>并行运行时，没有显示</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input: [PseudopotentialSet = standard]
Reading Coordinates from Coordinates block
Abort(269076484) on node 0 (rank 0 in comm 0): Fatal error in PMPI_Recv_init: Invalid tag, error stack:
PMPI_Recv_init(147): MPI_Recv_init(buf=0x7c0dd80, count=1, MPI_INTEGER, src=1, tag=1620299, MPI_COMM_WORLD, request=0x7c0dd40) failed
PMPI_Recv_init(99).: Invalid tag, value is 1620299
</code></pre></div></div>
<p>单核运行发现是缺少赝势</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
************************** Calculation Mode **************************
Input: [CalculationMode = gs]
**********************************************************************

Input: [PseudopotentialSet = standard]
Reading Coordinates from Coordinates block

**************************** FATAL ERROR *****************************
*** Fatal Error (description follows)
*--------------------------------------------------------------------
* From node =    0
*--------------------------------------------------------------------
* Species Ag not found in default pseudopotential set.
* ( /home/apps/octopus10.4/share/octopus/pseudopotentials/PSF )
**********************************************************************

Abort(999) on node 0 (rank 0 in comm 0): application called MPI_Abort(MPI_COMM_WORLD, 999) - process 0
</code></pre></div></div>

<p>添加赝势到<code class="language-plaintext highlighter-rouge">/home/apps/octopus10.4/share/octopus/pseudopotentials/PSF</code>就可以了</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            Calculation started on 2021/12/16 at 10:46:32


************************** Calculation Mode **************************
Input: [CalculationMode = gs]
**********************************************************************

Input: [PseudopotentialSet = standard]
Reading Coordinates from Coordinates block

****************************** Species *******************************
  Species 'Ag'
    type             : pseudopotential
    file             : '/home/apps/octopus10.4/share/octopus/pseudopotentials/PSF/Ag.psf'
    file format      : PSF
    valence charge   : 11.0
    atomic number    :  47
    form on file     : semilocal
    orbital origin   : calculated
    lmax             : 3
    llocal           : 0
    projectors per l : 1
</code></pre></div></div>

<hr />
<blockquote>
  <p>本文首发于<a href="https://cndaqiang.github.io/">我的博客@cndaqiang</a>.<br />
本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
</blockquote>

        </article>
        <hr>

        
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
        
        <!--- github follow and star -->
        <iframe src="/html_script/github-btn.html?user=cndaqiang&repo=cndaqiang.github.io&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        <iframe src="/html_script/github-btn.html?user=cndaqiang&type=follow&count=true&size=large" frameborder="0" scrolling="0" width="220px" height="30px"></iframe>
        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2019/04/06/Fortran-math/">Fortran 科学计算</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2019/04/11/gitbook/">[乱糟糟的博客结尾]本地gitbook写书</a></p>
        
    </div>
</div>

        
            





            <!--广告 _includes/adsenseAfterComments.html -->
            

        
        

        


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    目录
                </div>
                <ul id="content-side" class="content-ul">
                    
                     <!-- 关闭评论功能 <li><a href="#comments">评论</a></li> -->
                </ul>
            </div>
            <!-- 其他div框放到这里 ，添加br 使不粘连--><br>
            <!-- adsens -->
            <!--广告 _includes/adsense_side.html -->
            

            
            
                 
                <div class="side">
                   <div>
                       <i class="fa fa-database"></i>
                      访客数据
                   </div>
                   <script type="text/javascript" src="//rf.revolvermaps.com/0/0/7.js?i=537vyn60ia7&amp;m=0&amp;c=007eff&amp;cr1=ff0000&amp;sx=0" async="async"></script>
                </div>
                
            
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">
        


        <!-- 
        <p class="contact">
            
            联系方式: 
             <a href="https://github.com/cndaqiang" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>   
              
              
              
              
              
              
              
              
            .
        
        -->
         
        </p>
        <p>
            
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，访客<span id="busuanzi_value_site_uv"></span>人次，本文阅读量<span id="busuanzi_value_page_pv"></span>次.
            
        <!-- 
             <a href="https://us.umami.is/websites/27e72116-bcc0-4a4d-82a5-485b4105820e"> 实时访客数据</a>  
        -->
        </p>
        <!-- 
        <p class="power">
            <span>
                Site powered by <a href="https://cndaqiang.github.io/">cndaqiang</a>
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
        -->
        <p class="description">
            <!-- 
                 
            -->
            &copy; 2024 cndaqiang. Archived since 11/01/2014.
            </p>
    
    </div>
</footer>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 
    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
