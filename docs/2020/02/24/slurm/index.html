<!DOCTYPE html>
<html style="filter:grayscale(0%);">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Ubuntu 18.04/Mint 19 单机安装Slurm</title>
    <meta name="description" content="">

    <link rel="shortcut icon" href="/favicon.jpg?" type="image/x-icon">
    <link rel="icon" href="/favicon.jpg?" type="image/x-icon">
    <!---2020-01-17 change font-awesome-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <!--- 
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
    -->
    <link rel="stylesheet" href="/css/cndaqiang.css"> 
	<!---图标cdn icon，每次在iconfont中添加一个图标，这个链接就要更新--->
   <link rel="stylesheet" href="https://at.alicdn.com/t/font_461356_ofctiykkk5.css">
	 <link rel="stylesheet" href="/css/main.css ">
   <link rel="canonical" href="http://0.0.0.0:4000/2020/02/24/slurm/">
   <link rel="alternate" type="application/rss+xml" title="cndaqiang" href="http://0.0.0.0:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8ba332e6517ae0ba8a13339285d97bb3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>



<!-- 谷歌统计 --><!-- 跨网域跟踪 -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?UA-109057291-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-109057291-1');
</script>



<script defer src="https://cloud.umami.is/script.js" data-website-id="27e72116-bcc0-4a4d-82a5-485b4105820e"></script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: { inlineMath: [["$","$"],["\\(","\\)"]] },
    "HTML-CSS": {
      linebreaks: { automatic: true, width: "container" }
    }
});
</script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!---   谷歌cse站内搜索-->
<!--- <script async src="https://cse.google.com/cse.js?cx=011772597085732398296:uzswyrqhpft"></script>
--->





</head>


  <body>

    <!-- 备案不显示镜像-->


<header id="top">
    <div class="wrapper">
      
        <a href="/" class="brand">cndaqiang</a>
        <small>Web Linux DFT</small> 
        
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>专栏
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>工具
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>标签
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <!---文章页面--->

<div class="page clearfix" post>
    <div class="left">
        <h1>Ubuntu 18.04/Mint 19 单机安装Slurm</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2020-02-24
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>cndaqiang
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Linux" title="Category: Linux" rel="category">Linux</a>&nbsp;
    
        <a href="/category/#Slurm" title="Category: Slurm" rel="category">Slurm</a>&nbsp;
    
        <a href="/category/#Ubuntu" title="Category: Ubuntu" rel="category">Ubuntu</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#Slurm" title="Tag: Slurm" rel="tag">Slurm</a-->
        <a href="/tag/#Slurm" title="Tag: Slurm" rel="tag">Slurm</a>
    
  

</span>


            </div>
            <!--- 2020-01-17 RSS-->
            <div class="label-card">
                <a href="/feed.xml" title="RSS"><i class="fa fa-rss-square" aria-hidden="true"></i>RSS</a>
            </div>

            <div class="label-card">
                <a href="https://github.com/cndaqiang/cndaqiang.github.io" title="RSS"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i>Star</a>
            </div>
            
            <!--- github start , copy from https://github.com/mdo/github-buttons--->
            <!---
            <div>
                <iframe src="/html_script/github-btn.html?user=cndaqiang&repo=cndaqiang.github.io&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
            </div>
            --->

        </div>
        
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
  <li><a href="#安装" id="markdown-toc-安装">安装</a></li>
  <li><a href="#配置" id="markdown-toc-配置">配置</a></li>
  <li><a href="#启动" id="markdown-toc-启动">启动</a></li>
  <li><a href="#使用" id="markdown-toc-使用">使用</a>    <ul>
      <li><a href="#提交作业" id="markdown-toc-提交作业">提交作业</a></li>
      <li><a href="#用pbs的命令控制slurm" id="markdown-toc-用pbs的命令控制slurm">用pbs的命令控制slurm</a></li>
    </ul>
  </li>
  <li><a href="#更多设置" id="markdown-toc-更多设置">更多设置</a>    <ul>
      <li><a href="#允许单节点提交多个任务" id="markdown-toc-允许单节点提交多个任务">允许单节点提交多个任务</a></li>
      <li><a href="#单节点独占任务" id="markdown-toc-单节点独占任务">单节点独占任务</a></li>
    </ul>
  </li>
  <li><a href="#slurm其他用法" id="markdown-toc-slurm其他用法">slurm其他用法</a>    <ul>
      <li><a href="#交完作业后修改性质" id="markdown-toc-交完作业后修改性质">交完作业后修改性质</a></li>
      <li><a href="#查看作业信息" id="markdown-toc-查看作业信息">查看作业信息</a></li>
      <li><a href="#查看slurm环境变量" id="markdown-toc-查看slurm环境变量">查看slurm环境变量</a></li>
      <li><a href="#sacctmgr-show" id="markdown-toc-sacctmgr-show"><code class="language-plaintext highlighter-rouge">sacctmgr show</code></a></li>
      <li><a href="#不重启服务更新配置" id="markdown-toc-不重启服务更新配置">不重启服务更新配置</a></li>
      <li><a href="#交到指定节点" id="markdown-toc-交到指定节点">交到指定节点</a></li>
      <li><a href="#不交到问题节点" id="markdown-toc-不交到问题节点">不交到问题节点</a></li>
      <li><a href="#等指定作业结束后提交" id="markdown-toc-等指定作业结束后提交">等指定作业结束后提交</a></li>
      <li><a href="#提高任务优先级" id="markdown-toc-提高任务优先级">提高任务优先级</a></li>
      <li><a href="#hold任务" id="markdown-toc-hold任务">hold任务</a></li>
      <li><a href="#修改开始计算时间" id="markdown-toc-修改开始计算时间">修改开始计算时间</a></li>
      <li><a href="#保存作业脚本内容" id="markdown-toc-保存作业脚本内容">保存作业脚本内容</a></li>
    </ul>
  </li>
  <li><a href="#其他" id="markdown-toc-其他">其他</a>    <ul>
      <li><a href="#nodelistreason" id="markdown-toc-nodelistreason">NODELIST(REASON)</a></li>
    </ul>
  </li>
</ul>

<h2 id="参考">参考</h2>
<p><a href="https://www.linuxwave.info/2019/10/installing-slurm-workload-manager-job.html">Installing Slurm Workload Manager &amp; Job Scheduler on Ubuntu 18.04</a></p>

<p>Centos系统安装方法<a href="/2020/11/06/slurm-Centos7/">Centos7集群上搭建slurm作业管理系统</a></p>

<h2 id="安装">安装</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install slurm-wlm slurm-wlm-doc -y 
</code></pre></div></div>

<p>查看信息</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~$ slurmd -V
slurm-wlm 17.11.2
cndaqiang@girl:~$ slurmd -C
NodeName=girl CPUs=4 Boards=1 SocketsPerBoard=1 CoresPerSocket=2 ThreadsPerCore=2 RealMemory=15939
UpTime=0-08:01:18
</code></pre></div></div>

<h2 id="配置">配置</h2>

<p>修改配置文件</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /etc/slurm-llnl/slurm.conf 
vi /etc/slurm-llnl/slurm.conf 
</code></pre></div></div>
<p>根据
https://www.linuxwave.info/2019/10/installing-slurm-workload-manager-job.html</p>

<p>浏览器打开/usr/share/doc/slurm-wlm-doc/html/configurator.easy.html
添加各种配置和路径，生成配置文件，复制到<code class="language-plaintext highlighter-rouge">vi /etc/slurm-llnl/slurm.conf</code>
注意</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Some of the configuration that I changed from the default
- Make sure the hostname of the system is ControlMachine and NodeName
- State Preservation: set StateSaveLocation to /var/spool/slurm-llnl
- Process tracking: use Pgid instead of Cgroup
- Process ID logging: set this to /var/run/slurm-llnl/slurmctld.pid and /var/run/slurm-llnl/slurmd.pid
</code></pre></div></div>
<p>我的配置文件</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># slurm.conf file generated by configurator easy.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.
#
ControlMachine=girl
#ControlAddr=
#
#MailProg=/bin/mail
MpiDefault=none
#MpiParams=ports=#-#
ProctrackType=proctrack/pgid
ReturnToService=1
SlurmctldPidFile=/var/run/slurm-llnl/slurmctld.pid
#SlurmctldPort=6817
SlurmdPidFile=/var/run/slurm-llnl/slurmd.pid
#SlurmdPort=6818
SlurmdSpoolDir=/var/spool/slurmd
SlurmUser=slurm
#SlurmdUser=root
StateSaveLocation=/var/spool/slurm-llnl
SwitchType=switch/none
TaskPlugin=task/none
#
#
# TIMERS
#KillWait=30
#MinJobAge=300
#SlurmctldTimeout=120
#SlurmdTimeout=300
#
#
# SCHEDULING
FastSchedule=1
SchedulerType=sched/backfill
SelectType=select/linear
#SelectTypeParameters=
#
#
# LOGGING AND ACCOUNTING
AccountingStorageType=accounting_storage/none
ClusterName=cluster
#JobAcctGatherFrequency=30
JobAcctGatherType=jobacct_gather/none
#SlurmctldDebug=3
#SlurmctldLogFile=
#SlurmdDebug=3
#SlurmdLogFile=
#
#
# COMPUTE NODES
NodeName=girl CPUs=4 State=UNKNOWN
PartitionName=debug Nodes=girl Default=YES MaxTime=INFINITE State=UP
</code></pre></div></div>
<p>修改完<code class="language-plaintext highlighter-rouge">vi /etc/slurm-llnl/slurm.conf</code>配置文件后，与配置文件对应，创建相应的目录和权限设置</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -rf  /var/spool/slurm-llnl
mkdir /var/spool/slurm-llnl
chown -R slurm.slurm /var/spool/slurm-llnl
rm -rf /var/run/slurm-llnl/
mkdir /var/run/slurm-llnl/
chown -R slurm.slurm /var/run/slurm-llnl/
</code></pre></div></div>

<h2 id="启动">启动</h2>
<p>启动和设置开机自启
Start slurmd and enable on boot</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start slurmd
systemctl enable slurmd
systemctl start slurmctld
systemctl enable slurmctld
</code></pre></div></div>
<p>修改配置后的重启命令</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart  slurmctld
systemctl restart  slurmd
</code></pre></div></div>

<h2 id="使用">使用</h2>

<h3 id="提交作业">提交作业</h3>
<p>作业脚本</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
#
#SBATCH --job-name=manytdap
#SBATCH --output=tdap.out
#SBATCH -N 1
#SBATCH --ntasks-per-node=4
#SBATCH --time=00:30:00
#SBATCH -p debug



EXEC=/home/cndaqiang/work/siesta/siesta-4.1-b1/Obj/siesta

mpirun $EXEC input.fdf | tee result
#注
#默认mpirun使用核数由ntasks-per-node*N确定
#也可用 -np 指定
#mpirun -np 4  $EXEC -i input.in | tee result
</code></pre></div></div>

<p>提交作业，查看队列计算情况</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/work/slurm$ sbatch run-slurm.sh
Submitted batch job 21
cndaqiang@girl:~/work/slurm$ squeue
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
                21     debug manytdap cndaqian  R       0:01      1 girl
</code></pre></div></div>

<p><strong>提交到制定节点</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch -w hpcc148 run-wannier.sh
</code></pre></div></div>

<h3 id="用pbs的命令控制slurm">用pbs的命令控制slurm</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install slurm-wlm-torque
</code></pre></div></div>
<p>就可以使用qstat,qsub 等pbs的命令了</p>

<h2 id="更多设置">更多设置</h2>
<h3 id="允许单节点提交多个任务">允许单节点提交多个任务</h3>
<p>感谢<a href="https://github.com/orangeSi">myth</a>提供的方案.<br />
修改配置文件<code class="language-plaintext highlighter-rouge">vi /etc/slurm-llnl/slurm.conf</code>中的<code class="language-plaintext highlighter-rouge">SchedulerType</code>和<code class="language-plaintext highlighter-rouge">SelectType</code>为</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#SchedulerType=sched/backfill
#SelectType=select/linear
SelectType=select/cons_res
SelectTypeParameters=CR_CPU
</code></pre></div></div>
<p>重启slurm</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart  slurmctld
systemctl restart  slurmd
</code></pre></div></div>
<p><a href="https://slurm.schedmd.com/cons_res_share.html">Sharing Consumable Resources</a>
<img src="/uploads/2021/07/select.png" alt="" />
我的四核笔记本就可以交四个作业了</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@girl:~/work/slurm$ squeue
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
               125     debug manytdap cndaqian PD       0:00      1 (Resources)
               121     debug manytdap cndaqian  R       0:08      1 girl
               122     debug manytdap cndaqian  R       0:05      1 girl
               123     debug manytdap cndaqian  R       0:05      1 girl
               124     debug manytdap cndaqian  R       0:05      1 girl
</code></pre></div></div>
<h3 id="单节点独占任务">单节点独占任务</h3>
<p>当slurm是管理员配置, 普通用户希望独占节点,在作业脚本中添加</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#SBATCH --exclusive
</code></pre></div></div>

<h2 id="slurm其他用法">slurm其他用法</h2>
<h3 id="交完作业后修改性质">交完作业后修改性质</h3>
<p>参考<a href="http://bicmr.pku.edu.cn/~wenzw/pages/slurm.html">SLURM 使用参考</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol update jobid=JOBID ...
#如
account=&lt;account&gt;                      mintmpdisknode=&lt;megabytes&gt;             reqnodelist=&lt;nodes&gt;
conn-type=&lt;type&gt;                       name&gt;                                  reqsockets=&lt;count&gt;
contiguous=&lt;yes|no&gt;                    name=&lt;name&gt;                            reqthreads=&lt;count&gt;
dependency=&lt;dependency_list&gt;  依赖关系,格式见下         nice[=delta]                           requeue=&lt;0|1&gt;
eligibletime=yyyy-mm-dd                nodelist=&lt;nodes&gt;                       reservationname=&lt;name&gt;
excnodelist=&lt;nodes&gt;                    numcpus=&lt;min_count[-max_count]         rotate=&lt;yes|no&gt;
features=&lt;features&gt;                    numnodes=&lt;min_count[-max_count]&gt;       shared=&lt;yes|no&gt;
geometry=&lt;geo&gt;                         numtasks=&lt;count&gt;                       starttime=yyyy-mm-dd
gres=&lt;list&gt;                            or                                     switches=&lt;count&gt;[@&lt;max-time-to-wait&gt;]
licenses=&lt;name&gt;                        partition=&lt;name&gt;                       timelimit=[d-]h:m:s
mincpusnode=&lt;count&gt;                    priority=&lt;number&gt;                      userid=&lt;UID
minmemorycpu=&lt;megabytes&gt;               qos=&lt;name&gt;                             wckey=&lt;key&gt;
minmemorynode=&lt;megabytes&gt;              reqcores=&lt;count&gt;
</code></pre></div></div>
<p>修改示例</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#修改时间
scontrol update jobid=33932 timelimit=6:00:00
#修改队列  
scontrol update jobid=33932 partition=&lt;name&gt;          
#同时修改多个
scontrol update jobid=580,581 partition=long
#更多可修改的值，可通过scontrol show job ID 查看
</code></pre></div></div>

<p><strong>作业运行后普通用户不能修改时间限制,但是root可以,而且可以改大于队列限制</strong></p>

<h3 id="查看作业信息">查看作业信息</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol show job  67139
scontrol show job  671399 | grep WorkDir
   WorkDir=/public/home/cndaqiang/work/tdap/blocksize/origin/Si32/Si32-12
</code></pre></div></div>
<p>申请一个节点两个核的信息示例</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@girl:~/work/slurm$ scontrol show job 127
JobId=127 JobName=manytdap
   UserId=cndaqiang(1000) GroupId=cndaqiang(1000) MCS_label=N/A
   Priority=4294901749 Nice=0 Account=(null) QOS=(null)
   JobState=RUNNING Reason=None Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0
   RunTime=00:00:05 TimeLimit=00:30:00 TimeMin=N/A
   SubmitTime=2020-06-13T18:13:00 EligibleTime=2020-06-13T18:13:00
   StartTime=2020-06-13T18:13:01 EndTime=2020-06-13T18:43:01 Deadline=N/A
   PreemptTime=None SuspendTime=None SecsPreSuspend=0
   LastSchedEval=2020-06-13T18:13:01
   Partition=debug AllocNode:Sid=girl:30999
   ReqNodeList=(null) ExcNodeList=(null)
   NodeList=girl
   BatchHost=girl
   NumNodes=1 NumCPUs=2 NumTasks=2 CPUs/Task=1 ReqB:S:C:T=0:0:*:*
   TRES=cpu=2,node=1,billing=2
   Socks/Node=* NtasksPerN:B:S:C=2:0:*:* CoreSpec=*
   MinCPUsNode=2 MinMemoryNode=0 MinTmpDiskNode=0
   Features=(null) DelayBoot=00:00:00
   Gres=(null) Reservation=(null)
   OverSubscribe=OK Contiguous=0 Licenses=(null) Network=(null)
   Command=/home/cndaqiang/work/slurm/run-slurm.sh
   WorkDir=/home/cndaqiang/work/slurm
   StdErr=/home/cndaqiang/work/slurm/run-slurm.sh.e127
   StdIn=/dev/null
   StdOut=/home/cndaqiang/work/slurm/run-slurm.sh.o127
   Power=
</code></pre></div></div>

<h3 id="查看slurm环境变量">查看slurm环境变量</h3>
<p>提交作业后，会增加的环境变量，在脚本里面使用下面的命令找到相应环境变量</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>env | grep SLURM
SLURM_CHECKPOINT_IMAGE_DIR=/var/slurm/checkpoint
SLURM_NODELIST=comput[110,123,130]
SLURM_JOB_NAME=slurm
SLURMD_NODENAME=comput110
SLURM_TOPOLOGY_ADDR=comput110
SLURM_NTASKS_PER_NODE=36
SLURM_PRIO_PROCESS=0
SLURM_NODE_ALIASES=(null)
SLURM_JOB_QOS=normal
SLURM_TOPOLOGY_ADDR_PATTERN=node
SLURM_NNODES=3
SLURM_JOBID=850925
SLURM_NTASKS=108
SLURM_TASKS_PER_NODE=36(x3)
SLURM_WORKING_CLUSTER=cluster_admin1:10.10.10.249:6817:8448
SLURM_JOB_ID=850925
SLURM_JOB_USER=cndaqiang
SLURM_JOB_UID=1011
SLURM_NODEID=0
SLURM_SUBMIT_DIR=/public/home/cndaqiang/work/slurm
SLURM_TASK_PID=176862
SLURM_NPROCS=108
SLURM_HOME=/opt/gridview/slurm
SLURM_CPUS_ON_NODE=36
SLURM_PROCID=0
SLURM_JOB_NODELIST=comput[110,123,130]
SLURM_LOCALID=0
SLURM_JOB_GID=100
SLURM_JOB_CPUS_PER_NODE=36(x3)
SLURM_CLUSTER_NAME=cluster_admin1
SLURM_GTIDS=0
SLURM_SUBMIT_HOST=login2
SLURM_JOB_PARTITION=regular
SLURM_JOB_ACCOUNT=sf10
SLURM_JOB_NUM_NODES=3
SLURM_MEM_PER_NODE=181673
</code></pre></div></div>

<h3 id="sacctmgr-show"><code class="language-plaintext highlighter-rouge">sacctmgr show</code></h3>
<p>有些使用数据库的slurm还支持下面的命令</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) [cndaqiang@login3 ~]$ sacctmgr show 
No valid entity in list command
Input line must include "Account", "Association", "Cluster", "Configuration",
"Event", "Federation", "Problem", "QOS", "Resource", "Reservation",
"RunAwayJobs", "Stats", "Transaction", "TRES", "User", or "WCKey"
(python37) [cndaqiang@login3 ~]$ sacctmgr show Resource
      Name     Server     Type  Count % Allocated ServerType 
---------- ---------- -------- ------ ----------- ---------- 
(python37) [cndaqiang@login3 ~]$ sacctmgr show Stats
sacctmgr: RC:2002 Your user doesn't have privilege to perform this action
(python37) [cndaqiang@login3 ~]$ sacctmgr show qos              
</code></pre></div></div>
<p><img src="/uploads/2020/03/qos.png" alt="" /></p>

<h3 id="不重启服务更新配置">不重启服务更新配置</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol reconfig
</code></pre></div></div>

<h3 id="交到指定节点">交到指定节点</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#SBATCh -w comput6 
</code></pre></div></div>
<p>or</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch -w hpcc127  restart.rptdap.sh
</code></pre></div></div>

<h3 id="不交到问题节点">不交到问题节点</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch -x hpcc127  restart.rptdap.sh
</code></pre></div></div>

<h3 id="等指定作业结束后提交">等指定作业结束后提交</h3>
<p><strong>作业脚本要放到最后</strong>,参考<a href="https://slurm.schedmd.com/sbatch.html"></a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch --dependency=afterok:14940 4kp_cal.epsilon.sh
#非正常结束,如QE计算声子谱,时间到了，任务没算完. 这样叫作业可以自动续算
sbatch --dependency=afternotok:5718202 run-tdpw-huairou.sh
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">-d, --dependency=&lt;dependency_list&gt;</code></li>
  <li><code class="language-plaintext highlighter-rouge">&lt;dependency_list&gt;</code>=<code class="language-plaintext highlighter-rouge">&lt;type:job_id[:job_id][,type:job_id[:job_id]]&gt; or &lt;type:job_id[:job_id][?type:job_id[:job_id]]&gt;</code></li>
  <li>type:
    <ul>
      <li>after:job_id[[+time][:jobid[+time]…]]   <br />
  After the specified jobs start or are cancelled and ‘time’ in minutes from job start or cancellation happens, this job can begin execution. If no ‘time’ is given then there is no delay after start or cancellation.</li>
      <li>afterany:job_id[:jobid…]  <br />
  This job can begin execution after the specified jobs have terminated.
afterburstbuffer:job_id[:jobid…]   <br />
  This job can begin execution after the specified jobs have terminated and any associated burst buffer stage out operations have completed.</li>
      <li>aftercorr:job_id[:jobid…]    <br />
  A task of this job array can begin execution after the corresponding task ID in the specified job has completed successfully (ran to completion with an exit code of zero).</li>
      <li>afternotok:job_id[:jobid…]   <br />
  This job can begin execution after the specified jobs have terminated in some failed state (non-zero exit code, node failure, timed out, etc).</li>
      <li>afterok:job_id[:jobid…]   <br />
  This job can begin execution after the specified jobs have successfully executed (ran to completion with an exit code of zero).
singleton</li>
    </ul>
  </li>
</ul>

<h3 id="提高任务优先级">提高任务优先级</h3>
<p>服务器没有配置好每个人最多同时在算的作业数，某同学批量提交作业，导致后续同学的作业一直在排队，可先将其他同学的任务提前</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#查看批量作业的最高优先级
[root@mgmt cndaqiang]# scontrol show job=8914 | grep Priority | grep QOS
   Priority=4294894516 Nice=0 Account=XXX QOS=normal
#查看后面同学的优先级
[root@mgmt cndaqiang]# scontrol show job=8930 | grep Priority | grep QOS
   Priority=4294894500 Nice=0 Account=YYY QOS=normal
#更改优先级,数字越大优先级越高
[root@mgmt cndaqiang]# scontrol update job=8930 Priority=4294894532 
[root@mgmt cndaqiang]# scontrol show job=8930 | grep Priority  | grep QOS
   Priority=4294894532 Nice=0 Account=YYY QOS=normal
</code></pre></div></div>

<p>如果把优先级设成0,则会hold住任务,使用release接触hold</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol release &lt;jobid&gt;
</code></pre></div></div>

<h3 id="hold任务">hold任务</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol hold &lt;jobid&gt;
scontrol release &lt;jobid&gt;
</code></pre></div></div>

<h3 id="修改开始计算时间">修改开始计算时间</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol update JobId=1234 StartTime=now+30days
scontrol update JobId=1234 StartTime=now
</code></pre></div></div>
<p>延迟后状态是<code class="language-plaintext highlighter-rouge">BeginTime</code></p>

<h3 id="保存作业脚本内容">保存作业脚本内容</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) cndaqiang@mommint:~/work/tmp$ scontrol write batch_script 858
batch script for job 858 written to slurm-858.sh
</code></pre></div></div>

<h2 id="其他">其他</h2>
<h3 id="nodelistreason">NODELIST(REASON)</h3>

<p>其他队列的优先级更高, 节点优先分配给了其他的队列,当前队列暂时没有节点<br />
超过了提交作业限额</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nodes required for job are DOWN, DRAINED or reserved for jobs in higher priority partitions)
</code></pre></div></div>
<p>下一个节点空出就算</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Resources
</code></pre></div></div>
<p>被延迟了时间</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BeginTime
</code></pre></div></div>

<hr />
<blockquote>
  <p>本文首发于<a href="https://cndaqiang.github.io/">我的博客@cndaqiang</a>.<br />
本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
</blockquote>

        </article>
        <hr>

        
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
        
        <!--- github follow and star -->
        <iframe src="/html_script/github-btn.html?user=cndaqiang&repo=cndaqiang.github.io&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        <iframe src="/html_script/github-btn.html?user=cndaqiang&type=follow&count=true&size=large" frameborder="0" scrolling="0" width="220px" height="30px"></iframe>
        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2020/01/24/docker/">Docker 学习笔记</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2020/02/29/pgi/">挖坑 CUDA编程(Fortran)</a></p>
        
    </div>
</div>

        
            





            <!--广告 _includes/adsenseAfterComments.html -->
            

        
        

        


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    目录
                </div>
                <ul id="content-side" class="content-ul">
                    
                     <!-- 关闭评论功能 <li><a href="#comments">评论</a></li> -->
                </ul>
            </div>
            <!-- 其他div框放到这里 ，添加br 使不粘连--><br>
            <!-- adsens -->
            <!--广告 _includes/adsense_side.html -->
            

            
            
                 
                <div class="side">
                   <div>
                       <i class="fa fa-database"></i>
                      访客数据
                   </div>
                   <script type="text/javascript" src="//rf.revolvermaps.com/0/0/7.js?i=537vyn60ia7&amp;m=0&amp;c=007eff&amp;cr1=ff0000&amp;sx=0" async="async"></script>
                </div>
                
            
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">
        


        <!-- 
        <p class="contact">
            
            联系方式: 
             <a href="https://github.com/cndaqiang" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>   
              
              
              
              
              
              
              
              
            .
        
        -->
         
        </p>
        <p>
            
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，访客<span id="busuanzi_value_site_uv"></span>人次，本文阅读量<span id="busuanzi_value_page_pv"></span>次.
            
        <!-- 
             <a href="https://us.umami.is/websites/27e72116-bcc0-4a4d-82a5-485b4105820e"> 实时访客数据</a>  
        -->
        </p>
        <!-- 
        <p class="power">
            <span>
                Site powered by <a href="https://cndaqiang.github.io/">cndaqiang</a>
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
        -->
        <p class="description">
            <!-- 
                 
            -->
            &copy; 2024 cndaqiang. Archived since 11/01/2014.
            </p>
    
    </div>
</footer>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 
    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
