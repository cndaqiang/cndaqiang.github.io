I"M‚<ul id="markdown-toc">
  <li><a href="#å‚è€ƒ" id="markdown-toc-å‚è€ƒ">å‚è€ƒ</a></li>
  <li><a href="#ç‰©ç†èƒŒæ™¯" id="markdown-toc-ç‰©ç†èƒŒæ™¯">ç‰©ç†èƒŒæ™¯</a>    <ul>
      <li><a href="#pw-and-grids-æ–¹æ³•" id="markdown-toc-pw-and-grids-æ–¹æ³•">PW and grids æ–¹æ³•</a></li>
      <li><a href="#r-g-ç©ºé—´çš„fftå˜æ¢" id="markdown-toc-r-g-ç©ºé—´çš„fftå˜æ¢">R-/G-ç©ºé—´çš„FFTå˜æ¢</a></li>
      <li><a href="#r-g-ç©ºé—´çš„fftå˜æ¢åº”ç”¨-ç”µè·å¯†åº¦nrng" id="markdown-toc-r-g-ç©ºé—´çš„fftå˜æ¢åº”ç”¨-ç”µè·å¯†åº¦nrng">R-/G-ç©ºé—´çš„FFTå˜æ¢åº”ç”¨: ç”µè·å¯†åº¦<strong>n(r)&amp;n(G)</strong></a></li>
      <li><a href="#qeä¸­çš„fftå˜æ¢" id="markdown-toc-qeä¸­çš„fftå˜æ¢">QEä¸­çš„FFTå˜æ¢</a>        <ul>
          <li><a href="#qeä¸­çš„ä¸¤ç§fftç½‘æ ¼" id="markdown-toc-qeä¸­çš„ä¸¤ç§fftç½‘æ ¼">QEä¸­çš„ä¸¤ç§FFTç½‘æ ¼</a></li>
          <li><a href="#ecutrhoecutwfcå†³å®šfftå¤§ç½‘æ ¼å¤§ç‚¹é˜µå¤§æ£‹ç›˜nr1xnr2xnr3xå¹³è¡Œå…­é¢ä½“" id="markdown-toc-ecutrhoecutwfcå†³å®šfftå¤§ç½‘æ ¼å¤§ç‚¹é˜µå¤§æ£‹ç›˜nr1xnr2xnr3xå¹³è¡Œå…­é¢ä½“"><code class="highlighter-rouge">ecutrho</code>&amp;<code class="highlighter-rouge">ecutwfc</code>å†³å®šFFTå¤§ç½‘æ ¼(å¤§ç‚¹é˜µ/å¤§æ£‹ç›˜)<code class="highlighter-rouge">nr1x*nr2x*nr3x</code>(å¹³è¡Œå…­é¢ä½“)</a></li>
          <li><a href="#fftç½‘æ ¼ä¸sticksç½‘æ ¼" id="markdown-toc-fftç½‘æ ¼ä¸sticksç½‘æ ¼">FFTç½‘æ ¼ä¸sticksç½‘æ ¼</a></li>
          <li><a href="#waveå’Œrhoæˆªæ–­gkcutgcutå†³å®šå¤§ç½‘æ ¼ä¸­çš„æ¿€æ´»åŒºåŸŸg2gcutgkcutæ¤­çƒå½¢" id="markdown-toc-waveå’Œrhoæˆªæ–­gkcutgcutå†³å®šå¤§ç½‘æ ¼ä¸­çš„æ¿€æ´»åŒºåŸŸg2gcutgkcutæ¤­çƒå½¢">waveå’Œrhoæˆªæ–­<code class="highlighter-rouge">gkcut</code>&amp;<code class="highlighter-rouge">gcut</code>å†³å®šå¤§ç½‘æ ¼ä¸­çš„æ¿€æ´»åŒºåŸŸ<code class="highlighter-rouge">|G^2|&lt;gcut/gkcut</code>(æ¤­çƒå½¢)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#ç›¸å…³æ–‡ä»¶" id="markdown-toc-ç›¸å…³æ–‡ä»¶">ç›¸å…³æ–‡ä»¶</a>    <ul>
      <li><a href="#fftæ¨¡å—åº“" id="markdown-toc-fftæ¨¡å—åº“">FFTæ¨¡å—åº“</a></li>
      <li><a href="#fftç½‘æ ¼çš„è¾…åŠ©å±æ€§" id="markdown-toc-fftç½‘æ ¼çš„è¾…åŠ©å±æ€§">FFTç½‘æ ¼çš„è¾…åŠ©å±æ€§</a></li>
    </ul>
  </li>
  <li><a href="#fftç»“æ„ä½“å®šä¹‰" id="markdown-toc-fftç»“æ„ä½“å®šä¹‰">fftç»“æ„ä½“å®šä¹‰</a>    <ul>
      <li><a href="#fft-dimensions-æ•°æ®ç½‘æ ¼" id="markdown-toc-fft-dimensions-æ•°æ®ç½‘æ ¼">FFT dimensions <strong>æ•°æ®ç½‘æ ¼</strong></a></li>
      <li><a href="#communicators-and-processor-coordinates-cpuç½‘æ ¼" id="markdown-toc-communicators-and-processor-coordinates-cpuç½‘æ ¼">communicators and processor coordinates <strong>CPUç½‘æ ¼</strong></a></li>
      <li><a href="#fft-distributed-data-dimensions-and-indices" id="markdown-toc-fft-distributed-data-dimensions-and-indices">FFT distributed data dimensions and indices</a>        <ul>
          <li><a href="#task-group-alltoall-communication-layout" id="markdown-toc-task-group-alltoall-communication-layout">task group ALLTOALL communication layout</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#module-gvectgvecsè¯´æ˜" id="markdown-toc-module-gvectgvecsè¯´æ˜">MODULE <code class="highlighter-rouge">gvect</code>,<code class="highlighter-rouge">gvecs</code>è¯´æ˜</a>    <ul>
      <li><a href="#gvectecurhodfftpvsgvecs-4ecutwfcdffts" id="markdown-toc-gvectecurhodfftpvsgvecs-4ecutwfcdffts"><code class="highlighter-rouge">gvect(ecurho,dfftp)</code>vs<code class="highlighter-rouge">gvecs (4*ecutwfc,dffts)</code></a></li>
      <li><a href="#gvect-ä¸­æ›´å¤šçš„å˜é‡" id="markdown-toc-gvect-ä¸­æ›´å¤šçš„å˜é‡">gvect ä¸­æ›´å¤šçš„å˜é‡</a></li>
    </ul>
  </li>
  <li><a href="#module-gvecw" id="markdown-toc-module-gvecw"><code class="highlighter-rouge">MODULE gvecw</code></a></li>
  <li><a href="#sticks_mapç»“æ„ä½“å®šä¹‰" id="markdown-toc-sticks_mapç»“æ„ä½“å®šä¹‰"><code class="highlighter-rouge">sticks_map</code>ç»“æ„ä½“å®šä¹‰</a></li>
  <li><a href="#åˆå§‹åŒ–æµç¨‹data_structureåˆå§‹åŒ–å…¥å£" id="markdown-toc-åˆå§‹åŒ–æµç¨‹data_structureåˆå§‹åŒ–å…¥å£">åˆå§‹åŒ–æµç¨‹:<code class="highlighter-rouge">data_structure</code>åˆå§‹åŒ–å…¥å£</a>    <ul>
      <li><a href="#è®¡ç®—dfftsä¸dfftpæˆªæ–­èƒ½" id="markdown-toc-è®¡ç®—dfftsä¸dfftpæˆªæ–­èƒ½">è®¡ç®—<code class="highlighter-rouge">dffts</code>ä¸<code class="highlighter-rouge">dfftp</code>æˆªæ–­èƒ½</a></li>
      <li><a href="#fft_type_initè¢«è°ƒç”¨ä¸¤æ¬¡åˆå§‹åŒ–ä¸¤ä¸ªfftç½‘æ ¼dfftsdfftpsticksç½‘æ ¼smap" id="markdown-toc-fft_type_initè¢«è°ƒç”¨ä¸¤æ¬¡åˆå§‹åŒ–ä¸¤ä¸ªfftç½‘æ ¼dfftsdfftpsticksç½‘æ ¼smap"><code class="highlighter-rouge">fft_type_init</code>è¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªFFTç½‘æ ¼<code class="highlighter-rouge">dffts,dfftp</code>,sticksç½‘æ ¼<code class="highlighter-rouge">smap</code></a>        <ul>
          <li><a href="#æ ¹æ®persrhowaveè®¡ç®—gkcutandgcut" id="markdown-toc-æ ¹æ®persrhowaveè®¡ç®—gkcutandgcut">æ ¹æ®<code class="highlighter-rouge">pers="rho"/"wave"</code>è®¡ç®—<code class="highlighter-rouge">gkcut</code>and<code class="highlighter-rouge">gcut</code></a></li>
          <li><a href="#fft_type_allocate" id="markdown-toc-fft_type_allocate">fft_type_allocate</a>            <ul>
              <li><a href="#åˆ’åˆ†å¹¶è¡Œcpuç½‘æ ¼" id="markdown-toc-åˆ’åˆ†å¹¶è¡Œcpuç½‘æ ¼">åˆ’åˆ†å¹¶è¡ŒCPUç½‘æ ¼</a></li>
              <li><a href="#realspace_grid_initè®¡ç®—fftç½‘æ ¼" id="markdown-toc-realspace_grid_initè®¡ç®—fftç½‘æ ¼"><code class="highlighter-rouge">realspace_grid_init</code>è®¡ç®—FFTç½‘æ ¼</a></li>
            </ul>
          </li>
          <li><a href="#sticks_map_allocate-ç”±fftç½‘æ ¼å»ºç«‹sticksç½‘æ ¼" id="markdown-toc-sticks_map_allocate-ç”±fftç½‘æ ¼å»ºç«‹sticksç½‘æ ¼"><code class="highlighter-rouge">sticks_map_allocate</code> ç”±FFTç½‘æ ¼å»ºç«‹sticksç½‘æ ¼</a></li>
          <li><a href="#åˆå§‹åŒ–å˜é‡ç”¨äºåç»­è®¡ç®—" id="markdown-toc-åˆå§‹åŒ–å˜é‡ç”¨äºåç»­è®¡ç®—">åˆå§‹åŒ–å˜é‡,ç”¨äºåç»­è®¡ç®—</a></li>
          <li><a href="#get_stickså»ºç«‹sticksä¸cpuç½‘æ ¼é—´çš„è”ç³»" id="markdown-toc-get_stickså»ºç«‹sticksä¸cpuç½‘æ ¼é—´çš„è”ç³»"><code class="highlighter-rouge">get_sticks</code>å»ºç«‹sticksä¸CPUç½‘æ ¼é—´çš„è”ç³»</a>            <ul>
              <li><a href="#sticks_map_setç»Ÿè®¡å„ä¸ªsticksä¸Šçš„gç‚¹æ•°sti1i2" id="markdown-toc-sticks_map_setç»Ÿè®¡å„ä¸ªsticksä¸Šçš„gç‚¹æ•°sti1i2"><code class="highlighter-rouge">sticks_map_set</code>ç»Ÿè®¡å„ä¸ªsticksä¸Šçš„Gç‚¹æ•°:st(i1,i2)</a></li>
              <li><a href="#sticks_map_indexæŠŠäºŒç»´çš„sticksç´¢å¼•å˜ä¸ºä¸€ç»´ç´¢å¼•" id="markdown-toc-sticks_map_indexæŠŠäºŒç»´çš„sticksç´¢å¼•å˜ä¸ºä¸€ç»´ç´¢å¼•"><code class="highlighter-rouge">sticks_map_index</code>æŠŠäºŒç»´çš„sticksç´¢å¼•å˜ä¸ºä¸€ç»´ç´¢å¼•</a></li>
              <li><a href="#sticks_sort_newå¯¹ä¸€ç»´sticksç´¢å¼•æ’åº" id="markdown-toc-sticks_sort_newå¯¹ä¸€ç»´sticksç´¢å¼•æ’åº"><code class="highlighter-rouge">sticks_sort_new</code>å¯¹ä¸€ç»´sticksç´¢å¼•æ’åº</a></li>
              <li><a href="#åˆ†é…sticksåˆ°cpuç½‘æ ¼ç‚¹ä¸Š" id="markdown-toc-åˆ†é…sticksåˆ°cpuç½‘æ ¼ç‚¹ä¸Š">åˆ†é…sticksåˆ°CPUç½‘æ ¼ç‚¹ä¸Š</a></li>
            </ul>
          </li>
          <li><a href="#fft_type_set-è®¾ç½®fftç½‘æ ¼" id="markdown-toc-fft_type_set-è®¾ç½®fftç½‘æ ¼">fft_type_set è®¾ç½®FFTç½‘æ ¼</a>            <ul>
              <li><a href="#descnr1pdescnr2pdescnr3p" id="markdown-toc-descnr1pdescnr2pdescnr3p"><code class="highlighter-rouge">desc%nr1pï¼Œdesc%nr2pï¼Œdesc%nr3p</code></a></li>
              <li><a href="#descnnp---nr1x--nr2xç”¨äºä¼°ç®—" id="markdown-toc-descnnp---nr1x--nr2xç”¨äºä¼°ç®—"><code class="highlighter-rouge">desc%nnp  = nr1x * nr2x</code>ç”¨äºä¼°ç®—</a></li>
              <li><a href="#descngldescnwl" id="markdown-toc-descngldescnwl"><code class="highlighter-rouge">desc%ngl</code>&amp;<code class="highlighter-rouge">desc%nwl</code></a></li>
              <li><a href="#sticksæ ¼ç‚¹i1i2ä¸fftæ ¼ç‚¹m1m2å…³ç³»" id="markdown-toc-sticksæ ¼ç‚¹i1i2ä¸fftæ ¼ç‚¹m1m2å…³ç³»">sticksæ ¼ç‚¹<code class="highlighter-rouge">(i1,i2)</code>ä¸FFTæ ¼ç‚¹<code class="highlighter-rouge">(m1,m2)</code>å…³ç³»</a></li>
              <li><a href="#fftç½‘æ ¼çš„ä¸€ç»´ç¼–å·indm" id="markdown-toc-fftç½‘æ ¼çš„ä¸€ç»´ç¼–å·indm">FFTç½‘æ ¼çš„ä¸€ç»´ç¼–å·indm</a></li>
              <li><a href="#fftæ ¼ç‚¹çš„yzæˆªé¢xm1ä¸cpuç½‘æ ¼pyè¡Œçš„å…³ç³»" id="markdown-toc-fftæ ¼ç‚¹çš„yzæˆªé¢xm1ä¸cpuç½‘æ ¼pyè¡Œçš„å…³ç³»">FFTæ ¼ç‚¹çš„YZæˆªé¢<code class="highlighter-rouge">X(m1)</code>ä¸CPUç½‘æ ¼<code class="highlighter-rouge">py</code>è¡Œçš„å…³ç³»</a></li>
              <li><a href="#fftçš„æ ¼ç‚¹m1m2ä¸processorå¯¹åº”å…³ç³»" id="markdown-toc-fftçš„æ ¼ç‚¹m1m2ä¸processorå¯¹åº”å…³ç³»">FFTçš„æ ¼ç‚¹<code class="highlighter-rouge">(m1,m2)</code>ä¸processorå¯¹åº”å…³ç³»</a></li>
              <li><a href="#å‰©ä¸‹å°±æ˜¯è¿‘ä¼¼å€¼çš„ä¼°è®¡" id="markdown-toc-å‰©ä¸‹å°±æ˜¯è¿‘ä¼¼å€¼çš„ä¼°è®¡">å‰©ä¸‹å°±æ˜¯è¿‘ä¼¼å€¼çš„ä¼°è®¡</a></li>
            </ul>
          </li>
          <li><a href="#æœ¬processorå¤„ç†çš„gç‚¹dfftngwdfftngm" id="markdown-toc-æœ¬processorå¤„ç†çš„gç‚¹dfftngwdfftngm">æœ¬processorå¤„ç†çš„Gç‚¹<code class="highlighter-rouge">dfft%ngw</code>&amp;<code class="highlighter-rouge">dfft%ngm</code></a></li>
        </ul>
      </li>
      <li><a href="#fft_base_info" id="markdown-toc-fft_base_info"><code class="highlighter-rouge">fft_base_info</code></a></li>
      <li><a href="#gvect_init--gvecs_init-ç»Ÿè®¡n_gallocateg" id="markdown-toc-gvect_init--gvecs_init-ç»Ÿè®¡n_gallocateg"><code class="highlighter-rouge">gvect_init</code> &amp; <code class="highlighter-rouge">gvecs_init</code> ç»Ÿè®¡<script type="math/tex">N_{G}</script>,<strong>ALLOCATE(g)</strong></a></li>
    </ul>
  </li>
  <li><a href="#allocate_fftä¸ºfftç»§ç»­åˆ†é…å˜é‡" id="markdown-toc-allocate_fftä¸ºfftç»§ç»­åˆ†é…å˜é‡"><code class="highlighter-rouge">allocate_fft()</code>ä¸ºFFTç»§ç»­åˆ†é…å˜é‡</a>    <ul>
      <li><a href="#module-scfä¸­fftç›¸å…³çš„å˜é‡å®šä¹‰" id="markdown-toc-module-scfä¸­fftç›¸å…³çš„å˜é‡å®šä¹‰"><code class="highlighter-rouge">MODULE scf</code>ä¸­fftç›¸å…³çš„å˜é‡å®šä¹‰</a>        <ul>
          <li><a href="#scf_typeç»“æ„ä½“" id="markdown-toc-scf_typeç»“æ„ä½“"><code class="highlighter-rouge">scf_type</code>ç»“æ„ä½“</a></li>
          <li><a href="#ç”µè·å¯†åº¦rhoçš„fftçš„ç©ºé—´ç½‘æ ¼" id="markdown-toc-ç”µè·å¯†åº¦rhoçš„fftçš„ç©ºé—´ç½‘æ ¼"><strong>ç”µè·å¯†åº¦rhoçš„FFTçš„ç©ºé—´ç½‘æ ¼:</strong><br /></a></li>
          <li><a href="#å…¶ä»–å˜é‡" id="markdown-toc-å…¶ä»–å˜é‡">å…¶ä»–å˜é‡</a></li>
        </ul>
      </li>
      <li><a href="#wavefunctionsä¸­å®šä¹‰çš„å˜é‡" id="markdown-toc-wavefunctionsä¸­å®šä¹‰çš„å˜é‡"><code class="highlighter-rouge">wavefunctions</code>ä¸­å®šä¹‰çš„å˜é‡</a></li>
      <li><a href="#noncollin_module" id="markdown-toc-noncollin_module"><code class="highlighter-rouge">noncollin_module</code></a></li>
    </ul>
  </li>
  <li><a href="#ggenggensäº§ç”Ÿå€’æ ¼å¼å’Œfftç´¢å¼•" id="markdown-toc-ggenggensäº§ç”Ÿå€’æ ¼å¼å’Œfftç´¢å¼•"><code class="highlighter-rouge">ggen</code>&amp;<code class="highlighter-rouge">ggens</code>äº§ç”Ÿå€’æ ¼å¼å’Œfftç´¢å¼•</a>    <ul>
      <li><a href="#ggenç”Ÿæˆgcutmå…è®¸çš„gç‚¹" id="markdown-toc-ggenç”Ÿæˆgcutmå…è®¸çš„gç‚¹"><code class="highlighter-rouge">ggen</code>ç”Ÿæˆ<code class="highlighter-rouge">gcutm</code>å…è®¸çš„Gç‚¹</a></li>
      <li><a href="#ggens" id="markdown-toc-ggens">ggens</a></li>
    </ul>
  </li>
  <li><a href="#é™„å½•" id="markdown-toc-é™„å½•">é™„å½•</a>    <ul>
      <li><a href="#å›¾a" id="markdown-toc-å›¾a">å›¾A</a>        <ul>
          <li><a href="#å›¾a-1" id="markdown-toc-å›¾a-1">å›¾A-1</a></li>
          <li><a href="#å›¾a-2" id="markdown-toc-å›¾a-2">å›¾A-2</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>QEä»£ç é˜…è¯»ç³»åˆ—ï¼Œä¸ªäººå­¦ä¹ è®°å½•ï¼Œä»…ä¾›å‚è€ƒã€‚<br />
ä»£ç ä»“åº“<a href="https://gitee.com/cndaqiang/QE-6.4.1/tree/master">QE-6.4.1@cndaqiang</a><br /></p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://github.com/QEF/q-e.git">q-e code</a><br />
<a href="https://books.google.com/books?id=v1YhAwAAQBAJ">Martin, R. M., &amp; Martin, R. M. (2004). Electronic structure: basic theory and practical methods. Cambridge university press.</a></p>

<h2 id="ç‰©ç†èƒŒæ™¯">ç‰©ç†èƒŒæ™¯</h2>
<h3 id="pw-and-grids-æ–¹æ³•">PW and grids æ–¹æ³•</h3>
<p>PWåŸºç»„å’Œç½‘æ ¼ç‚¹æ˜¯ä¸¤ç§æ±‚è§£è–›å®šè°”(or kohn-sham etc.ï¼Œ ä»¥ä¸‹ç»Ÿç§°ä¸ºè–›å®šè°”)æ–¹ç¨‹çš„æ–¹æ³•</p>
<ul>
  <li>PWåŸºç»„ç±»ä¼¼è¡¨è±¡çš„æ€æƒ³ï¼Œåœ¨PWè¡¨è±¡ä¸‹ï¼Œè¿›è¡ŒçŸ©é˜µå¯¹è§’åŒ–æ±‚è§£</li>
  <li>gridsæ–¹æ³•ï¼ŒæŠŠå®ç©ºé—´åˆ’åˆ†æˆç½‘æ ¼ç‚¹ï¼Œä½¿ç”¨æœ‰é™å…ƒçš„æ€æƒ³åœ¨å®ç©ºé—´ç½‘æ ¼ç‚¹ä¸Šè§£äºŒé˜¶å¾®åˆ†æ–¹ç¨‹<script type="math/tex">- \frac{1}{2} \bigtriangledown \psi (r) + V(r) = E \psi (r)</script>
<br /> é€‚åˆæœ‰é™ä½“ç³»</li>
</ul>

<p>åœ¨QEç­‰<em>ç°ä»£åŒ–</em>çš„ç”µå­ç»“æ„è®¡ç®—ç¨‹åºä¸­ï¼Œè¿™ä¸¤ç§æ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œå…ˆæŠŠå€’ç©ºé—´ä¸‹é¢çš„æ³¢å‡½æ•°å˜æ¢åˆ°å®ç©ºé—´ï¼Œè®¡ç®—ç”µè·å¯†åº¦<strong>n(r)</strong>ï¼Œç„¶åIFFTå˜æ¢åˆ°å€’ç©ºé—´å¾—åˆ°<strong>n(G)</strong></p>

<p>n(r)å’Œn(G)ç”¨äºè®¡ç®—èƒ½é‡çš„ä¸åŒéƒ¨åˆ†</p>

<h3 id="r-g-ç©ºé—´çš„fftå˜æ¢">R-/G-ç©ºé—´çš„FFTå˜æ¢</h3>

<center> 

$$ | G_{m} &gt; = e^{ i {G}_{m}r }$$ 

$$ f(r)= \sum_{m} c_{m} | G_{m} &gt; $$

</center>
<p>where <script type="math/tex">c_m</script>æ˜¯G-ç©ºé—´çš„å‡½æ•°ï¼Œæˆ–è€…çŸ©é˜µ,<br />
<script type="math/tex">f(r)</script> æ˜¯R-ç©ºé—´çš„å‡½æ•°,ç¦»æ•£åæ ‡<script type="math/tex">r_n</script> ä¸Šçš„å€¼<script type="math/tex">f(r_n)</script> ä¹Ÿå¯ä»¥æ„æˆçŸ©é˜µ <br />
ç”±<a href="/2019/04/06/Fortran-math/">Fortran ç§‘å­¦è®¡ç®—</a>å¾—, <script type="math/tex">r_n</script>å’Œ<script type="math/tex">c_m</script> æ•°é‡ç›¸åŒï¼Œi.e. <script type="math/tex">N_{R} = N_{G}</script>
<br /><br />
æ ¹æ®<script type="math/tex">\frac{1}{2} \left |  G_{max}  \right | ^{2} \leqslant  E_{cutoff}</script>ï¼Œå¯ä»¥ç”¨æˆªæ–­èƒ½è®¾ç½®<strong>G</strong>çš„æ•°é‡ <script type="math/tex">N_{G}</script>,<br /></p>

<p>ä»¥ä¸€ç»´ä½“ç³»ä¸ºä¾‹,ç”±äºdGç­‰äºå€’æ ¼åŸºçŸ¢b,æ ¹æ®<a href="/2019/04/06/Fortran-math/">Fortran ç§‘å­¦è®¡ç®—</a>ï¼Œç”±ä¸‹é¢çš„æ¨å¯¼å¯å¾—:</p>
<ul>
  <li><strong><script type="math/tex">r_n</script> æœ€å¤§å€¼ä¸ºæ­£æ ¼åŸºå¤±a,ä¸æˆªæ–­èƒ½æ— å…³</strong></li>
  <li><strong>ç½‘æ ¼ç‚¹çš„æ•°ç›®<script type="math/tex">N_G</script>ä¸æˆªæ–­èƒ½çš„è®¾ç½®æœ‰å…³</strong></li>
</ul>

<center>
$$
R_{max} \cdot dG = 2\pi 
$$

$$
dG = b
$$

$$
R_{max} = \frac{2\pi}{b} = a
$$

$$
N_{G} = \frac{ G_{cutoff}}{dG} =  G_{cutoff} \cdot a \cdot 2\pi
$$

</center>

<p>å¦‚QEç¨‹åºä¸­ä½¿ç”¨Gæˆªæ–­èƒ½<code class="highlighter-rouge">gcutmï¼ecutrho/tpiba2</code>, è®¡ç®—çš„FFTç½‘æ ¼è¾¹ç•Œ:<script type="math/tex">N_G^{dfftp}</script> , <code class="highlighter-rouge">dfftp%nr1,dfftp%nr2,dfftp%nr3 </code>, x,y,zä¸‰ä¸ªæ–¹å‘<br />
å®é™…è®¡ç®—ä¸­é€šå¸¸ R-/G-ç©ºé—´ç½‘æ ¼ç‚¹æ•°ç›¸åŒ<script type="math/tex">N_{R} = N_{G} = N</script>ï¼Œè€Œä¸”æ„æˆå¹³è¡Œå…­é¢ä½“ç½‘æ ¼<br />
è¿™ä¸ªç½‘æ ¼ç‚¹æ•°é€šå¸¸æ¯”è®¡ç®—è–›å®šè°”æ–¹ç¨‹é‡‡ç”¨çš„åŸºç»„è¦å¤§<br /></p>

<h3 id="r-g-ç©ºé—´çš„fftå˜æ¢åº”ç”¨-ç”µè·å¯†åº¦nrng">R-/G-ç©ºé—´çš„FFTå˜æ¢åº”ç”¨: ç”µè·å¯†åº¦<strong>n(r)&amp;n(G)</strong></h3>
<p>å¯¹äºPW basis {<strong>G</strong>}, æˆ‘ä»¬æ˜¯åœ¨å€’ç©ºé—´è§£çš„è–›å®šè°”(or kohn-sham etc.)æ–¹ç¨‹ï¼Œå¾—åˆ°æ³¢å‡½æ•° <br /></p>
<center> $$ \psi _{i,\overrightarrow{k} } = \sum_{m} c_{i,m}( \overrightarrow{k} ) | G_{m} &gt; $$ </center>

<p>å…¶ä¸­çš„<script type="math/tex">c_{i,m}</script> æ˜¯æ³¢å‡½æ•°åœ¨å¹³é¢æ³¢è¡¨è±¡ä¸‹çš„çŸ©é˜µå…ƒï¼Œå³åœ¨G-ç©ºé—´(å€’ç©ºé—´)ç½‘æ ¼ç‚¹ä¸Šçš„æ³¢å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨è®¡ç®—æ—¶éœ€è¦å¾—åˆ°R-ç©ºé—´(å®ç©ºé—´)çš„ç”µè·å¯†åº¦<strong>n(r)</strong>æˆ–å…¶åœ¨å€’ç©ºé—´ä¸‹çš„å½¢å¼<strong>n(G)</strong>.<br />
æ ¹æ® <a href="https://books.google.com/books?id=v1YhAwAAQBAJ">Martin, R. M., &amp; Martin, R. M. (2004). Electronic structure: basic theory and practical methods. Cambridge university press.</a><br /></p>
<ul>
  <li>æ–¹æ³•ä¸€:ä½¿ç”¨(12.30)å’Œ(12.31)è¿›è¡Œè®¡ç®—ï¼Œä½†æ˜¯è®¡ç®—é‡æ˜¯<strong>N*N</strong>çš„æ•°é‡çº§
<img src="/uploads/2020/04/pwbasis_grids.png" alt="" /></li>
  <li>æ–¹æ³•äºŒ:æŠŠæ¯ä¸ªæ³¢å‡½æ•°<script type="math/tex">\psi _{i,\overrightarrow{k} }</script> ç”¨FFTå˜æ¢åˆ°æ—¶ç©ºé—´ç½‘æ ¼(ä¸€ä¸ªåŸèƒå†…)ï¼Œè®¡ç®—ç”µè·å¯†åº¦<strong>n(r)</strong>ï¼Œç„¶åIFFTå˜æ¢åˆ°å€’ç©ºé—´å¾—åˆ°<strong>n(G)</strong><br />
FFTç®—æ³•çš„è®¡ç®—é‡<strong>N*log(N)</strong></li>
</ul>

<h3 id="qeä¸­çš„fftå˜æ¢">QEä¸­çš„FFTå˜æ¢</h3>

<h4 id="qeä¸­çš„ä¸¤ç§fftç½‘æ ¼">QEä¸­çš„ä¸¤ç§FFTç½‘æ ¼</h4>
<p>åœ¨QEç¨‹åºä¸­ï¼Œæœ‰ä¸¤ç§fftç½‘æ ¼:<code class="highlighter-rouge">dffts</code>å’Œ<code class="highlighter-rouge">dfftp</code>
ä¸¤ç§ç½‘æ ¼çš„ç”¨é€”æš‚æ—¶æ²¡çœ‹åˆ°ã€‚QEè¾“å…¥å‚æ•°ä¸­è¯´:<br /></p>
<ul>
  <li>ç½‘æ ¼<code class="highlighter-rouge">dffts</code><br />
è¾“å…¥å‚æ•°<code class="highlighter-rouge">nr1s*nr2s*nr3s</code>å¯ä»¥æŒ‡å®šå¤§å°,æˆ–è€…ç”±<code class="highlighter-rouge">ï¼”*ecutwfc</code>è®¡ç®—<br />
sä»£è¡¨smooth<br />
    <blockquote>
      <p>Three-dimensional mesh for wavefunction FFT and for the smooth part of charge density ( smooth grid ).<br />
Coincides with nr1, nr2, nr3 if ecutrho = 4 * ecutwfc ( default )</p>
    </blockquote>
  </li>
  <li>ç½‘æ ¼<code class="highlighter-rouge">dfftp</code><br />
è¾“å…¥å‚æ•°<code class="highlighter-rouge">nr1*nr2*nr3</code>å¯ä»¥æŒ‡å®šå¤§å°ï¼Œæˆ–è€…ç”±<code class="highlighter-rouge">ecutrho</code>è®¡ç®—<br />
pä»£è¡¨potential <br />
    <blockquote>
      <p>Three-dimensional FFT mesh (hard grid) for charge density (and scf potential).</p>
    </blockquote>
  </li>
</ul>

<p>æ€»ç»“:</p>
<ul>
  <li>
    <p><code class="highlighter-rouge">dffts</code>å’Œ<code class="highlighter-rouge">dfftp</code>åˆ†åˆ«æ ¹æ®<code class="highlighter-rouge">4*ecutwfc</code>å’Œ<code class="highlighter-rouge">ecutrho</code>åˆå§‹åŒ–å¤§FFTç½‘æ ¼ç©ºé—´<code class="highlighter-rouge">nr1*nr2*nr3</code>ã€‚<br />
sticksä¸FFTç½‘æ ¼ä¸€ä¸€å¯¹åº”,å¦‚<strong>å›¾:fftç½‘æ ¼å’Œsticks</strong><br />
FFTå¤§ç½‘æ ¼å¯¹åº”çš„stickså¤§ç½‘æ ¼,å¦‚<strong>å›¾:fftç½‘æ ¼å’Œsticks</strong>å’Œ<strong>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</strong>ä¸­çš„<strong>çŸ©å½¢</strong>åŒºåŸŸ</p>
  </li>
  <li>ä¸¤ç§ç½‘æ ¼éƒ½æœ‰å„è‡ªçš„æ³¢å‡½æ•°æˆªæ–­<code class="highlighter-rouge">gkcut</code>,å¯†åº¦/åŠ¿èƒ½æˆªæ–­<code class="highlighter-rouge">gcut</code>,æœ‰å„è‡ªçš„<code class="highlighter-rouge">nr1=gcut*a</code><br /></li>
  <li>
    <p>ç”±äºä»–ä»¬çš„æˆªæ–­èƒ½å®šä¹‰ä¸åŒ,æ‰€ä»¥æœ‰æ•ˆçš„Gç‚¹/FFTç½‘æ ¼ç‚¹/sticks(<code class="highlighter-rouge">|G|^2 &lt; gcut/gkcut</code>)ä¸åŒ<br />
å¦‚<strong>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</strong>ä¸­çš„<strong>æ¤­åœ†å‹</strong>åŒºåŸŸ,<code class="highlighter-rouge">gcut/gkcut</code>å†³å®šäº†æ¤­åœ†çš„å°ºå¯¸</p>
  </li>
  <li>
    <p>åŒä¸€å¥—ç½‘æ ¼å†…waveå’Œrhoè®¡ç®—çš„æœ‰æ•ˆGç‚¹/FFTç½‘æ ¼ç‚¹/sticksç‚¹æ•°ä¹Ÿä¸åŒï¼Œä½†æ˜¯éƒ½æ˜¯åœ¨<code class="highlighter-rouge">nr1xnr2xnr3</code>ä»¥å†…åˆ†å¸ƒçš„<br />
å¦‚<strong>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</strong>ä¸­çš„<strong>æ¤­åœ†</strong>æ˜¯åœ¨<strong>çŸ©å½¢</strong>çš„å†…éƒ¨</p>
  </li>
  <li>è¿™ä¸¤ç§ç½‘æ ¼å”¯ä¸€çš„è”ç³»æ˜¯ï¼Œå…±ç”¨ä¸€å¥—sticks,åœ¨å€’ç©ºé—´ä¸­çš„ç›¸åŒçš„Gç‚¹/sticks/FFTç½‘æ ¼ç‚¹åˆ†é…çš„processorç›¸åŒ<br /></li>
  <li>
    <p><strong>é‡å çš„sticksæ€§è´¨<code class="highlighter-rouge">sticks%xxxx</code>ç›¸åŒ,åœ¨FFTç½‘æ ¼ä¸­çš„æ€§è´¨<code class="highlighter-rouge">dfft%xxx</code>å¯èƒ½ä¸åŒ</strong><br />
å³<strong>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</strong>ä¸­é‡å çš„åŒºåŸŸçš„sticksç´¢å¼•/ç¼–å·ç›¸åŒï¼Œå¤„ç†ç›¸åº”sticksçš„processorä¹Ÿç›¸åŒ</p>
  </li>
  <li>sticksç´¢å¼•/ç¼–å·çš„ä¼˜å…ˆåŸåˆ™:<br />
    <ul>
      <li>1)å…ˆç¼–<code class="highlighter-rouge">dffts</code>çš„æ ¼ç‚¹,å†ç¼–<code class="highlighter-rouge">dfftp</code>çš„æ ¼ç‚¹,i.e. <code class="highlighter-rouge">File:PW/src/data_structure.f90 -&gt; CALL fft_type_init</code><br /></li>
      <li>2)åŒä¸€ä¸ªdfftå†…,å…ˆç¼–waveçš„æ ¼ç‚¹(<code class="highlighter-rouge">|G|^2 &lt; gkcut</code>),å†rhoçš„æ ¼ç‚¹<code class="highlighter-rouge">(|G|^2 &lt; gcut</code>), i.e.<code class="highlighter-rouge">FFTXlib/fft_types.f90  -&gt; CALL CALL get_sticks</code><br /></li>
    </ul>
  </li>
</ul>

<p><br /> <strong><center>å›¾:dfftsä¸dfftpç½‘æ ¼</center></strong>
<img src="/uploads/2020/04/dfftsvsdfftp.jpg" alt="" /></p>

<h4 id="ecutrhoecutwfcå†³å®šfftå¤§ç½‘æ ¼å¤§ç‚¹é˜µå¤§æ£‹ç›˜nr1xnr2xnr3xå¹³è¡Œå…­é¢ä½“"><code class="highlighter-rouge">ecutrho</code>&amp;<code class="highlighter-rouge">ecutwfc</code>å†³å®šFFTå¤§ç½‘æ ¼(å¤§ç‚¹é˜µ/å¤§æ£‹ç›˜)<code class="highlighter-rouge">nr1x*nr2x*nr3x</code>(å¹³è¡Œå…­é¢ä½“)</h4>
<p>æ ¹æ®<strong>å›¾:dfftsä¸dfftpç½‘æ ¼</strong>ä¸<strong>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</strong></p>
<ul>
  <li>QEé»˜è®¤<code class="highlighter-rouge">ecutrho=4*ecutwfc</code>,å¯¹äºUSPPç­‰æƒ…å†µ,QEå»ºè®®:<code class="highlighter-rouge">ecutrho =8 to 12 times ecutwfc</code></li>
  <li>åœ¨å•kç‚¹,<code class="highlighter-rouge">ecutrho=4*ecutwfc</code>æƒ…å†µä¸‹, <code class="highlighter-rouge">gcut</code>ä¸€æ ·,<code class="highlighter-rouge">dffts</code>ä¸<code class="highlighter-rouge">dfftp</code>å°±æ˜¯å®Œå…¨ä¸€æ ·çš„</li>
  <li>å¤škç‚¹,<code class="highlighter-rouge">ecutrho=4*ecutwfc</code>æƒ…å†µä¸‹,<code class="highlighter-rouge">gcut</code>ä¸€æ ·å¤§,<code class="highlighter-rouge">dffts</code>çš„<code class="highlighter-rouge">gkcut</code>æ¯”<code class="highlighter-rouge">dfftp</code>å°</li>
  <li><code class="highlighter-rouge">ecutrho&gt;4*ecutwfc</code>æƒ…å†µä¸‹,<code class="highlighter-rouge">dffts</code>çš„<code class="highlighter-rouge">gcut</code>æ¯”<code class="highlighter-rouge">dfftp</code>å°</li>
  <li><code class="highlighter-rouge">ecutrho&lt;4*ecutwfc</code>æƒ…å†µä¸‹,å¯ä»¥è®¡ç®—,<code class="highlighter-rouge">dffts</code>çš„<code class="highlighter-rouge">gcut</code>æ¯”<code class="highlighter-rouge">dfftp</code>å¤§,dfftpåˆå§‹åŒ–æ—¶,å‡ ä¹éƒ½æ˜¯å¤åˆ¶<code class="highlighter-rouge">dffts</code>ä¹‹å‰çš„åˆå§‹åŒ–ä¿¡æ¯</li>
  <li>(<code class="highlighter-rouge">gcut</code>å¤§çš„,æ£‹ç›˜æ›´å¤§ï¼Œå› ä¸ºæ ¼ç‚¹å°±æ˜¯{<strong>G</strong>}çŸ¢é‡æ ¼ç‚¹ï¼Œå› æ­¤åœ¨å€’ç©ºé—´ä¸­<code class="highlighter-rouge">gcut</code>å°çš„æ ¼ç‚¹æ˜¯å¤§<code class="highlighter-rouge">gcut</code>çš„å­é›†)</li>
</ul>

<p><strong>nr1xçš„è®¡ç®—æ–¹æ³•:</strong><br />
ä»¥ä¸€ç»´ä½“ç³»ä¸¾ä¾‹:æ ¹æ®<a href="/2020/04/05/qe-pwscf/">QEä»£ç é˜…è¯»: pwscfæ¡†æ¶</a>ä¸­æ­£å€’æ™¶æ ¼çš„å•ä½</p>

<script type="math/tex; mode=display">a1 \cdot b1 = 1</script>

<p>æ‰€ä»¥åœ¨<code class="highlighter-rouge">fft_type_allocate</code>ï¼Œåˆ©ç”¨ä¸‹å¼ï¼Œç”±<code class="highlighter-rouge">gcut</code>è®¡ç®—FFTç½‘æ ¼ç‚¹æ•°<code class="highlighter-rouge">nr1</code></p>

<script type="math/tex; mode=display">a1\cdot G_{cut} = Nr1_{G}</script>

<p>ä¸ºäº†ä¼˜åŒ–è®¡ç®—ï¼Œä¼šè°ƒæ•´æ•°é‡å¾—åˆ°æœ€ä½³çš„æ•°é‡ï¼Œ<code class="highlighter-rouge">dfftp%nr1x,dfftp%nr2x,dfftp%nr3x </code>ï¼Œä¸”<code class="highlighter-rouge">nrix &gt;= nri</code><br /></p>

<h4 id="fftç½‘æ ¼ä¸sticksç½‘æ ¼">FFTç½‘æ ¼ä¸sticksç½‘æ ¼</h4>
<p>QEåœ¨<code class="highlighter-rouge">sticks_map_allocate</code>ä¸­è¿˜ä¼šæŠŠFFTç½‘æ ¼çš„XYé¢ä¸Šçš„åæ ‡ç‚¹<code class="highlighter-rouge">(m1,m2)</code>ç‚¹,æ¢åˆ°sticksç½‘æ ¼<code class="highlighter-rouge">(i1,i2)</code>ç‚¹
<br />sticksæŒ‡æ¿€æ´»çš„Gç‚¹çš„åœ¨XYé¢ä¸Šçš„åæ ‡<code class="highlighter-rouge">(i1,i2)</code>,sticksæ˜¯äºŒç»´çš„,ä¸æ˜¯æ‰€æœ‰æ¿€æ´»çš„Gç‚¹<code class="highlighter-rouge">(i1,i2,i3)</code></p>
<ul>
  <li>FFTç½‘æ ¼çš„è¾¹ç•Œ: <script type="math/tex">m_{min} = 1</script> and <script type="math/tex">m_{max} = N_{G}</script></li>
  <li>sticksç½‘æ ¼çš„è¾¹ç•Œ: <script type="math/tex">i_{min} = -\frac{ (N_{G} - 1)}{2}</script> and <script type="math/tex">i_{max} = \frac{ (N_{G} - 1)}{2}</script></li>
</ul>

<p>å¦‚<strong>å›¾:fftç½‘æ ¼å’Œsticks</strong>:<code class="highlighter-rouge">FFTXlib/fft_types.f90 -&gt; fft_type_set(...)</code>
<br /> <strong><center>å›¾:fftç½‘æ ¼å’Œsticks</center></strong>
<img src="/uploads/2020/04/fft_sticks.jpg" alt="" /></p>

<h4 id="waveå’Œrhoæˆªæ–­gkcutgcutå†³å®šå¤§ç½‘æ ¼ä¸­çš„æ¿€æ´»åŒºåŸŸg2gcutgkcutæ¤­çƒå½¢">waveå’Œrhoæˆªæ–­<code class="highlighter-rouge">gkcut</code>&amp;<code class="highlighter-rouge">gcut</code>å†³å®šå¤§ç½‘æ ¼ä¸­çš„æ¿€æ´»åŒºåŸŸ<code class="highlighter-rouge">|G^2|&lt;gcut/gkcut</code>(æ¤­çƒå½¢)</h4>
<p>æ¿€æ´»åŒºåŸŸçš„XYé¢æˆªå›¾å¦‚ä¸Š<strong>å›¾:fftç½‘æ ¼å’Œsticks</strong><br />
waveå’Œrhoä½¿ç”¨çš„Gç‚¹åˆ†åˆ«æ ¹æ®<code class="highlighter-rouge">gkcut</code>&amp;<code class="highlighter-rouge">gcut</code>è®¡ç®—:</p>
<ul>
  <li>waveæˆªæ–­<code class="highlighter-rouge">gkcut</code></li>
  <li>rhoæˆªæ–­<code class="highlighter-rouge">gcut</code></li>
</ul>

<p><strong><center>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</center></strong>
<img src="/uploads/2020/04/sticksall.jpg" alt="" /></p>

<p><strong>ä¸¤ä¸ªæ¿€æ´»åŒºåŸŸçš„åŠŸèƒ½æš‚æ—¶ä¸æ˜</strong><br />
<strong>ä¸¤å¥—FFTç½‘æ ¼åŠŸèƒ½æš‚æ—¶ä¸æ˜</strong></p>

<h2 id="ç›¸å…³æ–‡ä»¶">ç›¸å…³æ–‡ä»¶</h2>
<h3 id="fftæ¨¡å—åº“">FFTæ¨¡å—åº“</h3>
<ul>
  <li><code class="highlighter-rouge">FFTXlib/*</code> FFTæ¨¡å—åº“æ–‡ä»¶å¤¹</li>
  <li><code class="highlighter-rouge">FFTXlib/fft_types.f90 - TYPE fft_type_descriptor</code> FFTç»“æ„ä½“å®šä¹‰,åˆå§‹åŒ–<code class="highlighter-rouge">wave -&gt; dffts; rho -&gt; dfftp</code>çš„ç»“æ„ä½“å®šä¹‰</li>
  <li><code class="highlighter-rouge">FFTXlib/stick_base.f90- TYPE sticks_map</code>  sticksç»“æ„ä½“å®šä¹‰,åˆå§‹åŒ–</li>
  <li><code class="highlighter-rouge">Modules/fft_base.f90</code>å®šä¹‰å˜é‡dfftå’Œsticks,å„ç§fftç½‘æ ¼å®šä¹‰<code class="highlighter-rouge">TYPE ( fft_type_descriptor ) :: dffts,dfftp,dfftb,dfft3d</code> <br />sticks å®šä¹‰ <code class="highlighter-rouge">TYPE (sticks_map) :: smap</code></li>
</ul>

<h3 id="fftç½‘æ ¼çš„è¾…åŠ©å±æ€§">FFTç½‘æ ¼çš„è¾…åŠ©å±æ€§</h3>
<ul>
  <li><code class="highlighter-rouge">Modules/recvec.f90</code>,æˆªæ–­èƒ½çš„å®šä¹‰,rho Gç‚¹åœ¨å¤„ç†å™¨ä¸Šçš„åˆ†å¸ƒ,åŒ…å«<code class="highlighter-rouge">gvect_init</code>&amp;<code class="highlighter-rouge">gvecs_init</code>,åŠä¸€ç³»åˆ—å‚æ•°ï¼Œè§ä¸‹</li>
</ul>

<h2 id="fftç»“æ„ä½“å®šä¹‰">fftç»“æ„ä½“å®šä¹‰</h2>
<p>å‚è€ƒè‡ª<code class="highlighter-rouge">FFTXlib/fft_types.f90 - TYPE fft_type_descriptor</code></p>

<p>è·Ÿscalapackè®¡ç®—ä¸€æ ·<a href="/2019/04/06/Fortran-math/">Fortran ç§‘å­¦è®¡ç®—</a>,è¡¨è±¡ä¸‹çš„åŠ›å­¦é‡/æ³¢å‡½æ•°çŸ©é˜µæ•°æ®åˆ†å¸ƒå¼å­˜å‚¨åœ¨å¹¶è¡Œcpuç½‘æ ¼,DESCå˜é‡å­˜å‚¨äº†å¹¶è¡Œåˆ†å¸ƒä¿¡æ¯<br />
æˆ‘ä»¬ä¹Ÿæ˜¯æŠŠå¤§é‡çš„fftç½‘æ ¼æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨åˆ°å¹¶è¡Œcpuç½‘æ ¼ä¸­å»,fftç»“æ„ä½“å°±æ˜¯è®°å½•è¿™ä¸ªåˆ†é…å…³ç³»çš„DESCå˜é‡(å°±æ˜¯fft_type_descriptorç»“æ„ä½“)</p>

<h3 id="fft-dimensions-æ•°æ®ç½‘æ ¼">FFT dimensions <strong>æ•°æ®ç½‘æ ¼</strong></h3>
<p>å¦‚<strong>å›¾:fftç½‘æ ¼å’Œsticks</strong></p>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>å˜é‡å[=åˆå€¼]</th>
      <th>æ³¨é‡Š</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>INTEGER</td>
      <td>nr1    = 0</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nr2    = 0</td>
      <td>effective FFT dimensions of the 3D grid (global)</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nr3    = 0</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nr1x   = 0</td>
      <td>FFT grids leading dimensions</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nr2x   = 0</td>
      <td>dimensions of the arrays for the 3D grid (global)</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nr3x   = 0</td>
      <td>may differ from nr1 ,nr2 ,nr3 in order to boost performances</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<p>æ³¨fftç½‘æ ¼ <code class="highlighter-rouge">nr1*nr2*nr3</code>; ä¸ºäº†åŠ é€Ÿï¼Œä½¿ç”¨çš„<code class="highlighter-rouge">nr1x*nr2x*nr3x</code>å¯èƒ½ä¸nr1,nr2,nr3ä¸ä¸€æ ·,é€šå¸¸<code class="highlighter-rouge">nr1x&gt;=nr1</code><br />
ç½‘æ ¼ç”±è¾“å…¥å‚æ•°<code class="highlighter-rouge">4*ecutoff</code>ã€<code class="highlighter-rouge">ecutrho</code>æŒ‡å®š,æˆ–ç”±è¾“å…¥å‚æ•°<code class="highlighter-rouge">nr1s,nr2s,nr3s</code>ã€<code class="highlighter-rouge">nr1,nr2,nr3</code>æŒ‡å®š</p>

<h3 id="communicators-and-processor-coordinates-cpuç½‘æ ¼">communicators and processor coordinates <strong>CPUç½‘æ ¼</strong></h3>

<blockquote>
  <p>Parallel layout: in reciprocal space data are organized in columns (sticks) along
                               the third direction and distributed across nproc processors. <br />
                               In real space data are distributed in blocks comprising sections
                               of the Y and Z directions and complete rows in the X direction in   <br />
                               a matrix of  nproc2 x nproc3  processors.  <br />
                               nproc = nproc2 x nproc3 and additional communicators are introduced
                               for data redistribution across matrix columns and rows.</p>
</blockquote>

<p>åœ¨ç¨‹åº<code class="highlighter-rouge">fft_type_allocate</code>ä¸­,æŠŠä¸€ç»´çš„cpué“¾(<code class="highlighter-rouge">dfft%comm</code>,i.e.<code class="highlighter-rouge">intra_bgrp_comm</code>)åˆ†æˆäºŒç»´ç½‘æ ¼<code class="highlighter-rouge">Y*Z</code>,<br />
Yæ–¹å‘é•¿åº¦ç”±è¾“å…¥å‚æ•°<code class="highlighter-rouge">-nyfft</code>(<code class="highlighter-rouge">-nt</code>, <code class="highlighter-rouge">-ntg</code>, <code class="highlighter-rouge">-ntask_groups</code>, <code class="highlighter-rouge">-nyfft</code>)æŒ‡å®š,é»˜è®¤ä¸º1<br />
æ²¿Yæ–¹å‘çš„ä¸€åˆ—ä¸ºä¸€ä¸ª<code class="highlighter-rouge">dfft%comm2</code>,æ²¿Zæ–¹å‘çš„ä¸º<code class="highlighter-rouge">dfft%comm3</code>
<br /> <strong>åˆ’åˆ†æ–¹å¼å¦‚ä¸‹å›¾fft:CPUäºŒç»´å¹¶è¡Œç½‘æ ¼</strong>
<br /> meta-GGAå’ŒCGç­‰æ–¹æ³•ä¸é€‚ç”¨<code class="highlighter-rouge">-nyfft</code>å‚æ•°
<br /><code class="highlighter-rouge">nyfft</code>å†³å®šYæ–¹å‘çš„commæœ‰å‡ ä¸ªprocessor,i.e.<code class="highlighter-rouge">%proc2 = nyfft</code>
<br /><code class="highlighter-rouge">nzfft</code>å†³å®šZæ–¹å‘çš„commæœ‰å‡ ä¸ªprocessor,i.e.<code class="highlighter-rouge">%proc3 = nzfft = %proc/nyfft</code>
<br /> ç¼–è¯‘å‚æ•°<code class="highlighter-rouge">-DZCOMPACT</code>æ§åˆ¶<code class="highlighter-rouge">intra_bgrp_comm</code>å†…çš„cpuæ˜¯æŒ‰ç…§Yè¿˜æ˜¯Zæ–¹å‘çš„commåˆ†å¸ƒå½¢æˆç½‘æ ¼</p>

<p><strong><center>å›¾fft:CPUäºŒç»´å¹¶è¡Œç½‘æ ¼</center></strong>
<img src="/uploads/2020/04/yzfft.jpg" alt="" /></p>

<p><strong><center>CPUäºŒç»´å¹¶è¡Œç½‘æ ¼comm</center></strong></p>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>å˜é‡å[=åˆå€¼]</th>
      <th>æ³¨é‡Š</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>LOGICAL</td>
      <td>lpara  = .FALSE.</td>
      <td>.TRUE. if parallel FFT is active <br />   æ˜¯å¦å¹¶è¡Œè®¡ç®—fft<br />å½“ä¸€ä¸ªband commå†…processorå¤§äº1æ—¶ä¸ºT</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>LOGICAL</td>
      <td>lgamma = .FALSE.</td>
      <td>.TRUE. if the grid has Gamma symmetry  <br />   åªæœ‰è®¾ç½®<code class="highlighter-rouge">K_POINTS gamma</code>æ‰ä¸ºT,é»˜è®¤1x1x1æ˜¯F</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>root   = 0</td>
      <td>root processor</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>comm   = MPI_COMM_NULL</td>
      <td>communicator for the main fft group     <br />  æ•´ä¸ªprocessor mesh , i.e. <code class="highlighter-rouge">intra_bgrp_comm</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>comm2  = MPI_COMM_NULL</td>
      <td>communicator for the fft group along the second direction     <br />   processor mesh ä¸­ Y æ–¹å‘çš„ä¸€ç»„processor</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>comm3  = MPI_COMM_NULL</td>
      <td>communicator for the fft group along the third direction     <br />   processor mesh ä¸­ Z æ–¹å‘çš„ä¸€ç»„processor</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nproc  = 1</td>
      <td>number of processor in the main fft group     <br /> CPUçš„ä¸€ç»´é“¾ç½‘æ ¼processoræ€»æ•°</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nproc2 = 1</td>
      <td>number of processor in the fft group along the second direction  <br /> CPUäºŒç»´ç½‘æ ¼,</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nproc3 = 1</td>
      <td>number of processor in the fft group along the third direction</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>mype   = 0</td>
      <td>my processor id (starting from 0) in the fft main communicator  <br />æˆ‘çš„ä¸€ç»´rank pu - 1</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>mype2  = 0</td>
      <td>my processor id (starting from 0) in the fft communicator along the second direction (nproc2)<br />æˆ‘çš„pyåæ ‡-1</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>mype3  = 0</td>
      <td>my processor id (starting from 0) in the fft communicator along the third direction (nproc3) <br />æˆ‘çš„pzåæ ‡-1</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>iproc(:,:) <br /> iproc2(:) <br /> iproc3(:)    <br />     subcommunicators proc mapping (starting from 1) <br /><code class="highlighter-rouge">desc%iproc(desc%nproc2,desc%nproc3)</code><br /><code class="highlighter-rouge"> desc%iproc2(desc%nproc)</code><br /><code class="highlighter-rouge">desc%iproc3(desc%nproc)</code></td>
      <td><code class="highlighter-rouge">pu=iproc(py,pz)</code>æ˜¯äºŒç»´CPUç½‘æ ¼ä¸­(py,pz)å¯¹åº”çš„processoråœ¨ä¸€ç»´ç½‘æ ¼commä¸­çš„åºå·(rank pu)<br /><code class="highlighter-rouge">py = iproc2(pu)</code>æŒ‡åœ¨ä¸€ç»´commä¸­çš„rank puçš„processoræ”¾åˆ°äºŒç»´CPUç½‘æ ¼ä¸­çš„Yåæ ‡<br />i.e.æ‰€åœ¨comm2çš„ä¸­çš„rank<br /><code class="highlighter-rouge">pz=iproc3(pu)</code>ä¸€ç»´commä¸­rank puçš„processoråœ¨äºŒç»´ç½‘æ ¼ä¸­çš„pzåæ ‡,i.e. æ”¾åˆ°comm3ä¸­çš„rank</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h3 id="fft-distributed-data-dimensions-and-indices">FFT distributed data dimensions and indices</h3>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>å˜é‡å[=åˆå€¼]</th>
      <th>æ³¨é‡Š</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>INTEGER</td>
      <td>my_nr3p = 0</td>
      <td>size of the â€œZâ€ section for this processor = nr3p( mype3 + 1 )    <code class="highlighter-rouge">~</code> nr3/nproc3</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>my_nr2p = 0</td>
      <td>size of the â€œYâ€ section for this processor = nr2p( mype2 + 1 )    <code class="highlighter-rouge">~</code> nr2/nproc2</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>my_i0r3p = 0</td>
      <td>offset of the first â€œZâ€ element of this proc in the nproc3 group = i0r3p( mype3 + 1 )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>my_i0r2p = 0</td>
      <td>offset of the first â€œYâ€ element of this proc in the nproc2 group = i0r2p( mype2 + 1 )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nr3p(:)</td>
      <td>size of the â€œZâ€ section of each processor in the nproc3 group along Z</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nr3p_offset(:)</td>
      <td>offset of the â€œZâ€ section of each processor in the nproc3 group along Z</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nr2p(:)</td>
      <td>size of the â€œYâ€ section of each processor in the nproc2 group along Y</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nr2p_offset(:)</td>
      <td>offset of the â€œYâ€ section of each processor in the nproc2 group along Y</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nr1p(:)</td>
      <td>number of active â€œXâ€ values ( potential ) for a given proc in the nproc2 group</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nr1w(:)</td>
      <td>number of active â€œXâ€ values ( wave func ) for a given proc in the nproc2 group</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nr1w_tg</td>
      <td>total number of active â€œXâ€ values ( wave func ). used in task group ffts</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>i0r3p(:)</td>
      <td>offset of the first â€œZâ€ element of each proc in the nproc3 group (starting from 0)</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>i0r2p(:)</td>
      <td>offset of the first â€œYâ€ element of each proc in the nproc2 group (starting from 0)</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>ir1p(:)</td>
      <td>if &gt;0 ir1p(m1) is the incremental index of the active ( potential ) X value of this proc</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>indp(:,:)</td>
      <td>is the inverse of ir1p</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>ir1w(:)</td>
      <td>if &gt;0 ir1w(m1) is the incremental index of the active ( wave func ) X value of this proc</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>indw(:,:)</td>
      <td>is the inverse of ir1w</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>ir1w_tg(:)</td>
      <td>if &gt;0 ir1w_tg(m1) is the incremental index of the active ( wfc ) X value in task group</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>indw_tg(:)</td>
      <td>is the inverse of ir1w_tg</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nst</td>
      <td>total number of sticks ( potential )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nsp(:)</td>
      <td>number of sticks per processor ( potential ) using proc index starting from 1  <br />â€¦ that is on proc mype -&gt; nsp( mype + 1 )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nsp_offset(:,:)</td>
      <td>offset of sticks per processor ( potential )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nsw(:)</td>
      <td>number of sticks per processor ( wave func ) using proc index as above</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nsw_offset(:,:)</td>
      <td>offset of sticks per processor ( wave func )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nsw_tg(:)</td>
      <td>number of sticks per processor ( wave func ) using proc index as above. task group version</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>ngl(:)</td>
      <td>per proc. no. of non zero charge density/potential components   <br /> ngl(1:intra_bgrp_commå†…å¤„ç†å™¨æ•°é‡)</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nwl(:)</td>
      <td>per proc. no. of non zero wave function plane components</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>ngm</td>
      <td>my no. of non zero charge density/potential components   <br />ngm = dfftp%ngl( dfftp%mype + 1 ) <br />with gamma sym.(gamma_only)  <br />  ngm = ( dfftp%ngl( dfftp%mype + 1 ) + 1 ) / 2  <br />  åœ¨<code class="highlighter-rouge">data_structure</code>ä¸­è®¡ç®—ï¼Œæ¯ä¸ªprocessorä¸ä¸€æ ·</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>ngw</td>
      <td>my no. of non zero wave function plane components   <br /> ngw = dffts%nwl( dffts%mype + 1 ) <br /> with gamma sym.  <br /> ngw = ( dffts%nwl( dffts%mype + 1 ) + 1 ) / 2</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>iplp(:)</td>
      <td>if &gt; 0 is the iproc2 processor owning the active â€œXâ€ value ( potential )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>iplw(:)</td>
      <td>if &gt; 0 is the iproc2 processor owning the active â€œXâ€ value ( wave func )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nnp    = 0</td>
      <td>number of 0 and non 0 sticks in a plane ( <code class="highlighter-rouge">~</code>nr1<code class="highlighter-rouge">*</code>nr2/nproc )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nnr    = 0</td>
      <td>local number of FFT grid elements  ( <code class="highlighter-rouge">~</code>nr1<code class="highlighter-rouge">*</code>nr2<code class="highlighter-rouge">*</code>nr3/nproc )  <br />  size of the arrays allocated for the FFT, local to each processor:  <br /> in parallel execution may differ from nr1x<code class="highlighter-rouge">*</code>nr2x<code class="highlighter-rouge">*</code>nr3x <br />   Not to be confused either with nr1<code class="highlighter-rouge">*</code>nr2<code class="highlighter-rouge">*</code>nr3  <br />æ¯ä¸ªå¤„ç†å™¨è´Ÿè´£çš„æœ€å¤§æ—¶ç©ºé—´ç½‘æ ¼ç‚¹,ç”¨äºåˆå§‹åŒ–Rç©ºé—´çš„ç”µè·å¯†åº¦<code class="highlighter-rouge">rho%of_r( dfftp%nnr, nspin)</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>nnr_tg = 0</td>
      <td>local number of grid elements for task group FFT ( <code class="highlighter-rouge">~</code>nr1<code class="highlighter-rouge">*</code>nr2<code class="highlighter-rouge">*</code>nr3/proc3 )</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>iss(:)</td>
      <td>index of the first rho stick on each proc</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>isind(:)</td>
      <td>for each position in the plane indicate the stick index</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>ismap(:)</td>
      <td>for each stick in the plane indicate the position</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nl(:)</td>
      <td>position of the G vec in the FFT grid</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>nlm(:)</td>
      <td>with gamma sym. position of -G vec in the FFT grid</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h4 id="task-group-alltoall-communication-layout">task group ALLTOALL communication layout</h4>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>å˜é‡å[=åˆå€¼]</th>
      <th>æ³¨é‡Š</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>tg_snd(:)</td>
      <td>number of elements to be sent in task group redistribution</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>tg_rcv(:)</td>
      <td>number of elements to be received in task group redistribution</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>tg_sdsp(:)</td>
      <td>send displacement for task group A2A communication</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER, ALLOCATABLE</td>
      <td>tg_rdsp(:)</td>
      <td>receive displacement for task group A2A communicattion</td>
      <td>Â </td>
    </tr>
    <tr>
      <td>LOGICAL</td>
      <td>has_task_groups = .FALSE.</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>CHARACTER(len=12)</td>
      <td>rho_clock_label  = â€˜ â€˜</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>CHARACTER(len=12)</td>
      <td>wave_clock_label = â€˜ â€˜</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>INTEGER</td>
      <td>grid_id</td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h2 id="module-gvectgvecsè¯´æ˜">MODULE <code class="highlighter-rouge">gvect</code>,<code class="highlighter-rouge">gvecs</code>è¯´æ˜</h2>
<p>File:<code class="highlighter-rouge">Modules/recvec.f90</code></p>

<h3 id="gvectecurhodfftpvsgvecs-4ecutwfcdffts"><code class="highlighter-rouge">gvect(ecurho,dfftp)</code>vs<code class="highlighter-rouge">gvecs (4*ecutwfc,dffts)</code></h3>

<p><code class="highlighter-rouge">gvect</code>ä¸­çš„å˜é‡éƒ½æ˜¯åœ¨ç”±<code class="highlighter-rouge">ecurho</code>å†³å®šçš„FFTç½‘æ ¼<code class="highlighter-rouge">dfftp</code>ä¸­çš„rho Gç‚¹çš„<br />
<code class="highlighter-rouge">gvecs</code>ä¸­çš„å˜é‡éƒ½æ˜¯åœ¨ç”±<code class="highlighter-rouge">4*ecutwfc</code>å†³å®šçš„FFTç½‘æ ¼<code class="highlighter-rouge">dffts</code>çš„rho Gç‚¹çš„åœ¨CPUä¸Šçš„åˆ†å¸ƒåˆå§‹åŒ–çš„,å³<br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngm_ = dfftp%ngl( dfftp%mype + 1 ) !dfftpç½‘æ ¼ä¸­,æœ¬å¤„ç†å™¨å¤„ç†çš„rho sticksä¸Šçš„Gç‚¹æ•°
ngs_ = dffts%ngl( dffts%mype + 1 ) !dfftsç½‘æ ¼ä¸­,æœ¬å¤„ç†å™¨å¤„ç†çš„rho sticksä¸Šçš„Gç‚¹æ•° 
call gvect_init ( ngm_ , intra_bgrp_comm )
call gvecs_init ( ngs_ , intra_bgrp_comm )
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>è¯´æ˜</th>
      <th>gvect</th>
      <th>gvecs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ä½ç½®,å‡ä¸º <code class="highlighter-rouge">Modules/recvec.f90</code></td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>MODULE</td>
      <td><code class="highlighter-rouge">gvect</code></td>
      <td><code class="highlighter-rouge">gvecs</code></td>
    </tr>
    <tr>
      <td>é”å®šçš„FFTç½‘æ ¼</td>
      <td><code class="highlighter-rouge">dfftp</code></td>
      <td><code class="highlighter-rouge">dffts</code></td>
    </tr>
    <tr>
      <td>comm ï¼Œå‡ä¸º<code class="highlighter-rouge">comm intra_bgrp_comm</code></td>
      <td>Â </td>
      <td>Â </td>
    </tr>
    <tr>
      <td>åœ¨FFTç½‘æ ¼ä¸­,æ¯ä¸ªå¤„ç†å™¨è´Ÿè´£çš„rho GçŸ¢é‡æ•° ,local</td>
      <td><code class="highlighter-rouge">ngm</code></td>
      <td><code class="highlighter-rouge">ngms</code></td>
    </tr>
    <tr>
      <td>åœ¨FFTç½‘æ ¼ä¸­,å…¨éƒ¨å¤„ç†å™¨è´Ÿè´£çš„rho GçŸ¢é‡æ•°çš„æœ€å¤§å€¼,max</td>
      <td><code class="highlighter-rouge">ngmx</code></td>
      <td><code class="highlighter-rouge">ngsx</code></td>
    </tr>
    <tr>
      <td>åœ¨FFTç½‘æ ¼ä¸­,å…¨éƒ¨å¤„ç†å™¨è´Ÿè´£çš„rho GçŸ¢é‡æ•°çš„åŠ å’Œ,global</td>
      <td><code class="highlighter-rouge">ngm_g</code></td>
      <td><code class="highlighter-rouge">ngms_g</code></td>
    </tr>
    <tr>
      <td>?? number of G-vector shells</td>
      <td><code class="highlighter-rouge">ngl</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td>FFTç½‘æ ¼çš„ rho cutoff energy</td>
      <td><code class="highlighter-rouge">ecutrho</code></td>
      <td><code class="highlighter-rouge">ecuts=4*ecutwfc</code></td>
    </tr>
    <tr>
      <td>FFTç½‘æ ¼çš„ rho Gæˆªæ–­ <script type="math/tex">gcut = |G|^2</script> <code class="highlighter-rouge">= ecutoff/(2 /pi/a)^2</code></td>
      <td><code class="highlighter-rouge">gcutm</code><br /> <code class="highlighter-rouge">=ecutrho/(2 pi/a)^2 </code></td>
      <td><code class="highlighter-rouge">gcutms</code><br /> <code class="highlighter-rouge">= ecuts/(2 pi/a)^2</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">dffts</code>ä¸<code class="highlighter-rouge">dfftp</code>ä¹‹é—´çš„è”ç³»<code class="highlighter-rouge">dual</code> <br /><code class="highlighter-rouge">dual=ecutrho/ecutwfc</code>  <br /> é»˜è®¤  <code class="highlighter-rouge">ecutrho  = 4*ecutwfc</code>  <br />   USPP <code class="highlighter-rouge">= (8~12)*ecutwfc</code> <br /> PAW <code class="highlighter-rouge">= 4*ecutwfc</code></td>
      <td>Â </td>
      <td><code class="highlighter-rouge">dual</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">doublegrid</code>     <br />  true if smooth and dense grid differ doublegrid = (dual &gt; 4)<br />USPPç­‰æƒ…å†µä¸ºT</td>
      <td>Â </td>
      <td><code class="highlighter-rouge">LOGICAL :: doublegrid</code></td>
    </tr>
  </tbody>
</table>

<p><br /><strong>gvectä¸­è¿˜å®šä¹‰äº†å¾ˆå¤šå˜é‡ï¼Œæ¯”å¦‚è®¡ç®—åŠ¨èƒ½çš„å€’æ ¼å¤±<code class="highlighter-rouge">g(:,:)</code></strong>ï¼Œè§ä¸‹è¡¨,<strong>gvecsåœ¨QE-6.4.1ä¸­ç›®å‰ä»…å®šä¹‰ä¸Šé¢7ä¸ªå˜é‡</strong></p>

<h3 id="gvect-ä¸­æ›´å¤šçš„å˜é‡">gvect ä¸­æ›´å¤šçš„å˜é‡</h3>

<p>éœ€è¦å†ç»§ç»­è¡¥å……</p>

<table>
  <thead>
    <tr>
      <th>è¯´æ˜</th>
      <th>gvect</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">G</code></td>
      <td><code class="highlighter-rouge">g(:,:)</code></td>
      <td><code class="highlighter-rouge">g(3, ngm)</code>ï¼Œåˆ†å¸ƒå¼åˆ†å¸ƒ, æ˜¯åŒ…å«äº†æ‰€æœ‰çš„Gæ ¼å¼<br />gç‰©ç†ä¸Šæ˜¯ä¸kæ— å…³çš„,ä½†æ˜¯æ¯ä¸ªprocessoråœ¨ä¸åŒçš„kç‚¹å¤„ç†çš„npwåºåˆ—ä¸åŒ<br />(å³<script type="math/tex">G_{m}</script>çš„må–å€¼èŒƒå›´ä¸åŒ,å› æ­¤è¿˜æœ‰è§’æ ‡k)ï¼Œ<br /> æ‰€ä»¥è¦è½¬æ¢ä¸€ä¸‹igk_k<br />å¦‚<code class="highlighter-rouge">k+G</code>çš„è®¡ç®—<code class="highlighter-rouge"> xk(1,ik) + g( 1, igk_k(1:npw,ik) )</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">|G|^2</code></td>
      <td><code class="highlighter-rouge"> gg(:) </code></td>
      <td><code class="highlighter-rouge">gg(ngm)</code> <br /> <code class="highlighter-rouge">gg(i)=g(1,i)**2 + g(2,i)**2 + g(3,i)**2</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">G=0</code></td>
      <td><code class="highlighter-rouge">gstart</code></td>
      <td>å¦‚æœgammaç‚¹(G=0)åœ¨æœ¬å¤„ç†å™¨,<code class="highlighter-rouge">gstart=2</code>,ELSE,<code class="highlighter-rouge">gstart=1</code></td>
    </tr>
    <tr>
      <td>Â </td>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h2 id="module-gvecw"><code class="highlighter-rouge">MODULE gvecw</code></h2>
<p>File:<code class="highlighter-rouge">Modules/gvecw.f90</code><br /></p>

<table>
  <thead>
    <tr>
      <th>å˜é‡</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">ecutwfc</code></td>
      <td>è¾“å…¥å‚æ•°<code class="highlighter-rouge">ecutwfc</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">gcutw</code></td>
      <td><code class="highlighter-rouge">gcutw = ecutwfc / tpiba2</code></td>
    </tr>
    <tr>
      <td>Â </td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h2 id="sticks_mapç»“æ„ä½“å®šä¹‰"><code class="highlighter-rouge">sticks_map</code>ç»“æ„ä½“å®šä¹‰</h2>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
å®šä¹‰åœ¨<strong>è¡¨:sticks_mapç»“æ„ä½“å®šä¹‰</strong>ä¸­,é‡Œé¢çš„ç›¸å…³å˜é‡ï¼Œè§£é‡Šå¦‚ä¸‹:</p>

<p>ç”±å»ºç«‹è¿‡ç¨‹<strong>å›¾:sticks_map_allocateåˆ›å»ºsticksç½‘æ ¼</strong></p>
<ul>
  <li><code class="highlighter-rouge">lb</code> sticksç•Œé™</li>
  <li><code class="highlighter-rouge">ub</code> sticksç•Œé™</li>
</ul>

<p>äºŒç»´:sticks<code class="highlighter-rouge">(i1,i2)</code>,æ ¹æ®<strong>å›¾:sticksçš„ä¸€ç»´å½¢å¼</strong>,<code class="highlighter-rouge">(i1,i2)</code>ä¸å…¶ä¸€ç»´ç¼–å·<code class="highlighter-rouge">ind</code>ä¹‹é—´çš„è½¬æ¢å…³ç³»ä¸º</p>

<ul>
  <li><code class="highlighter-rouge">ind = smap%indmap(i1,i2)</code></li>
  <li><code class="highlighter-rouge">i1 =  smap%ist(ind,1)</code></li>
  <li><code class="highlighter-rouge">i2 =  smap%ist(ind,2)</code></li>
</ul>

<p>æŒ‰ç…§sitcksä¸Šçš„Gç‚¹æ’å,ç¬¬<code class="highlighter-rouge">ni</code>åå¯¹åº”çš„ä¸€ç»´ç¼–å·æ˜¯<code class="highlighter-rouge">ind = smap%idx(ni)</code>,å¦‚<strong>å›¾:sticksçš„ä¸€ç»´å½¢å¼</strong></p>

<p>æœ€ç»ˆå»ºç«‹çš„stickså¦‚<strong>å›¾:fftsä¸fftpåœ¨sticksä¸­çš„ä½ç½®å’Œä»–ä»¬å„è‡ªçš„æ¿€æ´»åŒºåŸŸ</strong></p>

<p>æ ¹æ®<strong>ç»„å›¾:è´Ÿè´£sticksçš„processor</strong>,æŠŠsticksç©ºé—´ä¸­<code class="highlighter-rouge">i1</code>ç›¸åŒçš„sticksä»¬<code class="highlighter-rouge">(i1,:)</code>ä½œä¸ºå•å…ƒåˆ†é…ç»™CPUç½‘æ ¼ä¸­çš„ä¸€è¡Œ(<code class="highlighter-rouge">py</code>ç›¸åŒçš„cpuä»¬,i.e. comm3)<br />
åœ¨åŒä¸€è¡Œ,åˆæŠŠ<code class="highlighter-rouge">(i1,i2)</code>åˆ†åˆ°è¯¥è¡Œå„ä¸ªprocessorä¸Š<br />
æœ€åçš„ç»“æœå°±æ˜¯sticks<code class="highlighter-rouge">(i1,i2)</code>è¢«rank <code class="highlighter-rouge">pu = smap%stown(i1,i2)</code>çš„processorå¤„ç†</p>

<p><strong><center>è¡¨:sticks_mapç»“æ„ä½“å®šä¹‰</center></strong></p>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>å˜é‡</th>
      <th>æ³¨é‡Š        <br />(å¤‡æ³¨)</th>
      <th>Â </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">LOGICAL</code></td>
      <td><code class="highlighter-rouge">lgamma=.false.</code></td>
      <td>if .true. the map has gamma symmetry</td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">LOGICAL</code></td>
      <td><code class="highlighter-rouge">lpara=.false.</code></td>
      <td>if .true. the map is set for parallel and serial, if .false. only serial  <br /> <code class="highlighter-rouge">lpara =  nproc &gt; 1</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">mype=0</code></td>
      <td>my task id (starting from 0)     <br />     åŒdfft</td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">nproc=1</code></td>
      <td>number of task (as nproc in fft_type_descriptor)     <br />      åŒdfft</td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">nyfft=1</code></td>
      <td>number processors in y-direction (as nproc2 in fft_type_descriptor)     <br />    åŒdfft</td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER, ALLOCATABLE</code></td>
      <td><code class="highlighter-rouge">iproc(:,:)</code></td>
      <td>the processor index (as in fft_type_descriptor)     <br /> åŒdfft,<code class="highlighter-rouge">N(Y,Z)</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER, ALLOCATABLE</code></td>
      <td><code class="highlighter-rouge">iproc2(:)</code></td>
      <td>the Y group processor index (as in fft_type_descriptor)     <br /> åŒdfft,<code class="highlighter-rouge">Z(N)</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">comm     = MPI_COMM_NULL</code></td>
      <td>communicator of the fft gruop    <br />   æ€»CPUç½‘æ ¼(dfft%comm)</td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">nstx=0</code></td>
      <td>a safe maximum number of sticks on the map   <br /> sticksçš„æœ€å¤§æ•°é‡ <br /> <code class="highlighter-rouge">nstx = (ub(1)-lb(1)+1)*(ub(2)-lb(2)+1)</code>  <br />  <script type="math/tex">N_{GX} \cdot N_{GY}</script></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">lb(3)=0</code></td>
      <td>mapâ€™s lower bounds <br /> <code class="highlighter-rouge">lb    = - ub</code>    <br />   <script type="math/tex">G_{min} = -\frac{ (N_{G} - 1)}{2}</script></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER</code></td>
      <td><code class="highlighter-rouge">ub(3)=0</code></td>
      <td>mapâ€™s upper bounds  <br /> <code class="highlighter-rouge">ub(1) = ( nr1 - 1 ) / 2</code>  <br />   <script type="math/tex">G_{max} = \frac{ (N_{G} - 1)}{2}</script></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER, ALLOCATABLE</code></td>
      <td><code class="highlighter-rouge">idx(:)</code></td>
      <td>the index of each stick  <br />  <code class="highlighter-rouge">smap%idx( nstx )</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER, ALLOCATABLE</code></td>
      <td><code class="highlighter-rouge">ist(:,:)</code></td>
      <td>the cartesian coordinates of each stick   <br />  <code class="highlighter-rouge">smap%ist( nstx , 2)</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER, ALLOCATABLE</code></td>
      <td><code class="highlighter-rouge">stown(:,:)</code></td>
      <td>the owner of each stick     <br /> <code class="highlighter-rouge">smap%stown ( lb(1):ub(1), lb(2):ub(2) )</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">INTEGER, ALLOCATABLE</code></td>
      <td><code class="highlighter-rouge">indmap(:,:)</code></td>
      <td>the index of each stick (represented on the map)   <br />   <code class="highlighter-rouge">smap%indmap ( lb(1):ub(1), lb(2):ub(2) )</code></td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">REAL(DP)</code></td>
      <td><code class="highlighter-rouge">bg(3,3)</code></td>
      <td>base vectors, the generators of the mapped space     <br />  å°±æ˜¯å€’æ ¼å¤±<code class="highlighter-rouge">bg</code></td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<h2 id="åˆå§‹åŒ–æµç¨‹data_structureåˆå§‹åŒ–å…¥å£">åˆå§‹åŒ–æµç¨‹:<code class="highlighter-rouge">data_structure</code>åˆå§‹åŒ–å…¥å£</h2>
<p>File: <code class="highlighter-rouge">PW/src/data_structure.f90</code><br />
è¢«<code class="highlighter-rouge">PW/src/init_run.f90 -&gt; init_run()</code>è°ƒç”¨<code class="highlighter-rouge">CALL data_structure( gamma_only )</code><br />
åœ¨ç»“æ„ä¼˜åŒ–ç»“æŸåï¼Œä¼šé‡æ–°ç”Ÿæˆç½‘æ ¼ç‚¹,kçŸ¢é‡ï¼Œè¿›è¡Œæœ€åä¸€æ¬¡è®¡ç®—ï¼Œä¼šå†æ¬¡é€šè¿‡<code class="highlighter-rouge">init_run()</code>è°ƒç”¨æœ¬å…¥å£<br />
fftç½‘æ ¼åˆå§‹åŒ–å…¥å£: åˆå§‹åŒ–fftç½‘æ ¼å’Œsticks</p>

<h3 id="è®¡ç®—dfftsä¸dfftpæˆªæ–­èƒ½">è®¡ç®—<code class="highlighter-rouge">dffts</code>ä¸<code class="highlighter-rouge">dfftp</code>æˆªæ–­èƒ½</h3>

<table>
  <thead>
    <tr>
      <th><script type="math/tex">G_{cut}</script></th>
      <th>dffs</th>
      <th>dfftp</th>
      <th>å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">gkcut</code></td>
      <td><code class="highlighter-rouge">gkcut = max{sqrt(|k|^2)}</code>,<br />then<code class="highlighter-rouge">gkcut = (sqrt (gcutw) + gkcut)**2</code>,<br />å³ <script type="math/tex">\left | \sqrt{G_{ecutwfc}} + k_{max}  \right |^{2}</script></td>
      <td><code class="highlighter-rouge">gcutm/4.0</code>,æ— é¡»è®¡ç®—</td>
      <td>Â </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">gcut</code></td>
      <td><code class="highlighter-rouge">gcutms</code>æ— é¡»è®¡ç®—</td>
      <td><code class="highlighter-rouge">gcutm</code>æ— é¡»è®¡ç®—</td>
      <td>Â </td>
    </tr>
  </tbody>
</table>

<p><strong>æ³¨:ç½‘æ ¼ç‚¹çš„æˆªæ–­èƒ½<code class="highlighter-rouge">gcutm,gcutms</code>å·²ç»åœ¨<code class="highlighter-rouge">PW/src/setup.f90 -&gt; setup()</code>ä»¥åŠ<code class="highlighter-rouge">iosys()</code>ä¸­è®¡ç®—è¿‡äº†ï¼Œå¦‚å›¾:dfftsä¸dfftpç½‘æ ¼</strong></p>
<ul>
  <li><code class="highlighter-rouge">gcutw = ecutwfc / tpiba2</code></li>
  <li><code class="highlighter-rouge">gcutms=4.D0 * ecutwfc / tpiba2</code></li>
  <li><code class="highlighter-rouge">gcutm=ecutrho/tpiba2</code></li>
</ul>

<h3 id="fft_type_initè¢«è°ƒç”¨ä¸¤æ¬¡åˆå§‹åŒ–ä¸¤ä¸ªfftç½‘æ ¼dfftsdfftpsticksç½‘æ ¼smap"><code class="highlighter-rouge">fft_type_init</code>è¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªFFTç½‘æ ¼<code class="highlighter-rouge">dffts,dfftp</code>,sticksç½‘æ ¼<code class="highlighter-rouge">smap</code></h3>
<p>File:<code class="highlighter-rouge">PW/src/data_structure.f90</code></p>

<p>å¯ä»¥çœ‹åˆ°åœ¨<code class="highlighter-rouge">fft_type_init</code>æ‰§è¡Œå,<code class="highlighter-rouge">dffts</code>ä¸<code class="highlighter-rouge">dfftp</code>å®é™…ä½¿ç”¨çš„<code class="highlighter-rouge">gkcut</code>å’Œ<code class="highlighter-rouge">gcut</code>å°±æ˜¯ä¸Šè¡¨</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!=== dffts
  CALL fft_type_init( dffts, smap, "wave", gamma_only, lpara, intra_bgrp_comm,&amp;
       at, bg, gkcut, gcutms/gkcut, fft_fact=fft_fact, nyfft=nyfft )
       !For "wave"   gkcut = gcut_in &lt;-&gt;  gkcut
       !             gcut  = gkcut * dual &lt;-&gt; gkcut * (gcutms/gkcut) = gcutms
!===dfftp
  CALL fft_type_init( dfftp, smap, "rho" , gamma_only, lpara, intra_bgrp_comm,&amp;
       at, bg, gcutm , 4.d0, fft_fact=fft_fact, nyfft=nyfft )
       !For "rho"         gcut  = gcut_in &lt;-&gt; gcutm
       !                  gkcut = gcut / dual = gcutm / 4.0
</code></pre></div></div>

<p><strong>æµç¨‹:</strong><br /></p>
<ul>
  <li>è®¡ç®—æˆªæ–­èƒ½<code class="highlighter-rouge">gcut</code>(rho) and <code class="highlighter-rouge">gkcut</code>(wave)</li>
  <li>åˆå§‹åŒ–FFTç½‘æ ¼<code class="highlighter-rouge">call fft_type_allocate(...)</code><br />
<code class="highlighter-rouge">CALL fft_type_allocate( dfft, at, bg, gcut, comm, fft_fact=fft_fact, nyfft=nyfft )</code>
    <ul>
      <li>è®¾ç½®äºŒç»´CPUç½‘æ ¼,æ•´ä¸ªcpuç½‘æ ¼çš„çˆ¶å¹¶è¡Œä¿¡æ¯(desc%comm=comm=intra_bgrp_comm)<br />
 Yæ–¹å‘æœ‰<code class="highlighter-rouge">nyfft=desc%nproc2</code>ä¸ªå¤„ç†å™¨,Zæ–¹å‘æœ‰<code class="highlighter-rouge">nzfft=desc%nproc3</code>ä¸ªå¤„ç†å™¨.</li>
      <li><code class="highlighter-rouge">call realspace_grid_init(...)</code>, è®¡ç®—ä¸‰ç»´æ•°æ®ç½‘æ ¼ç»´åº¦<code class="highlighter-rouge">nr1,nr2,nr3</code>,i.e. <script type="math/tex">{N_G} = a \cdot G_{cut}</script></li>
      <li><code class="highlighter-rouge">ALLOCATE(dfft%xxxx)</code>,å¹¶èµ‹åˆå€¼</li>
    </ul>
  </li>
  <li>åˆå§‹åŒ–stick<code class="highlighter-rouge">call sticks_map_allocate(...)</code><br />
<code class="highlighter-rouge">CALL sticks_map_allocate( smap, lgamma, dfft%lpara, dfft%nproc2, dfft%iproc, dfft%iproc2, dfft%nr1, dfft%nr2, dfft%nr3, bg, dfft%comm )</code><br />
File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
   åˆå§‹åŒ–sticks,è®¡ç®—sticksçš„ä¸Šä¸‹é™,å¤åˆ¶<code class="highlighter-rouge">dfft%</code>çš„å¹¶è¡Œå‚æ•°åˆ°<code class="highlighter-rouge">smap%</code><br />
   å› ä¸º<code class="highlighter-rouge">dffts</code>å’Œ<code class="highlighter-rouge">dfftp</code>,ä½¿ç”¨åŒä¸€ä¸ªsmap,æ‰€ä»¥ç¬¬äºŒæ¬¡åˆå§‹åŒ–ä¼šä¿ç•™ä¸Šæ¬¡åˆå§‹åŒ–çš„ä¿¡æ¯ï¼Œåœ¨åé¢æ–°å¢åŠ æ•°æ®
    <ul>
      <li>åœ¨<code class="highlighter-rouge">fft_type_init( dffts, smap, ...,...)</code>æƒ…å†µé¦–æ¬¡åˆå§‹åŒ–<code class="highlighter-rouge">smap</code>,åˆå§‹åŒ–æ“ä½œæœ‰:<br />
å¤åˆ¶<code class="highlighter-rouge">dfft</code>çš„å¹¶è¡Œä¿¡æ¯åˆ°<code class="highlighter-rouge">smap%comm, smap%mype, smap%nproc</code>,<code class="highlighter-rouge">comm</code>ä¸º<code class="highlighter-rouge">intra_bgrp_comm</code><br />
ä¼ å…¥çš„æ‰€æœ‰dfftå‚é‡<code class="highlighter-rouge">nyfft</code>ç­‰<br />
è®¡ç®—<code class="highlighter-rouge">%lb,%up</code>,<script type="math/tex">G_{max} = \frac{ (N_{G} - 1)}{2}</script> and <script type="math/tex">G_{min} = -\frac{ (N_{G} - 1)}{2}</script> <br />
è®¡ç®—<code class="highlighter-rouge">%nstx</code>,<code class="highlighter-rouge">nstx = (ub(1)-lb(1)+1)*(ub(2)-lb(2)+1)</code>,æ‰€æœ‰çš„éALLOCATEå˜é‡éƒ½ç¡®å®š<br />
ALLOCATE(smap%stown ,smap%indmap,smap%idx,smap%ist),å‡åˆå§‹ä¸º0<br />
ç¨‹åº<code class="highlighter-rouge">RETURN</code>å,ä¼šæœ‰å…¶ä»–ç¨‹åºç»§ç»­è®¾ç½®è¿™äº›å˜é‡</li>
      <li>åœ¨<code class="highlighter-rouge">fft_type_init( dfftp, smap, ...,...)</code>æƒ…å†µä¼šæ£€æµ‹åˆ°<code class="highlighter-rouge">smap</code>å·²åˆå§‹åŒ–(è¢«wave) <br />
è‹¥<code class="highlighter-rouge">ecutrho &lt;= 4*ecutwfc</code> ä¸æ“ä½œ<br />
è‹¥<code class="highlighter-rouge">ecutrho &gt;  4*ecutwfc</code>, i.e. <script type="math/tex">N_G^{n} > N_G^{Wave}</script>ï¼Œé‡æ–°åˆå§‹åŒ–<br />
é‡æ–°åˆå§‹åŒ–æ“ä½œ:å¤‡ä»½<code class="highlighter-rouge">smap%stown ,smap%indmap,smap%idx,smap%ist </code><br />
<code class="highlighter-rouge">DEALLOCATE</code>,then,<code class="highlighter-rouge">ALLOCATE</code><br />
æ¢å¤æ—§å¤‡ä»½,æ­¤æ—¶<code class="highlighter-rouge">smap%stown ,smap%indmap,smap%idx,smap%ist </code><br />
ä¸ºä¸Šä¸€æ¬¡<code class="highlighter-rouge">fft_type_init( dffts, smap, "wave",...)</code>å®Œå…¨æ‰§è¡Œåçš„ç»“æœ</li>
    </ul>
  </li>
  <li>æ ¹æ®<code class="highlighter-rouge">smap</code>ä¸­<code class="highlighter-rouge">%nproc,%up,%down</code>å˜é‡ALLOCATE<code class="highlighter-rouge">nstp, nstpw, sstp, sstpw, st, stw</code>ç”¨äºåç»­è®¡ç®—</li>
  <li>å»ºç«‹sticksä¸CPUç½‘æ ¼é—´çš„è”ç³»<code class="highlighter-rouge">get_sticks</code><br />
File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
æŒ‰ç…§é¡ºåº( [dffts:gkcut -&gt; gcut] -&gt; [dfftp:gkcut -&gt; gcut])åˆå§‹åŒ–sticks
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL get_sticks(  smap, gkcut,...)
CALL get_sticks(  smap, gcut,...)
</code></pre></div>    </div>
    <p>æŠŠ<code class="highlighter-rouge">sticks%</code>çš„æ€§è´¨åŠæ•´ä¸ªsticksç½‘ç»œåˆ›å»ºå®Œæˆ</p>
  </li>
  <li>fft_type_set(dfft,smap%xxx,â€¦)
æ ¹æ®<code class="highlighter-rouge">smap%</code>ç­‰å’Œ<code class="highlighter-rouge">get_sticks</code>å¾—åˆ°çš„å˜é‡ï¼Œè®¾ç½®<code class="highlighter-rouge">dfft%</code>å±æ€§,å»ºç«‹FFTæ ¼ç‚¹å’Œsticksæ ¼ç‚¹å’ŒCPUæ ¼ç‚¹é—´çš„å…³ç³»<br />
å…¨å±€ä¿¡æ¯å’Œå±€åŸŸä¿¡æ¯,æˆ‘(processor)å¤„ç†çš„æ ¼ç‚¹æœ‰</li>
</ul>

<h4 id="æ ¹æ®persrhowaveè®¡ç®—gkcutandgcut">æ ¹æ®<code class="highlighter-rouge">pers="rho"/"wave"</code>è®¡ç®—<code class="highlighter-rouge">gkcut</code>and<code class="highlighter-rouge">gcut</code></h4>
<p><br /><br /><br /></p>

<h4 id="fft_type_allocate">fft_type_allocate</h4>

<h5 id="åˆ’åˆ†å¹¶è¡Œcpuç½‘æ ¼">åˆ’åˆ†å¹¶è¡ŒCPUç½‘æ ¼</h5>
<p>File:<code class="highlighter-rouge">æœ¬æ–‡ä»¶</code><br />
å¦‚<strong>å›¾:fft_type_allocateåˆ’åˆ†CPUç½‘æ ¼</strong>,å°†comm(i.e. <code class="highlighter-rouge">intra_bgrp_comm</code>,å…±dfft%nrpocä¸ªprocessor)åˆ’åˆ†ä¸º<code class="highlighter-rouge">nyfft*nzfft=dfft%nrpoc2*dfft%nrproc3</code>çš„processorç½‘æ ¼</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL fft_type_allocate( dfft, at, bg, gcut, comm, fft_fact=fft_fact, nyfft=nyfft )
</code></pre></div></div>
<p><strong>æ³¨æ„:<code class="highlighter-rouge">%mype,%mype2,%mype2</code>çš„èµ·å§‹åæ ‡æ˜¯0,å› æ­¤åé¢å¸¸å¸¸ç”¨<code class="highlighter-rouge">var(dfft%mype+1)</code>è¡¨ç¤ºç›¸åº”cpuçš„æ€§è´¨</strong><br />
<strong><center>å›¾:fft_type_allocateåˆ’åˆ†CPUç½‘æ ¼</center></strong>
<img src="/uploads/2020/04/fft_type_init1.jpg" alt="" /></p>

<p><br /><br /><br /></p>

<h5 id="realspace_grid_initè®¡ç®—fftç½‘æ ¼"><code class="highlighter-rouge">realspace_grid_init</code>è®¡ç®—FFTç½‘æ ¼</h5>
<p>File:<code class="highlighter-rouge">æœ¬æ–‡ä»¶</code><br />
è®¡ç®—ç½‘æ ¼å¤§å°<code class="highlighter-rouge">nr1*nr2*nr3</code>,å¹¶è®¡ç®—æœ€ä¼˜çš„<code class="highlighter-rouge">nr1x*nr2x*nr3x</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL realspace_grid_init( desc, at, bg, gcutm, fft_fact )
</code></pre></div></div>

<p><strong><center>å›¾:realspace_grid_initåˆ’åˆ†FFTç½‘æ ¼</center></strong>
<img src="/uploads/2020/04/realspace_grid_init.png" alt="" /></p>

<p><br /><br /><br /></p>

<h4 id="sticks_map_allocate-ç”±fftç½‘æ ¼å»ºç«‹sticksç½‘æ ¼"><code class="highlighter-rouge">sticks_map_allocate</code> ç”±FFTç½‘æ ¼å»ºç«‹sticksç½‘æ ¼</h4>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
åˆ›å»ºsticksç½‘æ ¼,å¤åˆ¶<code class="highlighter-rouge">dfft%</code>å¹¶è¡Œå‚æ•°ï¼Œå¦‚<strong>å›¾:sticks_map_allocateåˆ›å»ºsticksç½‘æ ¼</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     CALL sticks_map_allocate( smap, lgamma, dfft%lpara, dfft%nproc2, &amp;
          dfft%iproc, dfft%iproc2, dfft%nr1, dfft%nr2, dfft%nr3, bg, dfft%comm )
</code></pre></div></div>
<p><strong><center>å›¾:sticks_map_allocateåˆ›å»ºsticksç½‘æ ¼</center></strong>
<img src="/uploads/2020/04/sticks_map_allocate.png" alt="" /></p>

<p><br /><br /><br /></p>

<h4 id="åˆå§‹åŒ–å˜é‡ç”¨äºåç»­è®¡ç®—">åˆå§‹åŒ–å˜é‡,ç”¨äºåç»­è®¡ç®—</h4>

<p>æ ¹æ®<code class="highlighter-rouge">gckut</code>å’Œ<code class="highlighter-rouge">gcut</code>å¯¹åº”ä¸¤å¥—sticks:wave and rho,ä¸¤æ¬¡åˆå§‹åŒ–smap,å®šä¹‰ä¸åŒçš„å˜é‡,å¦‚<strong>è¡¨:wave&amp;rhoâ€™s sticksè¾…åŠ©å˜é‡è¡¨</strong>,æ–¹ä¾¿åç»­è®¡ç®—<br /></p>

<p>waveå’Œrhoéƒ½æœ‰sticksï¼Œè¡¨æ ¼ä¸­çš„sticksæ˜¯ç›¸åº”åˆ—çš„sticks,å¦‚<code class="highlighter-rouge">stw(i1,i2)</code>æ˜¯å¤„ç†wave sticks<code class="highlighter-rouge">(i1,i2)</code>çš„processorä¸€ç»´ç¼–å·</p>

<p><strong><center>è¡¨:wave&amp;rho's sticksè¾…åŠ©å˜é‡è¡¨</center></strong></p>

<table>
  <thead>
    <tr>
      <th>å«ä¹‰</th>
      <th>wave sticks</th>
      <th>rho sticks</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><script type="math/tex">G_{cutoff}</script></td>
      <td><code class="highlighter-rouge">gckut</code></td>
      <td><code class="highlighter-rouge">gcut</code></td>
    </tr>
    <tr>
      <td>æ€»sticksæ•°é‡</td>
      <td><code class="highlighter-rouge">nstw</code></td>
      <td><code class="highlighter-rouge">nst</code></td>
    </tr>
    <tr>
      <td>sticksæ ¼ç‚¹(i1,i2)ä¸Šçš„Gç‚¹æ•°(ä¸­é—´å˜é‡)</td>
      <td><code class="highlighter-rouge">stw(i1,i2)</code></td>
      <td><code class="highlighter-rouge">st(i1,i2)</code></td>
    </tr>
    <tr>
      <td>sticksæ ¼ç‚¹(i1,i2)è¢«å“ªä¸ªcpuå¤„ç†(æœ€ç»ˆç»“æœ)ï¼Œä¸€ç»´ç¼–å·</td>
      <td><code class="highlighter-rouge">stw(i1,i2)</code></td>
      <td><code class="highlighter-rouge">st(i1,i2)</code></td>
    </tr>
    <tr>
      <td>ä¸€ç»´puå¤„ç†å™¨å¤„ç†çš„sticksä¸Šçš„Gç‚¹æ€»æ•°</td>
      <td><code class="highlighter-rouge">sstpw(pu)</code></td>
      <td><code class="highlighter-rouge">sstp(pu)</code></td>
    </tr>
    <tr>
      <td>ä¸€ç»´puå¤„ç†å™¨å¤„ç†çš„sticksä¸Šçš„sticksæ€»æ•°</td>
      <td><code class="highlighter-rouge">nstpw(pu)</code></td>
      <td><code class="highlighter-rouge">nstp(pu)</code></td>
    </tr>
    <tr>
      <td>æˆ‘(processor)å¤„ç†çš„Gç‚¹æ€»æ•°<br /><code class="highlighter-rouge">ngw=sstpw(smap%mype+1)</code><br /><code class="highlighter-rouge">ngm=sstp(smap%mype+1)</code></td>
      <td><code class="highlighter-rouge">ngw</code></td>
      <td><code class="highlighter-rouge">ngm</code></td>
    </tr>
  </tbody>
</table>

<p><br /><br /><br />
<br /><br /><br /></p>

<h4 id="get_stickså»ºç«‹sticksä¸cpuç½‘æ ¼é—´çš„è”ç³»"><code class="highlighter-rouge">get_sticks</code>å»ºç«‹sticksä¸CPUç½‘æ ¼é—´çš„è”ç³»</h4>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
sticksæŒ‡<code class="highlighter-rouge">(i1,i2)</code>å¯¹åº”çš„ç½‘æ ¼ç‚¹ä¸Šï¼Œå­˜åœ¨i3ä½¿å¾—<br />
<script type="math/tex">% <![CDATA[
\left |  G(i1,i2,i3)  \right | ^{2} = \left |  i1\cdot b1+i2\cdot b2+i3\cdot b3)  \right | ^{2} <= G_{cutoff} %]]></script><br />
åˆ™<code class="highlighter-rouge">(i2,i3)</code>æ˜¯å¯¹åº”<script type="math/tex">G_{cutoff}</script>ä¸Šçš„sticks.<br />
ä½¿ç”¨<strong>è¡¨:wave&amp;rhoâ€™s sticksè¾…åŠ©å˜é‡è¡¨</strong>ä¸­çš„<script type="math/tex">G_{cutoff}</script>åˆå§‹åŒ–ä¸¤æ¬¡<code class="highlighter-rouge">smap</code>,è®¡ç®—è¡¨ä¸­çš„å˜é‡<br />
ç¬¬äºŒæ¬¡åˆå§‹åŒ–ä¼šå¤‡ä»½ç¬¬ä¸€æ¬¡çš„ç»“æœ,åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­åˆ›å»ºsticksç´¢å¼•/åˆ†é…cpu(<code class="highlighter-rouge">%stown</code>)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     CALL get_sticks(  smap, gkcut, nstpw, sstpw, stw, nstw, ngw )
     CALL get_sticks(  smap, gcut,  nstp, sstp, st, nst, ngm )
</code></pre></div></div>
<p><br /><br /></p>

<h5 id="sticks_map_setç»Ÿè®¡å„ä¸ªsticksä¸Šçš„gç‚¹æ•°sti1i2"><code class="highlighter-rouge">sticks_map_set</code>ç»Ÿè®¡å„ä¸ªsticksä¸Šçš„Gç‚¹æ•°:st(i1,i2)</h5>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
è§<strong>å›¾:sticks &amp; sticks_map_set</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL sticks_map_set( smap%lgamma, smap%ub, smap%lb, smap%bg, gcut, st, smap%comm )
</code></pre></div></div>
<p><strong><center>å›¾:sticks &amp; sticks_map_set</center></strong>
<img src="/uploads/2020/04/get_sticks_1.jpg" alt="" />
<br /><br /></p>

<h5 id="sticks_map_indexæŠŠäºŒç»´çš„sticksç´¢å¼•å˜ä¸ºä¸€ç»´ç´¢å¼•"><code class="highlighter-rouge">sticks_map_index</code>æŠŠäºŒç»´çš„sticksç´¢å¼•å˜ä¸ºä¸€ç»´ç´¢å¼•</h5>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
å»ºç«‹sticksçš„ä¸€ç»´ç´¢å¼•<code class="highlighter-rouge">ind</code>,ä»¥åŠindä¸Šçš„Gç‚¹æ•°<code class="highlighter-rouge">ngc(ind)</code>,å¦‚<strong>å›¾:sticksçš„ä¸€ç»´å½¢å¼</strong><br /></p>
<ul>
  <li><code class="highlighter-rouge">ind = smap%indmap(i1,i2)</code></li>
  <li><code class="highlighter-rouge">i1 =  smap%ist(ind,1)</code></li>
  <li><code class="highlighter-rouge">i2 =  smap%ist(ind,2)</code></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      CALL sticks_map_index( smap%ub, smap%lb, st, smap%ist(:,1), smap%ist(:,2), ngc, smap%indmap )
</code></pre></div></div>
<p><br /><br /></p>

<h5 id="sticks_sort_newå¯¹ä¸€ç»´sticksç´¢å¼•æ’åº"><code class="highlighter-rouge">sticks_sort_new</code>å¯¹ä¸€ç»´sticksç´¢å¼•æ’åº</h5>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
æŒ‰ç…§sticksä¸Šé¢çš„Gç‚¹æ•°é‡,å¯¹indæ’åº,å­˜åˆ°<code class="highlighter-rouge">smap%idx</code>ä¸­å»ï¼Œè°ƒæ•´äº†ngc<br />
Gç‚¹ç¬¬<code class="highlighter-rouge">ni</code>å¤šçš„sticksæ˜¯<code class="highlighter-rouge">ind = smap%idx(ni)</code>,ä¸Šé¢æœ‰<code class="highlighter-rouge">ngc(smap%idx(ni))</code>ä¸ªGç‚¹<br />
å¦‚<strong>å›¾:sticksçš„ä¸€ç»´å½¢å¼</strong><br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL sticks_sort_new( smap%nproc&gt;1, ngc, SIZE(smap%idx), smap%idx )
</code></pre></div></div>

<p><strong><center>å›¾:sticksçš„ä¸€ç»´å½¢å¼</center></strong>
<img src="/uploads/2020/04/get_sticks_2.jpg" alt="" />
<br /><br /></p>

<h5 id="åˆ†é…sticksåˆ°cpuç½‘æ ¼ç‚¹ä¸Š">åˆ†é…sticksåˆ°CPUç½‘æ ¼ç‚¹ä¸Š</h5>
<p>File:<code class="highlighter-rouge">FFTXlib/stick_base.f90</code><br />
æŠŠsticksç©ºé—´ä¸­<code class="highlighter-rouge">i1</code>ç›¸åŒçš„sticks,ä»¥ä¸‹ç§°ä¸º<code class="highlighter-rouge">YZæˆªé¢</code>æˆ–<code class="highlighter-rouge">X(i1)</code><br />
<code class="highlighter-rouge">X(i1)</code>ä½œä¸ºå•å…ƒåˆ†é…ç»™CPUç½‘æ ¼ä¸­çš„ä¸€è¡Œ(<code class="highlighter-rouge">py</code>ç›¸åŒçš„cpuä»¬,i.e. comm3)<br />
åœ¨åŒä¸€è¡Œ,åˆæŠŠ<code class="highlighter-rouge">X(i1)</code>å˜æˆ<code class="highlighter-rouge">(i1,i2)</code>åˆ†åˆ°å„ä¸ªprocessorä¸Š<br />
<strong>æ³¨:åˆ†é…çš„æ—¶å€™ä¸æ˜¯é¡ºåºåˆ†é…çš„ï¼Œè€Œæ˜¯è´Ÿè½½åˆ†é…çš„ï¼Œä¼˜å…ˆåˆ†ç»™è®¡ç®—é‡æœ€å°‘çš„cpuè¡Œä¸Šæœ€å°‘çš„processor</strong><br />
æœ€åçš„ç»“æœå°±æ˜¯sticks<code class="highlighter-rouge">(i1,i2)</code>è¢«rank <code class="highlighter-rouge">pu = smap%stown(i1,i2)</code>çš„processorå¤„ç†</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      CALL sticks_dist_new( smap%lgamma, smap%mype, smap%nproc, smap%nyfft, smap%iproc, smap%iproc2, &amp;
                            smap%ub, smap%lb, smap%idx, &amp;
                            smap%ist(:,1), smap%ist(:,2), ngc, SIZE(smap%idx), nstp, sstp, smap%stown, ng )
</code></pre></div></div>

<p><strong><center>ç»„å›¾:è´Ÿè´£sticksçš„processor</center></strong>
<img src="/uploads/2020/04/get_sticks_3.jpg" alt="" />
<img src="/uploads/2020/04/get_sticks_4.jpg" alt="" />
<img src="/uploads/2020/04/get_sticks_5.jpg" alt="" />
<img src="/uploads/2020/04/dfftsvsdfftp.jpg" alt="" />
<br /><br /></p>

<h4 id="fft_type_set-è®¾ç½®fftç½‘æ ¼">fft_type_set è®¾ç½®FFTç½‘æ ¼</h4>
<p>File:<code class="highlighter-rouge">FFTXlib/fft_types.f90</code><br />
å‰é¢æœ‰FFTç½‘æ ¼å’Œstickså…³ç³»,sticksä¸CPUç½‘æ ¼å…³ç³»,ç°åœ¨è¦æ•´åˆèµ·æ¥ï¼ŒæŠŠ<code class="highlighter-rouge">dfft%</code>çš„æ‰€æœ‰å®šä¹‰è®¡ç®—å‡ºæ¥èµ‹å€¼</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     CALL fft_type_set( dfft, nst, smap%ub, smap%lb, smap%idx, &amp;
          smap%ist(:,1), smap%ist(:,2), nstp, nstpw, sstp, sstpw, st, stw )
</code></pre></div></div>
<p>ä¸‹é¢çš„<code class="highlighter-rouge">desc</code>å°±æ˜¯<code class="highlighter-rouge">dfft</code>
<br /></p>

<h5 id="descnr1pdescnr2pdescnr3p"><code class="highlighter-rouge">desc%nr1pï¼Œdesc%nr2pï¼Œdesc%nr3p</code></h5>
<ul>
  <li><code class="highlighter-rouge">desc%nr1p(p1)</code>,where <code class="highlighter-rouge">p1 =1,desc%proc1</code></li>
  <li><code class="highlighter-rouge">desc%nr2p(p2)</code>,where <code class="highlighter-rouge">p2 =1,desc%proc2</code></li>
  <li><code class="highlighter-rouge">desc%nr3p(p3)</code>,where <code class="highlighter-rouge">p3 =1,desc%proc3</code></li>
</ul>

<p><code class="highlighter-rouge">desc%nr1p</code>æ˜¯æ ¹æ®<code class="highlighter-rouge">smap%stown</code>è®¡ç®—çš„ï¼Œå’Œsticksçš„åˆ†å¸ƒä¸€è‡´çš„ï¼Œä¸çœŸå®çš„YZæˆªé¢åœ¨processoré—´çš„åˆ†å¸ƒä¸€è‡´ï¼Œæ˜¯çœŸå®åˆ†å¸ƒ</p>

<p>æŠŠ<code class="highlighter-rouge">nr2,nr3</code>åˆ†åˆ«åˆ†æˆ<code class="highlighter-rouge">desc%nproc2,desc%nproc3</code>ä»½(<strong>æ­¤æ˜¯ä¼°ç®—,å¹¶ä¸å¯¹åº”çœŸå®processoråˆ†é…</strong>), æ¯ä¸€ä»½æœ‰å¤šå°‘ä¸ª<code class="highlighter-rouge">desc%nr2pï¼Œdesc%nr3p</code></p>

<p>ç¨‹åºçš„å¼€å¤´åªè®¡ç®—äº†<code class="highlighter-rouge">desc%nr2pï¼Œdesc%nr3p</code>,<code class="highlighter-rouge">desc%nr1p</code>æ˜¯åé¢è®¡ç®—çš„</p>

<p><br /><br /><br /></p>

<h5 id="descnnp---nr1x--nr2xç”¨äºä¼°ç®—"><code class="highlighter-rouge">desc%nnp  = nr1x * nr2x</code>ç”¨äºä¼°ç®—</h5>

<h5 id="descngldescnwl"><code class="highlighter-rouge">desc%ngl</code>&amp;<code class="highlighter-rouge">desc%nwl</code></h5>

<ul>
  <li><code class="highlighter-rouge">desc%ngl( 1:desc%nproc )  = ngp( 1:desc%nproc ) </code> rank pu å¤„ç†å™¨ å¤„ç†çš„ rho sticksçš„Gç‚¹æ•°</li>
  <li><code class="highlighter-rouge">desc%nwl( 1:desc%nproc )  = ngpw( 1:desc%nproc )</code> rank pu å¤„ç†å™¨ å¤„ç†çš„ wave sticksçš„Gç‚¹æ•°</li>
</ul>

<h5 id="sticksæ ¼ç‚¹i1i2ä¸fftæ ¼ç‚¹m1m2å…³ç³»">sticksæ ¼ç‚¹<code class="highlighter-rouge">(i1,i2)</code>ä¸FFTæ ¼ç‚¹<code class="highlighter-rouge">(m1,m2)</code>å…³ç³»</h5>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m1 = i1 + 1; IF ( m1 &lt; 1 ) m1 = m1 + nr1   !=== æŠŠå€’ç©ºé—´ä¸­çš„è´Ÿåæ ‡ï¼Œå˜æ¢åˆ°ï¼~nr1ä¸Šæ¥ï¼Œ -2,-1,0,1,2 =&gt; 5,6,1,2,3 æˆ– 4,5,1,2,3ï¼Œ ä¸¤ç§å¯èƒ½éƒ½å‡ºç°äº†
m2 = i2 + 1; IF ( m2 &lt; 1 ) m2 = m2 + nr2   !=== æŠŠå€’ç©ºé—´ä¸­çš„è´Ÿåæ ‡ï¼Œå˜æ¢åˆ°ï¼~nr1ä¸Šæ¥ï¼Œ -2,-1,0,1,2 =&gt; 5,6,1,2,3 æˆ– 4,5,1,2,3ï¼Œ ä¸¤ç§å¯èƒ½éƒ½å‡ºç°äº†
</code></pre></div></div>

<h5 id="fftç½‘æ ¼çš„ä¸€ç»´ç¼–å·indm">FFTç½‘æ ¼çš„ä¸€ç»´ç¼–å·indm</h5>
<p><code class="highlighter-rouge">indm = m1 + ( m2 - 1 ) * nr1x</code>
<code class="highlighter-rouge">desc%isind(indm)</code>çš„ä¸­é—´å«ä¹‰:</p>
<ul>
  <li><code class="highlighter-rouge">desc%isind(indm) &gt; 0</code>,æœ¬waveæ ¼ç‚¹ç”±processor <code class="highlighter-rouge">desc%isind(indm)</code>è´Ÿè´£</li>
  <li><code class="highlighter-rouge">desc%isind(indm) &lt; 0</code>,æœ¬rhoä¸”éwaveæ ¼ç‚¹ç”±processor <code class="highlighter-rouge">-1*desc%isind(indm)</code>è´Ÿè´£</li>
  <li><code class="highlighter-rouge">desc%isind(indm) = 0</code>,æœ¬æ ¼ç‚¹æ˜¯æ— æ•ˆæ ¼ç‚¹,ä¸å¯¹åº”æœ‰æ•ˆsticks,è¶…è¿‡æˆªæ–­èƒ½<code class="highlighter-rouge">gcut</code></li>
</ul>

<p><br /><br /><br /></p>

<h5 id="fftæ ¼ç‚¹çš„yzæˆªé¢xm1ä¸cpuç½‘æ ¼pyè¡Œçš„å…³ç³»">FFTæ ¼ç‚¹çš„YZæˆªé¢<code class="highlighter-rouge">X(m1)</code>ä¸CPUç½‘æ ¼<code class="highlighter-rouge">py</code>è¡Œçš„å…³ç³»</h5>
<p>FFTç½‘æ ¼çš„YZæˆªé¢åŒsticksçš„YZæˆªé¢ä¸€æ ·è¢«åŒä¸€ç»„<code class="highlighter-rouge">py</code>å¤„ç†å™¨å¤„ç†<br />
FFTçš„æœ‰æ•ˆæˆªé¢æŒ‡æœ‰æ•ˆæ ¼ç‚¹<code class="highlighter-rouge">(m1,m2)</code>çš„æˆªé¢X(m1),æœ‰æ•ˆFFTæ ¼ç‚¹<code class="highlighter-rouge">(m1,m2)</code>å¯¹åº”æœ‰æ•ˆçš„sticks<code class="highlighter-rouge">(i1,i2)</code></p>

<p>å¯¹äºFFTçš„æ ¼ç‚¹çš„YZæˆªé¢X(m1)çš„æ€§è´¨</p>

<table>
  <thead>
    <tr>
      <th>è¯´æ˜</th>
      <th>waveæ ¼ç‚¹çš„æˆªé¢X(m1)</th>
      <th>rhoæ ¼ç‚¹çš„æˆªé¢X(m1)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>å¯¹åº”çš„sticks</td>
      <td><code class="highlighter-rouge">gkcut</code>ç¡®å®šçš„wave sticks</td>
      <td><code class="highlighter-rouge">gcut</code>å¯¹åº”çš„rho sticks</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">m1</code>è¢«å¤„ç†å™¨â€py=mype2+1â€ä»¬å¤„ç† <br />if <code class="highlighter-rouge">=0</code>,æˆ‘æ˜¯æ— æ•ˆæˆªé¢</td>
      <td><code class="highlighter-rouge">py=desc%iplw(m1)</code></td>
      <td><code class="highlighter-rouge">py=desc%iplp(m1)</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">m1</code>æ˜¯ç¬¬å‡ ä¸ªæœ‰æ•ˆæˆªé¢ <br /> if <code class="highlighter-rouge">=0</code>,æˆ‘æ˜¯æ— æ•ˆæˆªé¢</td>
      <td><code class="highlighter-rouge">desc%ir1w_tg(m1)</code></td>
      <td>æ— æ­¤å˜é‡<br /> <del><code class="highlighter-rouge">desc%ir1p_tg(m1)</code></del></td>
    </tr>
    <tr>
      <td>å…±æœ‰æœ‰æ•ˆæˆªé¢å¤šå°‘ä¸ª</td>
      <td><code class="highlighter-rouge">desc%nr1w_tg</code></td>
      <td>æ— æ­¤å˜é‡<br /><del><code class="highlighter-rouge">desc%nr1p_tg</code></del></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">m1</code>æ˜¯æœ¬<strong>pyå¤„ç†å™¨ä»¬</strong>å¤„ç†çš„ç¬¬å‡ ä¸ªæˆªé¢<br />if <code class="highlighter-rouge">&gt;0</code>æ˜¯æˆ‘ä»¬å¤„ç†çš„,else ä¸æ˜¯</td>
      <td><code class="highlighter-rouge">desc%ir1w(m1)</code></td>
      <td>desc%ir1p(m1)</td>
    </tr>
    <tr>
      <td>æœ¬<strong>pyå¤„ç†å™¨ä»¬</strong>å…±å¤„ç†æˆªé¢æ•°</td>
      <td><code class="highlighter-rouge">desc%nr1w(py)</code></td>
      <td><code class="highlighter-rouge">desc%nr1p(py)</code></td>
    </tr>
    <tr>
      <td>æœ¬<strong>pyå¤„ç†å™¨ä»¬</strong>å¤„ç†çš„ç¬¬uä¸ªæˆªé¢æ˜¯</td>
      <td><code class="highlighter-rouge">m1=desc%indw(u,py)</code></td>
      <td><code class="highlighter-rouge">m1=desc%indp(u,py)</code></td>
    </tr>
  </tbody>
</table>

<p><br /><br /><br /></p>

<h5 id="fftçš„æ ¼ç‚¹m1m2ä¸processorå¯¹åº”å…³ç³»">FFTçš„æ ¼ç‚¹<code class="highlighter-rouge">(m1,m2)</code>ä¸processorå¯¹åº”å…³ç³»</h5>

<ul>
  <li>çœŸå®æ ¼ç‚¹çš„äºŒç»´åæ ‡<code class="highlighter-rouge">(m1,m2)</code>ä¸ä¸€ç»´åæ ‡é—´çš„å…³ç³»<code class="highlighter-rouge">indm = m1 + ( m2 - 1 ) * nr1x</code></li>
  <li>æ–°æ ¼ç‚¹ind_newå¯¹åº”çš„çœŸå®æ ¼ç‚¹æ˜¯<code class="highlighter-rouge">indm = desc%ismap(ind_mew)</code></li>
  <li>indmæ˜¯æœ¬å¤„ç†å™¨å¤„ç†çš„ç¬¬<code class="highlighter-rouge">desc%isind(indm)</code>ä¸ªæ ¼ç‚¹,local</li>
</ul>

<p><img src="/uploads/2020/04/ismap.png" alt="" /></p>

<h5 id="å‰©ä¸‹å°±æ˜¯è¿‘ä¼¼å€¼çš„ä¼°è®¡">å‰©ä¸‹å°±æ˜¯è¿‘ä¼¼å€¼çš„ä¼°è®¡</h5>
<p>è¯¦è§File:<code class="highlighter-rouge">FFTXlib/fft_types.f90</code></p>
<ul>
  <li><code class="highlighter-rouge">desc%nnr</code></li>
  <li><code class="highlighter-rouge">desc%nnr_tg</code></li>
  <li><code class="highlighter-rouge">desc%tg_snd</code></li>
  <li><code class="highlighter-rouge">desc%tg_rcv</code></li>
  <li><code class="highlighter-rouge">desc%tg_sdsp</code></li>
  <li><code class="highlighter-rouge">desc%tg_rdsp</code></li>
</ul>

<h4 id="æœ¬processorå¤„ç†çš„gç‚¹dfftngwdfftngm">æœ¬processorå¤„ç†çš„Gç‚¹<code class="highlighter-rouge">dfft%ngw</code>&amp;<code class="highlighter-rouge">dfft%ngm</code></h4>
<ul>
  <li><code class="highlighter-rouge">dfft%ngw = dfft%nwl( dfft%mype + 1 )</code> !== æ¥è‡ªfft_type_setçš„sstpwçš„èµ‹å€¼, è¿”å›æœ¬å¤„ç†å™¨è®¡ç®—çš„Gç‚¹æ•°</li>
  <li><code class="highlighter-rouge">dfft%ngm = dfft%ngl( dfft%mype + 1 )</code> !== æ¥è‡ªfft_type_setçš„sstp çš„èµ‹å€¼, è¿”å›æœ¬å¤„ç†å™¨è®¡ç®—çš„Gç‚¹æ•°</li>
</ul>

<h3 id="fft_base_info"><code class="highlighter-rouge">fft_base_info</code></h3>
<p>File:<code class="highlighter-rouge">Modules/fft_base.f90</code><br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL fft_base_info( ionode, stdout )
</code></pre></div></div>
<p>å¦‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     Parallelization info
     --------------------
     sticks:   dense  smooth     PW     G-vecs:    dense   smooth      PW
     Min          26      20      7                  312      208      39
     Max          32      25      8                  334      231      54
     Sum         225     177     61                 2553     1743     365
</code></pre></div></div>

<p><strong>å°±æ˜¯è¾“å‡º<code class="highlighter-rouge">"dfftp%nsp,dffts%nsp,dffts%nsw,dfftp%ngl,dffts%ngl,dffts%nwl</code></strong></p>

<p>å·¦ä¾§æ˜¯sticksæ•°é‡åˆ†åˆ«æ˜¯:</p>
<ul>
  <li><code class="highlighter-rouge">dfftp</code>ç”¨<code class="highlighter-rouge">ecutrho</code>è®¡ç®—çš„sticks</li>
  <li><code class="highlighter-rouge">dffts</code>ç”¨<code class="highlighter-rouge">4*ecuwfc</code>è®¡ç®—çš„sticks</li>
  <li><code class="highlighter-rouge">dffts</code>ç”¨ <script type="math/tex">\left \| \sqrt{ecutwfc} + k_{max}  \right \|^{2}</script> è®¡ç®—çš„sticks</li>
</ul>

<p>å³ä¾§æ˜¯Gç‚¹æ•°é‡</p>
<ul>
  <li><code class="highlighter-rouge">dfftp</code>ç”¨<code class="highlighter-rouge">ecutrho</code>è®¡ç®—çš„Gç‚¹æ•°</li>
  <li><code class="highlighter-rouge">dffts</code>ç”¨<code class="highlighter-rouge">4*ecuwfc</code>è®¡ç®—çš„Gç‚¹æ•°</li>
  <li><code class="highlighter-rouge">dffts</code>ç”¨ <script type="math/tex">\left \| \sqrt{ecutwfc} + k_{max}  \right \|^{2}</script> è®¡ç®—çš„Gç‚¹æ•°</li>
</ul>

<h3 id="gvect_init--gvecs_init-ç»Ÿè®¡n_gallocateg"><code class="highlighter-rouge">gvect_init</code> &amp; <code class="highlighter-rouge">gvecs_init</code> ç»Ÿè®¡<script type="math/tex">N_{G}</script>,<strong>ALLOCATE(g)</strong></h3>
<p>File:<code class="highlighter-rouge">Modules/recvec.f90</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngm_ = dfftp%ngl( dfftp%mype + 1 ) !dfftpç½‘æ ¼ä¸­,æœ¬å¤„ç†å™¨å¤„ç†çš„rho sticksä¸Šçš„Gç‚¹æ•°
ngs_ = dffts%ngl( dffts%mype + 1 ) !dfftsç½‘æ ¼ä¸­,æœ¬å¤„ç†å™¨å¤„ç†çš„rho sticksä¸Šçš„Gç‚¹æ•° 
call gvect_init ( ngm_ , intra_bgrp_comm )
call gvecs_init ( ngs_ , intra_bgrp_comm )
</code></pre></div></div>

<p>åˆ©ç”¨ngm/ngsè®¡ç®—å¯¹äºå„è‡ªçš„FFTç½‘æ ¼ï¼Œæ¯ä¸ªprocessoråˆ†åˆ°çš„rhoçš„<strong>G</strong>æ•°é‡,ä»¥åŠæœ€å¤§ã€æ€»å…±çš„æ•°é‡<br />
åœ¨å‰é¢gvect(ecurho,dfftp) vs gvecs (4*ecutwfc,dffts) ä»‹ç»è¿‡äº†</p>
<ul>
  <li><code class="highlighter-rouge">gvect</code> - <code class="highlighter-rouge">fftp</code>: <code class="highlighter-rouge">ngm,ngmx,ngm_g</code>, åˆ†åˆ«ä»£è¡¨ local,max,total</li>
  <li><code class="highlighter-rouge">gvecs</code> - <code class="highlighter-rouge">ffts</code>: <code class="highlighter-rouge">ngms,ngsx,ngms_g</code></li>
</ul>

<p><strong><code class="highlighter-rouge">gvect_init</code>è¿˜è¦ALLOCATEå¾ˆå¤šå†…å­˜ï¼Œå¦‚è®¡ç®—åŠ¨èƒ½çš„å€’æ ¼å¤±<code class="highlighter-rouge">ALLOCATE( g(3, ngm) )</code></strong></p>

<ul>
  <li><code class="highlighter-rouge">ALLOCATE( gg(ngm) ) </code></li>
  <li><code class="highlighter-rouge">ALLOCATE( g(3, ngm) ) </code></li>
  <li><code class="highlighter-rouge">ALLOCATE( mill(3, ngm) ) </code></li>
  <li><code class="highlighter-rouge">ALLOCATE( ig_l2g(ngm) ) </code></li>
  <li><code class="highlighter-rouge">ALLOCATE( igtongl(ngm) ) </code></li>
</ul>

<h2 id="allocate_fftä¸ºfftç»§ç»­åˆ†é…å˜é‡"><code class="highlighter-rouge">allocate_fft()</code>ä¸ºFFTç»§ç»­åˆ†é…å˜é‡</h2>
<p>File: <code class="highlighter-rouge">PW/src/allocate_fft.f90</code><br />
åˆå§‹åŒ–fftç›¸å…³çš„å˜é‡,åœ¨<code class="highlighter-rouge">init_run()</code>ä¸­è°ƒç”¨<code class="highlighter-rouge">CALL allocate_fft()</code></p>

<p>åˆå§‹åŒ–ä¸‹é¢æåˆ°çš„å˜é‡ï¼Œè¿™äº›å˜é‡ï¼Œå°†ä¼šåœ¨<code class="highlighter-rouge">init_run</code>ä¸­<code class="highlighter-rouge">call hinit0(), call potinit()</code>ç­‰ä¸­åˆå§‹åŒ–</p>

<h3 id="module-scfä¸­fftç›¸å…³çš„å˜é‡å®šä¹‰"><code class="highlighter-rouge">MODULE scf</code>ä¸­fftç›¸å…³çš„å˜é‡å®šä¹‰</h3>
<p>File:<code class="highlighter-rouge">PW/src/scf_mod.f90</code></p>

<h4 id="scf_typeç»“æ„ä½“"><code class="highlighter-rouge">scf_type</code>ç»“æ„ä½“</h4>
<p>å®šä¹‰å¯†åº¦å’ŒåŠ¿èƒ½ï¼Œä»¥<code class="highlighter-rouge">rho%</code>ä¸¾ä¾‹</p>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>ALLOCATE(å˜é‡)</th>
      <th>è¢«æŒ‡</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>REAL(DP)</td>
      <td><code class="highlighter-rouge">rho%of_r( dfftp%nnr, nspin)</code></td>
      <td>the charge density in R-space</td>
    </tr>
    <tr>
      <td>COMPLEX(DP)</td>
      <td><code class="highlighter-rouge">rho%of_g( ngm, nspin )</code></td>
      <td>the charge density in G-space</td>
    </tr>
    <tr>
      <td>REAL(DP)</td>
      <td>IF(dft_is_meta() .or. lxdm) <br /><code class="highlighter-rouge">rho%kin_r( dfftp%nnr, nspin)</code> <br /> ELSE <br /><code class="highlighter-rouge">rho%kin_r(1,1)</code></td>
      <td>the kinetic energy density in R-space</td>
    </tr>
    <tr>
      <td>COMPLEX(DP)</td>
      <td>IF(dft_is_meta() .or. lxdm) <br /><code class="highlighter-rouge">rho%kin_g( ngm, nspin )</code>      <br /> ELSE <br /><code class="highlighter-rouge">rho%kin_g(1,1)</code></td>
      <td>the kinetic energy density in G-space</td>
    </tr>
    <tr>
      <td>REAL(DP)</td>
      <td><code class="highlighter-rouge">rho%ns(2*Hubbard_lmax+1,2*Hubbard_lmax+1,nspin,nat)</code></td>
      <td>the LDA+U occupation matrix</td>
    </tr>
    <tr>
      <td>COMPLEX(DP)</td>
      <td><code class="highlighter-rouge">rho%ns_nc(2*Hubbard_lmax+1,2*Hubbard_lmax+1,nspin,nat)</code></td>
      <td>â€”       noncollinear case</td>
    </tr>
    <tr>
      <td>REAL(DP)</td>
      <td><code class="highlighter-rouge">rho%bec(nhm*(nhm+1)</code>/2,nat,nspin)`</td>
      <td>the PAW hamiltonian elements</td>
    </tr>
  </tbody>
</table>

<p><code class="highlighter-rouge">scf_type</code> å®šä¹‰çš„å˜é‡</p>
<ul>
  <li><code class="highlighter-rouge">rho </code>  è‡ªæ´½ä½¿ç”¨çš„ç”µè·å¯†åº¦ï¼Œthe charge density and its other components</li>
  <li><code class="highlighter-rouge">v   </code>  the scf potential</li>
  <li><code class="highlighter-rouge">vnew</code>  used to correct the forces</li>
</ul>

<h4 id="ç”µè·å¯†åº¦rhoçš„fftçš„ç©ºé—´ç½‘æ ¼"><strong>ç”µè·å¯†åº¦rhoçš„FFTçš„ç©ºé—´ç½‘æ ¼:</strong><br /></h4>
<p><script type="math/tex">r_m = m_1/N_1 \cdot a_1 + m_2/N_2 \cdot a_2 + m_3/N_3 \cdot a_3</script>çš„å–å€¼ä¸ºåŸèƒå†…,å•ä½æ˜¯<code class="highlighter-rouge">alat</code><br />
<script type="math/tex">G_n = n_1\cdot b_1 + n_2 \cdot b_2 + n_3 \cdot b_3</script>çš„å–å€¼ä¸ºå€’ç©ºé—´ç½‘æ ¼ç‚¹,å•ä½æ˜¯<code class="highlighter-rouge">thiba=2pi/alat</code><br />
<strong><code class="highlighter-rouge">rho%of_r</code>å’Œ<code class="highlighter-rouge">rho%of_g</code>çš„å•ä½åˆ†åˆ«æ˜¯<code class="highlighter-rouge">1/omega</code>,<code class="highlighter-rouge">omega/(2pi^3)</code></strong><br />
æ ¹æ®<code class="highlighter-rouge">PW/src/potinit.f90</code>åŠ<code class="highlighter-rouge">Modules/fft_rho.f90</code>ä¸­å¯¹<code class="highlighter-rouge">rho%of_r</code>å’Œ<code class="highlighter-rouge">rho%of_g</code>çš„è½¬æ¢ï¼Œ</p>

<center>
$$
\rho (r_m) = \sum_{G_n} \rho (G_n) \cdot \exp (i G_n \cdot r_m)
$$

$$
\rho (G_n) = \sum_{r_n} \rho (r_m) \cdot \exp (-i G_m \cdot r_n)
$$

$$\Omega \cdot \rho (G_n = 0) = \Omega \cdot \sum_{r_n} = N_{cell} $$

</center>
<p>where, <script type="math/tex">N_{cell}</script>æ˜¯åŸèƒä¸­çš„ç”µå­æ•°åœ¨ç¨‹åºä¸­ç”¨äºåˆ¤æ–­ï¼Œç”µå­æ•°æ˜¯å¦æ­£å¸¸</p>

<h4 id="å…¶ä»–å˜é‡">å…¶ä»–å˜é‡</h4>

<ul>
  <li><code class="highlighter-rouge">REAL(DP), ALLOCATABLE</code>
    <ul>
      <li><code class="highlighter-rouge">vltot( dfftp%nnr)</code>        the local potential in real space</li>
      <li><code class="highlighter-rouge">vrs( dfftp%nnr, nspin)</code>   the total pot. in real space (smooth grid)</li>
      <li><code class="highlighter-rouge">rho_core( dfftp%nnr)</code>    the core charge in real space</li>
      <li>IF ( dft_is_meta() )  <code class="highlighter-rouge">kedtau(dffts%nnr,nspin)</code> <br /> ELSE <code class="highlighter-rouge">kedtau(1,nspin)</code>     position dependent kinetic energy enhancement factor</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">COMPLEX(DP), ALLOCATABLE</code>
    <ul>
      <li><code class="highlighter-rouge">rhog_core( ngm )</code>  the core charge in reciprocal space</li>
    </ul>
  </li>
</ul>

<h3 id="wavefunctionsä¸­å®šä¹‰çš„å˜é‡"><code class="highlighter-rouge">wavefunctions</code>ä¸­å®šä¹‰çš„å˜é‡</h3>
<p>File:<code class="highlighter-rouge">Modules/wavefunctions.f90</code><br /></p>
<ul>
  <li><code class="highlighter-rouge">COMPLEX(DP) , ALLOCATABLE, TARGET</code>
    <ul>
      <li><code class="highlighter-rouge">psic( dfftp%nnr)</code>    additional memory for FFT</li>
      <li><code class="highlighter-rouge">psic_nc( dfftp%nnr, npol)</code>    as above for the noncolinear case</li>
    </ul>
  </li>
</ul>

<h3 id="noncollin_module"><code class="highlighter-rouge">noncollin_module</code></h3>
<p>File:<code class="highlighter-rouge">/Modules/noncol.f90</code></p>

<p>ä¸€äº›æƒ…å†µï¼Œè¿˜ä¼šåˆå§‹åŒ–noncolä¸­çš„å˜é‡,<strong>æš‚æ—¶ç•¥è¿‡äº†</strong></p>

<h2 id="ggenggensäº§ç”Ÿå€’æ ¼å¼å’Œfftç´¢å¼•"><code class="highlighter-rouge">ggen</code>&amp;<code class="highlighter-rouge">ggens</code>äº§ç”Ÿå€’æ ¼å¼å’Œfftç´¢å¼•</h2>
<p>File:<code class="highlighter-rouge">Modules/recvec_subs.f90</code><br />
åœ¨<code class="highlighter-rouge">init_run</code>ä¸­ä¼šäº§ç”Ÿfftçš„å€’æ ¼çŸ¢ã€‚</p>
<h3 id="ggenç”Ÿæˆgcutmå…è®¸çš„gç‚¹"><code class="highlighter-rouge">ggen</code>ç”Ÿæˆ<code class="highlighter-rouge">gcutm</code>å…è®¸çš„Gç‚¹</h3>
<p>File:<code class="highlighter-rouge">Modules/recvec_subs.f90</code><br /></p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span><span class="w"> </span><span class="n">ggen</span><span class="p">(</span><span class="w"> </span><span class="n">dfftp</span><span class="p">,</span><span class="w"> </span><span class="n">gamma_only</span><span class="p">,</span><span class="w"> </span><span class="n">at</span><span class="p">,</span><span class="w"> </span><span class="n">bg</span><span class="p">,</span><span class="w"> </span><span class="n">gcutm</span><span class="p">,</span><span class="w"> </span><span class="n">ngm_g</span><span class="p">,</span><span class="w"> </span><span class="n">ngm</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
       </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">gg</span><span class="p">,</span><span class="w"> </span><span class="n">mill</span><span class="p">,</span><span class="w"> </span><span class="n">ig_l2g</span><span class="p">,</span><span class="w"> </span><span class="n">gstart</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>è¿”å›<strong>ä½¿ç”¨<code class="highlighter-rouge">gcutm==ecutrho/(2 pi/a)^2</code>è®¡ç®—çš„Gç‚¹ç½‘æ ¼ç‚¹</strong></p>
<ul>
  <li><code class="highlighter-rouge">gcutm</code>æœ¬processorå¤„ç†çš„Gç‚¹æ•°ï¼Œä¹‹å‰å·²è®¡ç®—è¿‡ï¼Œä¼šä¸ä¹‹å‰çš„å¯¹æ¯”ï¼Œä¸åŒåˆ™error
<br />åœ¨ç¨‹åºæ‰§è¡Œä¸­æœ‰å¾ˆå¤šä¸´æ—¶ä½œç”¨</li>
  <li><code class="highlighter-rouge">g(1:3, local_i) = i * bg (:, 1) + j * bg (:, 2) + k * bg (:, 3)</code>æœ¬å¤„ç†å™¨å¤„ç†çš„Gç‚¹<code class="highlighter-rouge">(/i,j,k/)</code>çš„åæ ‡
<br />**<code class="highlighter-rouge">local_i</code>æ˜¯æˆ‘å¤„ç†çš„Gç‚¹çš„å±€åŸŸç¼–å·<code class="highlighter-rouge">local_i = 1, ngm</code></li>
  <li><code class="highlighter-rouge">gg(local_i) = sum(g(1:3, local_i)**2)</code>Gç‚¹çš„æ¨¡ <script type="math/tex">\| G \|^2</script> ,local</li>
  <li><code class="highlighter-rouge">CALL fft_set_nl( dfftp, at, g, mill )</code><br />
 File:<code class="highlighter-rouge">FFTXlib/fft_ggen.f90</code><br />
 æ ¹æ®Gç‚¹åæ ‡è®¡ç®—ç±³å‹’æŒ‡æ•°<code class="highlighter-rouge">mile</code>
    <ul>
      <li><code class="highlighter-rouge">mill (3,local_i)</code>å°±æ˜¯Gç‚¹<code class="highlighter-rouge">(/n1,n2,n3/) = (/i,j,k/)</code>çš„åæ ‡ <br />
<script type="math/tex">mill_1(ig)=G(ig) \cdot at_1 = i(ig)</script>, since <script type="math/tex">bg_m\cdot  at_n = \delta_{mn}</script></li>
      <li><code class="highlighter-rouge">dfft%nl (ig)</code>Gåœ¨dfftpçš„Gç‚¹ä¸‰ç»´ç½‘æ ¼ä¸­çš„ä¸€ç»´é¡ºåº<br />
<code class="highlighter-rouge">dfft%nl (ng) = 1 + n3 + ( dfft%isind ( 1 + n1 + n2*dfft%nr1x) - 1) * dfft%nr3x</code><br />
where,<code class="highlighter-rouge">isind ( 1 + n1 + n2*dfft%nr1x)</code> è¿”å›fftç½‘æ ¼ç‚¹<code class="highlighter-rouge">(n1,n2)</code>æ˜¯æœ¬processorå¤„ç†çš„ç¬¬å‡ ä¸ªç½‘æ ¼ç‚¹</li>
      <li><code class="highlighter-rouge">ig_l2g( ig ) = global_i</code>,æˆ‘çš„ç¬¬<code class="highlighter-rouge">ig</code>(<code class="highlighter-rouge">ig=1,ngm</code>)ä¸ªGç‚¹åæ ‡ï¼Œ<br />
 æ˜¯<code class="highlighter-rouge">gcutm</code>å…è®¸çš„å…¨å±€Gç‚¹åæ ‡ä¸­çš„ç¬¬<code class="highlighter-rouge">global_i</code>(<code class="highlighter-rouge">global_i=1,ngm_m</code>)ä¸ªGç‚¹</li>
    </ul>
  </li>
</ul>

<h3 id="ggens">ggens</h3>
<p>File:<code class="highlighter-rouge">Modules/recvec_subs.f90</code><br /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL ggens( dffts, gamma_only, at, g, gg, mill, gcutms, ngms )
</code></pre></div></div>
<p>åˆ©ç”¨<code class="highlighter-rouge">g</code>ä»…è®¾ç½®<code class="highlighter-rouge">dffts%nl</code>,æ ¹æ®<code class="highlighter-rouge">gg</code>&amp;<code class="highlighter-rouge">gctums</code>åˆ¤æ–­ä¹‹å‰è®¡ç®—çš„ngmsæ˜¯ä¸æ˜¯ä¸€è‡´</p>

<h2 id="é™„å½•">é™„å½•</h2>

<h3 id="å›¾a">å›¾A</h3>
<h4 id="å›¾a-1">å›¾A-1</h4>
<p><img src="/uploads/2020/04/sticks1.png" alt="" /></p>

<h4 id="å›¾a-2">å›¾A-2</h4>
<p>å›¾ç‰‡è¿‡å¤§ï¼Œåœ¨æ–°çª—å£æ‰“å¼€<a href="/uploads/2020/04/dffts_dfftp.png">dffts_dfftp.png</a></p>
:ET