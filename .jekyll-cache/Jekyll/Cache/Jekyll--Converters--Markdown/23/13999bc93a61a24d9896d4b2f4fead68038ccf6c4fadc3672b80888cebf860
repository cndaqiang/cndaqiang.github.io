I"®T<ul id="markdown-toc">
  <li><a href="#å‚è€ƒ" id="markdown-toc-å‚è€ƒ">å‚è€ƒ</a></li>
  <li><a href="#pgiç¼–è¯‘å™¨åŸºæœ¬ç”¨æ³•" id="markdown-toc-pgiç¼–è¯‘å™¨åŸºæœ¬ç”¨æ³•">PGIç¼–è¯‘å™¨åŸºæœ¬ç”¨æ³•</a></li>
  <li><a href="#cuda" id="markdown-toc-cuda">CUDA</a>    <ul>
      <li><a href="#åŸºæœ¬æ¦‚å¿µ" id="markdown-toc-åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></li>
      <li><a href="#æ³¨æ„äº‹é¡¹" id="markdown-toc-æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></li>
      <li><a href="#æŸ¥çœ‹æ˜¾å¡å±æ€§" id="markdown-toc-æŸ¥çœ‹æ˜¾å¡å±æ€§">æŸ¥çœ‹æ˜¾å¡å±æ€§</a></li>
      <li><a href="#è®¾ç½®æ ¸å‡½æ•°è®¡ç®—ç½‘æ ¼" id="markdown-toc-è®¾ç½®æ ¸å‡½æ•°è®¡ç®—ç½‘æ ¼">è®¾ç½®æ ¸å‡½æ•°è®¡ç®—ç½‘æ ¼</a></li>
      <li><a href="#ä¸»æœºè®¾å¤‡ä»£ç åŒæ­¥é—®é¢˜" id="markdown-toc-ä¸»æœºè®¾å¤‡ä»£ç åŒæ­¥é—®é¢˜">ä¸»æœº,è®¾å¤‡ä»£ç åŒæ­¥é—®é¢˜</a></li>
      <li><a href="#æ ¸å‡½æ•°çš„å‚æ•°ä¼ é€’" id="markdown-toc-æ ¸å‡½æ•°çš„å‚æ•°ä¼ é€’">æ ¸å‡½æ•°çš„å‚æ•°ä¼ é€’</a></li>
      <li><a href="#æ€§èƒ½æµ‹è¯•" id="markdown-toc-æ€§èƒ½æµ‹è¯•">æ€§èƒ½æµ‹è¯•</a>        <ul>
          <li><a href="#æ£€æµ‹å„ä¸ªæ¨¡å—è¿è¡Œæ—¶é—´-nvprof-aout" id="markdown-toc-æ£€æµ‹å„ä¸ªæ¨¡å—è¿è¡Œæ—¶é—´-nvprof-aout">æ£€æµ‹å„ä¸ªæ¨¡å—è¿è¡Œæ—¶é—´<code class="highlighter-rouge"> nvprof ./a.out</code></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#æŠ¥é”™" id="markdown-toc-æŠ¥é”™">æŠ¥é”™</a>    <ul>
      <li><a href="#cudaä»£ç é”™è¯¯" id="markdown-toc-cudaä»£ç é”™è¯¯">CUDAä»£ç é”™è¯¯</a></li>
      <li><a href="#pgiæ™®é€šfortranè¯­æ³•é”™è¯¯" id="markdown-toc-pgiæ™®é€šfortranè¯­æ³•é”™è¯¯">PGIæ™®é€šFortranè¯­æ³•é”™è¯¯</a></li>
    </ul>
  </li>
</ul>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="/web/file/2020/PGI_ustc.pdf">æä¼šæ°‘ï¼šPGIç¼–è¯‘å™¨å’Œä½¿ç”¨ustc</a><br />
<a href="https://scc.ustc.edu.cn/zlsc/cxyy/201003/W020140729474268704267.pdf">å°å°æ²³ï¼šCUDA Fortran é«˜æ•ˆç¼–ç¨‹å®è·µ</a></p>

<h2 id="pgiç¼–è¯‘å™¨åŸºæœ¬ç”¨æ³•">PGIç¼–è¯‘å™¨åŸºæœ¬ç”¨æ³•</h2>
<p>ç¼–è¯‘å™¨</p>
<ul>
  <li>ç¼–è¯‘Cã€ C++æºç¨‹åºçš„å‘½ä»¤åˆ†åˆ«ï¼š <code class="highlighter-rouge">pgccã€ pgCC</code></li>
  <li>ç¼–è¯‘Fortran 77æºç¨‹åºçš„å‘½ä»¤ï¼š <code class="highlighter-rouge">pgf77</code></li>
  <li>ç¼–è¯‘Fortran 90çš„æºç¨‹åºçš„å‘½ä»¤ï¼š <code class="highlighter-rouge">pgf90ã€ pgf901ã€ pgf902ã€ pgf90_exã€pgf95å’Œpgfortran</code></li>
  <li>ä¸NVIDIA CUDAåº“é…åˆï¼Œå¯ä»¥ç¼–è¯‘Fortran-CUDAç¨‹åº</li>
</ul>

<p>å‚æ•°</p>

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">-c</code></td>
      <td>ä»…ç¼–è¯‘æˆå¯¹è±¡æ–‡ä»¶ï¼ˆ.oæ–‡ä»¶ï¼‰</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-o</code></td>
      <td>ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶å</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-O</code></td>
      <td>ä¼˜åŒ–</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">-mp</code></td>
      <td>openmp</td>
    </tr>
  </tbody>
</table>

<p>ç¼–è¯‘æ™®é€šFortranç¤ºä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/code/cuda$  cat hello.f90 
PROGRAM hello
      WRITE(*,*) "hello"
ENDPROGRAM hello
cndaqiang@girl:~/code/cuda$ pgf90 hello.f90 -o hello
cndaqiang@girl:~/code/cuda$ ./hello 
 hello
</code></pre></div></div>
<p>ç¼–è¯‘cudaç¤ºä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/code/cuda$ cat example.cuf 
!attributes(global) è®¾å¤‡å‡½æ•°ï¼Œglobalå¯è¢«ä¸»æœºè°ƒç”¨
attributes(global) subroutine hellocuda()
    IMPLICIT NONE
    INTEGER :: i,d,j
    i = BlockIdx%x  !çº¿ç¨‹å—ç´¢å¼•
    d = BlockDim%x  !çº¿ç¨‹å—é•¿åº¦
    j = ThreadIdx%x !çº¿ç¨‹ç´¢å¼•
    WRITE(*,*) "Block",i,"Thread",j,"In",d
ENDSUBROUTINE

PROGRAM main
USE cudafor
IMPLICIT NONE
INTEGER :: i
call hellocuda&lt;&lt;&lt;2,3&gt;&gt;&gt;()
i=cudaDeviceSynchronize() !use cudaforæ‰èƒ½æ­£å¸¸ä½¿ç”¨
!åœ¨æ‰§è¡Œhellocudaæ—¶ï¼Œæ§åˆ¶æƒå°±äº¤ç»™cpuäº†
END PROGRAM
cndaqiang@girl:~/code/cuda$ pgfortran example.cuf &amp;&amp; ./a.out 
 Block            2 Thread            1 In            3
 Block            2 Thread            2 In            3
 Block            2 Thread            3 In            3
 Block            1 Thread            1 In            3
 Block            1 Thread            2 In            3
 Block            1 Thread            3 In            3
</code></pre></div></div>
<p>å› ä¸ºå¯åŠ¨GPUä¸Šçš„å‡½æ•°<code class="highlighter-rouge">hellocuda</code>åï¼Œæ§åˆ¶æƒå°±è¿”å›CPUäº†ï¼Œå› æ­¤ï¼ŒåŠ ä¸Š<code class="highlighter-rouge">i=cudaDeviceSynchronize() </code>ï¼Œç­‰å¾…GPUè¾“å‡ºä¹‹åï¼Œå†ç»§ç»­</p>

<h2 id="cuda">CUDA</h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<ul>
  <li>ä¸»æœºhostï¼šæŒ‡CPUåŠå…¶å†…å­˜ã€‚</li>
  <li>è®¾å¤‡deviceï¼šæŒ‡GPUåŠå…¶å†…å­˜ã€‚</li>
  <li>CPUä»£ç ï¼šæŒ‡ä¸€ä¸ªä»…ç”¨åˆ°CPUçš„å®ç°/åœ¨hostä¸Šæ‰§è¡Œçš„ä»£ç </li>
  <li>æ ¸å‡½æ•°kernelï¼š hostä¸Šè°ƒç”¨ï¼Œdeviceä¸Šæ‰§è¡Œçš„subroutineï¼Œå¦‚<code class="highlighter-rouge">attributes(global) subroutine hellocuda()</code></li>
  <li>å¯åŠ¨æ ¸å‡½æ•°ï¼šåœ¨hostä¸Šè°ƒç”¨deviceä¸Šçš„å‡½æ•° ï¼Œå¦‚<code class="highlighter-rouge">CALL hellocuda &lt;&lt;&lt;2,3&gt;&gt;&gt;([å‚æ•°])</code>
<br />ä½¿ç”¨<code class="highlighter-rouge">&lt;&lt;&lt;çº¿ç¨‹å—æ•°é‡,æ¯ä¸ªçº¿ç¨‹å—çš„çº¿ç¨‹æ•°&gt;&gt;&gt;</code>ï¼Œå³<code class="highlighter-rouge">&lt;&lt;&lt;Grid,Block&gt;&gt;&gt;</code></li>
  <li>å®šä¹‰å‡½æ•°<code class="highlighter-rouge">attributes(å±æ€§) subroutine funname()</code>,å½“å±æ€§ä¸º:
<br /> <code class="highlighter-rouge">global</code>, deviceä¸Šæ‰§è¡Œï¼Œhostä¸Šè°ƒç”¨,ä¾‹<code class="highlighter-rouge">attributes(global) subroutine hellocuda()</code>,<strong>è°ƒç”¨æ—¶æŒ‡æ˜ç½‘æ ¼<code class="highlighter-rouge">&lt;&lt;&lt;&gt;&gt;&gt;</code></strong>
<br /> <code class="highlighter-rouge">device</code>, deviceä¸Šæ‰§è¡Œï¼Œdeviceä¸Šè°ƒç”¨,ä¾‹<code class="highlighter-rouge">attributes(device) subroutine hellocuda()</code>ï¼Œç›´æ¥å¯ç”¨ï¼Œ<strong>æ²¡æœ‰<code class="highlighter-rouge">&lt;&lt;&lt;&gt;&gt;&gt;</code></strong>
<br /> <code class="highlighter-rouge">host</code>, hostä¸Šæ‰§è¡Œï¼Œhostä¸Šè°ƒç”¨,ä¸å†™å±æ€§ï¼Œé»˜è®¤å°±æ˜¯æ­¤æƒ…å†µ,ä¾‹<code class="highlighter-rouge">subroutine hellohost()</code>,ç›´æ¥å¯ç”¨ï¼Œ<strong>æ²¡æœ‰<code class="highlighter-rouge">&lt;&lt;&lt;&gt;&gt;&gt;</code></strong></li>
  <li>å†…å­˜<br />
å…¨å±€å†…å­˜(Gloabl Memory):ç”±æ˜¾å­˜å†³å®šï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œæ“ä½œ,æˆ‘ä»¬ä¼ é€’ç»™æ ¸å‡½æ•°çš„deviceå˜é‡å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸Š<br />
å…±äº«å†…å­˜(Shard Memory):æ¯ä¸ªçº¿ç¨‹å—å…±äº«ï¼Œå¯¿å‘½ä¸çº¿ç¨‹å—ä¸€æ ·<br />
ç§æœ‰æœ¬åœ°å†…å­˜(Local Memory):ä»…æœ¬çº¿ç¨‹èƒ½è®¿é—®</li>
</ul>

<h3 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h3>
<ul>
  <li>è®¾å¤‡ä¸Šçš„å‡½æ•°ä¸èƒ½containedåœ¨ä¸»ç¨‹åºæˆ–å…¶ä»–å­ç¨‹åºä¸­</li>
  <li>å¾ˆå¤šå‡½æ•°å˜é‡éƒ½æ¥è‡ª<code class="highlighter-rouge">USE cudafor</code></li>
  <li>CPUè¿›è¡Œæ§åˆ¶ï¼ŒGPUè¿›è¡Œè®¡ç®—</li>
</ul>

<h3 id="æŸ¥çœ‹æ˜¾å¡å±æ€§">æŸ¥çœ‹æ˜¾å¡å±æ€§</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/code/cuda$ cat checkcuda.cuf 
PROGRAM checkcuda
USE cudafor
IMPLICIT NONE
type(cudaDeviceProp) :: prop
INTEGER :: nDevices=0,i,ierr
!
ierr = cudaGetDeviceCount(nDevices)
if(nDevices .EQ. 0) RETURN
DO i=0,nDevices-1
    WRITE(*,"('Device Number:',i0)"),i
    ierr = cudaGetDeviceProperties(prop,i)
    WRITE(*,"('Device Name: ',a)") TRIM(prop%name)
    !è®¡ç®—èƒ½åŠ› ä¸»è¦.æ¬¡è¦ ï¼Œç†è§£ä¸ºç‰ˆæœ¬å·
    WRITE(*,"('Compute Capability: ',i0,'.',i0)") prop%major, prop%minor
    !å¤„ç†å™¨æ•°é‡
    WRITE(*,"('Number of Multiprocessors: ',i0)") prop%multiProcessorCount
    WRITE(*,"('Max Threads per Multiprocessor:',i0)") prop%maxThreadsPerMultiprocessor
    WRITE(*,"('Global Memory (GB):',f9.3)" ) prop%totalGlobalMem/(1024.0**3)
    WRITE(*,"(/,A)") "Execution Configuration Limits "
    WRITE(*,"('Max Grid Dims: ',i0,'x',i0,'x',i0)") prop%maxGridSize
    !æ¯ç»´Blockå†…æœ€å¤§çº¿ç¨‹æ•°
    WRITE(*,"('Max Block Dims: ',i0,'x',i0,'x',i0)") prop%maxThreadsDim
    WRITE(*,"('Max Threads per Block: ',i0)") prop%maxThreadsPerBlock
ENDDO
END PROGRAMcndaqiang@girl:~/code/cuda$ pgf90 checkcuda.cuf &amp;&amp; ./a.out 
Device Number:0
Device Name: GeForce 940MX
Compute Capability: 5.0
Number of Multiprocessors: 3
Max Threads per Multiprocessor:2048
Global Memory (GB):    1.958

Execution Configuration Limits 
Max Grid Dims: 2147483647x65535x65535
Max Block Dims: 1024x1024x64
Max Threads per Block: 1024
</code></pre></div></div>
<p>å¹¶å‘çº¿ç¨‹æ•°=<code class="highlighter-rouge">å¤šå¤„ç†å™¨æ•°é‡*æ¯å¤„ç†å™¨ä¸Šæœ€å¤§çº¿ç¨‹æ•°é‡</code><br />
å¯¹äºæ­¤940MXè€Œè¨€ï¼Œä½¿ç”¨ä¸€ç»´ç½‘æ ¼,ä¸€ä¸ªBlockçº¿ç¨‹æ•°å¯è¾¾<code class="highlighter-rouge">2147483647*1024</code><br />
ä¹Ÿå¯ä»¥ä½¿ç”¨<code class="highlighter-rouge">pgaccelinfo</code>æŸ¥çœ‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/code/cuda$ pgaccelinfo 

CUDA Driver Version:           10010
NVRM version:                  NVIDIA UNIX x86_64 Kernel Module  435.21  Sun Aug 25 08:17:57 CDT 2019

Device Number:                 0
Device Name:                   GeForce 940MX
Device Revision Number:        5.0
Global Memory Size:            2101870592
Number of Multiprocessors:     3
Concurrent Copy and Execution: Yes
Total Constant Memory:         65536
Total Shared Memory per Block: 49152
Registers per Block:           65536
Warp Size:                     32
Maximum Threads per Block:     1024
Maximum Block Dimensions:      1024, 1024, 64
Maximum Grid Dimensions:       2147483647 x 65535 x 65535
Maximum Memory Pitch:          2147483647B
Texture Alignment:             512B
Clock Rate:                    1189 MHz
Execution Timeout:             Yes
Integrated Device:             No
Can Map Host Memory:           Yes
Compute Mode:                  default
Concurrent Kernels:            Yes
ECC Enabled:                   No
Memory Clock Rate:             2000 MHz
Memory Bus Width:              64 bits
L2 Cache Size:                 1048576 bytes
Max Threads Per SMP:           2048
Async Engines:                 1
Unified Addressing:            Yes
Managed Memory:                Yes
Concurrent Managed Memory:     No
PGI Default Target:            -ta=tesla:cc50
</code></pre></div></div>
<h3 id="è®¾ç½®æ ¸å‡½æ•°è®¡ç®—ç½‘æ ¼">è®¾ç½®æ ¸å‡½æ•°è®¡ç®—ç½‘æ ¼</h3>
<p>ä¸€ç»´Gird,ä¸€ç»´Block</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!ä¸€ç»´ç½‘æ ¼ä¸­æœ‰Mä¸ªBlockï¼Œæ¯ä¸ªBlockæœ‰Nä¸ªThread
call sub&lt;&lt;&lt;M,N&gt;&gt;&gt;([argument])
</code></pre></div></div>
<p>å¤šç»´</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TYPE(dim3) grid,block
!
grid=dim3(2,2,2)
block=dim3(1,1,1)
call hellocuda&lt;&lt;&lt;grid,block&gt;&gt;&gt;()
</code></pre></div></div>
<p>kernalå‡½æ•°ä¸­çš„ç½‘æ ¼å†…ç½®å˜é‡,æ˜¯dim3çš„ç±»å‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    gx=GridDim%x !ç½‘æ ¼å¤§å°,å³Blockæ•°é‡
    gy=GridDim%y !ç½‘æ ¼å¤§å°,å³Blockæ•°é‡
    gz=GridDim%z !ç½‘æ ¼å¤§å°,å³Blockæ•°é‡
    bx=BlockIdx%x !Block ID
    by=BlockIdx%y !Block ID
    bz=BlockIdx%z !Block ID
    bDx=BlockDim%x !Blockå¤§å°ï¼Œå³Threadæ•°é‡/Block
    bDy=BlockDim%y !Blockå¤§å°ï¼Œå³Threadæ•°é‡/Block
    bDz=BlockDim%z !Blockå¤§å°ï¼Œå³Threadæ•°é‡/Block
    tx=ThreadIdx%x !Thead ID
    ty=ThreadIdx%y !Thead ID
    tz=ThreadIdx%z !Thead ID
</code></pre></div></div>
<p>ç¡®å®šç»å¯¹çº¿ç¨‹æ•°ï¼Œå¯ç”¨</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bi =    BlockIdx%x +        &amp;
        (BlockIdx%y - 1)*GridDim%x + &amp;
        (BlockIdx%z - 1)*GridDim%y*GridDim%x
ti = (bi-1)*BlockDim%x*BlockDim%y*BlockDim%z + &amp;
        ThreadIdx%x +        &amp;
        (ThreadIdx%y - 1)*BlockDim%x + &amp;
        (ThreadIdx%z - 1)*BlockDim%y*BlockDim%x
</code></pre></div></div>
<p>åœ¨æ ¸å‡½æ•°ä¸Šå¯åŠ¨<code class="highlighter-rouge">device</code>å‡½æ•°æ—¶ï¼Œä¸èƒ½è®¾ç½®ç½‘æ ¼(å› ä¸ºæ˜¯å„ä¸ªThreadåˆ†åˆ«è°ƒç”¨æ­¤å‡½æ•°)ï¼Œ<code class="highlighter-rouge">device</code>ä¸­ä¹Ÿæœ‰ç½‘æ ¼å†…ç½®å˜é‡ï¼Œå€¼ç”±è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹ç¡®å®š</p>

<h3 id="ä¸»æœºè®¾å¤‡ä»£ç åŒæ­¥é—®é¢˜">ä¸»æœº,è®¾å¤‡ä»£ç åŒæ­¥é—®é¢˜</h3>
<p>é»˜è®¤ä¸»æœºå’Œè®¾å¤‡é—´çš„ä»£ç (golbalçš„æ ¸å‡½æ•°)æ‰§è¡Œæ˜¯ä¸åŒæ­¥çš„,<br />å³ä¸‹é¢ä»£ç åœ¨å¼€å§‹æ‰§è¡Œ<code class="highlighter-rouge">CALL hellocuda &lt;&lt;&lt;2,3&gt;&gt;&gt;()</code>æ—¶ï¼Œæ§åˆ¶æƒå°±è¿”å›CPUäº†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a_d=1 
CALL hellocuda &lt;&lt;&lt;2,3&gt;&gt;&gt;()
</code></pre></div></div>
<p>ä¸»æœºå’Œå†…æ ¸ä¹‹å‰çš„æ•°æ®ä¼ è¾“æ˜¯åŒæ­¥çš„(æˆ–è€…æ˜¯é˜»å¡çš„)ï¼Œå¦‚<code class="highlighter-rouge">a_d=1</code>,åªæœ‰å½“CPUå’ŒGPUéƒ½æ‰§è¡Œåˆ°æ­¤å¤„æ‰å¯ä»¥ä¼ è¾“æ•°æ®ã€‚<br />
å…¶ä»–åŒæ­¥æ–¹æ³•</p>
<ul>
  <li>åœ¨ä»£ç å†…æ·»åŠ <code class="highlighter-rouge">i=cudaDeviceSynchronize()</code>,ç›´åˆ°æ‰€æœ‰è®¾å¤‡(GPU)ä¸Šä»£ç æ‰§è¡Œå®Œåˆ°æ­¤å¤„,ä¸»æœº(CPU)ç¨‹åºæ‰ç»§ç»­æ‰§è¡Œ</li>
  <li>å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿CPUå’ŒGPUåŒæ­¥å‡½æ•°è°ƒç”¨<code class="highlighter-rouge">export CUDA_LAUNCH_BLOCKING=1</code></li>
</ul>

<h3 id="æ ¸å‡½æ•°çš„å‚æ•°ä¼ é€’">æ ¸å‡½æ•°çš„å‚æ•°ä¼ é€’</h3>
<p><strong>é»˜è®¤ä¼ å€è°ƒç”¨</strong><br />
ä¼ é€’çš„å˜é‡éœ€è¦ä¿å­˜åœ¨deviceä¸Šï¼Œå³è¯¥å˜é‡åŸå§‹å®šä¹‰æ—¶åŠ ä¸Šdeviceå±æ€§ï¼Œå¦‚<code class="highlighter-rouge">INTEGER,device :: x_d(100)</code><br />
åº”è¯¥åªèƒ½ä¼ é€’åœ¨GPU/deviceä¸Šçš„åœ°å€<br />
<strong>ä¸å¯ä»¥ç›´æ¥ä¼ é€’hostä¸Šçš„å˜é‡åœ°å€</strong><br />
<br />
<strong>ä¼ å€¼è°ƒç”¨æ—¶</strong><br />
ä¼ å€¼è°ƒç”¨å¯ä»¥ä¼ é€’hostä¸Šçš„å˜é‡ï¼Œæ­¤æ—¶ï¼Œåœ¨æ ¸å‡½æ•°å†…éƒ¨å®šä¹‰æ—¶åŠ ä¸Švalueå±æ€§ï¼Œå¦‚<code class="highlighter-rouge">INTEGER,value :: N </code><br />
<strong>åŒ…å«ä¼ é€’å½¢å‚çš„æ ¸å‡½æ•°åªèƒ½åœ¨MODULEé‡Œå®šä¹‰,ä¸èƒ½ä½¿ç”¨external</strong>,ä¸ç„¶ä¼ é€’è¿‡æ¥çš„å€¼éƒ½å¾ˆéšæœºï¼Œå¼•èµ·è®¡ç®—å¼‚å¸¸</p>

<p>ä¼ é€’ç¤ºä¾‹,å¯çœ‹åˆ°externalçš„å‡½æ•°ä¸èƒ½ä¼ å€¼ï¼Œmoduleçš„å¯ä»¥ï¼Œä¼ é€’deviceå½¢å˜é‡éƒ½å¯ä»¥</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/code/cuda$ cat cudavar.cuf
attributes(global) SUBROUTINE whoIam(n,n_d)
IMPLICIT NONE
INTEGER,value :: N
INTEGER :: N_d
WRITE(*,*) "External", "N",N,"N_d",N_d
END SUBROUTINE

MODULE m_var
CONTAINS
attributes(global) SUBROUTINE whoIam_m(n,n_d)
IMPLICIT NONE
INTEGER,value :: N
INTEGER :: N_d
WRITE(*,*) "Module", "N",N,"N_d",N_d
END SUBROUTINE
END MODULE

PROGRAM testSend
use cudafor
USE m_var
IMPLICIT NONE
INTEGER   :: N,i
INTEGER,device :: N_d
N=10
N_d=10
CALL whoIam&lt;&lt;&lt;1,1&gt;&gt;&gt;(N,N_d)
CALL whoIam_m&lt;&lt;&lt;1,1&gt;&gt;&gt;(N,N_d)
i=cudaDeviceSynchronize()
END PROGRAM
cndaqiang@girl:~/code/cuda$ pgfortran cudavar.cuf &amp;&amp; ./a.out 
 External N    816657356 N_d           10
 Module N           10 N_d           10
</code></pre></div></div>

<h3 id="æ€§èƒ½æµ‹è¯•">æ€§èƒ½æµ‹è¯•</h3>
<p>ä¸‹è½½<a href="/web/file/2020/fastcuda.cuf">fastcuda.cuf</a>ï¼Œç¼–è¯‘æµ‹è¯•<br />
å¯ä»¥çœ‹åˆ°å½“çŸ©é˜µå¤§äº1E5æ—¶ï¼ŒGPU(940MX)è®¡ç®—æ—¶é—´=CPU(i7-7500U)æ—¶é—´/3<br />
ä¸åŒå˜é‡èµ‹å€¼è€—æ—¶ &lt; ç›¸åŒå˜é‡èµ‹å€¼     <br />
ä¸åŒå˜é‡èµ‹å€¼: <code class="highlighter-rouge">GPU-GPU &lt; CPU-CPU</code>   <br />
GPU-CPUèµ‹å€¼è€—æ—¶:<code class="highlighter-rouge">GPUx-GPUy + CPUx-CPUy </code>  <br />
GPUx-GPUyé»˜è®¤çš„èµ‹å€¼è¿˜æŒºå¿«çš„</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/code/cuda$ pgfortran fastcuda.cuf  &amp;&amp; ./a.out 
 -----------------------
N     100000      CPU build, WALL         1.10000 ms
N     100000        CPU cal, WALL         0.25800 ms
N     100000      GPU build, WALL         0.12800 ms
N     100000        GPU cal, WALL         0.06400 ms
N     100000       GPU-&gt;CPU, WALL         0.33300 ms
N     100000       CPU-&gt;GPU, WALL         0.30300 ms
N     100000     CPUy-&gt;CPUx, WALL         0.20800 ms
N     100000     CPUy-&gt;CPUy, WALL         0.42600 ms
N     100000     GPUy-&gt;GPUz, WALL         0.07100 ms
N     100000     GPUy-&gt;GPUy, WALL         0.59500 ms
N     100000                Error         0.00000
 -----------------------
N  100100000      CPU build, WALL       910.17902 ms
N  100100000        CPU cal, WALL       202.79601 ms
N  100100000      GPU build, WALL        45.75900 ms
N  100100000        GPU cal, WALL        59.73200 ms
N  100100000       GPU-&gt;CPU, WALL       244.66000 ms
N  100100000       CPU-&gt;GPU, WALL       251.89999 ms
N  100100000     CPUy-&gt;CPUx, WALL       210.46001 ms
N  100100000     CPUy-&gt;CPUy, WALL       495.70901 ms
N  100100000     GPUy-&gt;GPUz, WALL        31.10200 ms
N  100100000     GPUy-&gt;GPUy, WALL       499.45700 ms
N  100100000                Error         0.00000
</code></pre></div></div>
<h4 id="æ£€æµ‹å„ä¸ªæ¨¡å—è¿è¡Œæ—¶é—´-nvprof-aout">æ£€æµ‹å„ä¸ªæ¨¡å—è¿è¡Œæ—¶é—´<code class="highlighter-rouge"> nvprof ./a.out</code></h4>
<p>ç¤ºä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python27) cndaqiang@girl:~/code/cuda$ nvprof ./a.out
            2            2            2
==2410== NVPROF is profiling process 2410, command: ./a.out
...ç¨‹åºè¿è¡Œè¾“å‡º
==2410== Profiling application: ./a.out
==2410== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:  100.00%  509.55us         1  509.55us  509.55us  509.55us  m_mycuda_hellocuda_
      API calls:   99.61%  264.75ms         1  264.75ms  264.75ms  264.75ms  cudaLaunchKernel
                    0.21%  549.89us         1  549.89us  549.89us  549.89us  cudaDeviceSynchronize
                    0.12%  318.01us        97  3.2780us     250ns  139.94us  cuDeviceGetAttribute
                    0.05%  123.14us         1  123.14us  123.14us  123.14us  cuDeviceTotalMem
                    0.02%  50.688us         1  50.688us  50.688us  50.688us  cuDeviceGetName
                    0.00%  2.9850us         3     995ns     267ns  2.0500us  cuDeviceGetCount
                    0.00%  2.1570us         2  1.0780us     348ns  1.8090us  cuDeviceGet
                    0.00%     464ns         1     464ns     464ns     464ns
</code></pre></div></div>

<h2 id="æŠ¥é”™">æŠ¥é”™</h2>
<h3 id="cudaä»£ç é”™è¯¯">CUDAä»£ç é”™è¯¯</h3>
<p>åœ¨è®¾å¤‡(GPU)ä»£ç ä¸Šè¿è¡Œä¸»æœº(CPU)ç¨‹åº,å¦‚<code class="highlighter-rouge">CALL SLEEP(1)</code>,<code class="highlighter-rouge">CALL system("")</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-S-0155-Calls from device code to a host subroutine are allowed only in emulation mode - sleep (hellocuda.cuf: 11)
  0 inform,   0 warnings,   1 severes, 0 fatal for mycuda2
</code></pre></div></div>

<p>åœ¨hostä¸Šè¾“å‡ºdeviceå˜é‡,å¦‚<code class="highlighter-rouge">WRITE(*,*)  a_d</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-S-0155-device data allowed in I/O statements only in emulation mode  (hellocuda.cuf: 45)
  0 inform,   0 warnings,   1 severes, 0 fatal for hellocuda
</code></pre></div></div>

<p>deviceä»£ç ä¸èƒ½ä½¿ç”¨æ ¼å¼åŒ–è¾“å‡ºï¼Ÿ ä¸èƒ½ç”¨<code class="highlighter-rouge">WRITE(*,"(A)") "Hello"</code>,åªèƒ½<code class="highlighter-rouge">WRITE(*,*) "Hello"</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-S-0155-I/O statements allowed in device routines only in emulation mode  (hellocuda.cuf: 12)
  0 inform,   0 warnings,   1 severes, 0 fatal for mycuda
</code></pre></div></div>

<p>åœ¨hostä¸Šè°ƒç”¨deviceå‡½æ•°</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-S-0155-Kernel launch of attributes(device) subprogram is not allowed - gpufun (hellocuda.cuf: 43)
  0 inform,   0 warnings,   1 severes, 0 fatal for main
</code></pre></div></div>

<p>æ‹“å±•å<code class="highlighter-rouge">cuf</code>å†™ä¸º<code class="highlighter-rouge">f90</code>æ—¶ï¼Œä¸è¯†åˆ«cudaå‡½æ•°</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/cndaqiang/code/cuda/checkcuda.f90:8: undefined reference to `cudagetdevicecount_'
</code></pre></div></div>
<p>å‘æ ¸å‡½æ•°ä¼ é€’hostä¸Šå˜é‡,å¦‚æœéè¦ä¼ é€’ï¼ŒæŠŠè¾“å…¥å‚æ•°ç±»å‹åŠ ä¸Š<code class="highlighter-rouge">value</code>ï¼Œä¸”éœ€è¦åœ¨Moduleé‡Œé¢</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-S-0528-Argument number 1 to whoiam_m: device attribute mismatch (cudavar.cuf: 47)
  0 inform,   0 warnings,   1 severes, 0 fatal for testsend
</code></pre></div></div>
<h3 id="pgiæ™®é€šfortranè¯­æ³•é”™è¯¯">PGIæ™®é€šFortranè¯­æ³•é”™è¯¯</h3>

<p>åœ¨ä»£ç è¡Œåé¢å¤šæ‰“<strong>ä¸­æ–‡å­—ç¬¦(ç©ºæ ¼,å¹å·,æ±‰å­—â€¦)</strong>ï¼Œå¦‚ï½€IMPLICIT NONEï½€ä¸<code class="highlighter-rouge">IMPLICIT NONEã€€</code>çš„åŒºåˆ«
è­¦å‘Šï¼Œä¹Ÿå¯ä»¥è¿è¡Œ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-W-0025-Illegal character (E3) - ignored (hellocuda.cuf: 7)
</code></pre></div></div>
<p>ä¸­è‹±æ–‡é€—å·æ‰“é”™<code class="highlighter-rouge">,</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-W-0025-Illegal character (EF) - ignored (hellocuda.cuf: 12)
</code></pre></div></div>
<p>sqrtè¾“å…¥ç±»å‹ä¸ºå®æ•°,ä½¿ç”¨æ•´å½¢<code class="highlighter-rouge">sqrt(10)</code>è¾“å…¥æŠ¥é”™</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PGF90-S-0038-Symbol, sqrt, has not been explicitly declared (fatercuda.cuf)
  0 inform,   0 warnings,   1 severes, 0 fatal for fast
</code></pre></div></div>
:ET