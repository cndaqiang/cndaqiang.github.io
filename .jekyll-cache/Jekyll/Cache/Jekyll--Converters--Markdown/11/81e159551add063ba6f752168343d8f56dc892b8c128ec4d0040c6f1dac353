I"¤><ul id="markdown-toc">
  <li><a href="#å‚è€ƒ" id="markdown-toc-å‚è€ƒ">å‚è€ƒ</a></li>
  <li><a href="#æ–‡ä»¶" id="markdown-toc-æ–‡ä»¶">æ–‡ä»¶</a></li>
  <li><a href="#bufferçš„ä½¿ç”¨" id="markdown-toc-bufferçš„ä½¿ç”¨">bufferçš„ä½¿ç”¨</a>    <ul>
      <li><a href="#ä½¿ç”¨" id="markdown-toc-ä½¿ç”¨">ä½¿ç”¨</a></li>
      <li><a href="#open_bufferåˆ›å»ºæ‰“å¼€buffer" id="markdown-toc-open_bufferåˆ›å»ºæ‰“å¼€buffer"><code class="highlighter-rouge">open_buffer</code>åˆ›å»º/æ‰“å¼€buffer</a>        <ul>
          <li><a href="#save_bufferä¿å­˜åˆ°buffer" id="markdown-toc-save_bufferä¿å­˜åˆ°buffer"><code class="highlighter-rouge">save_buffer</code>ä¿å­˜åˆ°buffer</a></li>
          <li><a href="#get_bufferè¯»å–æ•°æ®" id="markdown-toc-get_bufferè¯»å–æ•°æ®"><code class="highlighter-rouge">get_buffer</code>è¯»å–æ•°æ®</a></li>
          <li><a href="#close_bufferå…³é—­buffer" id="markdown-toc-close_bufferå…³é—­buffer"><code class="highlighter-rouge">close_buffer</code>å…³é—­buffer</a></li>
          <li><a href="#ç»¼åˆç¤ºä¾‹" id="markdown-toc-ç»¼åˆç¤ºä¾‹">ç»¼åˆç¤ºä¾‹</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#å…¶ä»–æ–‡ä»¶" id="markdown-toc-å…¶ä»–æ–‡ä»¶">å…¶ä»–æ–‡ä»¶</a>    <ul>
      <li><a href="#close_fileså…³é—­æ‰“å¼€çš„buffer" id="markdown-toc-close_fileså…³é—­æ‰“å¼€çš„buffer"><code class="highlighter-rouge">close_files</code>å…³é—­æ‰“å¼€çš„buffer</a></li>
    </ul>
  </li>
</ul>

<p>QEä»£ç é˜…è¯»ç³»åˆ—ï¼Œä¸ªäººå­¦ä¹ è®°å½•ï¼Œä»…ä¾›å‚è€ƒã€‚<br />
ä»£ç ä»“åº“<a href="https://gitee.com/cndaqiang/QE-6.4.1/tree/master">QE-6.4.1@cndaqiang</a><br /></p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://github.com/QEF/q-e.git">q-e code</a><br /></p>

<h2 id="æ–‡ä»¶">æ–‡ä»¶</h2>
<p>File:<code class="highlighter-rouge">PW/src/buffers.f90</code><br />
File:<code class="highlighter-rouge">Modules/io_files.f90</code> æ–‡ä»¶çš„unit</p>

<h2 id="bufferçš„ä½¿ç”¨">bufferçš„ä½¿ç”¨</h2>
<p>ä¸ºæ¯ä¸ªprocessoråˆ›å»ºä¸€ä¸ªæ–‡ä»¶(æˆ–å†…å­˜buffer)ï¼Œç”¨ä¸è¯»å–å’Œå­˜å‚¨å˜é‡<br />
å¦‚,å½“ä½¿ç”¨4ä¸ªprocessorè¿è¡Œæ—¶,å­˜å‚¨çš„æ³¢å‡½æ•°æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwscf.wfc1  pwscf.wfc2  pwscf.wfc3  pwscf.wfc4 
</code></pre></div></div>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USE buffers,  ONLY : open_buffer, save_buffer, get_buffer,close_buffer
</code></pre></div></div>

<h3 id="open_bufferåˆ›å»ºæ‰“å¼€buffer"><code class="highlighter-rouge">open_buffer</code>åˆ›å»º/æ‰“å¼€buffer</h3>
<p>å‘½ä»¤</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open_buffer (unit, extension, nword, io_level, exst, exst_file, direc)
</code></pre></div></div>
<p>å¯ç”¨äºåˆ›å»ºæ–°çš„bufferï¼Œä¹Ÿå¯ä»¥æ‰“å¼€æ—§çš„bufferï¼Œè¯»å–æ—§çš„æ•°æ®<br />
å‚æ•°è§£é‡Š</p>
<ul>
  <li><code class="highlighter-rouge">unit</code> æ–‡ä»¶çš„unitå·ï¼Œbufferçš„æ ‡è¯†</li>
  <li><code class="highlighter-rouge">extension</code>ï¼Œè‹¥ä¿å­˜èƒ½åˆ°æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸º<code class="highlighter-rouge">pwscf.extension.node</code></li>
  <li><code class="highlighter-rouge">nword</code>,ä¸€ä¸ªbufferé‡Œé¢ä¿å­˜äº†ä¸€æ®µä¸€æ®µçš„æ•°æ®ï¼Œä¸€æ®µçš„é•¿åº¦æ˜¯nwordä¸ªDCOMPLEX,<br />
å¦‚ï¼Œæ³¢å‡½æ•°çš„ä¸€æ®µå°±å­˜å‚¨äº†è¯¥processorå¤„ç†çš„å•ä¸ªkç‚¹çš„æ‰€æœ‰æ³¢å‡½æ•°<code class="highlighter-rouge">nwordwfc  = nbnd*npwx*npol</code><br />
where,<code class="highlighter-rouge">nbndèƒ½å¸¦æ•° * npwxå¹³é¢æ³¢æ•° * npol(Non-clinear spin)</code></li>
  <li><code class="highlighter-rouge">io_level</code>,<code class="highlighter-rouge">io_level&gt;0</code>ä¿å­˜åˆ°æ–‡ä»¶,<code class="highlighter-rouge">io_level=0</code>ä¿å­˜åˆ°å†…å­˜<br />
<code class="highlighter-rouge">io_level</code>ç”±è¾“å…¥å‚æ•°<code class="highlighter-rouge">disk_io</code>å†³å®š
    <blockquote>
      <ul>
        <li>â€˜highâ€™,<code class="highlighter-rouge">io_level = 2</code>
   <br />Â  Â   Â   save all data to disk at each SCF step</li>
        <li>
          <p>â€˜mediumâ€™,<code class="highlighter-rouge">io_level = 1</code> 
   <br />Â  Â   Â    save wavefunctions at each SCF step unless
   <br />Â  Â   Â    there is a single k-point per process (in which
   <br />Â  Â   Â    case the behavior is the same as â€˜lowâ€™)</p>
        </li>
        <li>
          <p>â€˜lowâ€™,<code class="highlighter-rouge">io_level = 0</code>
   <br />Â  Â   Â    store wfc in memory, save only at the end</p>
        </li>
        <li>â€˜noneâ€™,<code class="highlighter-rouge">io_level = -1</code>
   <br />Â  Â   Â    do not save anything, not even at the end
   <br />Â  Â   Â    (â€˜scfâ€™, â€˜nscfâ€™, â€˜bandsâ€™ calculations; some data
   <br />Â  Â   Â    may be written anyway for other calculations)</li>
      </ul>
    </blockquote>
  </li>
  <li><code class="highlighter-rouge">exst</code>ï¼Œå†…å­˜(<code class="highlighter-rouge">io_level=0</code>)/æ–‡ä»¶(<code class="highlighter-rouge">io_level&gt;0</code>)æ˜¯å¦å­˜åœ¨<code class="highlighter-rouge">pwscf.extension.node</code>æ–‡ä»¶</li>
  <li><code class="highlighter-rouge">exst_file</code> è‹¥ç›®å½•ä¸­å­˜åœ¨è¿™ä¸ªæ–‡ä»¶<code class="highlighter-rouge">pwscf.extension.node</code>ï¼Œè¿”å›<code class="highlighter-rouge">T</code><br />å¯é€‰ï¼ŒåºŸå¼ƒçš„å‚æ•°ï¼Œæ— è®ºä¿å­˜åˆ°å†…å­˜è¿˜æ˜¯æ–‡ä»¶ï¼Œåªæ£€æŸ¥æ˜¯å¦å­˜åœ¨<code class="highlighter-rouge">pwscf.extension.node</code>æ–‡ä»¶<br />
<code class="highlighter-rouge">LOGICAL, INTENT(OUT), OPTIONAL :: exst_file</code></li>
  <li><code class="highlighter-rouge">direc</code>ä¿å­˜æ–‡ä»¶è·¯å¾„,æ–‡ä»¶<code class="highlighter-rouge">direc/pwscf.extension.node</code><br />
<code class="highlighter-rouge">CHARACTER(LEN=*), INTENT(IN), OPTIONAL :: direc</code></li>
</ul>

<p>ç¤ºä¾‹,<code class="highlighter-rouge">wfcinit.f90</code>ä¸­æ‰“å¼€bufferæ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open_buffer( iunwfc, 'wfc', nwordwfc, io_level, exst_mem, exst_file )
</code></pre></div></div>

<h4 id="save_bufferä¿å­˜åˆ°buffer"><code class="highlighter-rouge">save_buffer</code>ä¿å­˜åˆ°buffer</h4>
<p>å‘½ä»¤</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>save_buffer( vect, nword, unit, nrec )
</code></pre></div></div>
<p>å‚æ•°è§£é‡Š</p>
<ul>
  <li>ä¿å­˜<code class="highlighter-rouge">COMPLEX(DP) vect</code>ä¸­çš„æ•°æ®</li>
  <li>ä¿å­˜æ•°æ®é•¿åº¦<code class="highlighter-rouge">nword</code>ï¼Œå¾…ä¿å­˜åŸå§‹æ•°æ®<code class="highlighter-rouge">vect(1:nword)</code>,<strong>å¿…é¡»å’Œopen_bufferçš„ä¸€æ ·ï¼Œä¸ç„¶ä¼šæŠ¥é”™</strong></li>
  <li>æ–‡ä»¶/bufferç¼–å·<code class="highlighter-rouge">unit</code></li>
  <li>ä¿å­˜åˆ°bufferä¸­çš„ç¬¬<code class="highlighter-rouge">(nrec-1)*nword+1</code>åˆ°<code class="highlighter-rouge">(nerc)*nword</code>æ®µ<br />
åœ¨æ³¢å‡½æ•°çš„éƒ¨åˆ†ï¼Œä¸€èˆ¬æŒ‰ç…§ä¸€ä¸ªkç‚¹ä¸€ä¸ªkç‚¹çš„ä¿å­˜ï¼Œ<code class="highlighter-rouge">nrec</code>å–kç‚¹ç¼–å·<code class="highlighter-rouge">ik</code><br />
å½“åªæœ‰ä¸€ä¸ªkç‚¹æ—¶,ä¸(æ— é¡»)è¿›è¡Œä¿å­˜æ“ä½œ</li>
</ul>

<p>ç¤ºä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     IF ( nks &gt; 1 .OR. (io_level &gt; 1) .OR. lelfield ) &amp;
         CALL save_buffer ( evc, nwordwfc, iunwfc, ik )
</code></pre></div></div>
<h4 id="get_bufferè¯»å–æ•°æ®"><code class="highlighter-rouge">get_buffer</code>è¯»å–æ•°æ®</h4>
<p>å‘½ä»¤</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get_buffer( vect, nword, unit, nrec )
</code></pre></div></div>
<p>å‚æ•°è§£é‡Š</p>
<ul>
  <li>å­˜åˆ°<code class="highlighter-rouge">COMPLEX(DP) vect</code>ä¸­å»</li>
  <li>æå–<code class="highlighter-rouge">nword</code>é•¿åº¦ï¼Œä¿å­˜åˆ°<code class="highlighter-rouge">vect(1:nword)</code>,<strong>å¿…é¡»å’Œopen_bufferçš„ä¸€æ ·ï¼Œä¸ç„¶ä¼šæŠ¥é”™</strong></li>
  <li>æ–‡ä»¶ç¼–å·<code class="highlighter-rouge">unit</code></li>
  <li>æå–ç¬¬<code class="highlighter-rouge">(nrec-1)*nword+1</code>åˆ°<code class="highlighter-rouge">(nerc)*nword</code>æ®µçš„æ•°æ®<br />
åœ¨æ³¢å‡½æ•°çš„éƒ¨åˆ†ï¼Œä¸€èˆ¬æŒ‰ç…§ä¸€ä¸ªkç‚¹ä¸€ä¸ªkç‚¹çš„å­˜å‚¨ï¼Œ<code class="highlighter-rouge">nrec</code>å–kç‚¹ç¼–å·<code class="highlighter-rouge">ik</code><br />
å½“åªæœ‰ä¸€ä¸ªkç‚¹æ—¶,ä¸(æ— é¡»)è¿›è¡Œè¯»å–æ“ä½œ</li>
</ul>

<p>ç¤ºä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF (nks &gt; 1) CALL get_buffer(evc, nwordwfc, iunwfc, ik)
</code></pre></div></div>

<h4 id="close_bufferå…³é—­buffer"><code class="highlighter-rouge">close_buffer</code>å…³é—­buffer</h4>
<p>å‘½ä»¤</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>close_buffer ( unit, status )
</code></pre></div></div>
<p>å‚æ•°è§£é‡Š</p>
<ul>
  <li><code class="highlighter-rouge">unit</code>ç¼–å·</li>
  <li><code class="highlighter-rouge">status</code>
    <ul>
      <li><code class="highlighter-rouge">status="keep"</code>,å…³é—­bufferåä¿å­˜åˆ°æ–‡ä»¶</li>
      <li><code class="highlighter-rouge">status="delet"</code>å…³é—­bufferåï¼Œåˆ é™¤buffer/æ–‡ä»¶</li>
    </ul>
  </li>
  <li>å…³é—­åï¼Œå†…å­˜ä¸­çš„bufferä¼šè¢«deallocateæ‰</li>
</ul>

<p>ç¤ºä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  IF ( lflag .AND. (io_level &lt;= 0) ) THEN
     CALL close_buffer ( iunwfc, 'DELETE' )
  ELSE
     CALL close_buffer ( iunwfc, 'KEEP' )
  END IF
</code></pre></div></div>

<h4 id="ç»¼åˆç¤ºä¾‹">ç»¼åˆç¤ºä¾‹</h4>
<p>æ‰“å¼€æ–‡ä»¶ï¼Œè‹¥å­˜åœ¨ï¼Œè¯»å–æ•°æ®ï¼Œè‹¥ä¸å­˜åœ¨ä¿å­˜æ•°æ®</p>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="kt">COMPLEX</span><span class="p">(</span><span class="n">DP</span><span class="p">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">q_data</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0_dp</span><span class="w">
  </span><span class="kt">INTEGER</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">q_i</span><span class="p">,</span><span class="n">q_unit</span><span class="o">=</span><span class="mi">12306</span><span class="w">
  </span><span class="kt">LOGICAL</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">q_exst</span><span class="p">,</span><span class="n">q_exst_file</span><span class="w">
  </span><span class="k">CALL</span><span class="w"> </span><span class="n">open_buffer</span><span class="p">(</span><span class="n">q_unit</span><span class="p">,</span><span class="s2">"qdata"</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">q_exst</span><span class="p">,</span><span class="n">q_exst_file</span><span class="p">)</span><span class="w">
  </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">"CNQ: q_exst_file"</span><span class="p">,</span><span class="n">q_exst_file</span><span class="w">
  </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">q_exst_file</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
      </span><span class="k">DO</span><span class="w"> </span><span class="n">q_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="w">
         </span><span class="k">CALL</span><span class="w"> </span><span class="n">get_buffer</span><span class="p">(</span><span class="w"> </span><span class="n">q_data</span><span class="p">((</span><span class="n">q_i</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="mi">10+1</span><span class="p">),</span><span class="mi">10</span><span class="p">,</span><span class="n">q_unit</span><span class="p">,</span><span class="n">q_i</span><span class="p">)</span><span class="w">
      </span><span class="k">ENDDO</span><span class="w">
      </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">"CNQ:q_data read from old data"</span><span class="p">,</span><span class="n">q_data</span><span class="w">
   </span><span class="k">ELSE</span><span class="w">
      </span><span class="k">DO</span><span class="w"> </span><span class="n">q_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="w">
         </span><span class="n">q_data</span><span class="p">(((</span><span class="n">q_i</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="mi">10+1</span><span class="p">):</span><span class="n">q_i</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_dp</span><span class="o">*</span><span class="n">q_i</span><span class="w">
         </span><span class="k">CALL</span><span class="w"> </span><span class="n">save_buffer</span><span class="p">(</span><span class="w"> </span><span class="n">q_data</span><span class="p">((</span><span class="n">q_i</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="mi">10+1</span><span class="p">),</span><span class="mi">10</span><span class="p">,</span><span class="n">q_unit</span><span class="p">,</span><span class="n">q_i</span><span class="p">)</span><span class="w">
      </span><span class="k">ENDDO</span><span class="w">
      </span><span class="n">q_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_dp</span><span class="w">
      </span><span class="k">DO</span><span class="w"> </span><span class="n">q_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="w">
         </span><span class="k">CALL</span><span class="w"> </span><span class="n">get_buffer</span><span class="p">(</span><span class="w"> </span><span class="n">q_data</span><span class="p">((</span><span class="n">q_i</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="mi">10+1</span><span class="p">),</span><span class="mi">10</span><span class="p">,</span><span class="n">q_unit</span><span class="p">,</span><span class="n">q_i</span><span class="p">)</span><span class="w">
      </span><span class="k">ENDDO</span><span class="w">
      </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">"CNQ:q_data read from save data"</span><span class="p">,</span><span class="n">q_data</span><span class="w">
   </span><span class="k">ENDIF</span><span class="w">
   </span><span class="k">CALL</span><span class="w"> </span><span class="n">close_buffer</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">q_unit</span><span class="p">,</span><span class="w"> </span><span class="s2">"KEEP"</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="å…¶ä»–æ–‡ä»¶">å…¶ä»–æ–‡ä»¶</h2>
<h3 id="close_fileså…³é—­æ‰“å¼€çš„buffer"><code class="highlighter-rouge">close_files</code>å…³é—­æ‰“å¼€çš„buffer</h3>
<p>File:<code class="highlighter-rouge">PW/src/close_files.f90</code><br />
å…³é—­æ‰“å¼€çš„buffer,å¦‚wfc</p>

:ET