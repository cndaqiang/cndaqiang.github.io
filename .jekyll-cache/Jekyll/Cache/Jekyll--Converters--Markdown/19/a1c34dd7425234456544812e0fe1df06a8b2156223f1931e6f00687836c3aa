I"/,<ul id="markdown-toc">
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
  <li><a href="#安装" id="markdown-toc-安装">安装</a></li>
  <li><a href="#配置" id="markdown-toc-配置">配置</a></li>
  <li><a href="#启动" id="markdown-toc-启动">启动</a></li>
  <li><a href="#使用" id="markdown-toc-使用">使用</a>    <ul>
      <li><a href="#提交作业" id="markdown-toc-提交作业">提交作业</a></li>
      <li><a href="#用pbs的命令控制slurm" id="markdown-toc-用pbs的命令控制slurm">用pbs的命令控制slurm</a></li>
    </ul>
  </li>
  <li><a href="#slurm其他用法" id="markdown-toc-slurm其他用法">slurm其他用法</a>    <ul>
      <li><a href="#交完作业后修改性质" id="markdown-toc-交完作业后修改性质">交完作业后修改性质</a></li>
      <li><a href="#查看作业信息" id="markdown-toc-查看作业信息">查看作业信息</a></li>
      <li><a href="#查看slurm环境变量" id="markdown-toc-查看slurm环境变量">查看slurm环境变量</a></li>
      <li><a href="#sacctmgr-show" id="markdown-toc-sacctmgr-show"><code class="highlighter-rouge">sacctmgr show</code></a></li>
    </ul>
  </li>
</ul>

<h2 id="参考">参考</h2>
<p><a href="https://www.linuxwave.info/2019/10/installing-slurm-workload-manager-job.html">Installing Slurm Workload Manager &amp; Job Scheduler on Ubuntu 18.04</a></p>

<h2 id="安装">安装</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install slurm-wlm slurm-wlm-doc -y 
</code></pre></div></div>

<p>查看信息</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~$ slurmd -V
slurm-wlm 17.11.2
cndaqiang@girl:~$ slurmd -C
NodeName=girl CPUs=4 Boards=1 SocketsPerBoard=1 CoresPerSocket=2 ThreadsPerCore=2 RealMemory=15939
UpTime=0-08:01:18
</code></pre></div></div>

<h2 id="配置">配置</h2>

<p>修改配置文件</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /etc/slurm-llnl/slurm.conf 
vi /etc/slurm-llnl/slurm.conf 
</code></pre></div></div>
<p>根据
https://www.linuxwave.info/2019/10/installing-slurm-workload-manager-job.html</p>

<p>浏览器打开/usr/share/doc/slurm-wlm-doc/html/configurator.easy.html
添加各种配置和路径，生成配置文件，复制到<code class="highlighter-rouge">vi /etc/slurm-llnl/slurm.conf</code>
注意</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Some of the configuration that I changed from the default
- Make sure the hostname of the system is ControlMachine and NodeName
- State Preservation: set StateSaveLocation to /var/spool/slurm-llnl
- Process tracking: use Pgid instead of Cgroup
- Process ID logging: set this to /var/run/slurm-llnl/slurmctld.pid and /var/run/slurm-llnl/slurmd.pid
</code></pre></div></div>
<p>我的配置文件</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># slurm.conf file generated by configurator easy.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.
#
ControlMachine=girl
#ControlAddr=
#
#MailProg=/bin/mail
MpiDefault=none
#MpiParams=ports=#-#
ProctrackType=proctrack/pgid
ReturnToService=1
SlurmctldPidFile=/var/run/slurm-llnl/slurmctld.pid
#SlurmctldPort=6817
SlurmdPidFile=/var/run/slurm-llnl/slurmd.pid
#SlurmdPort=6818
SlurmdSpoolDir=/var/spool/slurmd
SlurmUser=slurm
#SlurmdUser=root
StateSaveLocation=/var/spool/slurm-llnl
SwitchType=switch/none
TaskPlugin=task/none
#
#
# TIMERS
#KillWait=30
#MinJobAge=300
#SlurmctldTimeout=120
#SlurmdTimeout=300
#
#
# SCHEDULING
FastSchedule=1
SchedulerType=sched/backfill
SelectType=select/linear
#SelectTypeParameters=
#
#
# LOGGING AND ACCOUNTING
AccountingStorageType=accounting_storage/none
ClusterName=cluster
#JobAcctGatherFrequency=30
JobAcctGatherType=jobacct_gather/none
#SlurmctldDebug=3
#SlurmctldLogFile=
#SlurmdDebug=3
#SlurmdLogFile=
#
#
# COMPUTE NODES
NodeName=girl CPUs=4 State=UNKNOWN
PartitionName=debug Nodes=girl Default=YES MaxTime=INFINITE State=UP
</code></pre></div></div>
<p>修改完<code class="highlighter-rouge">vi /etc/slurm-llnl/slurm.conf</code>配置文件后，与配置文件对应，创建相应的目录和权限设置</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -rf  /var/spool/slurm-llnl
mkdir /var/spool/slurm-llnl
chown -R slurm.slurm /var/spool/slurm-llnl
rm -rf /var/run/slurm-llnl/
mkdir /var/run/slurm-llnl/
chown -R slurm.slurm /var/run/slurm-llnl/
</code></pre></div></div>

<h2 id="启动">启动</h2>
<p>启动和设置开机自启
Start slurmd and enable on boot</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start slurmd
systemctl enable slurmd
systemctl start slurmctld
systemctl enable slurmctld
</code></pre></div></div>
<p>修改配置后的重启命令</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart  slurmctld
systemctl restart  slurmd
</code></pre></div></div>

<h2 id="使用">使用</h2>

<h3 id="提交作业">提交作业</h3>
<p>作业脚本</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#</span>
<span class="c">#SBATCH --job-name=manytdap</span>
<span class="c">#SBATCH --output=tdap.out</span>
<span class="c">#SBATCH -N 1</span>
<span class="c">#SBATCH --ntasks-per-node=4</span>
<span class="c">#SBATCH --time=00:30:00</span>
<span class="c">#SBATCH -p debug</span>



<span class="nv">EXEC</span><span class="o">=</span>/home/cndaqiang/work/siesta/siesta-4.1-b1/Obj/siesta

mpirun <span class="nv">$EXEC</span> input.fdf | <span class="nb">tee </span>result
<span class="c">#注</span>
<span class="c">#默认mpirun使用核数由ntasks-per-node*N确定</span>
<span class="c">#也可用 -np 指定</span>
<span class="c">#mpirun -np 4  $EXEC -i input.in | tee result</span>
</code></pre></div></div>

<p>提交作业，查看队列计算情况</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cndaqiang@girl:~/work/slurm$ sbatch run-slurm.sh
Submitted batch job 21
cndaqiang@girl:~/work/slurm$ squeue
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
                21     debug manytdap cndaqian  R       0:01      1 girl
</code></pre></div></div>

<h3 id="用pbs的命令控制slurm">用pbs的命令控制slurm</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install slurm-wlm-torque
</code></pre></div></div>
<p>就可以使用qstat,qsub 等pbs的命令了</p>

<h2 id="slurm其他用法">slurm其他用法</h2>
<h3 id="交完作业后修改性质">交完作业后修改性质</h3>
<p>参考<a href="http://bicmr.pku.edu.cn/~wenzw/pages/slurm.html">SLURM 使用参考</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol update jobid=JOBID ...
#如
account=&lt;account&gt;                      mintmpdisknode=&lt;megabytes&gt;             reqnodelist=&lt;nodes&gt;
conn-type=&lt;type&gt;                       name&gt;                                  reqsockets=&lt;count&gt;
contiguous=&lt;yes|no&gt;                    name=&lt;name&gt;                            reqthreads=&lt;count&gt;
dependency=&lt;dependency_list&gt;           nice[=delta]                           requeue=&lt;0|1&gt;
eligibletime=yyyy-mm-dd                nodelist=&lt;nodes&gt;                       reservationname=&lt;name&gt;
excnodelist=&lt;nodes&gt;                    numcpus=&lt;min_count[-max_count]         rotate=&lt;yes|no&gt;
features=&lt;features&gt;                    numnodes=&lt;min_count[-max_count]&gt;       shared=&lt;yes|no&gt;
geometry=&lt;geo&gt;                         numtasks=&lt;count&gt;                       starttime=yyyy-mm-dd
gres=&lt;list&gt;                            or                                     switches=&lt;count&gt;[@&lt;max-time-to-wait&gt;]
licenses=&lt;name&gt;                        partition=&lt;name&gt;                       timelimit=[d-]h:m:s
mincpusnode=&lt;count&gt;                    priority=&lt;number&gt;                      userid=&lt;UID
minmemorycpu=&lt;megabytes&gt;               qos=&lt;name&gt;                             wckey=&lt;key&gt;
minmemorynode=&lt;megabytes&gt;              reqcores=&lt;count&gt;
</code></pre></div></div>
<p>修改示例</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#修改时间
 scontrol update jobid=33932 timelimit=6:00:00
#修改队列  
 scontrol update jobid=33932 partition=&lt;name&gt;          
</code></pre></div></div>

<h3 id="查看作业信息">查看作业信息</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scontrol show job  67139
scontrol show job  671399 | grep WorkDir
   WorkDir=/public/home/cndaqiang/work/tdap/blocksize/origin/Si32/Si32-12
</code></pre></div></div>

<h3 id="查看slurm环境变量">查看slurm环境变量</h3>
<p>提交作业后，会增加的环境变量，在脚本里面使用下面的命令找到相应环境变量</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>env | grep SLURM
SLURM_CHECKPOINT_IMAGE_DIR=/var/slurm/checkpoint
SLURM_NODELIST=comput[110,123,130]
SLURM_JOB_NAME=slurm
SLURMD_NODENAME=comput110
SLURM_TOPOLOGY_ADDR=comput110
SLURM_NTASKS_PER_NODE=36
SLURM_PRIO_PROCESS=0
SLURM_NODE_ALIASES=(null)
SLURM_JOB_QOS=normal
SLURM_TOPOLOGY_ADDR_PATTERN=node
SLURM_NNODES=3
SLURM_JOBID=850925
SLURM_NTASKS=108
SLURM_TASKS_PER_NODE=36(x3)
SLURM_WORKING_CLUSTER=cluster_admin1:10.10.10.249:6817:8448
SLURM_JOB_ID=850925
SLURM_JOB_USER=cndaqiang
SLURM_JOB_UID=1011
SLURM_NODEID=0
SLURM_SUBMIT_DIR=/public/home/cndaqiang/work/slurm
SLURM_TASK_PID=176862
SLURM_NPROCS=108
SLURM_HOME=/opt/gridview/slurm
SLURM_CPUS_ON_NODE=36
SLURM_PROCID=0
SLURM_JOB_NODELIST=comput[110,123,130]
SLURM_LOCALID=0
SLURM_JOB_GID=100
SLURM_JOB_CPUS_PER_NODE=36(x3)
SLURM_CLUSTER_NAME=cluster_admin1
SLURM_GTIDS=0
SLURM_SUBMIT_HOST=login2
SLURM_JOB_PARTITION=regular
SLURM_JOB_ACCOUNT=sf10
SLURM_JOB_NUM_NODES=3
SLURM_MEM_PER_NODE=181673
</code></pre></div></div>

<h3 id="sacctmgr-show"><code class="highlighter-rouge">sacctmgr show</code></h3>
<p>有些使用数据库的slurm还支持下面的命令</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(python37) [cndaqiang@login3 ~]$ sacctmgr show 
No valid entity in list command
Input line must include "Account", "Association", "Cluster", "Configuration",
"Event", "Federation", "Problem", "QOS", "Resource", "Reservation",
"RunAwayJobs", "Stats", "Transaction", "TRES", "User", or "WCKey"
(python37) [cndaqiang@login3 ~]$ sacctmgr show Resource
      Name     Server     Type  Count % Allocated ServerType 
---------- ---------- -------- ------ ----------- ---------- 
(python37) [cndaqiang@login3 ~]$ sacctmgr show Stats
sacctmgr: RC:2002 Your user doesn't have privilege to perform this action
(python37) [cndaqiang@login3 ~]$ sacctmgr show qos              
</code></pre></div></div>
<p><img src="/uploads/2020/03/qos.png" alt="" /></p>
:ET