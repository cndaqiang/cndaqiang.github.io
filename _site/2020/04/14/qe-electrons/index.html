<!DOCTYPE html>
<html style="filter:grayscale(0%);">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>QE代码阅读: 电子自洽计算electrons</title>
    <meta name="description" content="QE代码阅读系列，个人学习记录，仅供参考。代码仓库QE-6.4.1@cndaqiang">

    <link rel="shortcut icon" href="/favicon.jpg?" type="image/x-icon">
    <link rel="icon" href="/favicon.jpg?" type="image/x-icon">
    <!---2020-01-17 change font-awesome-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <!--- 
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
    -->
    <link rel="stylesheet" href="/css/cndaqiang.css"> 
	<!---图标cdn icon，每次在iconfont中添加一个图标，这个链接就要更新--->
   <link rel="stylesheet" href="https://at.alicdn.com/t/font_461356_ofctiykkk5.css">
	 <link rel="stylesheet" href="/css/main.css ">
   <link rel="canonical" href="http://localhost:4000/2020/04/14/qe-electrons/">
   <link rel="alternate" type="application/rss+xml" title="cndaqiang" href="http://localhost:4000/feed.xml ">

	
	<!---
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
		// 谷歌广告测试
	//	(adsbygoogle = window.adsbygoogle || []).push({
	//		google_ad_client: "ca-pub-8365330523291002",
	//		enable_page_level_ads: true
	//	});
		</script>
	--->

    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8ba332e6517ae0ba8a13339285d97bb3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-109057291-1', 'auto');
      ga('send', 'pageview');

    </script>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: { inlineMath: [["$","$"],["\\(","\\)"]] },
    "HTML-CSS": {
      linebreaks: { automatic: true, width: "container" }
    }
});
</script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!---   谷歌cse站内搜索-->
<!--- <script async src="https://cse.google.com/cse.js?cx=011772597085732398296:uzswyrqhpft"></script>
--->
	

</head>


  <body>

    <div class="wrapper">
    <center>
        <a href= http://www.gov.cn/zhengce/content/2020-04/03/content_5498472.htm>
            <h1> </h1><b> </b>
        </a>
        本站镜像站点        
        <a href="http://blog.cndaqiang.workers.dev//2020/04/14/qe-electrons/">cloudflare</a>,
        <a href="http://cndaqiang.gitee.io//2020/04/14/qe-electrons/">gitee</a>,
        <a href="https://cndaqiang.github.io//2020/04/14/qe-electrons/">Github</a>.
        <a href="https://github.com/cndaqiang/cndaqiang.github.io/">博客源码</a>
    </center>
</div>
<header id="top">
    <div class="wrapper">
      
        <a href="/" class="brand">cndaqiang</a>
        <small>Web Linux DFT</small> 
        
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>文章
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分类
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>标签
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>收藏
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>关于
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/Search/">
                        
                            <i class="fa fa-icon-sousuo"></i>Search
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <!---文章页面--->

<div class="page clearfix" post>
    <div class="left">
        <h1>QE代码阅读: 电子自洽计算electrons</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2020-04-14
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>cndaqiang
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Quantum-Espresso" title="Category: Quantum-Espresso" rel="category">Quantum-Espresso</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#QE" title="Tag: QE" rel="tag">QE</a-->
        <a href="/tag/#QE" title="Tag: QE" rel="tag">QE</a>&nbsp;
    
        <!--a href="/tag/#DFT" title="Tag: DFT" rel="tag">DFT</a-->
        <a href="/tag/#DFT" title="Tag: DFT" rel="tag">DFT</a>&nbsp;
    
        <!--a href="/tag/#Fortran" title="Tag: Fortran" rel="tag">Fortran</a-->
        <a href="/tag/#Fortran" title="Tag: Fortran" rel="tag">Fortran</a>
    
  

</span>


            </div>
            <!--- 2020-01-17 RSS-->
            <div class="label-card">
                <a href="/feed.xml" title="RSS"><i class="fa fa-rss-square" aria-hidden="true"></i>RSS</a>
            </div>

            <div class="label-card">
                <a href="https://github.com/cndaqiang/cndaqiang.github.io" title="RSS"><i class="fa fa-thumbs-o-up" aria-hidden="true"></i>Star</a>
            </div>
            
            <!--- github start , copy from https://github.com/mdo/github-buttons--->
            <!---
            <div>
                <iframe src="/html_script/github-btn.html?user=cndaqiang&repo=cndaqiang.github.io&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
            </div>
            --->

        </div>
        
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
  <li><a href="#" id="markdown-toc-"><center>~~~~~~~~~~~</center></a></li>
  <li><a href="#物理部分" id="markdown-toc-物理部分"><center>物理部分</center></a></li>
  <li><a href="#密度泛函理论" id="markdown-toc-密度泛函理论">密度泛函理论</a>    <ul>
      <li><a href="#hohenbergkohn定理" id="markdown-toc-hohenbergkohn定理">Hohenberg‐Kohn定理</a></li>
      <li><a href="#kohn-sham-ansatz" id="markdown-toc-kohn-sham-ansatz">Kohn-Sham ansatz</a>        <ul>
          <li><a href="#能量的密度泛函" id="markdown-toc-能量的密度泛函">能量的密度泛函</a></li>
          <li><a href="#无作用系统" id="markdown-toc-无作用系统">无作用系统</a></li>
          <li><a href="#scf操作中的能量密度泛函" id="markdown-toc-scf操作中的能量密度泛函"><strong>SCF操作中的能量密度泛函</strong></a>            <ul>
              <li><a href="#输入势场的能量泛函" id="markdown-toc-输入势场的能量泛函"><strong>输入势场的能量泛函</strong></a></li>
              <li><a href="#输入电荷密度的能量泛函" id="markdown-toc-输入电荷密度的能量泛函"><strong>输入电荷密度的能量泛函</strong></a></li>
              <li><a href="#输入势场密度的能量泛函" id="markdown-toc-输入势场密度的能量泛函"><strong>输入势场,密度的能量泛函</strong></a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#电子系统" id="markdown-toc-电子系统"><strong>电子系统</strong></a>    <ul>
      <li><a href="#单粒子的动能算符" id="markdown-toc-单粒子的动能算符">单粒子的动能算符</a></li>
      <li><a href="#单电子的有效势近似" id="markdown-toc-单电子的有效势近似">单电子的有效势近似</a>        <ul>
          <li><a href="#frozen-core-approximation" id="markdown-toc-frozen-core-approximation">Frozen core approximation</a></li>
          <li><a href="#赝势方法" id="markdown-toc-赝势方法">赝势方法</a></li>
        </ul>
      </li>
      <li><a href="#赝势" id="markdown-toc-赝势">赝势</a></li>
      <li><a href="#xc势能" id="markdown-toc-xc势能">XC势/能</a></li>
      <li><a href="#hartree势能库伦项" id="markdown-toc-hartree势能库伦项">Hartree势能/库伦项</a>        <ul>
          <li><a href="#hartree势" id="markdown-toc-hartree势">Hartree势</a></li>
          <li><a href="#hartree能" id="markdown-toc-hartree能">Hartree能</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#离子系统的静电势能" id="markdown-toc-离子系统的静电势能"><strong>离子系统的静电势能</strong></a>    <ul>
      <li><a href="#elwald求和" id="markdown-toc-elwald求和"><strong>Elwald求和</strong></a></li>
    </ul>
  </li>
  <li><a href="#热力学体系的总能量" id="markdown-toc-热力学体系的总能量">热力学体系的总能量</a></li>
  <li><a href="#-1" id="markdown-toc--1"><center>~~~~~~~~~~~</center></a></li>
  <li><a href="#代码部分" id="markdown-toc-代码部分"><center>代码部分</center></a></li>
  <li><a href="#文件" id="markdown-toc-文件">文件</a></li>
  <li><a href="#electreons框架" id="markdown-toc-electreons框架"><center>electreons框架</center></a>    <ul>
      <li><a href="#预准备" id="markdown-toc-预准备">预准备</a></li>
      <li><a href="#略restart模式" id="markdown-toc-略restart模式">[略]restart模式</a></li>
      <li><a href="#do-idum1niter杂换泛函循环" id="markdown-toc-do-idum1niter杂换泛函循环">DO idum=1,niter(杂换泛函循环)</a>        <ul>
          <li><a href="#electrons_scf" id="markdown-toc-electrons_scf"><code class="highlighter-rouge">electrons_scf</code></a></li>
          <li><a href="#略若是-dft_is_hybrid执行后续命令" id="markdown-toc-略若是-dft_is_hybrid执行后续命令">[略]若是<code class="highlighter-rouge"> dft_is_hybrid()</code>执行后续命令</a></li>
        </ul>
      </li>
      <li><a href="#end-do" id="markdown-toc-end-do">END DO</a></li>
    </ul>
  </li>
  <li><a href="#electrons_scf-1" id="markdown-toc-electrons_scf-1"><center>electrons_scf</center></a>    <ul>
      <li><a href="#预准备-1" id="markdown-toc-预准备-1">预准备</a>        <ul>
          <li><a href="#restart略" id="markdown-toc-restart略">restart略</a></li>
          <li><a href="#memstat内存状态略" id="markdown-toc-memstat内存状态略">memstat内存状态,略</a></li>
          <li><a href="#离子静电势能ewald求和" id="markdown-toc-离子静电势能ewald求和">离子静电势能:Ewald求和</a></li>
          <li><a href="#色散能dftd" id="markdown-toc-色散能dftd">色散能:DFT+D</a></li>
          <li><a href="#create_scf_typerhoinallocate输入电荷rhoin变量" id="markdown-toc-create_scf_typerhoinallocate输入电荷rhoin变量"><code class="highlighter-rouge">create_scf_type(rhoin)</code>ALLOCATE输入电荷<script type="math/tex">\rho^{in}</script>变量</a></li>
          <li><a href="#open_mix_file-iunmix-mix-exst-" id="markdown-toc-open_mix_file-iunmix-mix-exst-"><code class="highlighter-rouge">open_mix_file( iunmix, 'mix', exst )</code></a></li>
        </ul>
      </li>
      <li><a href="#do-idum--1-niter-真正的scf循环" id="markdown-toc-do-idum--1-niter-真正的scf循环">DO idum = 1, niter <strong>(真正的scf循环)</strong></a>        <ul>
          <li><a href="#更新对角化收敛精度ethr" id="markdown-toc-更新对角化收敛精度ethr">更新对角化收敛精度<code class="highlighter-rouge">ethr</code></a></li>
          <li><a href="#deband_hwfdelta_enin" id="markdown-toc-deband_hwfdelta_enin"><script type="math/tex">deband_{hwf}</script>=delta_e(<script type="math/tex">n^{in}</script>)</a></li>
          <li><a href="#scf_type_copy-rho-rhoin-复制电荷密度" id="markdown-toc-scf_type_copy-rho-rhoin-复制电荷密度"><code class="highlighter-rouge">scf_type_COPY( rho, rhoin )</code>复制电荷密度</a></li>
          <li><a href="#scf_step-do-对角化不合理时用" id="markdown-toc-scf_step-do-对角化不合理时用">scf_step: DO <br />[对角化不合理时用]</a>            <ul>
              <li><a href="#c_bands对角化" id="markdown-toc-c_bands对角化"><code class="highlighter-rouge">c_bands()</code>对角化</a></li>
              <li><a href="#pool并行回收et" id="markdown-toc-pool并行回收et">pool并行,回收<code class="highlighter-rouge">et</code></a></li>
              <li><a href="#sum_band" id="markdown-toc-sum_band"><code class="highlighter-rouge">sum_band()</code></a></li>
              <li><a href="#计算e_hwfnin" id="markdown-toc-计算e_hwfnin">计算<script type="math/tex">E_{HWF}[n^{in}]</script></a></li>
              <li><a href="#输出ldau信息" id="markdown-toc-输出ldau信息">输出lda+u信息</a></li>
              <li><a href="#磁性" id="markdown-toc-磁性">磁性</a></li>
              <li><a href="#debanddelta_enout" id="markdown-toc-debanddelta_enout">deband=delta_e(<script type="math/tex">n^{out}</script>)</a></li>
              <li><a href="#mix_rho收敛性判断混合密度" id="markdown-toc-mix_rho收敛性判断混合密度">mix_rho,收敛性判断,混合密度</a></li>
              <li><a href="#对角化出问题时cycle-scf_step" id="markdown-toc-对角化出问题时cycle-scf_step">对角化出问题时:<code class="highlighter-rouge">CYCLE scf_step</code></a></li>
              <li><a href="#更新势场" id="markdown-toc-更新势场">更新势场</a></li>
            </ul>
          </li>
          <li><a href="#end-do-scf_step对角化循环" id="markdown-toc-end-do-scf_step对角化循环">END DO scf_step<br />对角化循环</a></li>
          <li><a href="#一堆空plugin操作" id="markdown-toc-一堆空plugin操作">一堆空plugin操作</a></li>
          <li><a href="#vrs--external--scf" id="markdown-toc-vrs--external--scf"><code class="highlighter-rouge">vrs = external + scf</code></a></li>
          <li><a href="#call-newd" id="markdown-toc-call-newd"><code class="highlighter-rouge">CALL newd()</code></a></li>
          <li><a href="#略" id="markdown-toc-略">略</a></li>
          <li><a href="#用时报告write-stdout-9000--get_clock-pwscf-" id="markdown-toc-用时报告write-stdout-9000--get_clock-pwscf-">用时报告<code class="highlighter-rouge">WRITE( stdout, 9000 ) get_clock( 'PWSCF' )</code></a></li>
          <li><a href="#conv_elec收敛输出" id="markdown-toc-conv_elec收敛输出"><code class="highlighter-rouge">conv_elec</code>收敛输出</a></li>
          <li><a href="#计算e_ksvin" id="markdown-toc-计算e_ksvin">计算<script type="math/tex">E_{KS}[V^{in}]</script></a></li>
          <li><a href="#对e_hwfnine_ksvin的补充项" id="markdown-toc-对e_hwfnine_ksvin的补充项">对<script type="math/tex">E_{HWF}[n^{in}]</script>，<script type="math/tex">E_{KS}[V^{in}]</script>的补充项</a></li>
          <li><a href="#输出能量" id="markdown-toc-输出能量">输出能量</a></li>
          <li><a href="#若收敛报告信息跳出循环" id="markdown-toc-若收敛报告信息跳出循环">若收敛,报告信息,跳出循环</a></li>
        </ul>
      </li>
      <li><a href="#end-do-1" id="markdown-toc-end-do-1">END DO</a></li>
      <li><a href="#保存电荷密度charge-density" id="markdown-toc-保存电荷密度charge-density">保存电荷密度<code class="highlighter-rouge">charge-density</code></a></li>
      <li><a href="#close_mix_file-iunmix-delete-" id="markdown-toc-close_mix_file-iunmix-delete-"><code class="highlighter-rouge">close_mix_file( iunmix, 'delete' )</code></a></li>
      <li><a href="#remove_atomic_rho" id="markdown-toc-remove_atomic_rho"><code class="highlighter-rouge">remove_atomic_rho()</code></a></li>
      <li><a href="#destroy_scf_type--rhoin-" id="markdown-toc-destroy_scf_type--rhoin-"><code class="highlighter-rouge">destroy_scf_type ( rhoin )</code></a></li>
    </ul>
  </li>
</ul>

<p>QE代码阅读系列，个人学习记录，仅供参考。<br />
代码仓库<a href="https://gitee.com/cndaqiang/QE-6.4.1/tree/master">QE-6.4.1@cndaqiang</a><br /></p>

<h2 id="参考">参考</h2>
<ul>
  <li>Quantum Theory of Many Particle Systems@Xin-Zheng Li</li>
  <li><a href="https://books.google.com/books?id=v1YhAwAAQBAJ">Martin, R. M., &amp; Martin, R. M. (2004). Electronic structure: basic theory and practical methods. Cambridge university press.</a></li>
  <li>Marques, M., Rubio, A., Gross, E. K., Burke, K., Nogueira, F., &amp; Ullrich, C. A. (2006). Time-dependent density functional theory (Vol. 706). Springer Science &amp; Business Media.</li>
  <li><a href="https://github.com/QEF/q-e.git">q-e code</a></li>
</ul>

<h2><center>~~~~~~~~~~~</center></h2>
<h2 id="物理部分"><center>物理部分</center></h2>

<p><strong>下面的公式推导中很多矢量没有标粗或加箭头</strong></p>

<h2 id="密度泛函理论">密度泛函理论</h2>
<p>H-K定理一建立了密度泛函的基础，密度决定一切，将<script type="math/tex">3N</script>的问题变成<script type="math/tex">3</script>的问题<br />而且电荷密度是客观测量，有实际的物理意义.<br /></p>

<p>H-K定理二提供了求解基态密度的方法:对密度的泛函进行变分<br /></p>

<p>理论发展: 对H-K定理的发展就是使用于不同情况的密度泛函理论<br />
如,自旋密度泛函理论,系综密度泛函理论,电流泛函,含时密度泛函理论(Runge–Gross theorem)…</p>

<p>操作的发展:如何建立多体系统的能量泛函,如<br />
密度泛函理论可以通过：Kohn-Sham ansztz 联系无相互作用系统(KS方程)和多体相互作用系统的能量泛函<br />
含时密度泛函可以通过:Van Leeuwen theorem联系无相互作用系统(TDKS方程)和多体相互作用系统的能量泛函</p>

<h3 id="hohenbergkohn定理">Hohenberg‐Kohn定理</h3>
<ul>
  <li>定理一：系统的所有性质由基态密度<script type="math/tex">n_0(r)</script>
    <blockquote>
      <p>Theorem I: 对于在一个外势<script type="math/tex">V_{ext}(r)</script>作用下的多体相互作用系统, 外势<script type="math/tex">V_{ext}(r)</script>(除了一个常数)被基态密度决定<br />
Corollary I: 因为外势被密度决定，所以哈密顿量也被决定，进而<strong>任意态</strong>的多体波函数被确定。Therefore,<strong>系统的所有性质由基态密度<script type="math/tex">n_0(r)</script></strong>,i.e., in principle, 激发态的性质也可以由exact的密度泛函理论给出</p>
    </blockquote>
  </li>
  <li>定理二:能量泛函<script type="math/tex">E(n)</script>足够决定体系的基态能量和基态密度
    <blockquote>
      <p>Theoem II, 一个通用的密度<script type="math/tex">n(r)</script>的能量泛函<script type="math/tex">E[n]</script>可以被确定,适用于所有的外势.对于任意的外势<script type="math/tex">V_{ext}(r)</script>，系统严格的基态能量是泛函<script type="math/tex">E[n]</script>的全局最小值，严格的基态密度<script type="math/tex">n_0(r)</script>是泛函<script type="math/tex">E[n]</script>最小值时的密度<script type="math/tex">n(r)</script><br />
Corollary II: <strong>能量泛函<script type="math/tex">E(n)</script>足够决定体系的基态能量和基态密度</strong>. In general, 激发态的形式需要取法的方法来确定。</p>
    </blockquote>
  </li>
</ul>

<script type="math/tex; mode=display">E_0 = min_{\rho} \lbrace \int n(r)V_{ext}(r)dr + F_{HK}[n]	 \rbrace</script>

<h3 id="kohn-sham-ansatz">Kohn-Sham ansatz</h3>
<p>将求解多体相互作用系统的问题，转化为求解一个简单的辅助系统的问题，辅助系统的选择并没有唯一的描述，this is an ansatz that rephrase the issue.</p>

<p>Kohn-Sham ansztz 假设相互作用的多体系统基态密度等于一些无相互作用系统的密度.将交换关联泛函引入这些无相互作用单粒子方程，可以严格的获得原本的相互作用系统的基态密度和能量。</p>
<ul>
  <li>两个系统具有相同的基态密度</li>
  <li>两个系统通过交换关联泛函联系</li>
</ul>

<h4 id="能量的密度泛函">能量的密度泛函</h4>
<p>According to Chap (7) of <a href="https://books.google.com/books?id=v1YhAwAAQBAJ">Martin, R. M., &amp; Martin, R. M. (2004). Electronic structure: basic theory and practical methods. Cambridge university press.</a>,
总能量from (7.1)</p>
<center>
$$
E_{KS}[n] = T_s[n] + \int{ dr V_{ext}(r) n(r)} + E_{Hartree}[n]+E_{II} +E_{XC}[n]
$$

$$
E_{Hartree}[n]=\frac{1}{2} \int{ d^3rd^3r' \frac{n(r) n(\overrightarrow{r'})}{|r - \overrightarrow{r'} |} }
$$

$$
n( r ) = \sum_{\sigma } {n(r,\sigma) } = \sum_{\sigma}\sum_{i=1}^{N^\sigma} |\psi_i^\sigma(r) |^2
$$
</center>
<p>where,</p>
<ul>
  <li><script type="math/tex">T_s</script>是无相互作用体系的动能</li>
  <li><script type="math/tex">V_{ext}</script>是外势能</li>
  <li><script type="math/tex">E_{Hartree}</script>是无相护作用体系的电荷密度的经典库伦能</li>
  <li><script type="math/tex">E_{II}</script> 是离子间相互作用能</li>
  <li><script type="math/tex">E_{XC}</script>是前面使用无相护作用电子体系计算的动能,电子间相互作用能,和电子真实的相互作用能之间的差别<br />
<script type="math/tex">E_{XC}(n)=F_{HK}[n] - ( T_s[n]   + E_{Hartree}[n] )</script></li>
  <li><script type="math/tex">\sigma</script>是自旋维度</li>
</ul>

<h4 id="无作用系统">无作用系统</h4>
<p>通过变分法,证明略,可以得到无作用系统遵守的单粒子KS方程,<br />
不同的方法中,变分的变量不同，得到的KS方程也不同,如<script type="math/tex">H_{KS}^{\sigma} \psi_i^{\sigma} = \epsilon_i^{\sigma} \psi_i^{\sigma}</script> 与 <script type="math/tex">H_{KS}^{\sigma} \psi_i^{\sigma} = \epsilon_i^{\sigma} S \psi_i^{\sigma}</script>,以前者举例</p>

<script type="math/tex; mode=display">(H_{KS}^{\sigma}-\epsilon _i^{\sigma} )\psi _i^{\sigma} = 0</script>

<p>where</p>

<script type="math/tex; mode=display">H_{KS}^{\sigma}(r) = -\cfrac{1}{2}\nabla^2 + V_{KS}^{\sigma}(r)</script>

<p>with</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{array}{l}
V_{KS}^{\sigma}(r) &= V_{ext}(r)+\cfrac{\delta E_{Hartree}}{\delta n(r,\sigma)} +\cfrac{\delta E_{xc}}{\delta  n(r,\sigma) } 
\\ & =  V_{ext}(r)+   V_{Hartree}(r) + V_{xc}^{\sigma}(r)
\end{array} %]]></script>

<p><strong>注意:单粒子系统的XC势能不等于能量泛函中的XC能量项</strong></p>

<script type="math/tex; mode=display">\sum_{\sigma} \int n^{\sigma}(r)V_{xc}^{\sigma}(r) dr \color{red}{\neq} \sum_{\sigma} E_{xc}[n^{\sigma}]</script>

<p>在uspp情况下<script type="math/tex">\cfrac{\delta E_{xc}[n]}{\delta \phi_i^{*} } =  \cfrac{\delta E_{xc}[n]}{\delta n } + etc_{xc}</script>,与变分的变量有关，会仍选用<script type="math/tex">V_{xc}=\cfrac{\delta E_{xc}[n]}{\delta n }</script>,把多的项<script type="math/tex">etc_{xc}</script>移到其他地方</p>

<p><br /></p>

<p><strong>单粒子系统的其他外势,如Hartree,局域离子势等这些库伦势能,与变分的方式有关,也不一定对应多体系统能量泛函</strong></p>
<s><b>单粒子系统受到的外势,Hartree这些库伦势和多体系统能量泛函项一样</b>
<br />USPP时，由于$$n(\mathbf{r}) \neq \sum_i^{occ}  |\psi_i(\mathbf{r})|^2$$,不具有这样的性质
</s>

<script type="math/tex; mode=display">\require{enclose}
 \enclose{horizontalstrike}{ \sum_{i,\sigma}^{occ} \langle	\psi_i^{\sigma} | V_{ext}(r) |  \psi_i^{\sigma} \rangle == \int V_{ext}(r) n(r)dr ==  E_{ext}[n(r)] } \\
 \enclose{horizontalstrike}{ \sum_{i,\sigma}^{occ} \langle	\psi_i^{\sigma} | V_{Hartree}(r) |  \psi_i^{\sigma} \rangle == \int V_{Hartree}(r) n(r)dr ==  E_{Hartree}[n]  }</script>

<p><strong>单粒子系统的动能项就是多体系统能量泛函的动能项</strong><br />
唯一对应</p>

<script type="math/tex; mode=display">\sum_{i,\sigma}^{occ} \langle	\psi _i^{\sigma} | -\cfrac{1}{2}\nabla^2 | 	\psi _i^{\sigma}	\rangle	  == T_s[n]</script>

<p><strong>综上单粒子系统的本征能量不对应多体系统能量</strong>，没有物理意义<br />
但是在实际程序中，也许用于计算<script type="math/tex">T_S</script>, 对于其他项没有贡献.</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{array}{l}
 \sum_{i,\sigma}^{occ}  \epsilon_i^{\sigma} &=  \langle	\psi_i^{\sigma} | H_{KS}^{\sigma}(r)| 	\psi _i^{\sigma}	\rangle  
\\ &= \langle	\psi_i^{\sigma} | -\cfrac{1}{2}\nabla^2   + V_{ext} +  V_{Hartree} + V_{xc}^{\sigma} | 	\psi _i^{\sigma}	\rangle 
\\ &\color{red}{\neq} E_{KS}[n]
\end{array} %]]></script>

<h4 id="scf操作中的能量密度泛函"><strong>SCF操作中的能量密度泛函</strong></h4>

<p>According to Chap (9.2) of <a href="https://books.google.com/books?id=v1YhAwAAQBAJ">Martin, R. M., &amp; Martin, R. M. (2004). Electronic structure: basic theory and practical methods. Cambridge university press.</a>,理论上，尽管Kohn-Sham能量是密度的泛函，但是实际操作上，我们可能会采用各种形式的能量泛函，如<script type="math/tex">E_{KS}(V^{in}) , E_{KS}(n^{in}) , E_{KS}(V^{in},n^{in})</script><br /></p>

<p>理论上，Kohn-Sham能量是密度的泛函(Eq 9.2)</p>
<center>
$$
E_{KS}=T_s[n]+E_{pot}[n]
$$

$$
E_{pot} = \int {drV_{ext}(r)n(r)} + E_{Hartree}[n]+E_{II} +E_{XC}[n]
$$
</center>

<p>where, 动能<script type="math/tex">T_s</script>为单粒子能量<script type="math/tex">% <![CDATA[
\varepsilon_i^\sigma = < \psi_i^\sigma|H_{KS}^\sigma|\psi_i^\sigma> %]]></script>减去势能，自旋相同的单粒子态的哈密顿量，以及势能<script type="math/tex">V^{\sigma,in}(r)</script>相同，因此可以化成求和的形式，<script type="math/tex">E_s</script>是无相互作用系统的单粒子占据态能量之和<script type="math/tex">E_s = \sum_{i,\sigma}^{occ}  \epsilon_i^{\sigma}</script></p>
<center>
$$
T_s = E_s - \sum_\sigma \int drV^{\sigma,in}(r)n^{out}(r,\sigma)
$$
</center>

<h5 id="输入势场的能量泛函"><strong>输入势场的能量泛函</strong></h5>
<p>Frome(9.7)<br />
在操作上输入势场决定了所有的物理量的计算，进而决定最终的能量</p>
<center>
$$
E_{KS}[V^{in}]=E_s[V^{in}] - \sum_\sigma\int drV^{\sigma,in}(r)n^{out}(r,\sigma) + E_{pot}[n^{out}]

$$
</center>

<p>通过调整<script type="math/tex">V^{in}</script>达到最小的能量，此时得到Kohn-Sham Eq的解(<script type="math/tex">V_{KS},n_0</script>),<br />
此时,<script type="math/tex">V^{in} = V_{KS}, n^{in}=n_0</script><br /><br />
通过推导(9.8)可以证明,<strong><script type="math/tex">E_{KS}[V^{in}]\geq E_{KS}[V^{KS}]</script></strong></p>

<h5 id="输入电荷密度的能量泛函"><strong>输入电荷密度的能量泛函</strong></h5>
<p>From(Eq 9.9),是<strong>Harris,Weinert,Foulkes,Haydock,etc.</strong>人提出证明的泛函，使用输入密度计算总能量<br />
称作HWF能量,<script type="math/tex">E_{HWF}[n^{in}]</script>,QE在电子自洽循环前就计算了相应变量<code class="highlighter-rouge">deband_hwf = delta_e()</code></p>
<center>
$$
E_{HWF}[n^{in}]=E_s[V_{n^{in}}] - \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma) + E_{pot}[n^{in}]
$$
</center>
<p><strong>注意上面公式中的<script type="math/tex">- \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma) + E_{pot}[n^{in}]</script>都是用<script type="math/tex">n^{in}</script>计算的</strong><br /></p>

<p>通过推导(Eq 9.10)可以证明,<strong><script type="math/tex">E_{HWF}[n^{in}] \leq E_{KS}[V^{in}]</script></strong>,<br /></p>

<p><strong>由于<script type="math/tex">\Delta n</script>的原因，可能会出现就算过程中<script type="math/tex">E_{HWF}[n^{in}]</script>小于最终能量<script type="math/tex">E_{KS}[V^{in}]</script>的情况</strong></p>

<p>该方法有很多优点:</p>
<ul>
  <li>当密度接近真实密度，<script type="math/tex">E_{HWF}[n^{in}]</script>比<script type="math/tex">E_{KS}[V^{in}]</script>更接近真实的<script type="math/tex">E_{KS}</script></li>
  <li>收敛时，无需计算输出电荷密度</li>
  <li>etc, 很useful</li>
</ul>

<p>在QE中,将</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{array}{l}
E_{HWF}[n^{in}] &= E_s[V_{n^{in}}] - \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma) + E_{pot}[n^{in}] \\ \\
 &= E_s[V_{n^{in}}]   - \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma)  \\
 & \text{ } \; \;\;\;\; \;\;\;  + ( \int {drV_{ext}(r)n^{in}(r)} + E_{Hartree}[n^{in}]+E_{II} +E_{XC}[n^{in}] ) \\ \\
 &= E_s[V_{n^{in}}] 
- \lbrace   \sum_\sigma\int dr (V^{\sigma,in}(r)-V_{ext}(r)) n^{in}(r,\sigma)  \rbrace	 \\
 & \text{ } \; \;\;\;\; \;\;\;  + E_{Hartree}[n^{in}]+E_{II} +E_{XC}[n^{in}]  \\ \\
 &= E_s[V_{n^{in}}]  - \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)  + E_{Hartree}[n^{in}]+E_{II} +E_{XC}[n^{in}] 

\end{array} %]]></script>

<p>where</p>
<ul>
  <li>
    <p><script type="math/tex">E_{HWF}[n^{in}]</script>，即<code class="highlighter-rouge">deband_hwf</code>,计算见下</p>
  </li>
  <li>
    <p><script type="math/tex">E_s[V^{in}[n^{in}]] = \sum_{i,\sigma}^{occ}  \epsilon_i^{\sigma}</script>,即<code class="highlighter-rouge">eband</code>,在<code class="highlighter-rouge">sum_band</code>中计算</p>
  </li>
  <li>
    <p><script type="math/tex">V_{n^{in}}^{\sigma} = V^{\sigma,in}(r)-V_{ext}(r)</script>,<br />
即<script type="math/tex">V_{KS}^{\sigma} - V_{ion} = V_{Hartree}[n^{in}]+V_{xc}[n^{in}+n_{nlcc}]+V_{\mathbf{B}}+V_{\mathbf{E}}+V_{\mathbf{lda+U}}</script>，<br />
 就是变量<code class="highlighter-rouge">v%of_r</code>,在<code class="highlighter-rouge">v_of_rho</code>中计算,见<a href="/2020/04/16/qe-init/#xc势能泛函e_xcks方程的xc势v_xcrho--rho_nlcc">QE代码阅读: init in run_pwscf</a><br /></p>
  </li>
  <li>
    <p><script type="math/tex">- \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)</script>,<br />
就是变量<code class="highlighter-rouge">deband_hwf</code>(<script type="math/tex">n^{in}</script>),<code class="highlighter-rouge">deband</code>(用<script type="math/tex">n^{out}</script>计算).使用函数<code class="highlighter-rouge">delta_e()</code>计算</p>
  </li>
  <li>
    <p><script type="math/tex">E_s[V^{in}[n^{in}]]- \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)</script>,<br />
就是<script type="math/tex">\sum_{i,\sigma}^{occ}   \langle	\psi_i^\sigma(r) | \hat{T} + V_{ion} | \psi_i^\sigma(r)   \rangle</script>,对应<code class="highlighter-rouge">eband+deband_hwf</code></p>
  </li>
  <li>
    <p><script type="math/tex">E_{II}</script>,离子静电能量,其实是把离子实认为点电荷计算的静电能,见下，变量<code class="highlighter-rouge">ewld</code></p>
  </li>
  <li>
    <p><script type="math/tex">E_{Hartree}[n^{in}]</script>,价电子间的库伦能 即<code class="highlighter-rouge">ehart</code>,在<code class="highlighter-rouge"> v_of_rho</code>中计算,见<a href="/2020/04/16/qe-init/#hartree泛函与势能">QE代码阅读: init in run_pwscf</a></p>
  </li>
  <li>
    <p><script type="math/tex">E_{xc}=\int_r \epsilon_{xc}[\rho(r) + \rho_{nlcc}(r)](\rho[r] + \rho_{nlcc}[r])dr</script>, XC能量泛函, 即<code class="highlighter-rouge">etxc</code>,在<code class="highlighter-rouge"> v_of_rho</code>中计算,见<a href="/2020/04/16/qe-init/#xc势能泛函e_xcks方程的xc势v_xcrho--rho_nlcc">QE代码阅读: init in run_pwscf</a></p>
  </li>
</ul>

<h5 id="输入势场密度的能量泛函"><strong>输入势场,密度的能量泛函</strong></h5>
<p>把输入势场和密度作为独立的变量，计算总能量<br />
From (Eq 9.13)</p>

<center>
$$
E_{KS}[V^{in},n^{in}]=E_s[V^{in}] - \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma) + E_{pot}[n^{in}]
$$
</center>

<h2 id="电子系统"><strong>电子系统</strong></h2>
<p>单粒子系统中,电子系统的哈密顿量为</p>

<script type="math/tex; mode=display">H_{KS}^{\sigma}(r) = -\cfrac{1}{2}\nabla^2 + V_{KS}^{\sigma}(r)</script>

<h3 id="单粒子的动能算符">单粒子的动能算符</h3>
<p><strong>动能算符在倒空间是对角矩阵,在倒空间计算更方便</strong></p>

<script type="math/tex; mode=display">\hat{T} = -\cfrac{1}{2}\nabla^2 \\
T_s[n] = \sum_{i,\sigma}^{occ} \langle	\psi _i^{\sigma} | -\cfrac{1}{2}\nabla^2 | 	\psi _i^{\sigma}	\rangle</script>

<h3 id="单电子的有效势近似">单电子的有效势近似</h3>
<p>整个系统的多体静电相互作用可以分为Hartree/库伦势场+交换关联势场.</p>
<ul>
  <li><strong>Hartree/库伦势</strong>:<br />
<script type="math/tex">r^{'}</script>处电荷<script type="math/tex">\rho(r{'})dr</script>在<script type="math/tex">r</script>处产生的Hartree/库伦势就是<script type="math/tex">\cfrac{\rho(r^{'})}{|r -r^{'} |}</script><br />
具有<strong>线性相加</strong>的特征, <strong>远程</strong></li>
  <li><strong>xc势</strong>:<br />
与自旋相关,<script type="math/tex">V_{xc}^{\sigma}(r)=\cfrac{\delta E_{xc}}{\delta  \rho(r,\sigma)}</script>
描述了计算总能量的不准确部分,<strong>非线性</strong>, <strong>近程</strong></li>
</ul>

<h4 id="frozen-core-approximation">Frozen core approximation</h4>
<p>计算所有电子的为全电子计算<br />
实际往往采用<em>frozen core approximation</em>,固定芯电子，只求解价电子.<br />
芯电子与原子核组成离子实<script type="math/tex">\color{red}{ {\rho Z}_c}</script>,并不参与化学成键，也不随着结构的改变而改变，离子实自身的相互作用能是常数.<br /></p>
<blockquote>
  <p>合理性:因为芯电子更靠近原子核，原子形成分子与固体时，芯电子基本保持不变（容易通过对分子的全电子计算验证）</p>
</blockquote>

<p>价电子感受到的有效势场为:</p>

<script type="math/tex; mode=display">V_{eff}[\rho_v] = 
V_{Hartree}[\rho_v]
+ V_{Hartree}[ \color{red}{ {\rho Z}_c } ]  
+ V_{xc}[\rho_v+\color{red}{ \rho_c}]</script>

<ul>
  <li><script type="math/tex">V_{Hartree}[\rho_v]</script>, 价电子本身产生的Hartree/库伦势</li>
  <li><script type="math/tex">V_{Hartree}[ \color{red}{ {\rho Z}_c } ]</script>, 原子核+芯电子产生的Hartree/库伦势<br /></li>
  <li><script type="math/tex">V_{xc}[\rho_v+\color{red}{ \rho_c}]</script>, 价电子+芯电子的交换关联势</li>
</ul>

<h4 id="赝势方法">赝势方法</h4>
<p>由于实际的<script type="math/tex">V_{Hartree}[ \color{red}{ {\rho Z}_c } ]</script>在芯区变化比较剧烈，解出来的价电子波函数震荡比较大，需要很多平面波才能展开(硬)。<br />
引入赝势<script type="math/tex">V_l^{PS}</script>替换原有的<script type="math/tex">V_{Hartree}[ \color{red}{ {\rho Z}_c } ]</script>, 解出来的价电子波函数称为赝波函数</p>
<blockquote>
  <p>赝势思路:使其对赝波函数的散射性质与原子核及芯电子对价波函数的散射性质相同。赝波函数通常变化缓慢，少了剧烈振荡允许只以相对较少的基组函数（例如平面波）来展开。没有节点的（径向）波函数也意味着没有比它本征值更低的量子态来与它正交，求解内层电子的需要也就自动消失了</p>
</blockquote>

<p>赝势<script type="math/tex">V_l^{PS}</script>描述了:原子核与芯电子对价电子的Hartree作用.<br />
实际只有部分与价电子<script type="math/tex">\rho_v</script>分布重叠的芯电子<script type="math/tex">\color{fuchsia}{  \rho_c^{part} }</script>对价电子有xc势作用(NLCC，见<a href="/2020/04/05/qe-upf/">QE代码阅读: 赝势</a>)<br />
采用NLCC的赝势, 价电子感受到的有效势为</p>

<script type="math/tex; mode=display">V_{eff}[\rho_v] = 
V_{Hartree}[\rho_v]
+ V_l^{PS}
+ V_{xc}[\rho_v+\color{fuchsia}{ \rho_c^{part}}]</script>

<p>下面默认</p>
<ul>
  <li>用<script type="math/tex">\rho</script>,<script type="math/tex">n</script>,表示<script type="math/tex">\rho_v</script></li>
  <li>用<script type="math/tex">\color{fuchsia}{ \rho_{nlcc}}</script>表示<script type="math/tex">\color{fuchsia}{ \rho_c^{part}}</script></li>
</ul>

<h3 id="赝势">赝势</h3>
<p>同上,更多<a href="/2020/04/05/qe-upf/">QE代码阅读: 赝势</a></p>

<h3 id="xc势能">XC势/能</h3>
<p>同上,<strong>XC势是短程势,LDA中<script type="math/tex">V_{xc}(r)</script>仅于<script type="math/tex">\rho(r)</script>有关,所以在实空间计算方便</strong>
<br />采用Non linear core corrections修正的赝势时(<a href="/2020/04/05/qe-upf/">QE代码阅读: 赝势</a>)，XC势场为<br />
<script type="math/tex">V_{xc}[\rho_v+\color{fuchsia}{ \rho_c^{part}}]</script>
<br />程序中的<script type="math/tex">\color{fuchsia}{ \rho_c^{part}}</script>不变,积分只是部分电子,如<code class="highlighter-rouge">S_ONCV_PBE_sr.upf</code>的芯电子积分就是<code class="highlighter-rouge">1.3</code>
<br />不采用NLCC,如<code class="highlighter-rouge">H,Li</code>元素所有电子都是价电子,芯电子修正的电荷积分就是0</p>

<h3 id="hartree势能库伦项">Hartree势能/库伦项</h3>
<p><strong>Hartree/库伦势是长程势场,在倒空间比较好描述(在实空间每个点都需要全空间积分)，先在倒空间计算</strong></p>

<p><br />实空间与倒空间变换关系</p>
<blockquote>
  <p>Form UCAS 密度泛函理论与应用
<img src="/uploads/2020/04/hartreeG.png" alt="" />
<img src="/uploads/2020/04/ehartree.png" alt="" /></p>
</blockquote>

<h4 id="hartree势">Hartree势</h4>
<center>$$ V_{Hartree}(\mathbf{r})= \sum_{\mathbf{G} \neq  0} \rho(\mathbf{G})\frac{4\pi}{\mathbf{G^2}} \exp(i\mathbf{Gr})$$</center>
<p><br />
在QE的实际计算中<code class="highlighter-rouge">PW/src/v_of_rho.f90-&gt;v_h( rhog, ehart, charge, v )</code>,<br />
就是先计算倒空间: <script type="math/tex">aux(G) = \rho(\mathbf{G})\frac{4\pi}{\mathbf{G^2}}</script><br />
然后<code class="highlighter-rouge">V(r)=IFFT[aux(G)]</code></p>

<h4 id="hartree能">Hartree能</h4>
<center>$$ E_{Hartree}= \frac{1}{2}\Omega \sum_{\mathbf{G} \neq  0} \rho(\mathbf{G}) V_{Hartree}(\mathbf{G}) = \frac{1}{2}\Omega \sum_{\mathbf{G} \neq  0} \left | \rho(\mathbf{G}) \right | ^2 \frac{4\pi}{\mathbf{G^2}} \exp(i\mathbf{Gr})$$</center>
<p><br />
在QE的实际计算中<code class="highlighter-rouge">PW/src/v_of_rho.f90-&gt;v_h( rhog, ehart, charge, v )</code>,是用此公式计算的Hartree能<code class="highlighter-rouge">ehart</code></p>

<h2 id="离子系统的静电势能"><strong>离子系统的静电势能</strong></h2>

<h3 id="elwald求和"><strong>Elwald求和</strong></h3>
<p>Ewald方法（Ewald summation method）适用于计算周期性晶格中点电荷的静电相互作用能，对于一个原胞中的N个点电荷(<script type="math/tex">q_i,i=1,N</script>)的静电势能为:</p>
<center>$$ E_{II} = \frac{1}{2} \sum_{m}' \sum_{i=1}^{N} \sum_{j=1}^{N}\frac{q_iq_j}{4\pi\varepsilon_0|r_{ij}+R_m|} $$</center>
<p>where, <script type="math/tex">R_m</script>是正格矢。</p>
<blockquote>
  <p>根据:陈正隆，徐为人，汤立达. 分子模拟的理论与实践[M]. 化学工业出版社, 2007. 的推导
<img src="/uploads/2020/04/ewald923.png" alt="" /></p>
</blockquote>

<p>更多资料:<br />
<a href="http://course.sdu.edu.cn/G2S/Template/View.aspx?courseId=6073&amp;topMenuId=259738&amp;action=view&amp;type=1&amp;name=&amp;menuType=1&amp;curfolid=259794">02 理论教学&gt;02 教学内容&gt;05 模拟方法&gt;04 Ewald方法</a>
<br />卢贵武,李春喜,汪文川,王子镐.计算机分子模拟中静电相互作用能的计算及参数优化[J].化学物理学报,2004(05):547-553.</p>

<p>QE实际使用的公式与上面的有些许出入</p>

<h2 id="热力学体系的总能量">热力学体系的总能量</h2>
<p>entropy S熵最小,等，再引入温度T等参数</p>

<p><br />
<br />
<br />
<br /></p>

<h2 id="-1"><center>~~~~~~~~~~~</center></h2>
<h2 id="代码部分"><center>代码部分</center></h2>
<h2 id="文件">文件</h2>
<p><code class="highlighter-rouge">PW/src/electrons.f90</code> 自洽计算入口</p>

<h2 id="electreons框架"><center>electreons框架</center></h2>
<h3 id="预准备">预准备</h3>
<ul>
  <li>计数变量归0
-设置收敛标准</li>
  <li>终止检查</li>
</ul>

<h3 id="略restart模式">[略]restart模式</h3>
<h3 id="do-idum1niter杂换泛函循环">DO idum=1,niter(杂换泛函循环)</h3>
<p>该循环用于杂换泛函的计算,如B3LYP的情况<code class="highlighter-rouge">input_dft='B3LYP'</code><br />
不杂化时,只计算<code class="highlighter-rouge">CALL electrons_scf ( printout, exxen )</code><br />
该大循环实际上只循环了一次,电子密度自洽求解的循环结束后，<br />
判断不是杂化形式，就直接结束了｀IF ( .NOT. dft_is_hybrid() ) RETURN｀<br /></p>
<h4 id="electrons_scf"><code class="highlighter-rouge">electrons_scf</code></h4>
<p><code class="highlighter-rouge">electrons_scf</code>的计算见下</p>
<h4 id="略若是-dft_is_hybrid执行后续命令">[略]若是<code class="highlighter-rouge"> dft_is_hybrid()</code>执行后续命令</h4>
<p>还会执行一次fft的init</p>

<h3 id="end-do">END DO</h3>

<h2 id="electrons_scf-1"><center>electrons_scf</center></h2>
<p>File:<code class="highlighter-rouge">PW/src/electrons.f90</code>本文件<br />
<strong>真正的电荷密度自洽部分</strong><br /></p>
<h3 id="预准备-1">预准备</h3>
<h4 id="restart略">restart略</h4>
<h4 id="memstat内存状态略">memstat内存状态,略</h4>
<h4 id="离子静电势能ewald求和">离子静电势能:Ewald求和</h4>
<p>File:<code class="highlighter-rouge">PW/src/ewald.f90</code><br />
这里是把原子核与芯电子看作一个点电荷，电荷量<script type="math/tex">q_i</script>=<code class="highlighter-rouge">zv</code>=<code class="highlighter-rouge">价电子数</code>=UPF文件中的<code class="highlighter-rouge">z_valence</code><br />
计算公式与陈正隆，徐为人，汤立达. 分子模拟的理论与实践[M]. 化学工业出版社, 2007. 的推导有点点不同</p>
<h4 id="色散能dftd">色散能:DFT+D</h4>
<h4 id="create_scf_typerhoinallocate输入电荷rhoin变量"><code class="highlighter-rouge">create_scf_type(rhoin)</code>ALLOCATE输入电荷<script type="math/tex">\rho^{in}</script>变量</h4>
<p>File:<code class="highlighter-rouge">PW/src/scf_mod.f90</code><br />
ALLOCATE<code class="highlighter-rouge">scf_type</code>结构体<code class="highlighter-rouge">rhoin</code>，结构体定义在<a href="/2020/04/07/qe-mesh/#scf_type%E7%BB%93%E6%9E%84%E4%BD%93">QE代码阅读: PW and grids</a></p>

<ul>
  <li><code class="highlighter-rouge">rho</code>与<code class="highlighter-rouge">rhoin</code>的区别</li>
  <li><code class="highlighter-rouge">rhoin</code><script type="math/tex">\rho^{in}</script>是我们在对角化时输入的密度<br />
    <ul>
      <li>Step A. 循环开始前
<code class="highlighter-rouge">call scf_type_COPY( rho, rhoin )
</code></li>
      <li>Step B. <strong>对角化的结果保存在<code class="highlighter-rouge">rho</code></strong></li>
      <li>Step C.1 若未收敛, 把<code class="highlighter-rouge">rho</code>与<code class="highlighter-rouge">rhoin</code>进行混合,得到下一次对角化需要的<code class="highlighter-rouge">rhoin</code>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   CALL mix_rho ( rho, rhoin, mixing_beta, dr2, tr2_min, iter, nmix, &amp;
                  iunmix, conv_elec )
</code></pre></div>        </div>
      </li>
      <li>Step C.2 若未收敛,使用<strong>混合后的输入密度<code class="highlighter-rouge">rhoin</code></strong>，构造新的<script type="math/tex">V[\rho^{in}]</script>,计算相关能量,<br />
并复制到<code class="highlighter-rouge">rho</code>再回到Step A. 循环解KS方程
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      CALL v_of_rho( rhoin, rho_core, rhog_core, &amp;
                     ehart, etxc, vtxc, eth, etotefield, charge, v)
      CALL scf_type_COPY( rhoin, rho )
</code></pre></div>        </div>
      </li>
      <li>Step D. <strong>若收敛,<code class="highlighter-rouge">rho</code>就是合理的密度不需要混合,后续使用<code class="highlighter-rouge">rho</code>计算</strong></li>
    </ul>
  </li>
</ul>

<h4 id="open_mix_file-iunmix-mix-exst-"><code class="highlighter-rouge">open_mix_file( iunmix, 'mix', exst )</code></h4>
<p>File:<code class="highlighter-rouge">PW/src/scf_mod.f90</code><br />
打开多个变量共同使用的buffer,各个变量的入口</p>
<ul>
  <li><code class="highlighter-rouge">start_rho </code></li>
  <li><code class="highlighter-rouge">start_kin </code></li>
  <li><code class="highlighter-rouge">start_ldaU</code></li>
  <li><code class="highlighter-rouge">start_bec </code></li>
  <li><code class="highlighter-rouge">start_dipole</code></li>
</ul>

<p><br /><br /><br /><br /><br /></p>

<h3 id="do-idum--1-niter-真正的scf循环">DO idum = 1, niter <strong>(真正的scf循环)</strong></h3>
<h4 id="更新对角化收敛精度ethr">更新对角化收敛精度<code class="highlighter-rouge">ethr</code></h4>
<p>由于平面波的数量是非常大的(<script type="math/tex">~10^4</script>),直接像<a href="/2019/08/04/HC_SCE/">原子轨道基一样</a>,用scalapack进行矩阵对角化是不可取的.<br />
常采用迭代的方法进行对角化，只求解最小的几个本征值对应的本征态,如cg,david算法,在输入参数中通过<code class="highlighter-rouge">diagonalization</code>参数控制.<br />
对角化的算法也是有收敛精度的,QE是逐步增加收敛精度的，因为开始的电子步密度就不是精确的,不用使用较高的对角化精度。<br />
因此对角化的精度<code class="highlighter-rouge">ethr</code>是随着scf循环逐渐增加的</p>

<h4 id="deband_hwfdelta_enin"><script type="math/tex">deband_{hwf}</script>=delta_e(<script type="math/tex">n^{in}</script>)</h4>
<p>File:<code class="highlighter-rouge">PW/src/electrons.f90</code>本文件<br />
使用输入电荷密度<script type="math/tex">n^{in}</script>(i.e.<code class="highlighter-rouge">rho%of_r</code>),计算<script type="math/tex">- \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)</script>
HWF能量泛函的部分,参见本文<strong>物理部分</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deband_hwf =  delta_e () = - \int rho%of_r(r)  v%of_r(r)
</code></pre></div></div>
<blockquote>
  <p>delta_e = - <code class="highlighter-rouge">\int rho%of_r(r)  v%of_r(r)</code>
<br />               - <code class="highlighter-rouge">\int rho%kin_r(r) v%kin_r(r)</code> [for Meta-GGA]
<br />               - <code class="highlighter-rouge">\sum rho%ns       v%ns</code>       [for LDA+U]
<br />               - <code class="highlighter-rouge">\sum becsum       D1_Hxc</code>     [for PAW]</p>
</blockquote>

<h4 id="scf_type_copy-rho-rhoin-复制电荷密度"><code class="highlighter-rouge">scf_type_COPY( rho, rhoin )</code>复制电荷密度</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>call scf_type_COPY( rho, rhoin )
</code></pre></div></div>

<h4 id="scf_step-do-对角化不合理时用">scf_step: DO <br />[对角化不合理时用]</h4>
<p>这个循环一般执行一次就结束了,对角化出现问题，才会在此循环</p>

<h5 id="c_bands对角化"><code class="highlighter-rouge">c_bands()</code>对角化</h5>
<p>File:<code class="highlighter-rouge">PW/src/c_bands.f90</code><br />
对角化哈密顿算法实现。获得<code class="highlighter-rouge">et,evc</code><br />
细节转<a href="/2020/04/24/qe-cband/">QE代码阅读: cbands对角化</a></p>
<h5 id="pool并行回收et">pool并行,回收<code class="highlighter-rouge">et</code></h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL poolrecover( et, nbnd, nkstot, nks )
</code></pre></div></div>
<p><strong><code class="highlighter-rouge">poolrecover</code>会把所有pool的数据仅收集到ionode,其他node数据不会改变,可以放心多次recover</strong></p>
<h5 id="sum_band"><code class="highlighter-rouge">sum_band()</code></h5>
<p>File:<code class="highlighter-rouge">PW/src/sum_band.f90</code><br />
<strong>注意，更新KS电荷密度，保存到<code class="highlighter-rouge">rho</code>变量中去</strong><br />
<strong>计算<code class="highlighter-rouge">eband</code>,i.e.<script type="math/tex">E_s[V^{in}[n^{in}]] = \sum_{i,\sigma}^{occ}  \epsilon_i^{\sigma}</script></strong><br />
费米能量<code class="highlighter-rouge">ef,ef_up,ef_down</code><br />
<code class="highlighter-rouge">demet</code>, <code class="highlighter-rouge">variational correction ("-TS") for metals</code><br />
细节见<a href="/2020/04/24/qe-sum_band/">QE代码阅读: sum_band</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL sum_band()
</code></pre></div></div>
<h5 id="计算e_hwfnin">计算<script type="math/tex">E_{HWF}[n^{in}]</script></h5>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hwf_energy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eband</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">deband_hwf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">etxc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">etxcc</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ewld</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ehart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">demet</span><span class="w">
</span><span class="k">If</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">okpaw</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">hwf_energy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwf_energy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">epaw</span><span class="w">
</span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lda_plus_u</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">hwf_energy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwf_energy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eth</span><span class="w">
</span></code></pre></div></div>
<p>如本文<strong>物理部分</strong>中提到，</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{array}{l}
E_{HWF}[n^{in}] &= E_s[V_{n^{in}}] - \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma) + E_{pot}[n^{in}] \\ \\
 &= E_s[V_{n^{in}}]   - \sum_\sigma\int drV^{\sigma,in}(r)n^{in}(r,\sigma)  \\
 & \text{ } \; \;\;\;\; \;\;\;  + ( \int {drV_{ext}(r)n^{in}(r)} + E_{Hartree}[n^{in}]+E_{II} +E_{XC}[n^{in}] ) \\ \\
 &= E_s[V_{n^{in}}] 
- \lbrace   \sum_\sigma\int dr (V^{\sigma,in}(r)-V_{ext}(r)) n^{in}(r,\sigma)  \rbrace	 \\
 & \text{ } \; \;\;\;\; \;\;\;  + E_{Hartree}[n^{in}]+E_{II} +E_{XC}[n^{in}]  \\ \\
 &= E_s[V_{n^{in}}]  - \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)  + E_{Hartree}[n^{in}]+E_{II} +E_{XC}[n^{in}] 

\end{array} %]]></script>

<p>where</p>
<ul>
  <li>
    <p><script type="math/tex">E_{HWF}[n^{in}]</script>，即<code class="highlighter-rouge">deband_hwf</code></p>
  </li>
  <li>
    <p><script type="math/tex">E_s[V^{in}[n^{in}]] = \sum_{i,\sigma}^{occ}  \epsilon_i^{\sigma}</script>,即<code class="highlighter-rouge">eband</code>,在<code class="highlighter-rouge">sum_band</code>中计算</p>
  </li>
  <li>
    <p><script type="math/tex">V_{n^{in}}^{\sigma} = V^{\sigma,in}(r)-V_{ext}(r)</script>,<br />
即<script type="math/tex">V_{KS}^{\sigma} - V_{ion} = V_{Hartree}[n^{in}]+V_{xc}[n^{in}+n_{nlcc}]+V_{\mathbf{B}}+V_{\mathbf{E}}+V_{\mathbf{lda+U}}</script>，<br />
 就是变量<code class="highlighter-rouge">v%of_r</code>,在<code class="highlighter-rouge">v_of_rho</code>中计算,见<a href="/2020/04/16/qe-init/#xc势能泛函e_xcks方程的xc势v_xcrho--rho_nlcc">QE代码阅读: init in run_pwscf</a><br /></p>
  </li>
  <li>
    <p><script type="math/tex">- \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)</script>,<br />
就是变量<code class="highlighter-rouge">deband_hwf</code>(<script type="math/tex">n^{in}</script>).使用函数<code class="highlighter-rouge">delta_e()</code>计算,如前</p>
  </li>
  <li>
    <p><script type="math/tex">E_s[V^{in}[n^{in}]]- \int dr V_{n^{in}}^{\sigma} n^{in}(r,\sigma)</script>,<br />
就是<script type="math/tex">\sum_{i,\sigma}^{occ}   \langle	\psi_i^\sigma(r) | \hat{T} + V_{ion} | \psi_i^\sigma(r)   \rangle</script>,对应<code class="highlighter-rouge">eband+deband_hwf</code></p>
  </li>
  <li>
    <p><script type="math/tex">E_{II}</script>,离子静电能量,是把离子实认为点电荷使用ewald求和计算,<code class="highlighter-rouge">ewld</code></p>
  </li>
  <li>
    <p><script type="math/tex">E_{Hartree}[n^{in}]</script>,价电子间的库伦能，<code class="highlighter-rouge">ehart</code>,在<code class="highlighter-rouge"> v_of_rho</code>中计算,见<a href="/2020/04/16/qe-init/#hartree泛函与势能">QE代码阅读: init in run_pwscf</a></p>
  </li>
  <li>
    <p><script type="math/tex">E_{xc}=\int_r \epsilon_{xc}[\rho(r) + \rho_{nlcc}(r)](\rho[r] + \rho_{nlcc}[r])dr</script>, XC能量泛函, 即<code class="highlighter-rouge">etxc</code>,在<code class="highlighter-rouge"> v_of_rho</code>中计算,见<a href="/2020/04/16/qe-init/#xc势能泛函e_xcks方程的xc势v_xcrho--rho_nlcc">QE代码阅读: init in run_pwscf</a></p>
  </li>
  <li><code class="highlighter-rouge">etxcc</code>,<code class="highlighter-rouge">the nlcc exchange and correlation</code><br />应该是之前QE版本中的变量,已不在计算，为0.<br />
    <blockquote>
      <p>From PW/src/set_rhoc.f90: calculate core_only exch-corr energy etxcc=E_xc[rho_core] if required
The term was present in previous versions of the code but it shouldn’t</p>
    </blockquote>
  </li>
  <li><code class="highlighter-rouge">demet</code>, <code class="highlighter-rouge">variational correction ("-TS") for metals</code></li>
</ul>

<h5 id="输出ldau信息">输出lda+u信息</h5>
<p>略
输出lda+U信息,同<a href="/2020/04/16/qe-init/#输出ldau信息">QE代码阅读: init in run_pwscf</a></p>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lda_plus_u</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="k">THEN</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iverbosity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">.OR.</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">noncolin</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
                 </span><span class="k">CALL</span><span class="w"> </span><span class="n">write_ns_nc</span><span class="p">()</span><span class="w">
              </span><span class="k">ELSE</span><span class="w">
                 </span><span class="k">CALL</span><span class="w"> </span><span class="n">write_ns</span><span class="p">()</span><span class="w">
              </span><span class="k">ENDIF</span><span class="w">
           </span><span class="k">ENDIF</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="n">starting_pot</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'atomic'</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">ns_adj</span><span class="p">()</span><span class="w">
              </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">noncolin</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
                 </span><span class="n">rhoin</span><span class="o">%</span><span class="n">ns_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho</span><span class="o">%</span><span class="n">ns_nc</span><span class="w">
              </span><span class="k">ELSE</span><span class="w">
                 </span><span class="n">rhoin</span><span class="o">%</span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho</span><span class="o">%</span><span class="n">ns</span><span class="w">
              </span><span class="k">ENDIF</span><span class="w">
           </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">niter_with_fixed_ns</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s1">'(/,5X,"RESET ns to initial values (iter &lt;= mixing_fixed_ns)",/)'</span><span class="p">)</span><span class="w">
              </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">noncolin</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
                 </span><span class="n">rho</span><span class="o">%</span><span class="n">ns_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhoin</span><span class="o">%</span><span class="n">ns_nc</span><span class="w">
              </span><span class="k">ELSE</span><span class="w">
                 </span><span class="n">rho</span><span class="o">%</span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhoin</span><span class="o">%</span><span class="n">ns</span><span class="w">
              </span><span class="k">ENDIF</span><span class="w">
           </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
           </span><span class="c1">!</span><span class="w">
        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
</span></code></pre></div></div>

<h5 id="磁性">磁性</h5>
<p>File:<code class="highlighter-rouge">PW/src/electrons.f90</code>本文件<br />
公式: <br />
<script type="math/tex">\text{absmag}=\int dr \, \sqrt{m_x^2(r)+m_y^2(r)+m_z^2(r)}</script><br />
<script type="math/tex">\text{magtot_nc}(i)=\int dr \, m_i(r) \; i=x,y,z</script><br /></p>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lsda</span><span class="w"> </span><span class="ow">.OR.</span><span class="w"> </span><span class="n">noncolin</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">CALL</span><span class="w"> </span><span class="n">compute_magnetization</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<h5 id="debanddelta_enout">deband=delta_e(<script type="math/tex">n^{out}</script>)</h5>
<p>File:<code class="highlighter-rouge">PW/src/electrons.f90</code>本文件<br />
使用输出电荷密度<script type="math/tex">n^{out}</script>(或者叫做由输入势场决定的电荷密度<script type="math/tex">n^{out}[V^{in}]</script>(i.e.已更新的<code class="highlighter-rouge">rho%of_r</code>),<br />
及<script type="math/tex">n^{in}</script>其决定的势<script type="math/tex">V_{n^{in}}^{\sigma}</script><br />
计算 <script type="math/tex">- \int dr V_{n^{in}}^{\sigma} n^{out}(r,\sigma)</script></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deband = delta_e()
</code></pre></div></div>

<h5 id="mix_rho收敛性判断混合密度">mix_rho,收敛性判断,混合密度</h5>
<p>File:<code class="highlighter-rouge">PW/src/mix_rho.f90 </code><br />
判断输入密度<code class="highlighter-rouge">rhoin</code>与输出密度<code class="highlighter-rouge">rho</code>在G空间的差别<script type="math/tex">\Delta \rho(G) = \rho^{out}(G)-\rho^{in}(G)</script>,<br />
并计算<script type="math/tex">\Delta \rho(G)</script>对应的与Hartree能类似的:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dr2=\sum_G 4pi/G^2*rho1(-G)*rho2(G) = V1_Hartree(-G)*rho2(G)`
</code></pre></div></div>
<p>若<code class="highlighter-rouge">conv_elec =  dr2 &lt; tr2 </code>则收敛<br />
否则,<strong>混合密度保存到<code class="highlighter-rouge">rhoin</code></strong>,实空间倒空间全更新</p>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="k">CALL</span><span class="w"> </span><span class="n">mix_rho</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rho</span><span class="p">,</span><span class="w"> </span><span class="n">rhoin</span><span class="p">,</span><span class="w"> </span><span class="n">mixing_beta</span><span class="p">,</span><span class="w"> </span><span class="n">dr2</span><span class="p">,</span><span class="w"> </span><span class="n">tr2_min</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="n">nmix</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
                       </span><span class="n">iunmix</span><span class="p">,</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="p">)</span><span class="w">
        </span><span class="k">CALL</span><span class="w"> </span><span class="n">bcast_scf_type</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rhoin</span><span class="p">,</span><span class="w"> </span><span class="n">root_pool</span><span class="p">,</span><span class="w"> </span><span class="n">inter_pool_comm</span><span class="w"> </span><span class="p">)</span><span class="w">
        </span><span class="k">CALL</span><span class="w"> </span><span class="n">mp_bcast</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dr2</span><span class="p">,</span><span class="w"> </span><span class="n">root_pool</span><span class="p">,</span><span class="w"> </span><span class="n">inter_pool_comm</span><span class="w"> </span><span class="p">)</span><span class="w">
        </span><span class="k">CALL</span><span class="w"> </span><span class="n">mp_bcast</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">conv_elec</span><span class="p">,</span><span class="w"> </span><span class="n">root_pool</span><span class="p">,</span><span class="w"> </span><span class="n">inter_pool_comm</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><code class="highlighter-rouge">mix_rho</code>细节:<br />
<strong>判断是否收敛</strong>:<code class="highlighter-rouge">conv = ( dr2 &lt; tr2 )</code></p>
<ul>
  <li>不需要混合密度(收敛 OR 差别小:<code class="highlighter-rouge">conv .OR. dr2 &lt; tr2_min</code>)
    <ul>
      <li>DEALLOCATE相关变量,RETUEN</li>
      <li><code class="highlighter-rouge">rho</code>仍是<code class="highlighter-rouge">sum_band</code>中计算的KS密度<br />
<script type="math/tex">n^{new} = \sum_{\sigma}\sum_{i=1}^{N^\sigma} \langle \psi_i^\sigma(r) |  \psi_i^\sigma(r) \rangle</script></li>
    </ul>
  </li>
  <li>若需要
    <ul>
      <li>若未初始化,ALLOCATE相关变量</li>
      <li>混合密度,<code class="highlighter-rouge">rho</code>变为<script type="math/tex">n^{mix}=mix(n^{in},n^{new})</script></li>
    </ul>
  </li>
</ul>

<h5 id="对角化出问题时cycle-scf_step">对角化出问题时:<code class="highlighter-rouge">CYCLE scf_step</code></h5>
<p>若密度差的能量<code class="highlighter-rouge">dr2</code>比对角化的精度<code class="highlighter-rouge">ethr</code>小，说明对角化算法误差太大,需要提高精度对角化(减少<code class="highlighter-rouge">ethr</code>)</p>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="ow">.and.</span><span class="w"> </span><span class="n">nat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="c1">! ... first scf iteration: check if the threshold on diagonalization</span><span class="w">
           </span><span class="c1">! ... (ethr) was small enough wrt the error in self-consistency (dr2)</span><span class="w">
           </span><span class="c1">! ... if not, perform a new diagonalization with reduced threshold</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">.FALSE.</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">dr2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tr2_min</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="c1">!</span><span class="w">
              </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s1">'(/,5X,"Threshold (ethr) on eigenvalues was ", &amp;
                               &amp;    "too large:",/,5X,                      &amp;
                               &amp; "Diagonalizing with lowered threshold",/)'</span><span class="w"> </span><span class="p">)</span><span class="w">
              </span><span class="c1">!</span><span class="w">
              </span><span class="n">ethr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1D0</span><span class="o">*</span><span class="n">dr2</span><span class="w"> </span><span class="p">/</span><span class="w"> </span><span class="nb">MAX</span><span class="p">(</span><span class="w"> </span><span class="mf">1.D0</span><span class="p">,</span><span class="w"> </span><span class="n">nelec</span><span class="w"> </span><span class="p">)</span><span class="w">
              </span><span class="c1">!</span><span class="w">
              </span><span class="k">CYCLE</span><span class="w"> </span><span class="n">scf_step</span><span class="w">
              </span><span class="c1">!</span><span class="w">
           </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
           </span><span class="c1">!</span><span class="w">
        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
</span></code></pre></div></div>

<h5 id="更新势场">更新势场</h5>
<p>大致操作如下, 代码最下</p>
<ul>
  <li><strong>不收敛</strong>:下次循环的准备操作<br />
    <ul>
      <li><code class="highlighter-rouge">CALL v_of_rho</code>,具体见计算<a href="/2020/04/16/qe-init/#call-v_of_rho">QE代码阅读: init in run_pwscf</a>,<strong>更新混合密度<script type="math/tex">n^{mix}</script>的势场</strong><br />
 <code class="highlighter-rouge">v%of_r</code>,<script type="math/tex">V_{n^{mix}}^{\sigma} = V_{Hartree}[n^{mix}]+V_{xc}[n^{mix}+n_{nlcc}]+V_{\mathbf{B}}+V_{\mathbf{E}}+V_{\mathbf{lda+U}}</script><br />
 <code class="highlighter-rouge">ehart</code>,<script type="math/tex">E_{Hartree}[n^{mix}]</script><br />
 <code class="highlighter-rouge">etxc</code>,<script type="math/tex">E_{xc}[n^{mix}+n_{nlcc}]</script><br /></li>
      <li><code class="highlighter-rouge">descf = delta_escf()</code><br />
 因为:<code class="highlighter-rouge">deband</code><script type="math/tex">= - \int dr V_{n^{in}}^{\sigma} n^{out}(r,\sigma)</script>,<code class="highlighter-rouge">eband</code><script type="math/tex">=E_s[V^{in}[n^{in}]]</script>是基于<script type="math/tex">n^{new}</script>计算的，即<code class="highlighter-rouge">deband+eband</code>都是对应的<script type="math/tex">n^{new}</script>,而不是<script type="math/tex">n^{mix}</script>,使用<code class="highlighter-rouge">descf</code>代表误差<br />
 <code class="highlighter-rouge">descf</code> <script type="math/tex">= (eband+deband)[n^{mix}] - (eband+deband)[n^{new}]</script></li>
      <li><code class="highlighter-rouge">CALL scf_type_COPY( rhoin, rho )</code>复制输入电荷
 <script type="math/tex">n^{in} = n^{mix}</script></li>
      <li><code class="highlighter-rouge">descf = 0</code>,因为收敛时<code class="highlighter-rouge">rho</code>不需要混合,就是<script type="math/tex">n^{new}</script></li>
    </ul>
  </li>
  <li><strong>收敛</strong>:
    <ul>
      <li><code class="highlighter-rouge">CALL v_of_rho</code>,更新势场,<strong>收敛的时候<code class="highlighter-rouge">rho</code>是KS密度<script type="math/tex">n^{new}</script>,不是<script type="math/tex">n^{mix}</script> <script type="math/tex">V_{n^{new}}^{\sigma}</script></strong><br />
 <code class="highlighter-rouge">v%of_r</code>,<script type="math/tex">V_{n^{new}}^{\sigma} = V_{Hartree}[n^{new}]+V_{xc}[n^{new}+n_{nlcc}]+V_{\mathbf{B}}+V_{\mathbf{E}}+V_{\mathbf{lda+U}}</script><br />
 <code class="highlighter-rouge">ehart</code>,<script type="math/tex">E_{Hartree}[n^{new}]</script><br />
 <code class="highlighter-rouge">etxc</code>,<script type="math/tex">E_{xc}[n^{new}+n_{nlcc}]</script><br /></li>
      <li>计算势能差<code class="highlighter-rouge">vnew%of_r(:,:)</code>=<script type="math/tex">V_{n^{new}}^{\sigma} -V_{n^{in}}^{\sigma}</script></li>
    </ul>
  </li>
</ul>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="ow">.NOT.</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
           </span><span class="k">CALL</span><span class="w"> </span><span class="n">v_of_rho</span><span class="p">(</span><span class="w"> </span><span class="n">rhoin</span><span class="p">,</span><span class="w"> </span><span class="n">rho_core</span><span class="p">,</span><span class="w"> </span><span class="n">rhog_core</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
                          </span><span class="n">ehart</span><span class="p">,</span><span class="w"> </span><span class="n">etxc</span><span class="p">,</span><span class="w"> </span><span class="n">vtxc</span><span class="p">,</span><span class="w"> </span><span class="n">eth</span><span class="p">,</span><span class="w"> </span><span class="n">etotefield</span><span class="p">,</span><span class="w"> </span><span class="n">charge</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">okpaw</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">PAW_potential</span><span class="p">(</span><span class="n">rhoin</span><span class="o">%</span><span class="n">bec</span><span class="p">,</span><span class="w"> </span><span class="n">ddd_paw</span><span class="p">,</span><span class="w"> </span><span class="n">epaw</span><span class="p">,</span><span class="n">etot_cmp_paw</span><span class="p">)</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">PAW_symmetrize_ddd</span><span class="p">(</span><span class="n">ddd_paw</span><span class="p">)</span><span class="w">
           </span><span class="k">ENDIF</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="n">descf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta_escf</span><span class="p">()</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="k">CALL</span><span class="w"> </span><span class="n">scf_type_COPY</span><span class="p">(</span><span class="w"> </span><span class="n">rhoin</span><span class="p">,</span><span class="w"> </span><span class="n">rho</span><span class="w"> </span><span class="p">)</span><span class="w">
           </span><span class="c1">!</span><span class="w">
        </span><span class="k">ELSE</span><span class="w"> 
           </span><span class="c1">!</span><span class="w">
           </span><span class="c1">! ... convergence reached:</span><span class="w">
           </span><span class="c1">! ... 1) the output HXC-potential is saved in v</span><span class="w">
           </span><span class="c1">! ... 2) vnew contains V(out)-V(in) ( used to correct the forces ).</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="n">vnew</span><span class="o">%</span><span class="n">of_r</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="o">%</span><span class="n">of_r</span><span class="p">(:,:)</span><span class="w">
           </span><span class="k">CALL</span><span class="w"> </span><span class="n">v_of_rho</span><span class="p">(</span><span class="w"> </span><span class="n">rho</span><span class="p">,</span><span class="n">rho_core</span><span class="p">,</span><span class="n">rhog_core</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
                          </span><span class="n">ehart</span><span class="p">,</span><span class="w"> </span><span class="n">etxc</span><span class="p">,</span><span class="w"> </span><span class="n">vtxc</span><span class="p">,</span><span class="w"> </span><span class="n">eth</span><span class="p">,</span><span class="w"> </span><span class="n">etotefield</span><span class="p">,</span><span class="w"> </span><span class="n">charge</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
           </span><span class="n">vnew</span><span class="o">%</span><span class="n">of_r</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="o">%</span><span class="n">of_r</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vnew</span><span class="o">%</span><span class="n">of_r</span><span class="p">(:,:)</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">okpaw</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">PAW_potential</span><span class="p">(</span><span class="n">rho</span><span class="o">%</span><span class="n">bec</span><span class="p">,</span><span class="w"> </span><span class="n">ddd_paw</span><span class="p">,</span><span class="w"> </span><span class="n">epaw</span><span class="p">,</span><span class="n">etot_cmp_paw</span><span class="p">)</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">PAW_symmetrize_ddd</span><span class="p">(</span><span class="n">ddd_paw</span><span class="p">)</span><span class="w">
           </span><span class="k">ENDIF</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="c1">! ... note that rho is here the output, not mixed, charge density</span><span class="w">
           </span><span class="c1">! ... so correction for variational energy is no longer needed</span><span class="w">
           </span><span class="c1">!</span><span class="w">
           </span><span class="n">descf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0._dp</span><span class="w">
           </span><span class="c1">!</span><span class="w">
        </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
</span></code></pre></div></div>

<h4 id="end-do-scf_step对角化循环">END DO scf_step<br />对角化循环</h4>

<h4 id="一堆空plugin操作">一堆空plugin操作</h4>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">     </span><span class="n">plugin_etot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_dp</span><span class="w">
     </span><span class="k">CALL</span><span class="w"> </span><span class="n">plugin_scf_energy</span><span class="p">(</span><span class="n">plugin_etot</span><span class="p">,</span><span class="n">rhoin</span><span class="p">)</span><span class="w">
     </span><span class="k">CALL</span><span class="w"> </span><span class="n">plugin_scf_potential</span><span class="p">(</span><span class="n">rhoin</span><span class="p">,</span><span class="n">conv_elec</span><span class="p">,</span><span class="n">dr2</span><span class="p">,</span><span class="n">vltot</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<h4 id="vrs--external--scf"><code class="highlighter-rouge">vrs = external + scf</code></h4>
<p>File:<code class="highlighter-rouge">PW/src/set_vrs.f90</code><br />
同<a href="/2020/04/16/qe-init/#计算势能vrs">QE代码阅读: init in run_pwscf#set_vrs</a></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     ! ... define the total local potential (external + scf)
     !
     CALL sum_vrs( dfftp%nnr, nspin, vltot, v%of_r, vrs )
     !
     ! ... interpolate the total local potential
     !
     CALL interpolate_vrs( dfftp%nnr, nspin, doublegrid, kedtau, v%kin_r, vrs )
</code></pre></div></div>

<h4 id="call-newd"><code class="highlighter-rouge">CALL newd()</code></h4>
<p>File:<code class="highlighter-rouge">PW/src/newd.f90</code></p>
<blockquote>
  <p>… in the US case we have to recompute the self-consistent
… term in the nonlocal potential
… PAW: newd contains PAW updates of NL coefficients</p>

</blockquote>

<h4 id="略">略</h4>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">     </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lelfield</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">en_el</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">calc_pol</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w">
     </span><span class="c1">!</span><span class="w">
     </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span><span class="n">report</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="ow">.OR.</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
        </span><span class="c1">!</span><span class="w">
        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">noncolin</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="n">domag</span><span class="p">)</span><span class="w"> </span><span class="ow">.OR.</span><span class="w"> </span><span class="n">i_cons</span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="ow">.OR.</span><span class="w"> </span><span class="n">nspin</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">CALL</span><span class="w"> </span><span class="n">report_mag</span><span class="p">()</span><span class="w">
        </span><span class="c1">!</span><span class="w">
     </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
</span></code></pre></div></div>

<h4 id="用时报告write-stdout-9000--get_clock-pwscf-">用时报告<code class="highlighter-rouge">WRITE( stdout, 9000 ) get_clock( 'PWSCF' )</code></h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>9000 FORMAT(/'     total cpu time spent up to now is ',F10.1,' secs' )
</code></pre></div></div>

<h4 id="conv_elec收敛输出"><code class="highlighter-rouge">conv_elec</code>收敛输出</h4>

<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">     </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="mi">9101</span><span class="w"> </span><span class="p">)</span><span class="w">
     </span><span class="c1">!9101 FORMAT(/'     End of self-consistent calculation' )</span><span class="w">
</span><span class="c1">!  these values are assigned to global variables  because these information are needed for XML  printout </span><span class="w">
</span><span class="c1">!  P.D. </span><span class="w">
     </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> 
           </span><span class="n">scf_error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dr2</span><span class="w">
           </span><span class="n">n_scf_steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="w">
     </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">  

     </span><span class="c1">!</span><span class="w">
     </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="ow">.OR.</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="w"> </span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="n">iprint</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
        </span><span class="c1">!</span><span class="w">
        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lda_plus_U</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="n">iverbosity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">noncolin</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">write_ns_nc</span><span class="p">()</span><span class="w">
           </span><span class="k">ELSE</span><span class="w">
              </span><span class="k">CALL</span><span class="w"> </span><span class="n">write_ns</span><span class="p">()</span><span class="w">
           </span><span class="k">ENDIF</span><span class="w">
        </span><span class="k">ENDIF</span><span class="w">
        </span><span class="k">CALL</span><span class="w"> </span><span class="n">print_ks_energies</span><span class="p">()</span><span class="w">
        </span><span class="c1">!</span><span class="w">
     </span><span class="k">END</span><span class="w"> </span><span class="k">IF</span><span class="w">
</span></code></pre></div></div>
<h4 id="计算e_ksvin">计算<script type="math/tex">E_{KS}[V^{in}]</script></h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     etot = eband + ( etxc - etxcc ) + ewld + ehart + deband + demet + descf
</code></pre></div></div>
<ul>
  <li><code class="highlighter-rouge">etot</code>,输入势场的能量泛函<script type="math/tex">E_{KS}[V^{in}]</script>,见<strong>物理部分</strong>
    <ul>
      <li>未收敛时:<strong>是混合密度<script type="math/tex">n^{mix}</script>的能量,而不是<script type="math/tex">n^{new}</script></strong></li>
      <li>收敛时:<strong>是KS密度<script type="math/tex">n^{new}</script>的能量</strong></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">eband</code>,<script type="math/tex">E_s[V^{in}] = \sum_{i,\sigma}^{occ}  \epsilon_i^{\sigma}</script>,在<code class="highlighter-rouge">sum_band</code>中计算</li>
  <li><code class="highlighter-rouge">deband</code>,<script type="math/tex">- \int dr V^{in,\sigma} n^{new}(r,\sigma)</script></li>
  <li>
    <script type="math/tex; mode=display">descf = (eband+deband)[n^{mix}] - (eband+deband)[n^{new}]</script>
    <ul>
      <li>未收敛， <code class="highlighter-rouge">descf = delta_escf()</code></li>
      <li>收敛,  <code class="highlighter-rouge">descf = 0</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">etxc - etxcc</code>,ehart,分别为<script type="math/tex">E_{xc}[n^{?}+n_{nlcc}],E_{Hartree}[n^{?}]</script>,where <script type="math/tex">n^{?}</script>为
    <ul>
      <li>未收敛时:混合密度<script type="math/tex">n^{mix}</script></li>
      <li>收敛时:是KS密度<script type="math/tex">n^{new}</script></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">ewald</code>,<script type="math/tex">E_{II}</script></li>
</ul>

<h4 id="对e_hwfnine_ksvin的补充项">对<script type="math/tex">E_{HWF}[n^{in}]</script>，<script type="math/tex">E_{KS}[V^{in}]</script>的补充项</h4>
<p>简单的计算，是没有这些修正的</p>
<ul>
  <li>杂化</li>
  <li>lda+U</li>
  <li><code class="highlighter-rouge">lelfield</code></li>
  <li><code class="highlighter-rouge">textfor</code></li>
  <li><code class="highlighter-rouge">llondon</code></li>
  <li>DFT+D</li>
  <li>xdm energy</li>
  <li>ts_vdw</li>
  <li>tefield
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   IF ( tefield ) THEN
      etot = etot + etotefield
      hwf_energy = hwf_energy + etotefield
   END IF
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">gate</code></li>
  <li><code class="highlighter-rouge">lfcpopt .or. lfcpdyn</code></li>
  <li>etc</li>
</ul>

<h4 id="输出能量">输出能量</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL print_energies ( printout )
</code></pre></div></div>
<p>普通情况,如下,收敛了输出的total energy就带<code class="highlighter-rouge">!</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     total energy              =     -21.73135066 Ry
     Harris-Foulkes estimate   =     -21.73054035 Ry
     estimated scf accuracy    &lt;       0.00276733 Ry
</code></pre></div></div>
<p>若是 lda+U    , <code class="highlighter-rouge">lelfield</code>    , <code class="highlighter-rouge">textfor</code>    , <code class="highlighter-rouge">llondon</code>    , DFT+D    , xdm energy    , ts_vdw    , tefield  , tefield   , <code class="highlighter-rouge">gate</code>    , <code class="highlighter-rouge">lfcpopt .or. lfcpdyn</code>    , etc  等特殊情况，还会输出相应的能量</p>

<h4 id="若收敛报告信息跳出循环">若收敛,报告信息,跳出循环</h4>
<div class="language-fortran highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">conv_elec</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">do_makov_payne</span><span class="w"> </span><span class="ow">.AND.</span><span class="w"> </span><span class="n">printout</span><span class="p">/</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">CALL</span><span class="w"> </span><span class="n">makov_payne</span><span class="p">(</span><span class="w"> </span><span class="n">etot</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="mi">9110</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">iter</span><span class="w">
</span><span class="k">GO TO</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span></code></pre></div></div>
<p>输出</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>convergence has been achieved in   4 iterations
</code></pre></div></div>

<p><br /><br /><br /></p>

<h3 id="end-do-1">END DO</h3>

<p><br /><br /><br /><br /><br /></p>

<h3 id="保存电荷密度charge-density">保存电荷密度<code class="highlighter-rouge">charge-density</code></h3>
<p>File:<code class="highlighter-rouge">PW/src/io_rho_xml.f90</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL write_scf( rho, nspin )
</code></pre></div></div>
<h3 id="close_mix_file-iunmix-delete-"><code class="highlighter-rouge">close_mix_file( iunmix, 'delete' )</code></h3>
<p>File:<code class="highlighter-rouge">PW/src/scf_mod.f90</code><br />
关闭混合变量buffer</p>
<h3 id="remove_atomic_rho"><code class="highlighter-rouge">remove_atomic_rho()</code></h3>
<p>File:<code class="highlighter-rouge">PW/src/remove_atomic_rho.f90</code><br />
保存<code class="highlighter-rouge">rho%of_g - drhog</code>,并没有选项可以设置output_drho<br />
好像没找到输入参数可以设置输出该选项</p>
<h3 id="destroy_scf_type--rhoin-"><code class="highlighter-rouge">destroy_scf_type ( rhoin )</code></h3>
<p>File:<code class="highlighter-rouge">PW/src/scf_mod.f90</code><br />
DEALLOCATE<code class="highlighter-rouge">scf_type</code>结构体<code class="highlighter-rouge">rhoin</code></p>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <h2 id="similar_posts">类似文章</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2020/09/20/qe-spin/">QE代码阅读: 自旋相关
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        
        <!--- github follow and star -->
        <iframe src="/html_script/github-btn.html?user=cndaqiang&repo=cndaqiang.github.io&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        <iframe src="/html_script/github-btn.html?user=cndaqiang&type=follow&count=true&size=large" frameborder="0" scrolling="0" width="220px" height="30px"></iframe>
        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2020/04/12/eng-framework/">[开发中...]英语笔记: 语法框架</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2020/04/14/qe-input/">[挖坑]QE代码阅读: 计算参数</a></p>
        
    </div>
</div>

        <div id="adsense"></div>
<!-- 谷歌广告文章底部,夜广告，自适应 -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-8365330523291002"
     data-ad-slot="7816631956"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        <hr>
        <h2 id="comments">评论</h2>
        




<!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC80MDQ4OC8xNzAxNQ==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->

		<hr>
		<h2 id="adsenseAfterComments">广告</h2>
        <div id="adsense"></div>
<!-- 谷歌广告文章底部,夜广告，自适应 -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-8365330523291002"
     data-ad-slot="7816631956"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        

        


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    目录
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">类似文章</a></li>
                    
                    <li><a href="#comments">评论</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 ，添加br 使不粘连--><br>
            <div class="side">
               <div>
                   <i class="fa fa-database"></i>
                  访客数据
               </div>
               <script type="text/javascript" src="//rf.revolvermaps.com/0/0/7.js?i=537vyn60ia7&amp;m=0&amp;c=007eff&amp;cr1=ff0000&amp;sx=0" async="async"></script>
            </div>
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             本站记录我的学习笔记！ 
        </p>
        <p class="contact">
            联系方式: 
            <a href="https://github.com/cndaqiang" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:who@cndaqiang.ac.cn" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>   
            <a href="https://www.zhihu.com/people/cndaqiang" title="Zhihu"><i class="iconfont icon-zhihu"></i></a>   
            <a href="http://www.jianshu.com/u/5d47905688d0" title="Jianshu"><i class="iconfont icon-jianshu"></i></a>  
            <a href="https://twitter.com/cndaqiang" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a>  
            <a href="https://www.facebook.com/daqiang.chen.12" title="Facebook"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>    
        </p>
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://cndaqiang.github.io/">cndaqiang</a>
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
