---
layout: post
title:  "Linuxä½¿ç”¨clash"
date:   2020-07-17 20:42:00 +0800
categories: Linux
tags: clash
author: cndaqiang
mathjax: true
---
* content
{:toc}






## 2022-06-20æ›´æ–°
linuxçš„[shellå®¢æˆ·ç«¯:ShellClash](https://github.com/juewuy/ShellClash)

å¯ä»¥å¾ˆç®€å•çš„åœ¨æœåŠ¡å™¨å’Œopenwrtç­‰ç³»ç»Ÿä¸Šå¸ƒç½®clash.


## 2022-02-23æ›´æ–°
linuxçš„[GUIå®¢æˆ·ç«¯:CFW](https://github.com/Fndroid/clash_for_windows_pkg/releases)æœ‰äº†,é€‚åˆlinuxä½œä¸ºä¸»åŠ›æœºçš„ç”¨æˆ·
```
wget https://github.com/Fndroid/clash_for_windows_pkg/releases/download/0.19.8/Clash.for.Windows-0.19.8-x64-linux.tar.gz
tar xzvf Clash.for.Windows-0.19.8-x64-linux.tar.gz
cd Clash\ for\ Windows-0.19.8-x64-linux/
./cfw
```

ä¸‹é¢çš„æ–¹æ³•é€‚åˆä¸€å°æœåŠ¡å™¨ä¸Šè¿è¡Œclash,ç»™å±€åŸŸç½‘å†…å…¶ä»–æœºå™¨æä¾›ä»£ç†

## å‚è€ƒ
[linuxç¯å¢ƒä½¿ç”¨clashå®ç°ç½‘ç»œä»£ç†è®¿é—®å¤–ç½‘](https://www.cnblogs.com/sueyyyy/p/12424178.html)<br>
[Clash For Linuxè‡ªåŠ¨æ›´æ–°è®¢é˜…é…ç½®](https://ytlee.cn/2021/04/clash-for-linux-automatically-renews-the-subscription-link/)


## æ–‡ä»¶è¯´æ˜
- å®¢æˆ·ç«¯ï¼Œå¯æ‰§è¡Œç¨‹åº:clash<br>
é¡¹ç›®åœ°å€:https://github.com/Dreamacro/clash
- é…ç½®æ–‡ä»¶:`~/.config/clash/config.yaml`<br>
é‡Œé¢æ”¾ç€clashçš„æ¥å£,æ§åˆ¶å‚æ•°ï¼Œé“¾æ¥ä¿¡æ¯ç­‰  
- ipæ•°æ®åº“`~/.config/clash/Country.mmdb`<br>
å¯åŠ¨ç¨‹åºåä¼šè‡ªåŠ¨ä¸‹è½½ï¼Œä¸‹è½½å¤±è´¥ï¼Œç»ˆç«¯ä¼šæç¤ºé”™è¯¯ï¼Œå¤åˆ¶æç¤ºçš„ä¸‹è½½é“¾æ¥ï¼Œæ‰‹åŠ¨ä¸‹è½½æ”¾åˆ°`~/.config/clash/config.yaml`


## ä¸‹è½½å®¢æˆ·ç«¯
ä¸‹è½½é¡µé¢,https://github.com/Dreamacro/clash/releases
```
wget https://github.com/Dreamacro/clash/releases/download/v1.9.0/clash-linux-amd64-v1.9.0.gz
gzip -d clash-linux-amd64-v1.9.0.gz
```

## åˆå§‹åŒ–ç¨‹åº
```
(python37) cndaqiang@girl:~/MyTools/clash$ ./clash-linux-amd64-v0.19.0
```
è‹¥æ— `~/.config/clash/config.yaml`ä¸`~/.config/clash/Country.mmdb`ä¼šæç¤ºï¼Œç„¶åè‡ªåŠ¨ä¸‹è½½
```
cndaqiang@GIRL clash$ ./clash-linux-amd64-v1.9.0
INFO[0000] Can't find config, create a initial config file
INFO[0000] Can't find MMDB, start download
FATA[0011] Initial configuration directory error: Can't initial MMDB: Can't download MMDB: Get "https://github-production-release-asset-2e65be.s3.amazonaws.com/231014917/281a0e00-c369-11ea-8903-79a958b78b99?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20200717%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20200717T124944Z&X-Amz-Expires=300&X-Amz-Signature=95c6abc781a12fad2be03e640220a1f01f67e580d60d4510b9d80e233a164fbc&X-Amz-SignedHeaders=host&actor_id=0&repo_id=231014917&response-content-disposition=attachment%3B%20filename%3DCountry.mmdb&response-content-type=application%2Foctet-stream": net/http: TLS handshake timeout 
```
å¦‚æœä¸‹è½½ipæ•°æ®åº“å¤±è´¥ï¼Œäººä¸ºä»£ç†ä¸‹è½½åæ”¾åˆ°`~/.config/clash/`

## é…ç½®æ–‡ä»¶
ç¼–è¾‘`~/.config/clash/config.yaml`æ–‡ä»¶,ä¹°çš„æœºåœºä¹Ÿæä¾›ç›¸åº”çš„é…ç½®æ–‡ä»¶,ä¹Ÿå¯ä»¥æŠŠæœºåœºæä¾›çš„è®¢é˜…åœ°å€æŒ‰ç…§[ä¸‹é¢çš„æ–¹å¼](/2020/07/17/clash/#%E8%AE%A2%E9%98%85%E7%9B%B8%E5%85%B3)ç”Ÿæˆé…ç½®æ–‡ä»¶
```
#httpä»£ç†
port: 10091
#socksä»£ç†
socks-port: 10092
#æ˜¯å¦å…è®¸å±€åŸŸç½‘è¿æ¥
allow-lan: true
#è¿è¡Œæ¨¡å¼: è§„åˆ™Rule,å…¨å±€Global,ç›´è¿Direct
mode: Global
log-level: silent
#ç½‘é¡µç®¡ç†ipå’Œç«¯å£
external-controller: '0.0.0.0:10090'
#ç®¡ç†å¯†ç 
secret: ''
#ä¸€å †ä»£ç†
Proxy:
  -
    name: xxxx
    type: trojan
    server: xxxx
    port: xxxx
    password: xxxx
    sni: xxx
```
### å¸¸ç”¨é…ç½®å‚æ•°
```
mixed-port: 10092
allow-lan: true
mode: Rule
bind-address: '192.168.192.204'
external-controller: 192.168.192.204:9090
ipv6: true
```

### åˆ†ç»„è®¾ç½®
```
proxy-groups:
  - name: ğŸ”° èŠ‚ç‚¹é€‰æ‹© #ç»„å
    type: select     #ç±»å‹,é€‰æ‹©
    proxies:         #é€‰é¡¹
      - â™»ï¸è‡ªåŠ¨é€‰æ‹©   #å…¶ä»–åˆ†ç»„
      - ğŸ¯ å…¨çƒç›´è¿  #å…¶ä»–åˆ†ç»„
      - å…¬ç›Š|æ–°åŠ å¡é«˜é€ŸèŠ‚ç‚¹|H.Kä¸­è½¬|1Gps  #ä»£ç†èŠ‚ç‚¹
  - name: â™»ï¸è‡ªåŠ¨é€‰æ‹©
    type: url-test #æµ‹è¯•url
    url: http://www.gstatic.com/generate_204
    interval: 300
    proxies:
      - å…¬ç›Š|æ–°åŠ å¡é«˜é€ŸèŠ‚ç‚¹|H.Kä¸­è½¬|1Gps
```

### è§„åˆ™
æŒ‡å®šç¬¦åˆè§„åˆ™çš„åŸŸåé‡‡ç”¨çš„åˆ†ç»„
```
rules:
 - DOMAIN-SUFFIX,local,ğŸ¯ å…¨çƒç›´è¿
 - IP-CIDR,192.168.0.0/16,ğŸ¯ å…¨çƒç›´è¿,no-resolve
 - DOMAIN-SUFFIX,android.com,ğŸ”° èŠ‚ç‚¹é€‰æ‹©
 - DOMAIN-KEYWORD,XLLiveUD,ğŸ¯ å…¨çƒç›´è¿
 - GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿
 - MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼    #å…¶ä»–ç½‘ç«™é€‰æ‹©ğŸŸ æ¼ç½‘ä¹‹é±¼åˆ†ç»„
```

è§„åˆ™å®šä¹‰
- DOMAIN-SUFFIXï¼šåŸŸååç¼€åŒ¹é…
- DOMAINï¼šåŸŸååŒ¹é…
- DOMAIN-KEYWORDï¼šåŸŸåå…³é”®å­—åŒ¹é…
- IP-CIDRï¼šIP æ®µåŒ¹é…
- SRC-IP-CIDRï¼šæº IP æ®µåŒ¹é…
- GEOIPï¼šGEOIP æ•°æ®åº“ï¼ˆå›½å®¶ä»£ç ï¼‰åŒ¹é…
- DST-PORTï¼šç›®æ ‡ç«¯å£åŒ¹é…
- SRC-PORTï¼šæºç«¯å£åŒ¹é…
- PROCESS-NAMEï¼šæºè¿›ç¨‹ååŒ¹é…
- RULE-SETï¼šRule Provider è§„åˆ™åŒ¹é…
- MATCHï¼šå…¨åŒ¹é…

**è§„åˆ™é å‰çš„ä¼˜å…ˆçº§é«˜**,æˆ‘ä»¬è¦æ’å…¥è‡ªå®šä¹‰è§„åˆ™,è¦æ’åœ¨`MATCHï¼šå…¨åŒ¹é…`çš„å‰é¢



## è¿è¡Œ
```
cndaqiang@GIRL clash$ ./clash-linux-amd64-v1.9.0
```
æµè§ˆå™¨æ·»åŠ è®¾ç½®çš„http/socksä»£ç†

## å…¶ä»–
### dashboardé…ç½®
#### å…¬å…±dashboard
ç½‘é¡µæ‰“å¼€[http://clash.razord.top/](http://clash.razord.top/),é€‰æ‹©è®¾ç½®ï¼Œç‚¹å‡»ç¼–è¾‘å¤–éƒ¨æ§åˆ¶è®¾ç½®æ—è¾¹çš„è“è‰²ip:ç«¯å£<br>
å…¶ä»–çš„GUIç®¡ç†ç½‘é¡µä¹Ÿæ˜¯å¯ä»¥çš„[http://yacd.haishan.me/](http://yacd.haishan.me/).


å¡«å…¥é…ç½®æ–‡ä»¶ä¸­çš„ç®¡ç†ipç«¯å£å¯†ç ï¼Œè¿ä¸Šclash
![](/uploads/2020/07/clash.png)
ä¹‹åå¯ä»¥ç»§ç»­åœ¨è¿™é‡Œè®¾ç½®ç«¯å£å’Œå…¶ä»–ç®¡ç†<br>
**è¿™é‡Œçš„ç»“æœå¹¶ä¸ä¼šä¿å­˜åˆ°é…ç½®æ–‡ä»¶ï¼Œå°±æ˜¯ä¸´æ—¶ç”Ÿæ•ˆ**
![](/uploads/2020/07/clash2.png)
**åœ¨ä»£ç†é‡Œé€‰æ‹©ä½¿ç”¨çš„æœåŠ¡å™¨**
![](/uploads/2020/07/clash3.png)

#### ç§æœ‰dashboard
```
cd $CLASHDIR/ui
git clone git@github.com:Dreamacro/clash-dashboard.git
cd 
git checkout gh-pages
```
å¯ä»¥æŠŠ`clash-dashboard`ç›®å½•ç›´æ¥æ”¾åˆ°æœåŠ¡å™¨çš„webç›®å½•,è¿›è¡Œè®¿é—®(http://mom/clash-dashboard/#/proxies),ä¹Ÿå¯ä»¥ç”¨clashæä¾›çš„webæœåŠ¡(192.168.192.204/ui)è¿›è¡Œè®¿é—®,ä½¿ç”¨clashçš„æœåŠ¡éœ€è¦æ·»åŠ å‚æ•°`external-ui`
```
external-controller: 192.168.192.204:9090
external-ui: /home/cndaqiang/soft/clash/ui/clash-dashboard
```
ä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„dashboard:[yacd](https://github.com/haishanh/yacd)


## æ·»åŠ åˆ°å¿«æ·è„šæœ¬
```
#å¯åŠ¨clash
pkill -f clash-linux-amd64-v1.9.0; sleep 10; nohup $HOME/MyTools/clash/clash-linux-amd64-v1.9.0 > /tmp/clash.pid &
```

## è®¢é˜…ç›¸å…³
### subconverterè½¬æ¢è®¢é˜…urlä¸ºclashé…ç½®æ–‡ä»¶
ä¸‹è½½[subconverter](https://github.com/tindy2013/subconverter),è§£å‹,
```
wget https://github.com/tindy2013/subconverter/releases/download/v0.7.1/subconverter_linux64.tar.gz
tar xzvf subconverter_linux64.tar.gz
```

åˆ©ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼ç”Ÿæˆ`config.yml`,å¹¶å¤åˆ¶åˆ°clashé…ç½®ç›®å½•
```
cndaqiang@GIRL subconverter$ cp config.yml ~/.config/clash/config.yaml
```

#### é€šè¿‡httpè½¬æ¢è®¢é˜…æ–‡ä»¶
é€‚åˆæ­å»ºè½¬æ¢æœåŠ¡å™¨,ä¾›æ‰€æœ‰çš„æœºå™¨ä½¿ç”¨
```
cndaqiang@GIRL subconverter$ ./subconverter
2022/02/21 Mon 21:15:44.125582 [1058 10739384][INFO] SubConverter v0.7.1 starting up..
2022/02/21 Mon 21:15:44.127224 [1058 10739384][INFO] Reading preference settings...
......
2022/02/21 Mon 21:15:44.164532 [1058 10739384][INFO] Startup completed. Serving HTTP @ http://0.0.0.0:25500
```
ä½¿ç”¨httpè·å–clashé…ç½®æ–‡ä»¶, ç½‘å€è§„åˆ™è¯¦è§[README-cn.md](https://github.com/tindy2013/subconverter/blob/master/README-cn.md),æ³¨æ„è¦æŠŠè®¢é˜…è¿æ¥è½¬ä¸º[URLEncode](https://www.urlencoder.org/),ç¤ºä¾‹

```
cndaqiang@GIRL tmp$ curl -s "http://127.0.0.1:25500/sub?target=clash&url=http%3A%2F%2Fdy.clashweb.site%2Fapi%2Fv1%2Fclient%2Fsubscribe%3Ftoken%3Dcndaqiangstoken" > config.yaml
cndaqiang@GIRL tmp$ head  config.yaml
port: 7890
socks-port: 7891
allow-lan: true
mode: Rule
log-level: info
external-controller: :9090
proxies:
  - {name: æ—¥æœ¬01-CM-2.0, server: xxx.gz.cm.888022.site, port: 32224, type: ss, cipher: chacha20-ietf-poly1305, password: ec684a62-be94-47f6-820c-779e4d921234, udp: true}
  ...
```
æ ¹æ®URLEncodeçš„æ ¼å¼ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ª
```
cndaqiang@GIRL tmp$ curl -s "http://127.0.0.1:25500/sub?target=clash&url="$(echo "http://dy.clashweb.site/api/v1/client/subscribe?token=cndaqiangstoken" | sed  "s|/|%2F|g" | sed  "s|:|%3A|g"  | sed  "s|?|%3F|g")
```
#### [æ¨è]å‘½ä»¤è¡Œè½¬æ¢
ä¿®æ”¹é…ç½®æ–‡ä»¶,è‡ªå®šä¹‰é…ç½®ç±»å‹`[cndaqiang]`,urlå¯ä»¥ä¸ºæ–‡ä»¶ä¹Ÿå¯ä»¥ä¸ºè®¢é˜…åœ°å€
```
cndaqiang@GIRL subconverter$ vi generate.ini
#å†…å®¹å¦‚ä¸‹
[cndaqiang]
path=config.yml
target=clash
ver=4
url=http://dy.clashweb.site/api/v1/client/subscribe?token=cndaqiangstoken
```
ç”Ÿæˆé…ç½®æ–‡ä»¶`config.yml`
```
cndaqiang@GIRL subconverter$ ./subconverter -g --artifact "cndaqiang"
#è¿™é‡Œç”Ÿæˆçš„æ˜¯config.yml,é…ç½®æ–‡ä»¶æ—¶yaml
cndaqiang@GIRL subconverter$ cp config.yml ~/.config/clash/config.yaml
```

#### è‡ªå®šä¹‰subconverterç”Ÿæˆçš„é…ç½®æ–‡ä»¶
**ç®€å•ç²—æš´å°±ç›´æ¥ä¿®æ”¹`vi base/all_base.tpl`å°±å¯ä»¥**<br>
```
...
port: { { default(global.clash.http_port, "7890") } }
...
```

åœ¨`vi pref.toml`ä¸­è®¾ç½®æ¨¡æ¿ä¹Ÿå¯ä»¥
```
...
[[template.globals]]
key = "clash.http_port"
value = "7890"
...
```


### æœ‰é…ç½®æ–‡ä»¶å,å¯åŠ¨clashå³å¯
```
cndaqiang@GIRL clash$ ./clash-linux-amd64-v1.8.0
INFO[0000] Start initial compatible provider ğŸ”° èŠ‚ç‚¹é€‰æ‹©
INFO[0000] Start initial compatible provider ğŸ›‘ å…¨çƒæ‹¦æˆª
INFO[0000] Start initial compatible provider ğŸš« è¿è¥åŠ«æŒ
```
1.9ç‰ˆæœ¬è™½ç„¶æŠ¥é”™`ERRO[0000] Start DNS server error: missing port in address`,ä½†æ˜¯ä¸å½±å“ä½¿ç”¨



## æ–°æœåŠ¡å™¨ä»å¤´é…ç½®clash
```
cd $HOME/soft
CLASHDIR=$PWD/clash
mkdir $CLASHDIR
mkdir $CLASHDIR/bin
mkdir $CLASHDIR/log
mkdir $CLASHDIR/ui
cd $CLASHDIR
#giteeå¤‡ä»½
version=clash-linux-amd64-v1.9.0
wget http://cndaqiang.gitee.io/packages//mirrors/clash/${version}.gz
gzip -d ${version}.gz
chmod +x $version
#ç”Ÿæˆé…ç½®æ–‡ä»¶
./$version
#åˆå§‹åŒ–å®Œæˆåç»ˆæ­¢

#ä¸‹è½½subconvert
wget https://github.com/tindy2013/subconverter/releases/download/v0.7.1/subconverter_linux64.tar.gz
tar xzvf subconverter_linux64.tar.gz
cd $CLASHDIR/subconverter
cat >> generate.ini <<EOF
[cndaqiang]
path=config.yml
target=clash
ver=4
url=http://dy.clashweb.site/api/v1/client/subscribe?token=cndaqiangstoken
#å½“ç½‘ç»œç¯å¢ƒä¸å¥½æ—¶ï¼Œä½¿ç”¨æå‰ä¸‹è½½åæ”¾åˆ°æœ¬åœ°çš„wwwç›®å½•ä¸´æ—¶å¯ç”¨ä¹Ÿå¯
EOF
#

#æœ¬åœ°dashboardå¯é€‰
cd $CLASHDIR/ui
git clone git@github.com:Dreamacro/clash-dashboard.git
git checkout gh-pages
     
#æ”¹clashå‚æ•°          
vi base/all_base.tpl
#
./subconverter -g --artifact "cndaqiang"
cp $CLASHDIR/subconverter/config.yml $HOME/.config/clash/config.yaml


#æ‰§è¡Œ
ln -s $CLASHDIR/$version $CLASHDIR/bin/clash
$CLASHDIR/bin/clash


#é…ç½®æ–‡ä»¶ä½¿ç”¨ç³»ç»ŸæœåŠ¡å¯åŠ¨
cd $CLASHDIR/bin/
cat >  restart-clash.sh <<EOF
#!/bin/bash
PIDFILE=$CLASHDIR/log/clash.pid
if [ -f \$PIDFILE ]
then
kill -9 \$(cat \$PIDFILE )
fi
#ç”Ÿæˆæ–°çš„PIDæ–‡ä»¶
echo \$\$ > \$PIDFILE 
#æ–°é…ç½®æ–‡ä»¶
rm -rf $CLASHDIR/subconverter/config.yml
$CLASHDIR/subconverter/subconverter -g --artifact "cndaqiang"
if [ -f $CLASHDIR/subconverter/config.yml ]
then
        echo ä¸‹è½½$CLASHDIR/subconverter/config.ymlæˆåŠŸ
        cp $CLASHDIR/subconverter/config.yml $CLASHDIR/subconverter/config.yml.bak
else
        echo ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ä»½$CLASHDIRh/subconverter/config.yml.bak
        cp $CLASHDIR/subconverter/config.yml.bak $CLASHDIR/subconverter/config.yml
fi


#æ·»åŠ è‡ªå®šä¹‰çš„è§„åˆ™, å¦‚libgenèµ°ä»£ç†
line=\$(grep -rn rules $CLASHDIR/subconverter/config.yml | awk  -F: '{ print \$1 }')

sed -i \${line}a'\ - DOMAIN-KEYWORD,libgen,â™»ï¸ è‡ªåŠ¨é€‰æ‹©          ' $CLASHDIR/subconverter/config.yml
sed -i \${line}a'\ - DOMAIN-KEYWORD,sci-hub,â™»ï¸ è‡ªåŠ¨é€‰æ‹©         ' $CLASHDIR/subconverter/config.yml      
sed -i \${line}a'\ - DOMAIN-KEYWORD,sciencedirect,ğŸ¯ å…¨çƒç›´è¿   ' $CLASHDIR/subconverter/config.yml    
sed -i \${line}a'\ - DOMAIN-SUFFIX,aps.org,ğŸ¯ å…¨çƒç›´è¿          ' $CLASHDIR/subconverter/config.yml       
sed -i \${line}a'\ - DOMAIN-SUFFIX,webofscience.com,ğŸ¯ å…¨çƒç›´è¿ ' $CLASHDIR/subconverter/config.yml             
sed -i \${line}a'\ - DOMAIN-SUFFIX,iop.org,ğŸ¯ å…¨çƒç›´è¿          ' $CLASHDIR/subconverter/config.yml           
sed -i \${line}a'\ - DOMAIN-SUFFIX,scitation.org,ğŸ¯ å…¨çƒç›´è¿    ' $CLASHDIR/subconverter/config.yml                 
sed -i \${line}a'\ - DOMAIN-SUFFIX,elsevier.com,ğŸ¯ å…¨çƒç›´è¿     ' $CLASHDIR/subconverter/config.yml                
sed -i \${line}a'\ - DOMAIN-SUFFIX,wiley.com,ğŸ¯ å…¨çƒç›´è¿        ' $CLASHDIR/subconverter/config.yml             
sed -i \${line}a'\ - DOMAIN-SUFFIX,acs.org,ğŸ¯ å…¨çƒç›´è¿          ' $CLASHDIR/subconverter/config.yml           
sed -i \${line}a'\ - DOMAIN-SUFFIX,nih.gov,ğŸ¯ å…¨çƒç›´è¿          ' $CLASHDIR/subconverter/config.yml           
sed -i \${line}a'\ - DOMAIN-SUFFIX,springer.com,ğŸ¯ å…¨çƒç›´è¿     ' $CLASHDIR/subconverter/config.yml                
sed -i \${line}a'\ - DOMAIN-SUFFIX,nature.com,ğŸ¯ å…¨çƒç›´è¿       ' $CLASHDIR/subconverter/config.yml              
sed -i \${line}a'\ - DOMAIN-SUFFIX,science.org,ğŸ¯ å…¨çƒç›´è¿      ' $CLASHDIR/subconverter/config.yml               
sed -i \${line}a'\ - DOMAIN-SUFFIX,jps.jp,ğŸ¯ å…¨çƒç›´è¿      ' $CLASHDIR/subconverter/config.yml               
sed -i ${line}a'\ - DOMAIN-SUFFIX,xiaomi.eu,â™»ï¸ è‡ªåŠ¨é€‰æ‹©      ' /home/cndaqiang/soft/clash/subconverter/config.yml

diff $CLASHDIR/subconverter/config.yml $HOME/.config/clash/config.yaml
#å¦‚æœä¸¤ä¸ªæ–‡ä»¶ä¸€è‡´ï¼Œå°±ç›´æ¥å¼€å¯clashï¼Œå¦‚æœä¸ä¸€è‡´å°±ç”Ÿæˆå¤‡ä»½æ—§æ–‡ä»¶å¹¶ä¸‹è½½æ›¿æ¢æ–°çš„æ–‡ä»¶
if [ ! "\$?" == 0 ]
then
  cp  $CLASHDIR/subconverter/config.yml $HOME/.config/clash/config.yaml
fi
#
#æ‰§è¡Œ
$CLASHDIR/bin/clash | tee $CLASHDIR/log/clash.log
EOF

chmod +x restart-clash.sh
#ç»ˆæ­¢æ–‡ä»¶
cat >  stop-clash.sh <<EOF
#!/bin/bash
PIDFILE=$CLASHDIR/log/clash.pid
if [ -f \$PIDFILE ]
then
kill -9 \$(cat \$PIDFILE )
fi
EOF
chmod +x stop-clash.sh

#é…ç½®åŸºäºç”¨æˆ·èº«ä»½(æŠŠcndaqiangæ¢æˆè‡ªå·±çš„ç”¨æˆ·å)çš„ç³»ç»ŸæœåŠ¡
cat > $CLASHDIR/bin/clash.service <<EOF
[Unit]
[Service]
User=cndaqiang
Group=cndaqiang
ExecStart=$CLASHDIR/bin/restart-clash.sh
ExecStop=$CLASHDIR/bin/stop-clash.sh
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes
[Install]
WantedBy=multi-user.target
EOF

sudo cp $CLASHDIR/bin/clash.service /etc/systemd/system/clash.service
#å¯åŠ¨æœåŠ¡
sudo systemctl start clash
#å¼€æœºå¯åŠ¨
sudo systemctl enable clash

#å¦‚åªåœ¨zerotierçš„å†…ç½‘ä½¿ç”¨clash,åœ¨`/etc/rc.local`ä¸­æ·»åŠ 
systemctl start clash

#è®¡åˆ’ä»»åŠ¡ï¼Œæ¯å¤©ä¸€ç‚¹æ›´æ–°clash
crontab -e
0 1 * * * systemctl restart clash
```

### è‡ªå·±åˆ›å»ºç­–ç•¥å¹¶é…ç½®åˆ†æµ
ä¸æƒ³è½¬è¯‘äº†,è‡ªå·±æ·»åŠ åˆ°`restart-clash.sh`
```
#è‡ªåŠ¨ç­›é€‰èŠ‚ç‚¹
sourceFile=/home/cndaqiang/soft/clash/subconverter/config.yml
includeFile=${sourceFile}.chat.cndaqiang.in
echo "  - name: ChatGPT" > $includeFile
hang0=$(grep -n 'è‡ªåŠ¨é€‰æ‹©' $sourceFile | grep name | awk -F: '{ print $1 }')
hang=$((hang0+1))
sed -n "${hang},\$p" $sourceFile  | awk '/^[[:space:]]*-/ {exit} {print}' >> $includeFile
#ç­›é€‰èŠ‚ç‚¹
sed -n "${hang},\$p" $sourceFile  | awk '/name/ {exit} {print}' | grep -i GPT >> $includeFile
#ç”Ÿæˆæ–°çš„æ–‡ä»¶
awk -v line="${hang0}" -v includeFile="$includeFile" 'NR==line{system("cat " includeFile )} {print}' $sourceFile > ${sourceFile}.tmp
mv ${sourceFile}.tmp $sourceFile
rm $includeFile
line=$(grep -rn rules /home/cndaqiang/soft/clash/subconverter/config.yml | awk  -F: '{ print $1 }')
GPT=$(grep -i chatgpt /home/cndaqiang/soft/clash/subconverter/config.yml | grep name | head -1| sed 's/[,":{}]/ /g' | awk  '{ print $3 }')
if [ $GPT ]; then sed -i ${line}a'\ - DOMAIN-KEYWORD,openai, ChatGPT           ' /home/cndaqiang/soft/clash/subconverter/config.yml; fi
```

æŒ‰ç…§ä¸Šé¢çš„æ“ä½œåæœŸå¯ä»¥å†™æ›´å¤šçš„ç­–ç•¥ç»„,å¦‚ä»¥å›½å®¶ä¸ºæ­£åˆ™,ç”¨ä¸åˆ°ä¸æäº†







------
>æœ¬æ–‡é¦–å‘äº[æˆ‘çš„åšå®¢@cndaqiang](https://cndaqiang.github.io/).<br>
>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ [CC BY-SA 4.0 åè®®](https://creativecommons.org/licenses/by-sa/4.0/deed.zh) ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
